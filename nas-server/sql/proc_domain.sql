-- /* version 40 */
SET AUTODDL OFF;
SET TERM ^ ;

/* Stored procedures */
CREATE PROCEDURE ADD_CONTACT_TYPE_TO_OWNER (I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL,
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_CUSTOMER (TOWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
OWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_PASSWD VARCHAR(100) CHARACTER SET UTF8,
TOWNER_STATE STATE DEFAULT 0,
EXTERNAL_ID VARCHAR(100) CHARACTER SET UTF8 DEFAULT '',
TOWNER_COMMENT VARCHAR(8164) CHARACTER SET UTF8 DEFAULT '',
FBHOST VARCHAR(255) CHARACTER SET UTF8 DEFAULT '',
TLIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8 DEFAULT '',
TLIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8 DEFAULT '',
TLIBRARY_PATH VARCHAR(255) CHARACTER SET UTF8 DEFAULT '',
TLIBRARY_STATE STATE DEFAULT 0,
SUB_START DATE DEFAULT CURRENT_DATE,
SUB_END DATE DEFAULT NULL,
TLIBRARY_CHARGEABLE BOOLEAN DEFAULT 0)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_GEDGROUP_TO_LIBRARY (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL,
I_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_GEDUSER_TO_GEDGROUP (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDGROUP_ID INTEGER NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_GEDUSER_TO_LIBRARY (I_TGEDUSER_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL,
I_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE ADD_LOGSYNC (I_TLIBRARY_ID INTEGER NOT NULL,
I_SYNC_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL,
I_SYNC_STOP VARCHAR(20) CHARACTER SET UTF8 NOT NULL,
I_SYNC_SIZE_BEFORE BIGINT NOT NULL,
I_SYNC_SIZE_AFTER BIGINT NOT NULL,
I_SYNC_STATE BOOLEAN NOT NULL,
I_SYNC_ERR_COMMENT VARCHAR(4196) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_CONTACT (I_TCONTACT_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE DEL_CONTACT_TYPE_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_CONTACT_TYPE_FOR_OWNER (I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_CONTTYPE (I_TCONTTYPE_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_DOMPARAM (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_FBSERVER (I_TFBSERVER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE DEL_GEDGROUP (I_TGEDGROUP_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_GEDGROUP_FOR_LIBRARY (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_GEDPARAM (I_TGEDPARAM_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_GEDPARAMOWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_GEDPARAMPROF (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_GEDPARAMUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE DEL_GEDUSER_FOR_GEDGROUP (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDGROUP_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_GEDUSER_FOR_LIBRARY (I_TGEDUSER_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE DEL_OWNER (I_TOWNER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE DEL_PROFILE (I_TPROFILE_ID INTEGER NOT NULL)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE DEL_STORAGES (I_TOWNER_ID INTEGER NOT NULL,
I_TSTORAGE_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TSTORAGE_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE GET_ALL_LIBRARIES_FOR_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_WITH_DUPLICATE BOOLEAN NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_ORIGIN SMALLINT,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
GEDUSER_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_ALTER_STATE_OK (I_TARGETED_COLUMN VARCHAR(1000) CHARACTER SET UTF8 NOT NULL)
RETURNS (SQL_WHERE_DEFAULT_ALTER VARCHAR(255) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTACTS (I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTACT_ID INTEGER,
OWNER_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_STATE STATE,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTACTS_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TCONTACT_ALL BOOLEAN NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTACTS_TYPES_FOR_CONTACT (I_TCONTACT_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTACT_ID INTEGER,
OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
CONTTYPE_ID INTEGER,
CONTLIB_SYNC_SENDMAIL SYNC_MAIL,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8,
FBSERVER_ID INTEGER,
CONTACT_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTACTS_TYPES_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPE_ID INTEGER,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTLIB_SYNC_SENDMAIL SYNC_MAIL,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
CONTACT_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTACTS_TYPES_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPE_ID INTEGER,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTACT_INFOS (I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTACT_ID INTEGER,
OWNER_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_STATE STATE,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTACT_TYPE_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
CONTACT_ID INTEGER,
CONTTYPE_ID INTEGER,
CONTLIB_SYNC_SENDMAIL SYNC_MAIL,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
CONTACT_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTTYPES RETURNS (CONTTYPE_ID INTEGER,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTTYPE_INFOS (I_TCONTYPE_ID INTEGER NOT NULL)
RETURNS (CONTTYPE_ID INTEGER,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_CONTTYPE_MDF (I_TCONTACT_ID INTEGER NOT NULL)
RETURNS (CONTTYPES_INFOS BLOB CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_DATE_STRING (I_DATE TIMESTAMP)
RETURNS (DATE_STRING VARCHAR(20) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_DOMPARAM (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL)
RETURNS (DOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
DOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
DOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8,
DOMPARAM_VALUEBLB_FILLED BOOLEAN,
DOMPARAM_TYPE TYPE_PARAM,
DOMPARAM_COMMENT VARCHAR(512) CHARACTER SET UTF8,
DOMPARAM_PROTECTION STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_DOMPARAMS RETURNS (DOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
DOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
DOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8,
DOMPARAM_VALUEBLB_FILLED BOOLEAN,
DOMPARAM_TYPE TYPE_PARAM,
DOMPARAM_COMMENT VARCHAR(512) CHARACTER SET UTF8,
DOMPARAM_PROTECTION STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_DOMPARAM_VALUEBLB (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8)
RETURNS (DOMPARAM_TYPE TYPE_PARAM,
DOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8,
DOMPARAM_VALUEBLB BLOB)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_DOM_ACCESS (I_ACCESS_TYPE INTEGER NOT NULL DEFAULT 0)
RETURNS (ACCESS BOOLEAN)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_FBSERVERS (I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (FBSERVER_ID INTEGER,
FBSERVER_NAME VARCHAR(100) CHARACTER SET UTF8,
FBSERVER_TCPPORT INTEGER,
FBSERVER_HOST VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_TUNNELPORT INTEGER,
FBSERVER_TUNNELHOST VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_LIBROOTPATH VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_FBADMLOGIN VARCHAR(31) CHARACTER SET UTF8,
FBSERVER_FBADMPASSWD VARCHAR(100) CHARACTER SET UTF8,
FBSERVER_SIZE_MB BIGINT,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_FBSERVER_INFOS (I_TFBSERVER_ID INTEGER NOT NULL,
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (FBSERVER_ID INTEGER,
FBSERVER_NAME VARCHAR(50) CHARACTER SET UTF8,
FBSERVER_TCPPORT INTEGER,
FBSERVER_HOST VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_TUNNELPORT INTEGER,
FBSERVER_TUNNELHOST VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_LIBROOTPATH VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_FBADMLOGIN VARCHAR(31) CHARACTER SET UTF8,
FBSERVER_FBADMPASSWD VARCHAR(100) CHARACTER SET UTF8,
FBSERVER_SIZE_MB BIGINT,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDGROUPS_FOR_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8,
GEDGROUP_TYPE SMALLINT,
GEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDGROUP_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_GEDUSERS_COUNT INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
GEDUSER_STATE STATE,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDGROUPS_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8,
GEDGROUP_TYPE SMALLINT,
GEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDGROUP_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_GEDUSERS_COUNT INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDGROUPS_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8,
GEDGROUP_TYPE SMALLINT,
GEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDGROUP_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_GEDUSERS_COUNT INTEGER,
PROFILE_ID INTEGER,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDGROUP_INFOS (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDGROUP_ID INTEGER,
OWNER_ID INTEGER,
GEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8,
GEDGROUP_TYPE SMALLINT,
GEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDGROUP_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_GEDUSERS_COUNT INTEGER,
PROFILE_ID INTEGER,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAM (I_TGEDPARAM_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAM_CLASS INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDPARAM_DEFAULTVALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMOWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMOWNER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMOWNERS_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_CLASS VARCHAR(15) CHARACTER SET UTF8 DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMOWNER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMOWNER_MDF (I_TOWNER_ID INTEGER NOT NULL)
RETURNS (GEDPARAMOWNERS_INFOS BLOB CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMOWNER_VALUEBLB (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL)
RETURNS (GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMOWNER_VALUEBLB BLOB,
GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMPROF (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMPROF_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMPROFS_FOR_PROFILE (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_CLASS VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMPROF_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMPROF_VALUEBLB (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL)
RETURNS (GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMPROF_VALUEBLB BLOB,
GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMS (I_TGEDPARAM_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_CLASS VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAM_CLASS INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDPARAM_DEFAULTVALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
LIBRARY_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMUSER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDUSER_STATE STATE,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMUSERS_FOR_USER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
LIBRARY_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMUSER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDUSER_STATE STATE,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAMUSER_VALUEBLB (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0)
RETURNS (GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMUSER_VALUEBLB BLOB,
GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAM_DEFAULTVALUEBLB (I_TGEDPARAM_ID INTEGER NOT NULL)
RETURNS (GEDPARAM_TYPE TYPE_PARAM,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDPARAM_DEFAULTVALUEBLB BLOB,
OWNER_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAM_FOR_NAME (I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TGEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAM_CLASS INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDPARAM_DEFAULTVALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDPARAM_SECTION_OWNER_OK (SECTION VARCHAR(40) CHARACTER SET UTF8)
RETURNS (OK BOOLEAN)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDUSERS_COUNT_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_GEDUSERS_COUNT INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDUSERS_COUNT_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDGROUP_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDUSERS_COUNT INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDUSERS_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TGEDUSER_LOGIN_FILTER VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_NAME_FILTER VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_FIRSTNAME_FILTER VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_MAX_ROWS INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
GEDUSER_ID INTEGER,
GEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
GEDUSER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDUSER_CHARGEABLE BOOLEAN,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
PROFILE_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
GEDUSER_STATE STATE,
CONTACT_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDUSERS_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDGROUP_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_LOGIN_FILTER VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_NAME_FILTER VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_FIRSTNAME_FILTER VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_MAX_ROWS INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDUSER_ID INTEGER,
GEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
GEDUSER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDUSER_CHARGEABLE BOOLEAN,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
PROFILE_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
OWNER_STATE STATE,
GEDUSER_STATE STATE,
CONTACT_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDUSER_ID (I_TOWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDUSER_PASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
OWNER_ID INTEGER,
PROFILE_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
GEDGROUP_PROFILE_ID INTEGER,
CONTACT_ID INTEGER,
GEDUSER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_GEDUSER_INFOS (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
GEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
GEDUSER_PASSWD VARCHAR(100) CHARACTER SET UTF8,
GEDUSER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDUSER_CHARGEABLE BOOLEAN,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
OWNER_ID INTEGER,
PROFILE_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
GEDGROUP_PROFILE_ID INTEGER,
GEDUSER_STATE STATE,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LASTSYNC_MDF (I_TLIBRARY_ID INTEGER NOT NULL)
RETURNS (LOGSYNCS_INFOS BLOB CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LIBRARIES (I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
PROFILE_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LIBRARIES_FOR_FBSERVER (I_TFBSERVER_ID INTEGER NOT NULL,
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (FBSERVER_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
OWNER_ID INTEGER,
PROFILE_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
FBSERVER_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LIBRARIES_FOR_GEDGROUP (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (GEDGROUP_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
GEDUSER_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LIBRARIES_FOR_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
GEDUSER_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LIBRARIES_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT'')
RETURNS (OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
FBSERVER_ID INTEGER,
PROFILE_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LIBRARY_CONNECT (I_TLIBRARY_ID INTEGER NOT NULL)
RETURNS (LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LIBRARY_INFOS (I_TLIBRARY_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
PROFILE_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LOGSYNCS (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TIME_CRIT_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TIME_CRIT_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_STATE_CRIT BOOLEAN NOT NULL DEFAULT 32767,
I_MAX_ROWS INTEGER NOT NULL DEFAULT 0)
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
OWNER_ID INTEGER,
OWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
SYNC_START VARCHAR(20) CHARACTER SET UTF8,
SYNC_STOP VARCHAR(20) CHARACTER SET UTF8,
SYNC_DURATION BIGINT,
SYNC_SIZE_BEFORE BIGINT,
SYNC_SIZE_AFTER BIGINT,
SYNC_SIZE_TRANSFERED BIGINT,
SYNC_STATE BOOLEAN,
SYNC_ERR_COMMENT VARCHAR(4196) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LOGSYNCSTATS (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TIME_CRIT_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TIME_CRIT_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_STATE_CRIT BOOLEAN NOT NULL DEFAULT 32767)
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
OWNER_ID INTEGER,
OWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
SYNC_NB INTEGER,
SYNC_SIZE_TRANSFERED_SUM BIGINT,
SYNC_SIZE_TRANSFERED_AVG BIGINT,
SYNC_DURATION_SUM BIGINT,
SYNC_DURATION_AVG BIGINT)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_LOGSYNC_MDF (I_TLOGSYNC_ID INTEGER NOT NULL)
RETURNS (LOGSYNCS_INFOS BLOB CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_OWNERS (I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
OWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
OWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
OWNER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
OWNER_EXTERNAL_ID VARCHAR(100) CHARACTER SET UTF8,
OWNER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
OWNER_ISADMIN BOOLEAN,
OWNER_SIZE_MB BIGINT,
OWNER_SIZE_MB_CHARGEABLE BIGINT,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
GEDPARAMOWNERS_INFOS BLOB CHARACTER SET UTF8,
PROFILE_ID INTEGER,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_OWNER_ID (I_TOWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_PASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
PROFILE_ID INTEGER,
CONTACT_ID INTEGER,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_OWNER_INFOS (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
OWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
OWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_PASSWD VARCHAR(100) CHARACTER SET UTF8,
OWNER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
OWNER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
OWNER_EXTERNAL_ID VARCHAR(100) CHARACTER SET UTF8,
OWNER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
OWNER_ISADMIN BOOLEAN,
OWNER_SIZE_MB BIGINT,
OWNER_SIZE_MB_CHARGEABLE BIGINT,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
GEDPARAMOWNERS_INFOS BLOB CHARACTER SET UTF8,
PROFILE_ID INTEGER,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_OWNER_IS_ADMIN (I_TOWNER_ID INTEGER NOT NULL)
RETURNS (OWNER_ADMIN BOOLEAN,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_PROFILES_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
GEDUSER_ID INTEGER,
PROFILE_ID INTEGER,
PROFILE_NAME VARCHAR(100) CHARACTER SET UTF8,
PROFILE_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
PROFILE_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
PROFILE_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE,
GEDUSER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_PROFILE_FOR_GEDGROUPLIB (I_TLIBRARY_ID INTEGER NOT NULL,
I_TGEDGROUP_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
GEDGROUP_ID INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_PROFILE_FOR_GEDUSERLIB (I_TLIBRARY_ID INTEGER NOT NULL,
I_TGEDUSER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
GEDUSER_ID INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE,
GEDUSER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_PROFILE_INFOS (I_TPROFILE_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER,
PROFILE_NAME VARCHAR(100) CHARACTER SET UTF8,
OWNER_ID INTEGER,
PROFILE_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
LIBRARY_ID INTEGER,
GEDUSER_ID INTEGER,
PROFILE_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
PROFILE_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
GEDUSER_STATE STATE,
FBSERVER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_STATES (I_TARGETED_TABLE VARCHAR(255) CHARACTER SET UTF8 NOT NULL,
I_CRITERIA VARCHAR(8000) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_RETURN_COLUMN VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT 'ID',
I_TARGETED_COLUMN VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT 'STATE')
RETURNS (COLUMN_ID VARCHAR(8000) CHARACTER SET UTF8,
STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_STATE_CRITERIA (I_EXPR_CRIT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL,
I_TARGETED_COLUMN VARCHAR(1000) CHARACTER SET UTF8 NOT NULL)
RETURNS (CRIT_FOR_STATE VARCHAR(1000) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_STORAGES (I_TOWNER_ID INTEGER NOT NULL,
I_TSTORAGE_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TSTORAGE_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDUSER_ID INTEGER,
LIBRARY_ID INTEGER,
STORAGE_SECTION VARCHAR(40) CHARACTER SET UTF8,
STORAGE_NAME VARCHAR(80) CHARACTER SET UTF8,
STORAGE_VALUE VARCHAR(8000) CHARACTER SET UTF8,
STORAGE_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_SUBDOMAIN_EXISTS (I_TOWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
PROFILE_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE GET_VISIBILITY_STATE_OK (I_TARGETED_COLUMN VARCHAR(1000) CHARACTER SET UTF8 NOT NULL)
RETURNS (SQL_WHERE_DEFAULT_VISIBILITY VARCHAR(255) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE PURGE_ALL (I_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_PURGE_LOGSYNC BOOLEAN NOT NULL DEFAULT 0)
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE PURGE_CONTACTS (I_TCONTACT_ID INTEGER NOT NULL DEFAULT 0,
I_TCONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE PURGE_GEDUSERS (I_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE PURGE_LIBRARIES (I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE PURGE_LOGSYNC (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TIME_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE PURGE_OWNERS (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE PURGE_PROFILES (I_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TPROFILE_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_ID INTEGER NOT NULL DEFAULT 0)
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_CONTACT_INFOS (I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTACT_TOWNER_ID INTEGER NOT NULL,
I_TCONTACT_NAME VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_TEL VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_REGION VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_CITY VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTACT_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_CONTACT_TYPE_TO_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL,
I_TCONTLIB_SYNC_SENDMAIL SYNC_MAIL NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE SET_CONTTYPE_INFOS (I_TCONTTYPE_ID INTEGER NOT NULL DEFAULT 0,
I_TCONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTTYPE_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_DOMPARAM (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TDOMPARAM_TYPE TYPE_PARAM NOT NULL DEFAULT 1,
I_TDOMPARAM_COMMENT VARCHAR(512) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TDOMPARAM_PROTECTION STATE NOT NULL DEFAULT 2)
RETURNS (DOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
DOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
DOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_DOMPARAM_VALUEBLB (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_VALUEBLB BLOB NOT NULL DEFAULT '')
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE SET_FBSERVER_INFOS (I_TFBSERVER_ID INTEGER NOT NULL,
I_TFBSERVER_NAME VARCHAR(50) CHARACTER SET UTF8 NOT NULL,
I_TFBSERVER_HOST VARCHAR(255) CHARACTER SET UTF8 NOT NULL,
I_TFBSERVER_FBADMLOGIN VARCHAR(31) CHARACTER SET UTF8 NOT NULL,
I_TFBSERVER_FBADMPASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_TCPPORT TCPPORT NOT NULL DEFAULT 0,
I_TFBSERVER_TUNNELPORT TCPPORT NOT NULL DEFAULT 0,
I_TFBSERVER_TUNNELHOST VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_LIBROOTPATH VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (FBSERVER_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDGROUP_INFOS (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TGEDGROUP_TOWNER_ID INTEGER NOT NULL,
I_TGEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDGROUP_TYPE SMALLINT NOT NULL DEFAULT 0,
I_TGEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDGROUP_PROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDGROUP_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDGROUP_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDPARAM (I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TGEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_TYPE TYPE_PARAM NOT NULL DEFAULT 1,
I_TGEDPARAM_CLASS INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_PROTECTION STATE NOT NULL DEFAULT 2,
I_TGEDPARAM_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDPARAMOWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMOWNER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDPARAMOWNER_VALUEBLB (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAMOWNER_VALUEBLB BLOB NOT NULL DEFAULT '')
RETURNS (GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDPARAMPROF (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMPROF_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDPARAMPROF_VALUEBLB (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAMPROFVALUEBLB BLOB NOT NULL DEFAULT '')
RETURNS (GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDPARAMUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
LIBRARY_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMUSER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDPARAMUSER_VALUEBLB (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAMUSER_VALUEBLB BLOB NOT NULL DEFAULT '')
RETURNS (GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDPARAM_DEFAULTVALUEBLB (I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAM_DEFAULTVALUEBLB BLOB NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDUSER_INFOS (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_TOWNER_ID INTEGER NOT NULL,
I_TGEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDUSER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COMMENT VARCHAR(8164) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_CHARGEABLE BOOLEAN DEFAULT 0,
I_TGEDUSER_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_TGEDGROUP_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_TCONTACT_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_GEDUSER_PASSWD (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_PASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_LIBRARY_INFOS (I_TLIBRARY_ID INTEGER NOT NULL,
I_TLIBRARY_TOWNER_ID INTEGER NOT NULL,
I_TLIBRARY_TFBSERVER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_VERSION INTEGER NOT NULL DEFAULT '',
I_TLIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_CHARGEABLE BOOLEAN NOT NULL DEFAULT 0,
I_TLIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_ACCESS_MODE SMALLINT NOT NULL DEFAULT 0,
I_TLIBRARY_ACCESS_TYPE INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_SIZE_MB BIGINT NOT NULL DEFAULT 0,
I_TLIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_SIZE_MB_ORG BIGINT NOT NULL DEFAULT 0,
I_TLIBRARY_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_LISTORDER INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_OWNER_INFOS (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_NAME VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_EXTERNAL_ID VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_COMMENT VARCHAR(8164) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_TCONTACT_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_OWNER_PASSWD (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_PASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_PROFILE_INFOS (I_TPROFILE_ID INTEGER NOT NULL,
I_TPROFILE_OWNER_ID INTEGER NOT NULL,
I_TPROFILE_NAME VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TPROFILE_COMMENT VARCHAR(8164) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TPROFILE_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TPROFILE_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TPROFILE_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_GEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_STATE (I_EXPR_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL,
I_CRITERIA VARCHAR(8000) CHARACTER SET UTF8 NOT NULL,
I_TARGETED_TABLE VARCHAR(255) CHARACTER SET UTF8 NOT NULL,
I_TARGETED_COLUMN VARCHAR(255) CHARACTER SET UTF8 DEFAULT 'STATE')
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SET_STORAGE (I_TSTORAGE_TOWNER_ID INTEGER NOT NULL,
I_TSTORAGE_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TSTORAGE_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL,
I_TSTORAGE_VALUE VARCHAR(8000) CHARACTER SET UTF8 NOT NULL,
I_TSTORAGE_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0)
AS 
BEGIN EXIT; END ^
CREATE PROCEDURE SET_STRING_DATE (I_STRING VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (DATE_STRING TIMESTAMP)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE SPLIT_BLOB (SQL_GETBLOB VARCHAR(8000) CHARACTER SET UTF8 NOT NULL,
FIELD_SEP VARCHAR(5) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULTS VARCHAR(255) CHARACTER SET UTF8)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE UNDEL_CONTACT (I_TCONTACT_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE UNDEL_FBSERVER (I_TFBSERVER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE UNDEL_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE UNDEL_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^
CREATE PROCEDURE UNDEL_OWNER (I_TOWNER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
BEGIN SUSPEND; END ^

ALTER PROCEDURE ADD_CONTACT_TYPE_TO_OWNER (I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL,
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
/*
    Ajout d'un type de contact pour un propritaire

    Le contact ET le propitaire doivent exister pralamblement  l'appel de cette procdure
    
    Les colonnes "STATE" des tables parentes sont values afin de savoir s'il est possible d'utiliser l'un et/ou l'autre (cf. gestion des colonnes STATE dans la documentation)
    
    Ne renvoi rien (ie. si pas d'erreur, insertion Ok)
    
    Si le couple existe dj, une erreur SQL standard est leve (violation PK)
    
*/

DECLARE VARIABLE SQL_WHERE_CONTACT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);

    SQL_WHERE_CONTACT = '';
    SQL_WHERE_OWNER = '' ;

    ID_OK=Null;

    /* Owner utilisable outrepassable)... */
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    /* contact utilisable outrepassable)... */
    IF (:I_TCONTACT_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE_CONTACT;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE_CONTACT; 

    EXECUTE STATEMENT '
        SELECT TCONTACT.ID FROM TCONTACT INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
        WHERE TCONTACT.ID=' || :I_TCONTACT_ID ||
            IIF (:SQL_WHERE_CONTACT != '' , ' AND ' || :SQL_WHERE_CONTACT, '') ||
            IIF (:SQL_WHERE_OWNER != '' , ' AND ' || :SQL_WHERE_OWNER, '')
        INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOCONTACT;

	/* Type de contact prsent */
	IF (NOT EXISTS (SELECT ID FROM TCONTTYPE WHERE ID=:I_TCONTTYPE_ID)) THEN EXCEPTION EX_NOCONTTYPE;
        
    /* L'environnement est correct, on peut insrer */
    BEGIN
        INSERT INTO TCONTOWNER(TCONTACT_ID, TCONTTYPE_ID)
        VALUES(
            :I_TCONTACT_ID,
            :I_TCONTTYPE_ID
        );

        WHEN GDSCODE unique_key_violation DO
            EXCEPTION EX_CONTOWN_EXISTS;
    END
        
END ^

ALTER PROCEDURE ADD_CUSTOMER (TOWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
OWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_PASSWD VARCHAR(100) CHARACTER SET UTF8,
TOWNER_STATE STATE DEFAULT 0,
EXTERNAL_ID VARCHAR(100) CHARACTER SET UTF8 DEFAULT '',
TOWNER_COMMENT VARCHAR(8164) CHARACTER SET UTF8 DEFAULT '',
FBHOST VARCHAR(255) CHARACTER SET UTF8 DEFAULT '',
TLIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8 DEFAULT '',
TLIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8 DEFAULT '',
TLIBRARY_PATH VARCHAR(255) CHARACTER SET UTF8 DEFAULT '',
TLIBRARY_STATE STATE DEFAULT 0,
SUB_START DATE DEFAULT CURRENT_DATE,
SUB_END DATE DEFAULT NULL,
TLIBRARY_CHARGEABLE BOOLEAN DEFAULT 0)
AS 
DECLARE VARIABLE
	OWN_ID INTEGER;
DECLARE VARIABLE
	LIB_ID INTEGER; 
DECLARE VARIABLE
	TFB_ID INTEGER; 

BEGIN

	/*
	Cette procdure permet de crer/ajouter les lments correspondants  client et/ou une librairie hberge :
	- Owner :
		TOWNER_NAME, LOGIN, PASSWORD, TOWNER_STATE ==> lments  ajouter dans la table OWNER (voir ci-dessous)
		EXTERNAL_ID :
			* Si pass et dj existant dans la table OWNER, on considre que le propritaire est dj cr
			(les paramtres TOWNER_NAME, LOGIN, PASSWORD, TOWNER_STATE, TOWNER_COMMENT sont ignors dans ce cas)
			* Si pass et non existant dans la table, utilis avec les paramtres TOWNER_NAME, LOGIN, PASSWORD, TOWNER_STATE, TOWNER_COMMENT
			pour crer un NOUVEAU OWNER...
			* Si non pass, ajout d'un nouvel OWNER avec les paramtres TOWNER_NAME, LOGIN, PASSWORD, TOWNER_STATE, TOWNER_COMMENT
	- Serveur Firebird :
		FB_HOST : host fqdn devant exit dans la table TFBSERVER (aucun ajout de serveur Firebird n'est effectu)
	- Bilbiothque
		TLIBRARY_NAME, TLIBRARY_TITLE, TLIBRARY_PATH, TLIBRARY_STATE, SUB_START, SUB_END, TLIBRARY_CHARGEABLE => lments  ajouter  la table TLIBRARY
		On considre que la labrairie doit toujours tre ajoute...
	- Profils
		TPROFILE_NAME, TPROFILE_WEB_THEME, TPROFILE_WEB_BACKGROUND, TPROFILE_DESC

	TODO : scinder pour traitement de chaque entit et voir 1 Mta procdure unique de traitement

MAJ V12 :
	- DOM_LOGIN/DOM_PASSWD ==> OWNER_LOGIN/OWNER_PASSWD
*/

	/* Recherche du hostname du serveur Firebird dans la trable idoine*/
	SELECT ID FROM TFBSERVER WHERE HOST=:FBHOST INTO TFB_ID;
	/* Si non trouv, exception personnalise*/
	IF (TFB_ID IS NULL) THEN 
		EXCEPTION EX_NOFBSER;
	
	/*
		Recherche d'un owner dj existant (bas sur Code externe GENESYS pass en paramtre)
		Bien sur dans ce cas on n'estime que le OWNER existe dj et il n'est pas cr...
	
	*/
	OWN_ID = NULL;
	IF (EXTERNAL_ID IS NOT NULL AND EXTERNAL_ID != '') THEN
		BEGIN
			SELECT ID FROM TOWNER WHERE EXTERNAL_ID=:EXTERNAL_ID INTO :OWN_ID;
        END

    IF (OWN_ID IS NULL) THEN
        BEGIN
            /* Ajout OWNER */
            INSERT INTO TOWNER (NAME, LOGIN, PASSWD, STATE, EXTERNAL_ID, "COMMENT")
                VALUES (
                    :TOWNER_NAME, 
                    :OWNER_LOGIN, 
                    :OWNER_PASSWD, 
                    COALESCE(:TOWNER_STATE,0), 
                    :EXTERNAL_ID, 
                    :TOWNER_COMMENT
                ) RETURNING ID INTO :OWN_ID;
        END
	
	/* Ajout LIBRARY */
	/*
	Les dates de dbut et de fin sont calcules si non fournies :
	- CURRENT_DATE
	- CURRENT_DATE + 1 YEAR - 1 DAY (par dfaut, abonnement d'un an)
	*/
	INSERT INTO TLIBRARY (TOWNER_ID, TFBSERVER_ID, "COMMENT", TITLE, DBPATH, STATE, SUBSCRIBE_START, SUBSCRIBE_END, CHARGEABLE)
		VALUES (
			:OWN_ID, 
			:TFB_ID, 
			:TLIBRARY_COMMENT, 
			:TLIBRARY_TITLE, 
			:TLIBRARY_PATH, 
			COALESCE(:TLIBRARY_STATE,0), 
			COALESCE(:SUB_START,CURRENT_DATE), 
			COALESCE(:SUB_END, DATEADD(1 YEAR TO CURRENT_DATE)-1),
			COALESCE(:TLIBRARY_CHARGEABLE,1)
	) RETURNING ID INTO LIB_ID;
	
-- 	/* Ajout PROFILE */
-- 	/* Nom de profil = "Nom de client + (Profil par dfaut)" si non fourni... */
-- 	INSERT INTO TPROFILE (NAME, TOWNER_ID, WEB_THEME, WEB_BACKGROUND, DESCRIPTION)
-- 		VALUES (
-- 			COALESCE(:TPROFILE_NAME, :TOWNER_NAME || ' (Profil par dfaut)'),
-- 			:OWN_ID, 
-- 			:TPROFILE_WEB_THEME, 
-- 			:TPROFILE_WEB_BACKGROUND, 
-- 			:TPROFILE_DESC
-- 		) RETURNING ID INTO PROF_ID;
-- 
-- 	/* Ajout ACCESS */
-- 	INSERT INTO TACCESS (TPROFILE_ID, TLIBRARY_ID)
-- 		VALUES (
-- 			:PROF_ID, 
-- 			:LIB_ID
-- 		);

END ^

ALTER PROCEDURE ADD_GEDGROUP_TO_LIBRARY (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL,
I_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
AS 
/*
    Cration d'une association Groute Utilisateur GED / Bibliothque
    
    Les STATES de tous les parents sont examins...

V32 :
	- Cration
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDGROUP VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDGROUP = '';

	ID_OK = Null;

	/* PROFILE existant */
	IF (I_TPROFILE_ID!=0 AND NOT EXISTS (SELECT ID FROM TPROFILE WHERE ID=:I_TPROFILE_ID)) THEN EXCEPTION EX_NOPROFILE;	

    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY et TGEDUSER */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    -- Groupe GED 
    EXECUTE STATEMENT '
        SELECT TOWNER.ID FROM TOWNER INNER JOIN TGEDGROUP ON TOWNER.ID=TGEDGROUP.TOWNER_ID
        WHERE TGEDGROUP.ID=' || :I_TGEDGROUP_ID ||
            IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDGROUP;

    ID_OK=Null;
    
   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;

    /* L'environnement est correct, on peut insrer */
    BEGIN
        INSERT INTO TGEDGROUPLIB(TGEDGROUP_ID, TLIBRARY_ID, TPROFILE_ID)
        VALUES(
            :I_TGEDGROUP_ID,
            :I_TLIBRARY_ID,
            NULLIF(:I_TPROFILE_ID,0)
        );
        
        /* Traitement violation PK */
        WHEN GDSCODE unique_key_violation DO
            EXCEPTION EX_GEDGROUPLIB_EXISTS;
    END


END ^

ALTER PROCEDURE ADD_GEDUSER_TO_GEDGROUP (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDGROUP_ID INTEGER NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
/*
    Cration d'une association Utilisateur GED / Groupe d'utilisateur
    
    Les STATES de tous les parents sont examins...
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_GEDUSER = '';
	ID_OK = Null;

    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY et TGEDUSER */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    -- GEDGROUP Ok
    EXECUTE STATEMENT '
        SELECT TGEDGROUP.ID FROM TOWNER INNER JOIN TGEDGROUP ON TOWNER.ID=TGEDGROUP.TOWNER_ID
        WHERE TGEDGROUP.ID=' || :I_TGEDGROUP_ID ||
            IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO ID_OK;
        
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDGROUP;

    ID_OK=Null;

    -- Utilisateur GED 
    IF (I_TGEDUSER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

    -- GEDUSER Ok
    EXECUTE STATEMENT '
        SELECT TOWNER.ID FROM TOWNER INNER JOIN TGEDUSER ON TOWNER.ID=TGEDUSER.TOWNER_ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '') ||
            IIF (:SQL_WHERE_GEDUSER != '' , ' AND (' || :SQL_WHERE_GEDUSER || ')', '')
        INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;

    /* L'environnement est correct, on peut insrer */
    BEGIN
        INSERT INTO TGEDGROUPUSER(TGEDGROUP_ID, TGEDUSER_ID)
        VALUES(
            :I_TGEDGROUP_ID,
            :I_TGEDUSER_ID
        );
        
        /* Traitement violation PK */
        WHEN GDSCODE unique_key_violation DO
            EXCEPTION EX_GEDGROUPUSER_EXISTS;
    END


END ^

ALTER PROCEDURE ADD_GEDUSER_TO_LIBRARY (I_TGEDUSER_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL,
I_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
AS 
/*
    Cration d'une association Utilisateur GED / Bibliothque
    
    Les STATES de tous les parents sont examins...
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDUSER = '';
	ID_OK = Null;



	/* PROFILE existant */
	IF (I_TPROFILE_ID!=0 AND NOT EXISTS (SELECT ID FROM TPROFILE WHERE ID=:I_TPROFILE_ID)) THEN EXCEPTION EX_NOPROFILE;	

    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY et TGEDUSER */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    -- Utilisateur GED 
    IF (I_TGEDUSER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

    -- GEDUSER Ok
    EXECUTE STATEMENT '
        SELECT TOWNER.ID FROM TOWNER INNER JOIN TGEDUSER ON TOWNER.ID=TGEDUSER.TOWNER_ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '') ||
            IIF (:SQL_WHERE_GEDUSER != '' , ' AND (' || :SQL_WHERE_GEDUSER || ')', '')
        INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;

    ID_OK=Null;
    
   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;

    /* L'environnement est correct, on peut insrer */
    BEGIN
        INSERT INTO TGEDUSERLIB(TGEDUSER_ID, TLIBRARY_ID, TPROFILE_ID)
        VALUES(
            :I_TGEDUSER_ID,
            :I_TLIBRARY_ID,
            NULLIF(:I_TPROFILE_ID,0)
        );
        
        /* Traitement violation PK */
        WHEN GDSCODE unique_key_violation DO
            EXCEPTION EX_GEDUSERLIB_EXISTS;
    END


END ^

ALTER PROCEDURE ADD_LOGSYNC (I_TLIBRARY_ID INTEGER NOT NULL,
I_SYNC_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL,
I_SYNC_STOP VARCHAR(20) CHARACTER SET UTF8 NOT NULL,
I_SYNC_SIZE_BEFORE BIGINT NOT NULL,
I_SYNC_SIZE_AFTER BIGINT NOT NULL,
I_SYNC_STATE BOOLEAN NOT NULL,
I_SYNC_ERR_COMMENT VARCHAR(4196) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
/*
    Enregistrement d'un log de synchro...
    Attention, tous les apramtres sont obligatoires (sauf comment)
    
V13 :
    - cration

V19 :
	- Tailles enregistres telles quelles (et plus NULL si = 0)

V25
    - Mise  jour du TOWNER_ID dans le trigger (plus dans la PS) ==> plus propre...
*/

BEGIN
    IF (NOT EXISTS (SELECT ID FROM TLIBRARY WHERE ID=:I_TLIBRARY_ID)) THEN
        EXCEPTION EX_NOLIB;
        
    -- On y va directement
    INSERT INTO TLOGSYNC(TLIBRARY_ID, TIME_START, TIME_END, SIZE_BEFORE, SIZE_AFTER, STATE, ERR_COMMENT)
    VALUES (
        :I_TLIBRARY_ID,
        (SELECT DATE_STRING FROM SET_STRING_DATE(:I_SYNC_START)),
        (SELECT DATE_STRING FROM SET_STRING_DATE(:I_SYNC_STOP)),
        :I_SYNC_SIZE_BEFORE,
        :I_SYNC_SIZE_AFTER,
        :I_SYNC_STATE,
        NULLIF(:I_SYNC_ERR_COMMENT,'')
    );
END ^

ALTER PROCEDURE DEL_CONTACT (I_TCONTACT_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Suppression logique d'un contact dans la table correspondante
    
    Paramtres : 
    - I_CONTACT_ID : Code contact

    Particularits :
    Cette suppression est une suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
        
    Retourne :
    - NEW_STATE : Nouvel tat du proritaire obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppresion" (mise  jour de colonne STATE) impossible

V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/

BEGIN

    /* Contact existant */
    IF (NOT EXISTS (SELECT ID FROM TCONTACT WHERE ID=:I_TCONTACT_ID)) THEN EXCEPTION EX_NOCONTACT;
    
    /* MAJ de la colonne STATE, on ajoute la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('+' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TCONTACT.ID=' || :I_TCONTACT_ID,'TCONTACT','STATE') INTO :NEW_STATE;
    SUSPEND;
    
END ^

ALTER PROCEDURE DEL_CONTACT_TYPE_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL)
AS 
/*
    Suppression *physique* d'une  association contact/librairie dans la table TACCESS
    
    Paramtres : 
    - I_TLIBRARY_ID : Code librairie
    - I_TCONTACT_ID : Code contact
    
    Particularits :
    Cette suppression est une suppression *physique* (ie. DELETE SQL)
    Les STATE des parents NE SONT PAS valus (choix arbitraire)
        
    Retourne :
    - Rien
        
    Attention
    - cette procdure lve des erreurs en cas de "suppression" impossible    
*/
BEGIN
    DELETE FROM TCONTLIB WHERE TLIBRARY_ID=:I_TLIBRARY_ID AND TCONTACT_ID=:I_TCONTACT_ID AND TCONTTYPE_ID=:I_TCONTTYPE_ID;
    
    IF (ROW_COUNT=0) THEN EXCEPTION EX_NOCONTLIB;

END ^

ALTER PROCEDURE DEL_CONTACT_TYPE_FOR_OWNER (I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL)
AS 
/*
    Suppression *physique* d'une  association contact Type dans la table TCONTOWNER
    
    Paramtres : 
    - I_TCONTACT_ID : Code contact
	- I_TCONTTYPE_ID : Code type de contact
    
    Particularits :
    Cette suppression est une suppression *physique* (ie. DELETE SQL)
    Les STATE des parents NE SONT PAS valus (choix arbitraire)
        
    Retourne :
    - Rien
        
    Attention
    - cette procdure lve des erreurs en cas de "suppression" impossible    
*/
BEGIN
    DELETE FROM TCONTOWNER WHERE TCONTTYPE_ID=:I_TCONTTYPE_ID AND TCONTACT_ID=:I_TCONTACT_ID;
    
    IF (ROW_COUNT=0) THEN EXCEPTION EX_NOCONTOWN;

END ^

ALTER PROCEDURE DEL_CONTTYPE (I_TCONTTYPE_ID INTEGER NOT NULL)
AS 
/*
    Suppression (physique) d'un type de contact
    
*/

BEGIN
	DELETE FROM TCONTTYPE WHERE ID=:I_TCONTTYPE_ID;

	IF (ROW_COUNT=0) THEN EXCEPTION EX_NOCONTTYPE;

	WHEN GDSCODE foreign_key DO
		EXCEPTION EX_CONTTYPE_INUSE;
END ^

ALTER PROCEDURE DEL_DOMPARAM (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL)
AS 
/*
	Suppression (physique) d'un paramtre DOMAIN

V13 :
	- Cration

V 17 :
	- Ajout SECTION

V18 :
	- Force les paramtres NOT NULL En entre...

V20 :
    - SYSTEM ==> PROTECTION
    - Plus de test (NAS s'en occupe directement)
	- Paramtre I_FORCE BOOLEAN NOT NULL DEFAULT 0 supprim
	
*/
BEGIN

    -- Test existence et SYSTEM
    /* V 20 : obsolte
    IF (EXISTS (SELECT NAME FROM TDOMPARAM WHERE SECTION=:I_TDOMPARAM_SECTION AND NAME = :I_TDOMPARAM_NAME AND SYSTEM=1) AND I_FORCE !=1) THEN
        EXCEPTION EX_DOMPARAMSYSTEM;
    */

    DELETE FROM TDOMPARAM WHERE SECTION=:I_TDOMPARAM_SECTION AND NAME = :I_TDOMPARAM_NAME;
    
	IF (ROW_COUNT=0) THEN EXCEPTION EX_NODOMPARAM;
    
END ^

ALTER PROCEDURE DEL_FBSERVER (I_TFBSERVER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Suppression logique d'un Serveur Firebirf dans la table correspondante
    
    Paramtres : 
    - I_TFBSERVER_ID : Code serveur Firebird

    Particularits :
    Cette suppression est une suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
        
    Retourne :
    - NEW_STATE : Nouvel tat du proritaire obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppresion" (mise  jour de colonne STATE) impossible

V17 :    
    - Nouvelle Gestion SECTION TDOMPARAM

V31 :
	- Exception spcifique
*/

DECLARE VARIABLE TAGDEL VARCHAR(30);

BEGIN

    /* Serveur existant */
    IF (NOT EXISTS (SELECT ID FROM TFBSERVER WHERE ID=:I_TFBSERVER_ID)) THEN EXCEPTION EX_NOFBSER;

    /* MAJ de la colonne STATE, on ajoute la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('+' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TFBSERVER.ID=' || :I_TFBSERVER_ID,'TFBSERVER','STATE') INTO :NEW_STATE;

    -- Rcupration du paramtre ou init par dfaut
    TAGDEL =COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ') ||
            (SELECT DATE_STRING FROM GET_DATE_STRING(CURRENT_TIMESTAMP)) ||
            COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ');
    UPDATE
        TFBSERVER SET
            NAME = TRIM(TRIM(NAME) || :TAGDEL)
    WHERE ID = :I_TFBSERVER_ID;

    SUSPEND;

    -- NAME trop court pour stocker le tag de suppression
    WHEN GDSCODE arith_except
        DO EXCEPTION EX_DELCOLOVERFLOW;
    
END ^

ALTER PROCEDURE DEL_GEDGROUP (I_TGEDGROUP_ID INTEGER NOT NULL)
AS 
/*
    Suppression physique d'un Groupe d'utilisateur GED

MAJ V 33 :
	- Ajout de suppression TGEDGROUPLIB et UPDATE TGEDUSER
*/

BEGIN

    -- Suppression des records enfants
    DELETE FROM TGEDGROUPUSER WHERE TGEDGROUP_ID=:I_TGEDGROUP_ID;
	DELETE FROM TGEDGROUPLIB WHERE TGEDGROUP_ID=:I_TGEDGROUP_ID;
	-- MAJ Groupes principaux
	UPDATE TGEDUSER SET TGEDGROUP_ID=NULL WHERE TGEDGROUP_ID=:I_TGEDGROUP_ID;

	DELETE FROM TGEDGROUP WHERE ID=:I_TGEDGROUP_ID;

	IF (ROW_COUNT=0) THEN EXCEPTION EX_NOGEDGROUP;

	-- Ne devrait plus arriver depuis V33 car nettoyage "complet" des records enfants...
	WHEN GDSCODE foreign_key DO
		EXCEPTION EX_GEDGROUP_INUSE;

END ^

ALTER PROCEDURE DEL_GEDGROUP_FOR_LIBRARY (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL)
AS 
/*
	Suppression (physique) d'une association Groupde d'Utlisateur GED/Library dans la table TGEDGROUPLIB

    Les STATE des parents NE SONT PAS valus (choix arbitraire)
        
    Retourne :
    - Rien
        
    Attention
    - cette procdure lve des erreurs en cas de "suppression" impossible   

V 32 :
	Cration

*/
BEGIN

	DELETE FROM TGEDGROUPLIB WHERE TLIBRARY_ID=:I_TLIBRARY_ID AND TGEDGROUP_ID=:I_TGEDGROUP_ID;

    IF (ROW_COUNT=0) THEN EXCEPTION EX_NOGEDGROUPLIB;

END ^

ALTER PROCEDURE DEL_GEDPARAM (I_TGEDPARAM_ID INTEGER NOT NULL)
AS 
/*
	Suppression (physique) d'un paramtre GED
	Une erreur est leve si le paramtre est utilis ou inexistant

V13 :
	- MAJ pour exception si GEDPARAM inexistant...
V18 :
	- Force les paramtres NOT NULL En entre...
*/
BEGIN
    DELETE FROM TGEDPARAM WHERE ID = :I_TGEDPARAM_ID;

	IF (ROW_COUNT=0) THEN EXCEPTION EX_NOGEDPARAM;

	WHEN GDSCODE foreign_key DO -- FK Not FOUND (GEDPARAM car PROFILE est test en dbut de PS)
		EXCEPTION EX_GEDPARAM_INUSE;
END ^

ALTER PROCEDURE DEL_GEDPARAMOWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL)
AS 
/*
	Suppression d'un paramtre GED pour un Propritaire

	Les STATE parents ne sont PAS valus (choix arbitraire)

	Une erreur est leve si l'association n'existe pas...

V21 :
    - Cration

V40 :
	- Factorisation TGEDPARAM 
*/

BEGIN

	DELETE FROM TGEDPARAMOWNER WHERE TOWNER_ID=:I_TOWNER_ID AND TGEDPARAM_ID = :I_TGEDPARAM_ID;-- (SELECT ID FROM TGEDPARAM TGP WHERE TGP."SECTION"=:I_TGEDPARAM_SECTION AND TGP."NAME" = :I_TGEDPARAM_NAME);
	IF (ROW_COUNT=0) THEN EXCEPTION EX_NOGEDPARAMOWNER;

END ^

ALTER PROCEDURE DEL_GEDPARAMPROF (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL)
AS 
/*
	Suppression d'un paramtre GED dans un Profil

	Les STATE parents ne sont PAS valus (choix arbitraire)

	Une erreur est leve si l'association n'existe pas...

V40 :
	- Factorisation TGEDPARAM
*/

BEGIN

	DELETE FROM TGEDPARAMPROF WHERE TPROFILE_ID=:I_TPROFILE_ID AND TGEDPARAM_ID=:I_TGEDPARAM_ID ;--(SELECT ID FROM TGEDPARAM TGP WHERE TGP."SECTION"=:I_TGEDPARAM_SECTION AND TGP."NAME" = :I_TGEDPARAM_NAME);

	IF (ROW_COUNT=0) THEN EXCEPTION EX_NOGEDPARAMPROF;

END ^

ALTER PROCEDURE DEL_GEDPARAMUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0)
AS 
/*
	Suppression d'un paramtre GED pour un GEDUSER

	Les STATE parents ne sont PAS valus (choix arbitraire)

	Une erreur est leve si l'association n'existe pas...

V40 :
	- Factorisation TGEDPARAM 
*/

DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);

BEGIN

    IF (I_TLIBRARY_ID = 0) THEN
        DELETE FROM TGEDPARAMUSER 
        WHERE TGEDUSER_ID=:I_TGEDUSER_ID AND TGEDPARAM_ID=:I_TGEDPARAM_ID; -- (SELECT ID FROM TGEDPARAM TGP WHERE TGP."SECTION"=:I_TGEDPARAM_SECTION AND TGP."NAME" = :I_TGEDPARAM_NAME);

    ELSE
        DELETE FROM TGEDPARAMUSER 
        WHERE TGEDUSER_ID=:I_TGEDUSER_ID AND TLIBRARY_ID=:I_TLIBRARY_ID AND TGEDPARAM_ID=:I_TGEDPARAM_ID;  --(SELECT ID FROM TGEDPARAM TGP WHERE TGP."SECTION"=:I_TGEDPARAM_SECTION AND TGP."NAME" = :I_TGEDPARAM_NAME) 


	IF (ROW_COUNT=0) THEN EXCEPTION EX_NOGEDPARAMUSER;

END ^

ALTER PROCEDURE DEL_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Suppression logique d'un utilisateur GED
    
    Paramtres : 
    - I_TGEDUSER_ID : Code Utilisateur GED

    Particularits :
    Cette suppression est une suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
    On ne teste aucun STATE (ni parent, ni enfant), puisqu'on est en train de le mettre  jour...
        
    Retourne :
    - NEW_STATE : Nouvel tat de la bibliothque obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppression" (mise  jour de colonne STATE) impossible

MAJ V12 :
	- GED_LOGIN ==> LOGIN (gestion des tag suppression)
    
V17 :
    - Nouvelle Gestion SECTION TDOMPARAM

V31 :
	- Exception spcifique
	
V34 :
    - MAJ TPROFILE.NAME avec TIMESTAMP pour pouvoir recrer un profil avec le nom "libr"
*/
BEGIN
    /* Utilisateur GED existante */
    IF (NOT EXISTS (SELECT ID FROM TGEDUSER WHERE ID=:I_TGEDUSER_ID)) THEN EXCEPTION EX_NOGEDUSER;    
    
    /* MAJ de la colonne STATE, on ajoute la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('+' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TGEDUSER.ID=' || :I_TGEDUSER_ID,'TGEDUSER','STATE') INTO :NEW_STATE;

    /* MAJ du login du geduser pour marquage avec la date de suppression */
    UPDATE TGEDUSER SET LOGIN = TRIM(LOGIN || 
        -- Rcupration du paramtre ou init par dfaut
        COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ') ||
        (SELECT DATE_STRING FROM GET_DATE_STRING(CURRENT_TIMESTAMP)) || 
        COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ')
		)
    WHERE ID = :I_TGEDUSER_ID;

    -- Ajout V34
    UPDATE TPROFILE SET "NAME" = TRIM("NAME" || 
        -- Rcupration du paramtre ou init par dfaut
        COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ') ||
        (SELECT DATE_STRING FROM GET_DATE_STRING(CURRENT_TIMESTAMP)) || 
        COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ')
		)
    WHERE TGEDUSER_ID = :I_TGEDUSER_ID;
    
    SUSPEND;

	-- LOGIN trop court pour stocker le tag de suppression
    WHEN GDSCODE arith_except
        DO EXCEPTION EX_DELCOLOVERFLOW;
    
END ^

ALTER PROCEDURE DEL_GEDUSER_FOR_GEDGROUP (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDGROUP_ID INTEGER NOT NULL)
AS 
/*
	Suppression (physique) d'une association Utlisateur GED/Groupe GED

    Les STATE des parents NE SONT PAS valus (choix arbitraire)
        
    Retourne :
    - Rien
        
    Attention
    - cette procdure lve des erreurs en cas de "suppression" impossible   
*/
BEGIN

	DELETE FROM TGEDGROUPUSER WHERE TGEDGROUP_ID=:I_TGEDGROUP_ID AND TGEDUSER_ID=:I_TGEDUSER_ID;

    IF (ROW_COUNT=0) THEN EXCEPTION EX_NOGEDGROUPUSER;

END ^

ALTER PROCEDURE DEL_GEDUSER_FOR_LIBRARY (I_TGEDUSER_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL)
AS 
/*
	Suppression (physique) d'une association Utlisateur GED/Library dans la table TGEDUSERLIB

    Les STATE des parents NE SONT PAS valus (choix arbitraire)
        
    Retourne :
    - Rien
        
    Attention
    - cette procdure lve des erreurs en cas de "suppression" impossible   
*/
BEGIN

	DELETE FROM TGEDUSERLIB WHERE TLIBRARY_ID=:I_TLIBRARY_ID AND TGEDUSER_ID=:I_TGEDUSER_ID;

    IF (ROW_COUNT=0) THEN EXCEPTION EX_NOGEDUSERLIB;

END ^

ALTER PROCEDURE DEL_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Suppression logique d'une bibliothque dans la table correspondante
    
    Paramtres : 
    - I_TLIBRARY_ID : Code bibliothque

    Particularits :
    Cette suppression est une suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
    On ne teste aucun STATE (ni parent, ni enfant), puisqu'on est en train de le mettre  jour...
        
    Retourne :
    - NEW_STATE : Nouvel tat de la bibliothque obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppression" (mise  jour de colonne STATE) impossible
    
V17 :
    - Nouvelle Gestion SECTION TDOMPARAM

V31 :
	- Exception spcifique

V34
    - MAJ TPROFILE.NAME avec TIMESTAMP pour pouvoir recrer un profil avec le nom "libr"

*/

BEGIN

    /* Library existante */
    IF (NOT EXISTS (SELECT ID FROM TLIBRARY WHERE ID=:I_TLIBRARY_ID)) THEN EXCEPTION EX_NOLIB;    
    
    /* MAJ de la colonne STATE, on ajoute la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('+' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TLIBRARY.ID=' || :I_TLIBRARY_ID,'TLIBRARY','STATE') INTO :NEW_STATE;
    /* MAJ du title de la library pour marquage avec la date de suppression (Unicit TONWER_ID+TITLE) */
    UPDATE TLIBRARY SET TITLE = TRIM(TITLE || 
        -- Rcupration du paramtre ou init par dfaut
        COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ') ||
        (SELECT DATE_STRING FROM GET_DATE_STRING(CURRENT_TIMESTAMP)) || 
        COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ')
		)
    WHERE ID = :I_TLIBRARY_ID;
    
    -- Ajout V34
    UPDATE TPROFILE SET "NAME" = TRIM("NAME" || 
        -- Rcupration du paramtre ou init par dfaut
        COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ') ||
        (SELECT DATE_STRING FROM GET_DATE_STRING(CURRENT_TIMESTAMP)) || 
        COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ')
		)
    WHERE  TLIBRARY_ID = :I_TLIBRARY_ID;
    
    SUSPEND;

	-- TITLE trop court pour stocker le tag de suppression
    WHEN GDSCODE arith_except
        DO EXCEPTION EX_DELCOLOVERFLOW;
    
END ^

ALTER PROCEDURE DEL_OWNER (I_TOWNER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Suppression logique d'un propritaire dans la table correspondante
   
    Paramtres :
    - I_TOWNER_ID : Code propritaire

    Particularits :
    Cette suppression est une suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
       
    Retourne :
    - NEW_STATE : Nouvel tat du proritaire obtenu aprs suppression logique
       
    Attention
    - cette procdure lve des erreurs en cas de "suppresion" (mise  jour de colonne STATE) impossible
   
MAJ V12 :
	- DOM_LOGIN ==> LOGIN (gestion des tag suppression)

V17 :
    - Nouvelle Gestion SECTION TDOMPARAM

V31 :
	- Exception spcifique
*/

DECLARE VARIABLE TAGDEL VARCHAR(30);

BEGIN

    /* Owner existant */
    IF (NOT EXISTS (SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN EXCEPTION EX_NOOWNER;
   
    /* MAJ de la colonne STATE, on ajoute la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('+' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TOWNER.ID=' || :I_TOWNER_ID,'TOWNER','STATE') INTO :NEW_STATE;
   
    -- Rcupration du paramtre ou init par dfaut
    TAGDEL =COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ') ||
            (SELECT DATE_STRING FROM GET_DATE_STRING(CURRENT_TIMESTAMP)) ||
            COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','SEP_TM_DELETED')),' ### ');

    UPDATE
        TOWNER SET
            LOGIN = TRIM(TRIM(LOGIN) || :TAGDEL),
            SUBDOMAIN = TRIM(TRIM(SUBDOMAIN) || :TAGDEL),
            EXTERNAL_ID = TRIM(TRIM(COALESCE(EXTERNAL_ID,'')) || :TAGDEL)
    WHERE ID = :I_TOWNER_ID;

    SUSPEND;

    -- LOGIN trop court pour stocker le tag de suppression
    WHEN GDSCODE arith_except
        DO EXCEPTION EX_DELCOLOVERFLOW;
END ^

ALTER PROCEDURE DEL_PROFILE (I_TPROFILE_ID INTEGER NOT NULL)
AS 
/*
    Suppression (physique ==> Pas de STATE...) d'un Profil
V18 :
	- Force les paramtres NOT NULL En entre...
*/

BEGIN
    -- Suppression des records enfants dans TGEDPARAMPROF
    DELETE FROM TGEDPARAMPROF WHERE TPROFILE_ID = :I_TPROFILE_ID;

	DELETE FROM TPROFILE WHERE ID = :I_TPROFILE_ID;

	IF (ROW_COUNT=0) THEN EXCEPTION EX_NOPROFILE;

	WHEN GDSCODE foreign_key DO
		EXCEPTION EX_PROFILE_INUSE;
END ^

ALTER PROCEDURE DEL_STORAGES (I_TOWNER_ID INTEGER NOT NULL,
I_TSTORAGE_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TSTORAGE_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
/*
	Suppression de paramtre(s) TSTORAGE

	Si TLIBRARY_ID et/ou TGEDUSER_ID est pass, on ne vrifie pas qu'il(s) corresponde(nt) au OWNER_ID...
	Les STATES OWNER/GEDUSER/LIBRARY ne sont PAS values par cette procdure...
	On pratique par filtage successif sur les paramtres passs, DANS l'ORDRE de l'index "STORAGE_UNI" (pour l'accrocher)
	TODO :
		Revoir les index car si TOWNER et/ou SECTION/NAME non passe(s) on n'accroche pas l'index TSTORAGE_UNI
		Prvoi rdes index additionnels sur SECTION/NAME ?
	
	

V40 :
	- Cration

*/

DECLARE VARIABLE NULL_PARAM INTEGER;

DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE COUNT_DEL INTEGER;

BEGIN

    -- OWNER obligatoire si GEDUSER/LIBRARY non fourni
    IF (:I_TOWNER_ID=0 AND :I_TSTORAGE_TGEDUSER_ID<=0 AND I_TSTORAGE_TLIBRARY_ID<=0) THEN
        EXCEPTION EX_BAD_PARAM;
    
    -- dummy WHERE pour OWNER_ID non pass...
    -- Dans ce cas, on n'accroche pas l'index :-(
    SQL_WHERE=IIF(:I_TOWNER_ID!=0,'TOWNER_ID=' || :I_TOWNER_ID,'1=1');
        
    I_TSTORAGE_NAME = TRIM(:I_TSTORAGE_NAME);
    I_TSTORAGE_SECTION = TRIM(:I_TSTORAGE_SECTION);
    
    SQL_WHERE=:SQL_WHERE || IIF(:I_TSTORAGE_SECTION!='',' AND SECTION=''' || :I_TSTORAGE_SECTION ||'''','');
    
    SQL_WHERE=:SQL_WHERE || IIF(:I_TSTORAGE_NAME!='',' AND "NAME"=''' || :I_TSTORAGE_NAME ||'''','');

	-- Rcupration du DOM_PARAM reprsentant la recherche de valeur NULL
	NULL_PARAM=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','PARAM_EQUIV_NULL')),-9);
    
    IF (:I_TSTORAGE_TGEDUSER_ID!=0) THEN
        SQL_WHERE=:SQL_WHERE || ' AND TGEDUSER_ID' || IIF(:I_TSTORAGE_TGEDUSER_ID=NULL_PARAM,' IS NULL', '=' || :I_TSTORAGE_TGEDUSER_ID);
    
    IF (:I_TSTORAGE_TLIBRARY_ID!=0) THEN
        SQL_WHERE=:SQL_WHERE || ' AND TLIBRARY_ID' || IIF(:I_TSTORAGE_TLIBRARY_ID=NULL_PARAM,' IS NULL', '=' || :I_TSTORAGE_TLIBRARY_ID);
        
    EXECUTE STATEMENT 'SELECT COUNT(TOWNER_ID) FROM TSTORAGE WHERE ' || :SQL_WHERE INTO COUNT_DEL;
    IF (:COUNT_DEL=0) THEN EXCEPTION EX_NOSTORAGE;
    
    EXECUTE STATEMENT 'DELETE FROM TSTORAGE WHERE ' || :SQL_WHERE;

        
END ^

ALTER PROCEDURE GET_ALL_LIBRARIES_FOR_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_WITH_DUPLICATE BOOLEAN NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_ORIGIN SMALLINT,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
GEDUSER_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
Cration V32 :
	- Ajout de ORDER + Tri sur ORDER...
	- Ajout GEDGROUP_ID
	- On renvoi les libs directement associes  un utilisateur + les Libs associes aux groupes de l'utilisateur
	- Ajout de colonne LIBRARY_ORIGIN = 0 : sans doublons donc origine idem dans les 2 cas, 1 =GEDUSER; 2=GEDGROUP

- V34
    - GEDGROUP_ID => GEDUSER_GEDGROUP_ID en sortie (clarification paramtre)
    
- V 36
    - LIBRARY_SIZE_MB_ORG en sortie

-V40
	GUID VARCHAR(40) => VARCHAR(255)
	Ajout TLIBRARY.VERSION
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
DECLARE VARIABLE GROUP_ID INTEGER;
BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDUSER = '';
	ID_OK = Null;


    /* Owner utilisable outrepassable... */
	/* Mme OWNER pour TLIBRARY et TPROFILE */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    -- Utilisateur GED 
    IF (I_TGEDUSER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 


    /*
        Existence/visibilit de l'utilisateur GED lui-mme et ses parents
        On en profite pour rcuprer le GROUP_ID du GEDUSER
    
    */
    EXECUTE STATEMENT '
        SELECT TGEDUSER.ID, COALESCE(TGEDUSER.TGEDGROUP_ID,0), COALESCE(TGEDUSER.STATE,0)
		FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '')
        INTO :ID_OK, :GROUP_ID, :GEDUSER_STATE;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

	/* Recherche des Bibliothques Utilisateurs*/
	FOR EXECUTE STATEMENT '
        SELECT
			-- Ajout V32
            COALESCE(TLIBRARY.LISTORDER,0),

            COALESCE(TLIBRARY.TITLE,''''),

			TGEDUSERLIB.TGEDUSER_ID,
			TGEDUSER.TGEDGROUP_ID,
			TGEDUSERLIB.TLIBRARY_ID,
			' || IIF (:I_WITH_DUPLICATE = 0, '0', '1') || ', -- ORIGIN GEDUSERLIB...
			' || IIF (:I_WITH_DUPLICATE = 0, '0', 'COALESCE(TGEDUSERLIB.TPROFILE_ID,0)') || ',
			TGEDUSER.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			TLIBRARY.STATE,
			TGEDUSER.STATE,
            TOWNER.STATE,
			COALESCE(TFBSERVER.STATE,0),
			
            COALESCE(TLIBRARY."COMMENT",''''),
			COALESCE((SELECT LIBRARY_CONNECT FROM GET_LIBRARY_CONNECT(TLIBRARY.ID)),'''') AS PATH,
            COALESCE(TLIBRARY.GUID, ''''),
            COALESCE(TLIBRARY.VERSION, 0),
            COALESCE(TLIBRARY.DBPATH,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_END)),
			TLIBRARY.ACCESS_MODE,
            COALESCE(TLIBRARY.ACCESS_TYPE,0),
            TLIBRARY.CHARGEABLE,
            COALESCE(TLIBRARY.SIZE_MB,0),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.LAST_SIZE_CHECK)),
            COALESCE(TLIBRARY.SIZE_MB_ORG,0),

            -- Ajout V25
            COALESCE(TLIBRARY.TLOGSYNC_ID,0)
           			
		FROM TGEDUSERLIB INNER JOIN TGEDUSER ON TGEDUSERLIB.TGEDUSER_ID=TGEDUSER.ID
            INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
            INNER JOIN TLIBRARY  ON TGEDUSERLIB.TLIBRARY_ID=TLIBRARY.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TGEDUSERLIB.TGEDUSER_ID=' || :I_TGEDUSER_ID || 
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') || '
        UNION
		SELECT 
            -- Ajout V32
            COALESCE(TLIBRARY.LISTORDER,0),

            COALESCE(TLIBRARY.TITLE,''''),

            ' || :I_TGEDUSER_ID || ',
			TGEDGROUPLIB.TGEDGROUP_ID,
			TGEDGROUPLIB.TLIBRARY_ID,
			' || IIF (:I_WITH_DUPLICATE = 0, '0', '2') || ', -- ORIGIN GEDGROUPLIB...
			' || IIF (:I_WITH_DUPLICATE = 0, '0', 'COALESCE(TGEDGROUPLIB.TPROFILE_ID,0)') || ',
			TLIBRARY.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			TLIBRARY.STATE,
			' || :GEDUSER_STATE || ',
            TOWNER.STATE,
			COALESCE(TFBSERVER.STATE,0),
			
            COALESCE(TLIBRARY."COMMENT",''''),
			COALESCE((SELECT LIBRARY_CONNECT FROM GET_LIBRARY_CONNECT(TLIBRARY.ID)),'''') AS PATH,
            COALESCE(TLIBRARY.GUID, ''''),
            COALESCE(TLIBRARY.VERSION, 0),
            COALESCE(TLIBRARY.DBPATH,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_END)),
			TLIBRARY.ACCESS_MODE,
            COALESCE(TLIBRARY.ACCESS_TYPE,0),
            TLIBRARY.CHARGEABLE,
            COALESCE(TLIBRARY.SIZE_MB,0),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.LAST_SIZE_CHECK)),
            COALESCE(TLIBRARY.SIZE_MB_ORG,0),

            -- Ajout V25
            COALESCE(TLIBRARY.TLOGSYNC_ID,0)
  			
		FROM TGEDGROUPLIB INNER JOIN TGEDGROUP ON TGEDGROUPLIB.TGEDGROUP_ID=TGEDGROUP.ID
            INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
            INNER JOIN TLIBRARY  ON TGEDGROUPLIB.TLIBRARY_ID=TLIBRARY.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TGEDGROUPLIB.TGEDGROUP_ID=' || :GROUP_ID || 
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') || '
        
		-- MAJ v32
        ORDER BY 1,2'
		INTO
            -- Ajout en V32
            :LIBRARY_LISTORDER,

            :LIBRARY_TITLE,
			:GEDUSER_ID,
			:GEDUSER_GEDGROUP_ID,
			:LIBRARY_ID,
			:LIBRARY_ORIGIN,
			:PROFILE_ID,
			:OWNER_ID,
			:FBSERVER_ID,
			:LIBRARY_STATE,
			:GEDUSER_STATE,
			:OWNER_STATE,
			:FBSERVER_STATE,
			-- Ajouts en version 22
            :LIBRARY_COMMENT,
            :LIBRARY_CONNECT,
            :LIBRARY_GUID,
            :LIBRARY_VERSION,
            :LIBRARY_DBPATH,
            :LIBRARY_CREATE_DATE,
            :LIBRARY_MODIF_DATE,
            :LIBRARY_SUBSCRIBE_START,
            :LIBRARY_SUBSCRIBE_END,
            -- Ajout V31
			:LIBRARY_ACCESS_MODE,
            :LIBRARY_ACCESS_TYPE,
            :LIBRARY_CHARGEABLE,
            :LIBRARY_SIZE_MB,
            :LIBRARY_LAST_SIZE_CHECK,
            :LIBRARY_SIZE_MB_ORG,
            -- Ajout en V25
            :LOGSYNC_ID
			
	DO
	BEGIN
        SELECT LOGSYNCS_INFOS FROM GET_LASTSYNC_MDF(:LIBRARY_ID) INTO :LASTSYNC_INFOS;	
		SUSPEND;
    END
END ^

ALTER PROCEDURE GET_ALTER_STATE_OK (I_TARGETED_COLUMN VARCHAR(1000) CHARACTER SET UTF8 NOT NULL)
RETURNS (SQL_WHERE_DEFAULT_ALTER VARCHAR(255) CHARACTER SET UTF8)
AS 
/*
    Cette procdure renvoie un critre de modification des enregistrements par rapport  une colonne STATE
    Rappel : Les procdures stockes de mise  jour permettent de modifier cet tat par dfaut par l'intermdiaire d'un paramtre formel, le cas chant
    
	Paramtres : I_TARGETED_COLUMN : Nom (pleinement qualifi recommand) d'une colonne (par exemple "TOWNER.STATE")
	Aucun contrle de validation n'est effectu par rapport  ce paramtre (pas de recherche de colonne prsente par exemple)

    On utilise deux paramtres du domaine (DOM_RECORD_ALTER_KO et ADM_RECORDS_ALTER_KO) afin de connaitre les tats NE PERMETTANT PAS la modification.
        - Le premier est rattach  l'application (et ne devrait pas tre modifi par d'autres personnes que les programmeurs)
        - Le second est laiss  la discrtion de l'administrateur de site afin qu'il gre ces propres tats de non modification
        - La valeur de ce second paramtre est ajout  la valeur du premier afin de dterminer, finalement, quels sont les enregistrements visibles ou pas...
    
    Ces paramtres doivent indiquer les combinaisons d'tat ne permettant pas une modification, par exemple :
    - DOM_RECORDS_ALTER_KO = 1
        ==> seuls les enregistrements STATE ne contenant pas 1 sont modifiables (valeur par dfaut)
    - ADM_RECORD_ALTER_KO = 1 (inutile car cet tat est dja considr comme inaltrable par dfaut dans DOM_RECORDS_ALTER_KO)
    - DOM_RECORD_ALTER_KO = 6 ==> seuls les enregistrements STATE = 0 ou tat ne contient pas 1 (DOM_RECORDS_ALTER_KO) ou tat ne contient pas 2 ou tat ne contient pas 4 sont modifiables
        (attention, ce n'est pas la valeur atomique de la colonne qui est prise en compte, mais le ou les tats prsents ou non dans cette colonne)

V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/
DECLARE VARIABLE STATE_TEST STATE;
BEGIN
    /* Ensemble d'tats considrs comme devant toujours tre inaltrables 
    Si le paramtre DOM_RECORDS_ALTER_KO n'est pas trouv, on essai avec (au moins) le paramtres des enregistrements supprim (DOM_RECORD_DELETED)
    Si aucun des paramtres n'est disponible, on init en dur  1
    */
    STATE_TEST=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','RECORDS_ALTER_KO')),
        (SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')),1);
    /* Init des tats Admin  tester */
    STATE_TEST=BIN_OR(:STATE_TEST,COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('ADMIN','RECORDS_ALTER_KO')),0)); 
    
    /*
    On compare la colonne par rapport au paramtre en ajoutant les tats considrs comme devant tre TOUJOURS masqus
    */
    SQL_WHERE_DEFAULT_ALTER =  'BIN_AND(' || :I_TARGETED_COLUMN || ',' || :STATE_TEST || ')=0';
    
    SUSPEND;
    
END ^

ALTER PROCEDURE GET_CONTACTS (I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTACT_ID INTEGER,
OWNER_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_STATE STATE,
OWNER_STATE STATE)
AS 
/*
	Renvoie la liste des informations dtailles de tous les contacts
	
MAJ :
	v12 : ORDER BY NAME

MAJ V32 :
	- Ajout de ORGANIZATION, etc...
*/
DECLARE VARIABLE SQL_WHERE_CONTACT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);

BEGIN

    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

    SQL_WHERE_CONTACT = '';
    SQL_WHERE_OWNER = '' ;

    IF (I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 
        
    IF (I_TCONTACT_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE_CONTACT;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE_CONTACT; 


	/* Recherche des contacts */
	FOR EXECUTE STATEMENT '
		SELECT
			TCONTACT.ID,
			TCONTACT.TOWNER_ID,
			TCONTACT.NAME,
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),

			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),

            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			TOWNER.STATE,
			TCONTACT.STATE
        FROM TCONTACT INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID '
        -- WHERE "bidon" pour simplification des critres suivants (AND...)
		|| ' WHERE (1=1) ' || 
		IIF (:SQL_WHERE_CONTACT != '' , ' AND ' || :SQL_WHERE_CONTACT, '') ||
		IIF (:SQL_WHERE_OWNER != '' , ' AND ' || :SQL_WHERE_OWNER, '')
		|| 'ORDER BY TCONTACT.NAME'
		INTO
			:CONTACT_ID,
			:OWNER_ID,
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			:OWNER_STATE,
			:CONTACT_STATE 
	DO
    BEGIN
        SUSPEND;
    END

END ^

ALTER PROCEDURE GET_CONTACTS_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TCONTACT_ALL BOOLEAN NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
/*
    Renvoie la liste des contacts associs  un propritaire

    Il est possible qu'il y en ai aucune (pas de contacts visibles/actifs pour 1 propritaire donn)
    ==> recordset vide

    Attend :
    - I_TOWNER_ID : un code numrique identifiant de propritaire (FK TOWNER)
    - OWNER_STATE : Etat particulier du owner (0 ==> actif par dfaut)
    - I_TCONTACT_STATE : Etat particulier de contact (0 ==> actif par dfaut)

V17 :
    - Gestion CONTACT PRIINCIPAL
    
V 22
    - Ajout des informations dtailles contact

MAJ V 24 :
    - CONTTYPES_INFOS renvoy en tant que BLOB

MAJ V32 :
	- Ajout de ORGANIZATION, etc...

MAJ V34
	- Optimisation de la requte sous jacente pour traitement de I_TCONTACT_ALL

*/
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;
DECLARE CONT_ID Integer;

BEGIN
  
    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

    /* construction des WHERE */
    SQL_WHERE = '';
    ID_OK = Null;

    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE;

    EXECUTE STATEMENT '
        SELECT ID,TCONTACT_ID FROM TOWNER
        WHERE ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE != '' , ' AND (' || :SQL_WHERE || ')', '')
        INTO ID_OK, CONT_ID;
      
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;


    SQL_WHERE = '';

    IF (:I_TCONTACT_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE;

    -- On exclu les contacts principaux OWNER/GEDUSER dans ce cas
    IF (I_TCONTACT_ALL != 1) THEN
        SQL_WHERE=:SQL_WHERE || IIF (:SQL_WHERE != '',' AND ','') ||
            IIF (:CONT_ID IS NOT NULL, '(TCONTACT.ID != ' || :CONT_ID || ') AND ','') ||
			-- V34 Dans ce cas le LEFT JOIN est plus performant que la sous-requte (voir aussi le FROM plus bas...)
            --'(TCONTACT.ID NOT IN (SELECT TCONTACT_ID FROM TGEDUSER WHERE TGEDUSER.TOWNER_ID=' || :I_TOWNER_ID || ' AND TCONTACT_ID IS NOT NULL))';
            'TGEDUSER.TCONTACT_ID IS NULL';


      
    /* Recherche des contacts */
    FOR EXECUTE STATEMENT '
        SELECT
            TCONTACT.ID,
            TCONTACT.STATE,
            TCONTACT.TOWNER_ID,
            TOWNER.STATE,
            
			COALESCE(TCONTACT.NAME,''''),
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),
			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE))
            

        FROM TCONTACT
			-- Ajout en V34 (gain de perf sur le filtrage des contacts principaux)
            LEFT OUTER JOIN TGEDUSER ON TCONTACT.ID =TGEDUSER.TCONTACT_ID
            INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
        WHERE
            TCONTACT.TOWNER_ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE != '' , ' AND ' || :SQL_WHERE, '')
        INTO
            :CONTACT_ID,
            :CONTACT_STATE,
            :OWNER_ID,
            :OWNER_STATE,
			-- Ajout V22
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE
            
    DO
    BEGIN
        SELECT CONTTYPES_INFOS FROM GET_CONTTYPE_MDF(:CONTACT_ID) INTO :CONTTYPES_INFOS;
        SUSPEND;
    END
END ^

ALTER PROCEDURE GET_CONTACTS_TYPES_FOR_CONTACT (I_TCONTACT_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTACT_ID INTEGER,
OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
CONTTYPE_ID INTEGER,
CONTLIB_SYNC_SENDMAIL SYNC_MAIL,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8,
FBSERVER_ID INTEGER,
CONTACT_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
    Renvoie l'ensemble des "utilisations" d'un contact (dans TCONTLIB et TCONTOWNER)
    Il s'agit donc d'une UNION...
    
V17 :
    - Cration...

V19 :
	- Correction STATE OWNER erron en entre
    
*/

DECLARE VARIABLE SQL_WHERE_CONTACT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

    /* construction des WHERE */
    SQL_WHERE_CONTACT = '';
    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';

	ID_OK = Null;

    IF (:I_TFBSERVER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER; 

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    IF (:I_TLIBRARY_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    IF (:I_TCONTACT_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE_CONTACT;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE_CONTACT; 

    /* Existence/visibilit du contact demand (lui-mme ou son OWNER)*/
    EXECUTE STATEMENT '
        SELECT TCONTACT.ID
		FROM TCONTACT
            INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
        WHERE TCONTACT.ID=' || :I_TCONTACT_ID ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_CONTACT != '' ,' AND ' || :SQL_WHERE_CONTACT, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOCONTACT;

	/* Recherche des contacts */
	FOR EXECUTE STATEMENT '
        SELECT
            TCONTACT.ID,
            TCONTACT.TOWNER_ID,
            TCONTLIB.TLIBRARY_ID,
            TCONTLIB.TCONTTYPE_ID,
            TCONTLIB.SYNC_SENDMAIL,
            COALESCE(TLIBRARY.TITLE,''''),
            TCONTTYPE.NAME,
            COALESCE(TFBSERVER.ID,0),
            TCONTACT.STATE,
            TOWNER.STATE,
            TLIBRARY.STATE,
            COALESCE(TFBSERVER.STATE,0)
        FROM TCONTACT
            INNER JOIN TCONTLIB ON TCONTACT.ID=TCONTLIB.TCONTACT_ID
                INNER JOIN TCONTTYPE ON TCONTLIB.TCONTTYPE_ID=TCONTTYPE.ID
            INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
            INNER JOIN TLIBRARY  ON TCONTLIB.TLIBRARY_ID=TLIBRARY.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TCONTACT.ID=' || I_TCONTACT_ID || 
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_LIB != '' ,' AND (' || :SQL_WHERE_LIB || ' OR TLIBRARY.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_CONTACT != '' ,' AND ' || :SQL_WHERE_CONTACT, '')
        || '
        
        UNION
        SELECT
            TCONTACT.ID,
            TCONTACT.TOWNER_ID,
            0,
            TCONTOWNER.TCONTTYPE_ID,
            0,
            '''',
            TCONTTYPE.NAME,
            0,
            TCONTACT.STATE,
            TOWNER.STATE,
            0,
            0
        FROM TCONTACT
            INNER JOIN TCONTOWNER ON TCONTACT.ID=TCONTOWNER.TCONTACT_ID
                INNER JOIN TCONTTYPE ON TCONTOWNER.TCONTTYPE_ID=TCONTTYPE.ID
            INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
        WHERE TCONTACT.ID=' || I_TCONTACT_ID || 
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_CONTACT != '' ,' AND ' || :SQL_WHERE_CONTACT, '')
        || ' ORDER BY 3;
        '
		INTO
			:CONTACT_ID,
			:OWNER_ID,
			:LIBRARY_ID,
			:CONTTYPE_ID , 
            :CONTLIB_SYNC_SENDMAIL,
            :LIBRARY_TITLE,
            :CONTTYPE_NAME,
            :FBSERVER_ID,
            :CONTACT_STATE,
            :OWNER_STATE,
            :LIBRARY_STATE,
            :FBSERVER_STATE
	DO
		SUSPEND;
END ^

ALTER PROCEDURE GET_CONTACTS_TYPES_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPE_ID INTEGER,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTLIB_SYNC_SENDMAIL SYNC_MAIL,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
CONTACT_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie la liste des contacts associes  une bibliothque
	
	Il est possible qu'il y en ai aucune (pas de librairie visible/active pour 1 bibliothque donne)
	==> recordset vide

	Attend :
	- I_TLIBRARY_ID : un code numrique identCREATE OR ALTER PROCEDURE GET_CONTACT_INFOS (identifiant de bibliothque
	- I_TLIBRARY_STATE : Etat particulier du bibliothque (0 ==> actif par dfaut)
	- I_TCONTACT_STATE : Etat particulier de contact (0 ==> actif par dfaut)
	
MAJ :
	V15 : ajout de TCONTLIB_SYNC_SENDMAIL

MAJ V22:
    - Ajout dtail CONTACT + CONTTYPE pour amliorations performances NAS

MAJ V32 :
	- Ajout de ORGANIZATION, etc...

*/
DECLARE VARIABLE SQL_WHERE_CONTACT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

    /* construction des WHERE */
    SQL_WHERE_CONTACT = '';
    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';

	ID_OK = Null;

    IF (:I_TFBSERVER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER; 

    IF (SQL_WHERE_OWNER = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    IF (I_TLIBRARY_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;
    
    IF (I_TCONTACT_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE_CONTACT;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE_CONTACT; 

	/* Recherche des contacts */
	FOR EXECUTE STATEMENT '
		SELECT
			TCONTACT.ID,
			
			-- Ajout V22
			TCONTACT.NAME,
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),
			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			
			TCONTACT.STATE,
			TCONTLIB.TCONTTYPE_ID,

			-- Ajout V22
			TCONTTYPE.NAME,
			
			TCONTLIB.SYNC_SENDMAIL,
			TCONTLIB.TLIBRARY_ID,
			TLIBRARY.STATE,
			TCONTACT.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			COALESCE(TFBSERVER.STATE,0),
            TOWNER.STATE
		FROM TCONTACT
            INNER JOIN TCONTLIB ON TCONTACT.ID=TCONTLIB.TCONTACT_ID
                INNER JOIN TCONTTYPE ON TCONTLIB.TCONTTYPE_ID=TCONTTYPE.ID
                INNER JOIN TLIBRARY  ON TCONTLIB.TLIBRARY_ID=TLIBRARY.ID
                    LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
		WHERE
			TCONTLIB.TLIBRARY_ID=' || :I_TLIBRARY_ID ||
			IIF (:SQL_WHERE_OWNER != '' , ' AND ' || :SQL_WHERE_OWNER, '') || 
            IIF (:SQL_WHERE_CONTACT != '' , ' AND ' || :SQL_WHERE_CONTACT, '') || 
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
        'ORDER BY TCONTACT.NAME;'
		INTO
			:CONTACT_ID,
			-- Ajout V22
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,
            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			
			:CONTACT_STATE,
			:CONTTYPE_ID, 
			
			-- Ajout V22
			:CONTTYPE_NAME,
			
			:CONTLIB_SYNC_SENDMAIL,
			:LIBRARY_ID,
			:LIBRARY_STATE,
			:OWNER_ID,
			:FBSERVER_ID,
			:FBSERVER_STATE,
			:OWNER_STATE
	DO
		SUSPEND;
END ^

ALTER PROCEDURE GET_CONTACTS_TYPES_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPE_ID INTEGER,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
/*
	Renvoie la liste des contacts par types associs  un propritaire

	Il est possible qu'il y en ai aucune (pas de contacts visibles/actifs pour 1 propritaire donn)
	==> recordset vide
	Il est possible qu'il y ait des doublons (CONTACTTYPE)

	Attend :
	- I_TOWNER_ID : un code numrique identifiant de propritaire (FK TOWNER)
	- OWNER_STATE : Etat particulier du owner (0 ==> actif par dfaut)
	- I_TCONTACT_STATE : Etat particulier de contact (0 ==> actif par dfaut)

MAJ V22:
    - Ajout dtail CONTACT + CONTTYPE pour amliorations performances NAS
	
MAJ V32 :
	- Ajout de ORGANIZATION, etc...

*/
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    

BEGIN
    
    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

    /* construction des WHERE */
    SQL_WHERE = '';
	ID_OK = Null;

    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE != '' , ' AND (' || :SQL_WHERE || ')', '')
        INTO ID_OK;
        
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;


    SQL_WHERE = '';

    IF (:I_TCONTACT_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE; 

	/* Recherche des contacts */
	FOR EXECUTE STATEMENT '
		SELECT
			TCONTACT.ID,
			
			-- Ajout V22
			TCONTACT.NAME,
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),
			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			
			TCONTOWNER.TCONTTYPE_ID,
			
			-- Ajout V22
			TCONTTYPE.NAME,

			TCONTACT.STATE,
			TCONTACT.TOWNER_ID,
			TOWNER.STATE

		FROM TCONTACT
            INNER JOIN TCONTOWNER ON TCONTACT.ID=TCONTOWNER.TCONTACT_ID
                INNER JOIN TCONTTYPE ON TCONTOWNER.TCONTTYPE_ID=TCONTTYPE.ID
        INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
		WHERE
			TCONTACT.TOWNER_ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE != '' , ' AND ' || :SQL_WHERE, '') 
		INTO
			:CONTACT_ID,
			-- Ajout V22
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			
			:CONTTYPE_ID,
            -- Ajout V22
			:CONTTYPE_NAME,
			
            :CONTACT_STATE,
			:OWNER_ID,
			:OWNER_STATE 
	DO
		SUSPEND;
END ^

ALTER PROCEDURE GET_CONTACT_INFOS (I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTACT_ID INTEGER,
OWNER_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_STATE STATE,
OWNER_STATE STATE)
AS 
/*
	Renvoie les informations dtailles d'un contact
	
MAJ V32 :
	- Ajout de ORGANIZATION, etc...

*/
DECLARE VARIABLE SQL_WHERE_CONTACT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE REC_FOUND INTEGER;

BEGIN

    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

    REC_FOUND=0;

    SQL_WHERE_CONTACT = '';
    SQL_WHERE_OWNER = '' ;

    IF (I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 
        
    IF (I_TCONTACT_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE_CONTACT;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE_CONTACT; 


	/* Recherche des contacts */
	FOR EXECUTE STATEMENT '
		SELECT
			TCONTACT.ID,
			TCONTACT.TOWNER_ID,
			TCONTACT.NAME,
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),
			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			TOWNER.STATE,
			TCONTACT.STATE
        FROM TCONTACT INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
		WHERE TCONTACT.ID=' || :I_TCONTACT_ID || 
		IIF (:SQL_WHERE_CONTACT != '' , ' AND ' || :SQL_WHERE_CONTACT, '') ||
		IIF (:SQL_WHERE_OWNER != '' , ' AND ' || :SQL_WHERE_OWNER, '')
		INTO
			:CONTACT_ID,
			:OWNER_ID,
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			:OWNER_STATE,
			:CONTACT_STATE 
	DO
    BEGIN
        REC_FOUND=:REC_FOUND+1;
        SUSPEND;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOCONTACT;
END ^

ALTER PROCEDURE GET_CONTACT_TYPE_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
CONTACT_ID INTEGER,
CONTTYPE_ID INTEGER,
CONTLIB_SYNC_SENDMAIL SYNC_MAIL,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
CONTACT_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie un contact associ  une bibliothque
	
	Il est possible qu'il y en ai aucune (pas de librairie visible/active pour 1 bibliothque donne)
	==> Error

	Attend :
	- I_TLIBRARY_ID : un code numrique identCREATE OR ALTER PROCEDURE GET_CONTACT_INFOS (identifiant de bibliothque
	- I_TLIBRARY_STATE : Etat particulier du bibliothque (0 ==> actif par dfaut)
	- I_TCONTACT_STATE : Etat particulier de contact (0 ==> actif par dfaut)
	
V16 :
	Cration
*/
DECLARE VARIABLE SQL_WHERE_CONTACT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    
DECLARE VARIABLE REC_FOUND INTEGER;

BEGIN

    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    
    REC_FOUND=0;
    
    /* construction des WHERE */
    SQL_WHERE_CONTACT = '';
    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';

	ID_OK = Null;

    IF (:I_TFBSERVER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER; 

    IF (SQL_WHERE_OWNER = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    IF (I_TLIBRARY_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;
    
    IF (I_TCONTACT_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE_CONTACT;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE_CONTACT; 

	/* Recherche des contacts */
	FOR EXECUTE STATEMENT '
		SELECT
			TCONTACT.ID,
			TCONTACT.STATE,
			TCONTLIB.TCONTTYPE_ID,
			TCONTLIB.SYNC_SENDMAIL,
			TCONTLIB.TLIBRARY_ID,
			TLIBRARY.STATE,
			TCONTACT.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			COALESCE(TFBSERVER.STATE,0),
            TOWNER.STATE
		FROM TCONTACT INNER JOIN TCONTLIB ON TCONTACT.ID=TCONTLIB.TCONTACT_ID
            INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
            INNER JOIN TLIBRARY  ON TCONTLIB.TLIBRARY_ID=TLIBRARY.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TCONTLIB.TLIBRARY_ID=' || :I_TLIBRARY_ID || '
			AND TCONTACT.ID=' || :I_TCONTACT_ID || '
			AND TCONTLIB.TCONTTYPE_ID=' || :I_TCONTTYPE_ID ||
			IIF (:SQL_WHERE_OWNER != '' , ' AND ' || :SQL_WHERE_OWNER, '') || 
            IIF (:SQL_WHERE_CONTACT != '' , ' AND ' || :SQL_WHERE_CONTACT, '') || 
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
        'ORDER BY TCONTACT.NAME;
        '
		INTO
			:CONTACT_ID,
			:CONTACT_STATE,
			:CONTTYPE_ID , 
			:CONTLIB_SYNC_SENDMAIL,
			:LIBRARY_ID,
			:LIBRARY_STATE,
			:OWNER_ID,
			:FBSERVER_ID,
			:FBSERVER_STATE,
			:OWNER_STATE
	DO
    BEGIN
        REC_FOUND=:REC_FOUND+1;	
		SUSPEND;
    END
    
    IF (REC_FOUND=0) THEN EXCEPTION EX_NOCONTLIB;
    
END ^

ALTER PROCEDURE GET_CONTTYPES RETURNS (CONTTYPE_ID INTEGER,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8)
AS 
/* 
	Liste des type de contacts

MAJ V12 : 
	- ORDER BY NAME
 */

BEGIN
	FOR SELECT ID,
		COALESCE(NAME,'') -- Ne devrait jamais arriver...
	    FROM TCONTTYPE
		ORDER BY NAME
	    INTO :CONTTYPE_ID, :CONTTYPE_NAME
	DO
	BEGIN
		SUSPEND;
	END
END ^

ALTER PROCEDURE GET_CONTTYPE_INFOS (I_TCONTYPE_ID INTEGER NOT NULL)
RETURNS (CONTTYPE_ID INTEGER,
CONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8)
AS 
/* Informations dtailles sur un type de contact */

BEGIN

	FOR SELECT ID,
		COALESCE(NAME,'') -- Ne devrait jamais arriver...
		FROM TCONTTYPE
	    WHERE ID = :I_TCONTYPE_ID
	    INTO :CONTTYPE_ID, :CONTTYPE_NAME
	DO
		SUSPEND;
		
    IF (ROW_COUNT=0) THEN EXCEPTION EX_NOCONTTYPE;
END ^

ALTER PROCEDURE GET_CONTTYPE_MDF (I_TCONTACT_ID INTEGER NOT NULL)
RETURNS (CONTTYPES_INFOS BLOB CHARACTER SET UTF8)
AS 
/*
    Retourne une chaine contenant la concatnation des types de contacts pour un contact donn, par exemple :
     "1";""|"3";"Technique et autre" 

V22 :
    - Cration

V24 : 
	- Changement du type de sortie de VARCHAR(6000) en BLOB
*/
DECLARE VARIABLE CONTTYPE_INFOS VARCHAR(1000);
DECLARE VARIABLE CONTYPE_NUM INTEGER;

DECLARE VARIABLE FIELD_SEP VARCHAR(5);
DECLARE VARIABLE RECORD_SEP VARCHAR(5);
BEGIN

    CONTYPE_NUM = 0;
    CONTTYPE_INFOS = '';
    CONTTYPES_INFOS = '';
	SELECT COALESCE(CAST(DOMPARAM_VALUE AS VARCHAR(5)),';') FROM GET_DOMPARAM('DOMAIN','MDF_FIELD_SEP')  INTO FIELD_SEP;
	SELECT COALESCE(CAST(DOMPARAM_VALUE AS VARCHAR(5)),'|') FROM GET_DOMPARAM('DOMAIN','MDF_RECORD_SEP') INTO RECORD_SEP;

    FOR SELECT
        '"' || TCONTOWNER.TCONTTYPE_ID || '"' ||
         :FIELD_SEP ||
        '"' || TCONTTYPE.NAME || '"'
    FROM TCONTACT
        INNER JOIN TCONTOWNER ON TCONTACT.ID=TCONTOWNER.TCONTACT_ID
            INNER JOIN TCONTTYPE ON TCONTOWNER.TCONTTYPE_ID=TCONTTYPE.ID
        WHERE TCONTACT.ID=:I_TCONTACT_ID
    INTO :CONTTYPE_INFOS
    DO
    BEGIN
        IF (CONTYPE_NUM > 0) THEN
            CONTTYPES_INFOS = CONTTYPES_INFOS || :RECORD_SEP;
            
        CONTTYPES_INFOS = 
            CONTTYPES_INFOS || 
            CONTTYPE_INFOS;
        CONTYPE_NUM = CONTYPE_NUM + 1;
    END
    SUSPEND;
END ^

ALTER PROCEDURE GET_DATE_STRING (I_DATE TIMESTAMP)
RETURNS (DATE_STRING VARCHAR(20) CHARACTER SET UTF8)
AS 
/*
	Renvoie une chaine formate SQL/Novaxel ('CCYY-MM-DD HH:NN:SS') par rapport  une date donne

	Accepte une date ou timestamp

*/
BEGIN
    IF (I_DATE IS NULL) THEN
        DATE_STRING = '';
    ELSE
        DATE_STRING = LPAD(CAST(EXTRACT(YEAR FROM I_DATE) AS CHAR(4)),4,'0') ||'-'|| LPAD(EXTRACT(MONTH FROM I_DATE),2,'0')
            ||'-'|| LPAD(EXTRACT(DAY FROM I_DATE),2,'0') || ' ' || LPAD(EXTRACT(HOUR FROM I_DATE),2,'0')
            ||':'|| LPAD(EXTRACT(MINUTE FROM I_DATE),2,'0') ||':'|| LPAD(TRUNC(EXTRACT(SECOND FROM I_DATE)),2,'0');

    SUSPEND;
END ^

ALTER PROCEDURE GET_DOMPARAM (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL)
RETURNS (DOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
DOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
DOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8,
DOMPARAM_VALUEBLB_FILLED BOOLEAN,
DOMPARAM_TYPE TYPE_PARAM,
DOMPARAM_COMMENT VARCHAR(512) CHARACTER SET UTF8,
DOMPARAM_PROTECTION STATE)
AS 
/*
    
    Renvoi la valeur d'un paramtre prsent dans la table TDOMPARAM
    
    Si le paramtre est inconnu, renvoi NULL...
    
    ATTENTION : La valeur du paramtre est TOUJOURS renvoye en tant que VARCHAR;
    
    Il appartient  la procdure appelante de convertir (CAST) cette valeur dans le type attendu/utilisable...

V9 :
    - Ajout TYPE
V15 :
    - Ajout VALUEBLB

V17 :
	- VALUE VIDE en sortie...
	- Ajout SECTION
	
V20 :
    - SYSTEM ==> PROTECTION
    
V22 :
    - DOMPARAM_VALUEBLB est remplac par DOMPARAM_VALUEBLB_FILLED (boolean) et l'extraction du BLOB est gr par une PS  part (GET_DOMPARAM_VALUEBLB)

V32
	- VALUE VARCHAR(100) ==> VARCHAR(255)

*/

BEGIN

    FOR
        SELECT
			tp.SECTION,
			tp.NAME,
            COALESCE(tp."VALUE",''),
            IIF(tp.VALUEBLB IS NULL,0,1),
            tp."TYPE",
            COALESCE(tp."COMMENT",''),
            tp.PROTECTION -- NOT NULL
        FROM TDOMPARAM tp
        WHERE tp.SECTION=:I_TDOMPARAM_SECTION AND NAME=:I_TDOMPARAM_NAME
        INTO
			:DOMPARAM_SECTION,
			:DOMPARAM_NAME,
            :DOMPARAM_VALUE,
            :DOMPARAM_VALUEBLB_FILLED,
            :DOMPARAM_TYPE,
            :DOMPARAM_COMMENT,
            :DOMPARAM_PROTECTION
    DO
        SUSPEND;
END ^

ALTER PROCEDURE GET_DOMPARAMS RETURNS (DOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
DOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
DOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8,
DOMPARAM_VALUEBLB_FILLED BOOLEAN,
DOMPARAM_TYPE TYPE_PARAM,
DOMPARAM_COMMENT VARCHAR(512) CHARACTER SET UTF8,
DOMPARAM_PROTECTION STATE)
AS 
/*
    
    Renvoi la liste des paramtre de la table TDOMPARAM
    
    ATTENTION : La valeur du paramtre est TOUJOURS renvoye en tant que VARCHAR;
    
    Il appartient  la procdure appelante de convertir (CAST) cette valeur dans le type attendu/utilisable...

V13 :
	- Cration
V15 :
    - ajout VALUEBLB
V17 :
	- Value vide possible en sortie...
	- Ajout SECTION
V20 :
    - SYSTEM ==> PROTECTION

V32
	- VALUE VARCHAR(100) ==> VARCHAR(255)

*/
BEGIN
    FOR
        SELECT
			tp.SECTION,
			tp.NAME,
            COALESCE(tp."VALUE",''),
            IIF(tp.VALUEBLB IS NULL,0,1),
            tp."TYPE",
            COALESCE(tp."COMMENT",''),
            tp.PROTECTION -- NOT NULL
        FROM TDOMPARAM tp
        INTO
			:DOMPARAM_SECTION,
			:DOMPARAM_NAME,
            :DOMPARAM_VALUE,
            :DOMPARAM_VALUEBLB_FILLED,
            :DOMPARAM_TYPE,
            :DOMPARAM_COMMENT,
            :DOMPARAM_PROTECTION
    DO
        SUSPEND;
END ^

ALTER PROCEDURE GET_DOMPARAM_VALUEBLB (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8)
RETURNS (DOMPARAM_TYPE TYPE_PARAM,
DOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8,
DOMPARAM_VALUEBLB BLOB)
AS 
/*
	Retourne une valeur BLOB pour un paramtre domaine
	Les STATES ne sont PAS  valus
	Le paramtre concern doit exister pralablement  l'appel de cette PS

V22 :
    - Cration

V32
	- VALUE VARCHAR(100) ==> VARCHAR(255)
*/
BEGIN
    FOR
        SELECT 
            "TYPE",
            COALESCE("VALUE",''),
            COALESCE(VALUEBLB,'')
        FROM TDOMPARAM
        WHERE
            SECTION = :I_TDOMPARAM_SECTION AND  NAME =:I_TDOMPARAM_NAME
        INTO
            DOMPARAM_TYPE, DOMPARAM_VALUE,DOMPARAM_VALUEBLB
    DO
        SUSPEND;
        
	IF (ROW_COUNT = 0) THEN
		EXCEPTION EX_NODOMPARAM;
            
END ^

ALTER PROCEDURE GET_DOM_ACCESS (I_ACCESS_TYPE INTEGER NOT NULL DEFAULT 0)
RETURNS (ACCESS BOOLEAN)
AS 
/*
        Renvoi 1 si l'accs au domaine est possible ou 0 dans le cas contraire
        Doit tre appele par les procdures de login (ou quivalent) de plus haut niveau (NAS)
        
        Paramtre :
        I_ACCESS_TYPE : Type d'accs  consulter, peut-tre (version DB domain 5) :
            0/NULL : Accs domaine gnral ==> correspond  TDOMPARAM.NAME='DOM_ACCESS'
            1 : Accs domaine WEB ==> correspond  TDOMPARAM.NAME='WEB_ACCESS'
            2 : Accs domaine Mobile ==> correspond  TDOMPARAM.NAME='MOBILE_ACCESS'
            3 : Accs domaine Client Lourd (novaxel.exe) ==> correspond  TDOMPARAM.NAME='NOVAXEL_ACCESS'
            
            Autre : Erreur SQL (Exception EX_BAD_PARAM)
            
            Attention, si un des paramtres n'est pas prsents dans la table TDOMPARAM, cette procdure lve une erreur...

V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
            
*/

DECLARE VARIABLE ACCESS_TYPE
    VARCHAR(100);
DECLARE VARIABLE ACCESS_VALUE
    VARCHAR(255);


BEGIN

    /* numration */
    ACCESS_TYPE = DECODE(I_ACCESS_TYPE
        ,0,'DOMAIN'
        ,1,'WEB'
        ,2,'MOBILE'
        ,3,'CLOUD_CLIENT'
        ,Null
        );
        
    /* Autres paramtres non accepts */
    IF (ACCESS_TYPE IS NULL) THEN
        BEGIN
            EXCEPTION EX_BAD_PARAM;
            EXIT;
        END
        
    /* Recherche de la valeur du paramtre */
    /* TODO : trouver un moyen de retourner le type en fontion de TDOMPARAM.PARAM_TYPE ??? */
    
    /* On teste d'abord l'accs gnral */
	SELECT CAST(DOMPARAM_VALUE AS SMALLINT) FROM GET_DOMPARAM('ACCESS','DOMAIN') INTO ACCESS_VALUE;
--    SELECT CAST(PARAM_VALUE AS SMALLINT) FROM TDOMPARAM WHERE PARAM_NAME='DOM_ACCESS' ;

    /* Le rsutat doit tre non Null (sinon cela veut dire que l'on teste un accs inexistant dans la table TDOMPARAM) */
    IF (ACCESS_VALUE IS NULL) THEN
        BEGIN
            EXCEPTION EX_NOPARAM;
            EXIT;
        END

    /* Si cet accs n'est pas autoris ou est le seul  tester, on sort immdiatement */
    IF (I_ACCESS_TYPE = 0 OR ACCESS_VALUE != 1) THEN
        BEGIN
            ACCESS=ACCESS_VALUE;
            SUSPEND;
            EXIT;
        END

    ACCESS_VALUE=NULL;
    
    /* Dans le cas contraire, on va tester l'accs correspondant */
	SELECT CAST(DOMPARAM_VALUE AS SMALLINT) FROM GET_DOMPARAM('ACCESS',:ACCESS_TYPE) INTO ACCESS_VALUE;
    --SELECT CAST(PARAM_VALUE AS SMALLINT) FROM TDOMPARAM WHERE PARAM_NAME=:ACCESS_TYPE INTO ACCESS_VALUE;
    IF (ACCESS_VALUE IS NULL) THEN
        BEGIN
            EXCEPTION EX_NOPARAM;
            EXIT;
        END

    ACCESS=ACCESS_VALUE;
    SUSPEND;
        
END ^

ALTER PROCEDURE GET_FBSERVERS (I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (FBSERVER_ID INTEGER,
FBSERVER_NAME VARCHAR(100) CHARACTER SET UTF8,
FBSERVER_TCPPORT INTEGER,
FBSERVER_HOST VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_TUNNELPORT INTEGER,
FBSERVER_TUNNELHOST VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_LIBROOTPATH VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_FBADMLOGIN VARCHAR(31) CHARACTER SET UTF8,
FBSERVER_FBADMPASSWD VARCHAR(100) CHARACTER SET UTF8,
FBSERVER_SIZE_MB BIGINT,
FBSERVER_STATE STATE)
AS 
/*
    Renvoie la liste des serveurs Firebird

    Attend :
    - I_TFBSERVER_STATE : critre de slection des tats  afficher
    
    Renvoie: cf. table FBSERVER
    
    Par dfaut, on ne renvoie que les serveurs en tat actif
    
MAJ V13 :
    - Ajout FBSERVER_LIB_ROOT_PATH
    - Ajout FBADM*
V18 :
	- Force les paramtres NOT NULL En entre...

V 19 :
	- Correction FBSERVER_NAME Varchar(50) ==> Varchar (100)

MAJ V31 :
	- Ajout SIZE_MB
*/

DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
BEGIN

    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

    /* construction des WHERE */
    SQL_WHERE_FBSERVER = '';

    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER; 

	FOR EXECUTE STATEMENT '
        SELECT
            TFBSERVER.ID,
            TFBSERVER.NAME,
            COALESCE(TFBSERVER.TCPPORT,0),
            TFBSERVER.HOST,
            COALESCE(TFBSERVER.TUNNELPORT,0),
            COALESCE(TFBSERVER.TUNNELHOST,''''),
            COALESCE(TFBSERVER.LIBROOTPATH,''''),
            FBADMLOGIN,
            COALESCE(FBADMPASSWD,''''),
			COALESCE(TFBSERVER.SIZE_MB,0),
            TFBSERVER.STATE
        FROM TFBSERVER' || IIF (:SQL_WHERE_FBSERVER != '' , ' WHERE ' || :SQL_WHERE_FBSERVER, '') || '
        ORDER BY TFBSERVER.NAME'
    INTO
	    :FBSERVER_ID,
	    :FBSERVER_NAME,
	    :FBSERVER_TCPPORT,
	    :FBSERVER_HOST,
	    :FBSERVER_TUNNELPORT,
	    :FBSERVER_TUNNELHOST,
	    :FBSERVER_LIBROOTPATH,
	    :FBSERVER_FBADMLOGIN,
	    :FBSERVER_FBADMPASSWD,
		:FBSERVER_SIZE_MB,
	    :FBSERVER_STATE
	DO
		SUSPEND;
END ^

ALTER PROCEDURE GET_FBSERVER_INFOS (I_TFBSERVER_ID INTEGER NOT NULL,
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (FBSERVER_ID INTEGER,
FBSERVER_NAME VARCHAR(50) CHARACTER SET UTF8,
FBSERVER_TCPPORT INTEGER,
FBSERVER_HOST VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_TUNNELPORT INTEGER,
FBSERVER_TUNNELHOST VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_LIBROOTPATH VARCHAR(255) CHARACTER SET UTF8,
FBSERVER_FBADMLOGIN VARCHAR(31) CHARACTER SET UTF8,
FBSERVER_FBADMPASSWD VARCHAR(100) CHARACTER SET UTF8,
FBSERVER_SIZE_MB BIGINT,
FBSERVER_STATE STATE)
AS 
/*
    Renvoie les informations dtailles associes  un serveur Firebird

    Attend :
    - I_TFBSERVER_ID : un code numrique identifiant de propritaire (FK TOWNER)
    - I_TFBSERVER_STATE : critre de slection des tats  afficher

MAJ V13 :
    - Ajout FBSERVER_LIB_ROOT_PATH
    - Ajout FBADM*

MAJ V31 :
	- Ajout SIZE_MB
*/
DECLARE VARIABLE REC_FOUND INTEGER;
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
BEGIN

    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    
    /* construction des WHERE */
    SQL_WHERE_FBSERVER = '';
    
    REC_FOUND=0;

    IF (:I_TFBSERVER_STATE ='' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER; 

	FOR EXECUTE STATEMENT '
        SELECT
            TFBSERVER.ID,
            TFBSERVER.NAME,
            COALESCE(TFBSERVER.TCPPORT,0),
            TFBSERVER.HOST,
            COALESCE(TFBSERVER.TUNNELPORT,0),
            COALESCE(TFBSERVER.TUNNELHOST,''''),
            COALESCE(TFBSERVER.LIBROOTPATH,''''),
            FBADMLOGIN,
            COALESCE(FBADMPASSWD,''''),
			COALESCE(TFBSERVER.SIZE_MB,0),
            TFBSERVER.STATE
        FROM TFBSERVER
        WHERE
            TFBSERVER.ID=' || :I_TFBSERVER_ID || IIF (:SQL_WHERE_FBSERVER != '' , ' AND ' || :SQL_WHERE_FBSERVER, '')
    INTO
	    :FBSERVER_ID,
	    :FBSERVER_NAME,
	    :FBSERVER_TCPPORT,
	    :FBSERVER_HOST,
	    :FBSERVER_TUNNELPORT,
	    :FBSERVER_TUNNELHOST,
	    :FBSERVER_LIBROOTPATH,
	    :FBSERVER_FBADMLOGIN,
	    :FBSERVER_FBADMPASSWD,
		:FBSERVER_SIZE_MB,
	    :FBSERVER_STATE
	DO
    BEGIN
        REC_FOUND=:REC_FOUND+1;
        SUSPEND;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOFBSER;
    
END ^

ALTER PROCEDURE GET_GEDGROUPS_FOR_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8,
GEDGROUP_TYPE SMALLINT,
GEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDGROUP_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_GEDUSERS_COUNT INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
GEDUSER_STATE STATE,
OWNER_STATE STATE)
AS 
/*
	Renvoie la liste des groupes associs  un Utilisateur GED
	
MAJ V22 :
    - Ajout des informations dtailles GROUP pour amliorations performances NAS

MAJ V 32
	- Ajout TYPE + PROFILE ID + COMMENT + DATE's
	
MAJ V34
    - Ajout GEDUSERS_COUNT en sortie...

*/
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);

DECLARE VARIABLE SQL_WHERE_GEDUSER_COUNT VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    
BEGIN
    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);
    I_TGEDUSER_COUNT_STATE = TRIM(I_TGEDUSER_COUNT_STATE);

    SQL_WHERE_OWNER = '';
	SQL_WHERE_GEDUSER = '';
	SQL_WHERE_GEDUSER_COUNT='';
    ID_OK = Null;

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;

    -- Utilisateur GED 
    IF (:I_TGEDUSER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

    /* Existence/visibilit de l'utilisateur GED lui-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TGEDUSER.ID
		FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;
    
	IF (:I_TGEDUSER_COUNT_STATE ='') THEN
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;
	ELSE
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_COUNT_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;

	/* Recherche des groupes GED */
	FOR EXECUTE STATEMENT '
		SELECT
            TGEDUSER.ID,
			TGEDGROUPUSER.TGEDGROUP_ID,
			-- Ajout V22
			TGEDGROUP.NAME,
			TGEDGROUP.TOWNER_ID,
			-- Ajout V32
			TGEDGROUP."TYPE",
			COALESCE(TGEDGROUP.COMMENT,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDGROUP.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDGROUP.MODIF_DATE)),
			COALESCE(TGEDGROUP.TPROFILE_ID,0),
            (
                SELECT COUNT(TGEDGROUPUSER.TGEDUSER_ID)
                FROM TGEDGROUPUSER INNER JOIN TGEDUSER ON TGEDGROUPUSER.TGEDUSER_ID=TGEDUSER.ID
                WHERE TGEDGROUPUSER.TGEDGROUP_ID=TGEDGROUP.ID '
                || IIF (:SQL_WHERE_GEDUSER_COUNT != '' , ' AND (' || :SQL_WHERE_GEDUSER_COUNT || ')', '') || '
            ),
			
			TGEDUSER.STATE,
			TOWNER.STATE
		FROM
			TGEDGROUPUSER
                INNER JOIN TGEDUSER ON TGEDGROUPUSER.TGEDUSER_ID=TGEDUSER.ID
                    INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
                INNER JOIN TGEDGROUP ON TGEDGROUPUSER.TGEDGROUP_ID=TGEDGROUP.ID
                
		WHERE
			TGEDGROUPUSER.TGEDUSER_ID=' || :I_TGEDUSER_ID ||
--			Finalement nous retournons aussi les groupes primaires
-- 			-- Mme si aucun groupe primaire n'est cens tre retourn ici, on s'en assure...
-- 			' AND TGEDGROUP.ID<> COALESCE(TGEDUSER.TGEDGROUP_ID,0)' ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
		INTO
			:GEDUSER_ID,
			:GEDGROUP_ID,
			-- Ajout V22
			:GEDGROUP_NAME,
			:OWNER_ID,
			-- Ajout V32
			:GEDGROUP_TYPE,
			:GEDGROUP_COMMENT,
			:GEDGROUP_CREATE_DATE,
			:GEDGROUP_MODIF_DATE,
			:PROFILE_ID,
            -- Ajout V34
			:GEDGROUP_GEDUSERS_COUNT,
			
			:GEDUSER_STATE,
			:OWNER_STATE
	DO
		SUSPEND;

END ^

ALTER PROCEDURE GET_GEDGROUPS_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8,
GEDGROUP_TYPE SMALLINT,
GEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDGROUP_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_GEDUSERS_COUNT INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie les groupes d'Utilisateurs GED  lis  une bibliothque dans la table TGEDGROUPLIB
	
V 32 :
	Cration

MAJ V34
    - Ajout GEDUSERS_COUNT en sortie...
    - Ajout de COMMENT + DATES en sortie...

*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);

DECLARE VARIABLE SQL_WHERE_GEDUSER_COUNT VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    
BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TGEDUSER_COUNT_STATE = TRIM(I_TGEDUSER_COUNT_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDUSER_COUNT='';
	ID_OK = Null;


    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY et TPROFILE */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;

	IF (:I_TGEDUSER_COUNT_STATE ='') THEN
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;
	ELSE
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_COUNT_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;


	/* Recherche des Groupes */
	FOR EXECUTE STATEMENT '
		SELECT
			TGEDGROUPLIB.TLIBRARY_ID,
			TGEDGROUPLIB.TGEDGROUP_ID,
			TGEDGROUP."NAME",
			COALESCE(TGEDGROUP."TYPE",0),
			COALESCE(TGEDGROUP.COMMENT,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDGROUP.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDGROUP.MODIF_DATE)),			
			COALESCE(TGEDGROUPLIB.TPROFILE_ID,0),
			TGEDGROUP.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
            (
                SELECT COUNT(TGEDGROUPUSER.TGEDUSER_ID)
                FROM TGEDGROUPUSER INNER JOIN TGEDUSER ON TGEDGROUPUSER.TGEDUSER_ID=TGEDUSER.ID
                WHERE TGEDGROUPUSER.TGEDGROUP_ID=TGEDGROUP.ID '
                || IIF (:SQL_WHERE_GEDUSER_COUNT != '' , ' AND (' || :SQL_WHERE_GEDUSER_COUNT || ')', '') || '
            ),
			TLIBRARY.STATE,
            TOWNER.STATE,
			COALESCE(TFBSERVER.STATE,0)
			
		FROM TGEDGROUPLIB
            INNER JOIN TGEDGROUP ON TGEDGROUPLIB.TGEDGROUP_ID=TGEDGROUP.ID
            INNER JOIN TLIBRARY  ON TGEDGROUPLIB.TLIBRARY_ID=TLIBRARY.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
		WHERE
			TGEDGROUPLIB.TLIBRARY_ID=' || :I_TLIBRARY_ID || 
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
        '
        ORDER BY TGEDGROUP."NAME" '
		INTO
			:LIBRARY_ID,
			:GEDGROUP_ID,
			:GEDGROUP_NAME,
			:GEDGROUP_TYPE,
            -- Ajout V34
			:GEDGROUP_COMMENT,
			:GEDGROUP_CREATE_DATE,
			:GEDGROUP_MODIF_DATE,
			:PROFILE_ID,
			:OWNER_ID,
			:FBSERVER_ID,
            -- Ajout V34
			:GEDGROUP_GEDUSERS_COUNT,
			:LIBRARY_STATE,
			:OWNER_STATE,
			:FBSERVER_STATE

	DO
	BEGIN
		SUSPEND;
    END
END ^

ALTER PROCEDURE GET_GEDGROUPS_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8,
GEDGROUP_TYPE SMALLINT,
GEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDGROUP_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_GEDUSERS_COUNT INTEGER,
PROFILE_ID INTEGER,
OWNER_STATE STATE)
AS 
/*
	Renvoie la liste des groupes associs  un Propritaire
	
MAJ V22 :
    - Ajout informaitons dtailles GROUP pour amlioration performances NAS

MAJ V32 :
	- Ajout TYPE + PROFILE ID + COMMENT + DATE's

MAJ v34 :
    - Ajout GEDUSERS_COUNT en sortie...
*/
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;

DECLARE VARIABLE SQL_WHERE_GEDUSER_COUNT VARCHAR(8000);
BEGIN
    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TGEDUSER_COUNT_STATE = TRIM(I_TGEDUSER_COUNT_STATE);

	SQL_WHERE = '';
	ID_OK = Null;

    SQL_WHERE_GEDUSER_COUNT='';
    
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE;

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE != '' , ' AND (' || :SQL_WHERE || ')', '')
        INTO ID_OK;

	IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;

	IF (:I_TGEDUSER_COUNT_STATE ='') THEN
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;
	ELSE
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_COUNT_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;

    
	/* Recherche des Utilisateurs GED */
	FOR EXECUTE STATEMENT '
		SELECT
			TGEDGROUP.ID,

			-- Ajout V22
			TGEDGROUP.NAME,
			-- Ajout V32
			COALESCE(TGEDGROUP."TYPE",0),
			COALESCE(TGEDGROUP.COMMENT,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDGROUP.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDGROUP.MODIF_DATE)),
			COALESCE(TGEDGROUP.TPROFILE_ID,0),
            (
                SELECT COUNT(TGEDGROUPUSER.TGEDUSER_ID)
                FROM TGEDGROUPUSER INNER JOIN TGEDUSER ON TGEDGROUPUSER.TGEDUSER_ID=TGEDUSER.ID
                WHERE TGEDGROUPUSER.TGEDGROUP_ID=TGEDGROUP.ID '
                || IIF (:SQL_WHERE_GEDUSER_COUNT != '' , ' AND (' || :SQL_WHERE_GEDUSER_COUNT || ')', '') || '
            ),
			
			TGEDGROUP.TOWNER_ID,
			TOWNER.STATE AS TOWNER_STATE
		FROM
			TGEDGROUP
                INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
		WHERE
			TGEDGROUP.TOWNER_ID=' || :I_TOWNER_ID ||
        '
        ORDER BY TGEDGROUP.ID
        '
		INTO
			:GEDGROUP_ID,
			-- Ajout V22
			:GEDGROUP_NAME,

			-- Ajout V32
			:GEDGROUP_TYPE,
			:GEDGROUP_COMMENT,
			:GEDGROUP_CREATE_DATE,
			:GEDGROUP_MODIF_DATE,
			:PROFILE_ID,

            -- Ajout V34
			:GEDGROUP_GEDUSERS_COUNT,

			:OWNER_ID,
			:OWNER_STATE
	DO
		SUSPEND;

END ^

ALTER PROCEDURE GET_GEDGROUP_INFOS (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDGROUP_ID INTEGER,
OWNER_ID INTEGER,
GEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8,
GEDGROUP_TYPE SMALLINT,
GEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDGROUP_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDGROUP_GEDUSERS_COUNT INTEGER,
PROFILE_ID INTEGER,
OWNER_STATE STATE)
AS 
/*
	Renvoie les informations dtailles sur un groupe d'Utilisateur GED...

MAJ V32 :
	- Ajout TYPE + PROFILE ID + COMMENT + DATE's

MAJ v34 :
    - Ajout GEDUSERS_COUNT en sortie...

*/
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE REC_FOUND INTEGER;

DECLARE VARIABLE SQL_WHERE_GEDUSER_COUNT VARCHAR(8000);
BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TGEDUSER_COUNT_STATE = TRIM(I_TGEDUSER_COUNT_STATE);

	SQL_WHERE = '';
	REC_FOUND = 0;

    SQL_WHERE_GEDUSER_COUNT='';

    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

	IF (:I_TGEDUSER_COUNT_STATE ='') THEN
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;
	ELSE
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_COUNT_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;
    
    FOR EXECUTE STATEMENT '
        SELECT
            TGEDGROUP.ID,
			TGEDGROUP.TOWNER_ID,
			TGEDGROUP.NAME,
			-- Ajout V32
			COALESCE(TGEDGROUP."TYPE",0),
			COALESCE(TGEDGROUP.COMMENT,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDGROUP.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDGROUP.MODIF_DATE)),
			COALESCE(TGEDGROUP.TPROFILE_ID,0),
            (
                SELECT COUNT(TGEDGROUPUSER.TGEDUSER_ID)
                FROM TGEDGROUPUSER INNER JOIN TGEDUSER ON TGEDGROUPUSER.TGEDUSER_ID=TGEDUSER.ID
                WHERE TGEDGROUPUSER.TGEDGROUP_ID=TGEDGROUP.ID '
                || IIF (:SQL_WHERE_GEDUSER_COUNT != '' , ' AND (' || :SQL_WHERE_GEDUSER_COUNT || ')', '') || '
            ),
            TOWNER.STATE
        FROM TGEDGROUP INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
        WHERE
            TGEDGROUP.ID=' || :I_TGEDGROUP_ID ||
            IIF (:SQL_WHERE != '' , ' AND (' || :SQL_WHERE || ')', '')
        INTO
            :GEDGROUP_ID,
            :OWNER_ID,
            :GEDGROUP_NAME,

			-- Ajout V32
			:GEDGROUP_TYPE,
			:GEDGROUP_COMMENT,
			:GEDGROUP_CREATE_DATE,
			:GEDGROUP_MODIF_DATE,
			:PROFILE_ID,
            -- Ajout V34
			:GEDGROUP_GEDUSERS_COUNT,

            :OWNER_STATE
    DO
    BEGIN
        REC_FOUND=:REC_FOUND+1;
        SUSPEND;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOGEDGROUP;

END ^

ALTER PROCEDURE GET_GEDPARAM (I_TGEDPARAM_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAM_CLASS INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDPARAM_DEFAULTVALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie les informations dtailles d'un paramtre GED_LOGIN

	Une erreur est leve si le paramtre n'existe pas...

MAJ V11 :
    - Ajout SYSTEM

V20 :
    - SYSTEM ==> PROTECTION

V21 :
	- ajout TGEDDPARAM.CLASS
	
V22 :
    - GEDPARAM_DEFAULTVALUEBLB est remplac par GEDPARAM_DEFAULTVALUEBLB (boolean) et l'extraction du BLOB est gr par une PS  part (GET_GEDPARAM_VALUEBLB)

V40 :
	- Ajout d'infos GEDPARAM en sortie
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE REC_FOUND INTEGER;

BEGIN
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';

    REC_FOUND=0;

    IF (I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;

        IF (I_TLIBRARY_STATE = '') THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB;

       /* Serveur Firebird (si non Null) utilisable outrepassable...*/
        IF (:I_TFBSERVER_STATE = '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         


	FOR
        EXECUTE STATEMENT
             'SELECT
                TGEDPARAM.ID,
                TGEDPARAM.SECTION,
                COALESCE(TGEDPARAM.NAME,''''),
                TGEDPARAM."TYPE",
				TGEDPARAM."CLASS",
                COALESCE(TGEDPARAM.DEFAULTVALUE,''''),
                IIF(TGEDPARAM.DEFAULTVALUEBLB IS NULL,0,1),
                COALESCE(TGEDPARAM."COMMENT",''''),
				TGEDPARAM.PROTECTION,
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
                COALESCE(TGEDPARAM.TOWNER_ID, 0),
                COALESCE(TGEDPARAM.TLIBRARY_ID,0),
                COALESCE(TFBSERVER.ID,0),
                COALESCE(TOWNER.STATE,0),
                COALESCE(TLIBRARY.STATE,0),
                COALESCE(TFBSERVER.STATE,0)
            FROM TGEDPARAM 
                LEFT JOIN TOWNER ON TGEDPARAM.TOWNER_ID=TOWNER.ID
                LEFT JOIN TLIBRARY ON TGEDPARAM.TLIBRARY_ID=TLIBRARY.ID
                    LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE TGEDPARAM.ID=' || :I_TGEDPARAM_ID ||
                IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || 'OR TOWNER.STATE IS NULL)', '') ||
                IIF (:SQL_WHERE_LIB != '' , ' AND (' || :SQL_WHERE_LIB || 'OR TLIBRARY.STATE IS NULL)', '') ||
                IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '')
                
        INTO
            :GEDPARAM_ID,
            :GEDPARAM_SECTION,
            :GEDPARAM_NAME,
            :GEDPARAM_TYPE,
			:GEDPARAM_CLASS,
            :GEDPARAM_DEFAULTVALUE,
            :GEDPARAM_DEFAULTVALUEBLB_FILLED,
            :GEDPARAM_COMMENT,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
            :OWNER_ID,
            :LIBRARY_ID,
            :FBSERVER_ID,
            :OWNER_STATE,
            :LIBRARY_STATE,
            :FBSERVER_STATE

	DO
    BEGIN
		SUSPEND;
        REC_FOUND=:REC_FOUND+1;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOGEDPARAM;
END ^

ALTER PROCEDURE GET_GEDPARAMOWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMOWNER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
/*
	Renvoie tous les dtails pour un paramtre GED donn d'un Propritaire donn...

V21 :
- Cration

V22 :
    - GEDPARAMOWNER_VALUEBLB est remplac par GEDPARAMOWNER_VALUEBLB_FILLED (boolean)

V40 :
	- Factorisation TGEDPARAM
	- Ajout d'infos GEDPARAM en sortie

*/

DECLARE VARIABLE ID_OK Integer;
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);

BEGIN

	SQL_WHERE = '';
	ID_OK= Null;

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    /* Existence/visibilit du OWNER demand (OWNER STATE OK)*/
    EXECUTE STATEMENT '
        SELECT TOWNER.ID
		FROM TOWNER
        WHERE TOWNER.ID=' || :I_TOWNER_ID ||
            IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '') 
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;

	FOR
		SELECT
			TGEDPARAMOWNER.TOWNER_ID,
			TGEDPARAM.SECTION,
			TGEDPARAM.NAME,
			TGEDPARAM."TYPE",
			COALESCE(TGEDPARAMOWNER."VALUE",''),
			IIF(TGEDPARAMOWNER.VALUEBLB IS NULL,0,1),
			COALESCE(TGEDPARAM."COMMENT",''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMOWNER.MODIF_DATE)),
            TGEDPARAM.ID,
			TGEDPARAM.CLASS,
			TGEDPARAM.PROTECTION,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
			COALESCE(TGEDPARAM.TOWNER_ID,0),
			COALESCE(TGEDPARAM.TLIBRARY_ID,0),
			COALESCE(TGEDPARAM.DEFAULTVALUE,''),
			TOWNER.STATE
		FROM TGEDPARAMOWNER
			INNER JOIN TGEDPARAM ON TGEDPARAMOWNER.TGEDPARAM_ID=TGEDPARAM.ID
			INNER JOIN TOWNER ON TGEDPARAMOWNER.TOWNER_ID=TOWNER.ID
		-- V40 V2
		WHERE TGEDPARAMOWNER.TOWNER_ID=:I_TOWNER_ID AND TGEDPARAMOWNER.TGEDPARAM_ID=:I_TGEDPARAM_ID -- TGEDPARAM.SECTION=:I_TGEDPARAM_SECTION AND TGEDPARAM.NAME=:I_TGEDPARAM_NAME
		INTO
			:OWNER_ID,
			:GEDPARAM_SECTION,
			:GEDPARAM_NAME,
			:GEDPARAM_TYPE,
			:GEDPARAMOWNER_VALUE,
			:GEDPARAMOWNER_VALUEBLB_FILLED,
			:GEDPARAM_COMMENT,
			:GEDPARAMOWNER_MODIF_DATE,
			:GEDPARAM_ID,
			:GEDPARAM_CLASS,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID,
			:GEDPARAM_DEFAULTVALUE,
			:OWNER_STATE
	DO
		SUSPEND;
		
    IF (ROW_COUNT = 0) THEN EXCEPTION EX_NOGEDPARAMOWNER;

END ^

ALTER PROCEDURE GET_GEDPARAMOWNERS_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_CLASS VARCHAR(15) CHARACTER SET UTF8 DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMOWNER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
/*
	Renvoie la liste de tous les paramtres pour un Propritaire
	
	Particularits :
	- Pour des raisons de performances NAS, GEDPARAMOWNER_VALUEBLB_FILLED ne renvoie pas la valeur du BLOB
	mais indique si VALUEBLB est utilis (NOT NULL) ou NON
	- Le paramtre SECTION permet de filtrer le rsultat par rapport  une seule section dans TGEDPARAMOWNER pour le OWNER_ID donn (ie. pas tous les paramtres du profil)
	
	On utilisera la PS GET_GEDPARAM_FOR_OWNER pour obtenir la valeur de ce blob, le cas chant...
	
V21:
    - Cration

V40 :
	- Factorisation TGEDPARAM
    - Ajout d'infos GEDPARAM en sortie
    - Ajout I_TGEDPARAM_CLASS
*/

DECLARE VARIABLE ID_OK Integer;
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_CLASS VARCHAR(8000);

BEGIN

	SQL_WHERE = '';
	ID_OK= Null;

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    /* Existence/visibilit du OWNER demand (OWNER STATE OK)*/
    EXECUTE STATEMENT '
        SELECT TOWNER.ID
		FROM TOWNER
        WHERE TOWNER.ID=' || :I_TOWNER_ID ||
            IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '') 
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;
    
    I_TGEDPARAM_SECTION=TRIM(I_TGEDPARAM_SECTION);
    I_TGEDPARAM_CLASS=TRIM(I_TGEDPARAM_CLASS);    
    
    SQL_WHERE = '';
    
    -- Ajout du critre sur la section si le paramtre est pass
    IF (I_TGEDPARAM_SECTION != '') THEN
        SQL_WHERE='TGEDPARAM.SECTION=''' || :I_TGEDPARAM_SECTION || '''';

    -- Dernier filtre sur class
    IF (I_TGEDPARAM_CLASS!='') THEN
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDPARAM_CLASS,'TGEDPARAM.CLASS') INTO SQL_WHERE_CLASS;
	FOR
        EXECUTE STATEMENT
            'SELECT
                TGEDPARAMOWNER.TOWNER_ID,
                TGEDPARAM.SECTION,
                TGEDPARAM.NAME,
                TGEDPARAM."TYPE",
                COALESCE(TGEDPARAMOWNER."VALUE",''''),
                IIF(TGEDPARAMOWNER.VALUEBLB IS NULL,0,1),
                COALESCE(TGEDPARAM."COMMENT",''''),
				(SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMOWNER.MODIF_DATE)),
				TGEDPARAM.ID,
				TGEDPARAM.CLASS,
				TGEDPARAM.PROTECTION,
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
				COALESCE(TGEDPARAM.TOWNER_ID,0),
				COALESCE(TGEDPARAM.TLIBRARY_ID,0),
				COALESCE(TGEDPARAM.DEFAULTVALUE,''''),
                TOWNER.STATE
            FROM TGEDPARAMOWNER
				INNER JOIN TGEDPARAM ON TGEDPARAMOWNER.TGEDPARAM_ID = TGEDPARAM.ID
                INNER JOIN TOWNER ON TGEDPARAMOWNER.TOWNER_ID=TOWNER.ID
            WHERE TGEDPARAMOWNER.TOWNER_ID=' || :I_TOWNER_ID || 
                IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '') ||
                IIF (:SQL_WHERE_CLASS !='','AND ' || :SQL_WHERE_CLASS,'') || '
            ORDER BY TGEDPARAM.SECTION,TGEDPARAM.NAME'
		INTO
			:OWNER_ID,
			:GEDPARAM_SECTION,
			:GEDPARAM_NAME,
			:GEDPARAM_TYPE,
			:GEDPARAMOWNER_VALUE,
			:GEDPARAMOWNER_VALUEBLB_FILLED,
			:GEDPARAM_COMMENT,
			:GEDPARAMOWNER_MODIF_DATE,
			:GEDPARAM_ID,
			:GEDPARAM_CLASS,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID,
			:GEDPARAM_DEFAULTVALUE,
			:OWNER_STATE
	DO
		SUSPEND;

END ^

ALTER PROCEDURE GET_GEDPARAMOWNER_MDF (I_TOWNER_ID INTEGER NOT NULL)
RETURNS (GEDPARAMOWNERS_INFOS BLOB CHARACTER SET UTF8)
AS 
/*
    Retourne une chaine contenant la concatnation des paramtres GED d'un OWNER exemple :
     "LICENCE";"PANIERES_WEB_DOSSIER";"2";"1";"0"|"LICENCE";"TYPE";"7";"FAMILY";"0"

V24 :
    - Cration
    
V27 :
	- Correction de l'appel de GET_GEDPARAMOWNERS_FOR_OWNER avec tous les STATES...

V40 :
	- Factorisation TGEDPARAM
	- Format GEDPARAMOWNERS_INFOS modifi :
	SECTION;NAME;TYPE;VALUE;VALUEBLB_FILLED + ;GEDPARAM_ID;GEDPARAM_CLASS,GEDPARAM_PROTECTION
	V40 V2 : voir si besoin ajout GEDPARAM_OWNER_ID + GEDPARAM_LIBRARY_ID ???
	V40 V3 : ajout de TGEDPARAM.DEFAULTVALUE...
	SECTION;NAME;TYPE;VALUE;VALUEBLB_FILLED + ;GEDPARAM_ID;GEDPARAM_CLASS,GEDPARAM_PROTECTION +,DEFAULTVALUE
*/
DECLARE VARIABLE GEDPARAM_INFOS VARCHAR(8000);
DECLARE VARIABLE GEDPARAM_NUM INTEGER;

DECLARE VARIABLE FIELD_SEP VARCHAR(5);
DECLARE VARIABLE RECORD_SEP VARCHAR(5);

BEGIN
    GEDPARAMOWNERS_INFOS='';
    GEDPARAM_NUM=0;
    GEDPARAM_INFOS='';
	SELECT COALESCE(CAST(DOMPARAM_VALUE AS VARCHAR(5)),';') FROM GET_DOMPARAM('DOMAIN','MDF_FIELD_SEP')  INTO FIELD_SEP;
	SELECT COALESCE(CAST(DOMPARAM_VALUE AS VARCHAR(5)),'|') FROM GET_DOMPARAM('DOMAIN','MDF_RECORD_SEP') INTO RECORD_SEP;

    FOR SELECT 
        '"' || GEDPARAM_SECTION || '"' ||
        :FIELD_SEP ||        
        '"' || GEDPARAM_NAME || '"' ||
        :FIELD_SEP ||        
        '"' || GEDPARAM_TYPE || '"' ||
        :FIELD_SEP ||        
        '"' || GEDPARAMOWNER_VALUE || '"' ||	
        :FIELD_SEP ||        
        '"' || GEDPARAMOWNER_VALUEBLB_FILLED || '"' ||
        :FIELD_SEP ||        
        '"' || GEDPARAM_ID || '"' ||
        :FIELD_SEP ||        
        '"' || GEDPARAM_CLASS || '"' ||
        :FIELD_SEP ||        
        '"' || GEDPARAM_PROTECTION || '"' ||
        :FIELD_SEP ||        
        '"' || GEDPARAM_DEFAULTVALUE || '"'
        
    
	-- Correction d'appel en V40 pour intgrer le paramtre de flitre sur la class (pass  vide ici, ie tous les paramtres)...
    FROM GET_GEDPARAMOWNERS_FOR_OWNER(:I_TOWNER_ID,'','','*')
    INTO GEDPARAM_INFOS
    DO
    BEGIN
        IF (GEDPARAM_NUM > 0) THEN
            GEDPARAMOWNERS_INFOS = GEDPARAMOWNERS_INFOS || :RECORD_SEP;
            
        GEDPARAMOWNERS_INFOS = 
            GEDPARAMOWNERS_INFOS || 
            GEDPARAM_INFOS;
        GEDPARAM_NUM = GEDPARAM_NUM + 1;
    END

    SUSPEND;
END ^

ALTER PROCEDURE GET_GEDPARAMOWNER_VALUEBLB (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL)
RETURNS (GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMOWNER_VALUEBLB BLOB,
GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER)
AS 
/*
	Retourne une valeur BLOB pour un paramtre GED d'un propritaire
	Les STATES ne sont PAS  valus
	Le paramtre concern doit exister pralablement  l'appel de cette PS

V22 :
    - Cration

V40 :
	- Factorisation TGEDPARAM
	- Ajout d'infos GEDPARAM en sortie
*/
BEGIN
    FOR
        SELECT
			TGEDPARAM."TYPE",
			COALESCE(TGEDPARAMOWNER."VALUE",''),
            COALESCE(TGEDPARAMOWNER.VALUEBLB,''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMOWNER.MODIF_DATE)),
			TGEDPARAM.ID,
			TGEDPARAM.CLASS,
			TGEDPARAM.PROTECTION,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
			COALESCE(TGEDPARAM.TOWNER_ID,0),
			COALESCE(TGEDPARAM.TLIBRARY_ID,0)

        FROM TGEDPARAMOWNER
			INNER JOIN TGEDPARAM ON TGEDPARAMOWNER.TGEDPARAM_ID = TGEDPARAM.ID
			-- V40 V2
		WHERE TGEDPARAMOWNER.TOWNER_ID=:I_TOWNER_ID AND TGEDPARAMOWNER.TGEDPARAM_ID=:I_TGEDPARAM_ID --TGEDPARAM.SECTION=:I_TGEDPARAM_SECTION AND TGEDPARAM.NAME=:I_TGEDPARAM_NAME
        INTO
			:GEDPARAM_TYPE, 
			:GEDPARAMOWNER_VALUE,
			:GEDPARAMOWNER_VALUEBLB,
			:GEDPARAMOWNER_MODIF_DATE,
			:GEDPARAM_ID,
			:GEDPARAM_CLASS,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID


    DO
        SUSPEND;
        
	IF (ROW_COUNT = 0) THEN EXCEPTION EX_NOGEDPARAMOWNER;
END ^

ALTER PROCEDURE GET_GEDPARAMPROF (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMPROF_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
/*
	Renvoie tous les dtails pour un paramtre GED donn d'un Profil donn...

MAJ V11 :
- Ajout MODIF_DATE

V22 :
    - GEDPARAMPROF_VALUEBLB est remplac par GEDPARAMPROF_VALUEBLB_FILLED (boolean)
    
V40 :
    - Factorisation GEDPARAM
    - Ajout d'infos GEDPARAM en sortie

*/

DECLARE VARIABLE ID_OK Integer;
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);

BEGIN

	SQL_WHERE = '';
	ID_OK= Null;

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    /* Existence/visibilit du PROFILE demand (OWNER STATE OK)*/
    EXECUTE STATEMENT '
        SELECT TPROFILE.ID
		FROM TPROFILE INNER JOIN TOWNER ON TPROFILE.TOWNER_ID=TOWNER.ID
        WHERE TPROFILE.ID=' || :I_TPROFILE_ID ||
            IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '') 
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOPROFILE;

	FOR
		SELECT
			TGEDPARAMPROF.TPROFILE_ID,
			TGEDPARAM.SECTION,
			TGEDPARAM.NAME,
			TGEDPARAM."TYPE",
			COALESCE(TGEDPARAMPROF."VALUE",''),
			IIF(TGEDPARAMPROF.VALUEBLB IS NULL,0,1),
			COALESCE(TGEDPARAM."COMMENT",''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMPROF.MODIF_DATE)),
			TPROFILE.TOWNER_ID,
			TGEDPARAM.ID,
			TGEDPARAM.CLASS,
			TGEDPARAM.PROTECTION,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
			COALESCE(TGEDPARAM.TOWNER_ID,0),
			COALESCE(TGEDPARAM.TLIBRARY_ID,0),
			COALESCE(TGEDPARAM.DEFAULTVALUE,''),
			TOWNER.STATE
		FROM TGEDPARAMPROF
            INNER JOIN TGEDPARAM ON TGEDPARAMPROF.TGEDPARAM_ID = TGEDPARAM.ID
            INNER JOIN TPROFILE ON TGEDPARAMPROF.TPROFILE_ID=TPROFILE.ID
                INNER JOIN TOWNER ON TPROFILE.TOWNER_ID=TOWNER.ID
		WHERE TGEDPARAMPROF.TPROFILE_ID=:I_TPROFILE_ID AND TGEDPARAMPROF.TGEDPARAM_ID = :I_TGEDPARAM_ID --SECTION=:I_TGEDPARAM_SECTION AND TGEDPARAM.NAME=:I_TGEDPARAM_NAME
		INTO
			:PROFILE_ID,
			:GEDPARAM_SECTION,
			:GEDPARAM_NAME,
			:GEDPARAM_TYPE,
			:GEDPARAMPROF_VALUE,
			:GEDPARAMPROF_VALUEBLB_FILLED,
			:GEDPARAM_COMMENT,
			:GEDPARAMPROF_MODIF_DATE,
			:OWNER_ID,
			:GEDPARAM_ID,
			:GEDPARAM_CLASS,
            :GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID,
			:GEDPARAM_DEFAULTVALUE,
			:OWNER_STATE
	DO
		SUSPEND;
		
    IF (ROW_COUNT = 0) THEN EXCEPTION EX_NOGEDPARAMPROF;

END ^

ALTER PROCEDURE GET_GEDPARAMPROFS_FOR_PROFILE (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_CLASS VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMPROF_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
/*
	Renvoie la liste de tous les paramtres pour un Profil
	
	Particularits :
	- Pour des raisons de performances NAS, GEDPARAMPROF_VALUEBLB_FILLED ne renvoie pas la valeur du BLOB
	mais indique si VALUEBLB est utilis (NOT NULL) ou NON
	- Le paramtre SECTION permet de filtrer le rsultat par rapport  une seule section dans TGEDPARAMPROF pour le PROFILE_ID donn (ie. pas tous les paramtres du profil)
	
	On utilisera la PS GET_GEDPARAM_FOR_PROFILE pour obtenir la valeur de ce blob, le cas chant...

MAJ V11 :
- Ajout MODIF_DATE

MAJ V38
    - Ajout I_TGEDPARAM_CLASS en entre
    - Ajout GEDPARAM_CLASS, GEDPARAM_TYPE, GEDPARAM_PROTECTION en sortie
    
V40 :
    - Factorisation GEDPARAM
    - Ajout d'infos GEDPARAM en sortie
*/

DECLARE VARIABLE ID_OK Integer;
DECLARE VARIABLE SQL_WHERE_CLASS VARCHAR(8000);

DECLARE VARIABLE SQL_WHERE VARCHAR(8000);

BEGIN

    I_TGEDPARAM_CLASS=TRIM(I_TGEDPARAM_CLASS);

	SQL_WHERE = '';
	ID_OK= Null;
	SQL_WHERE_CLASS = '';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    /* Existence/visibilit du PROFILE demand (OWNER STATE OK)*/
    EXECUTE STATEMENT '
        SELECT TPROFILE.ID
		FROM TPROFILE INNER JOIN TOWNER ON TPROFILE.TOWNER_ID=TOWNER.ID
        WHERE TPROFILE.ID=' || :I_TPROFILE_ID ||
            IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '') 
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOPROFILE;
    
    I_TGEDPARAM_SECTION=TRIM(I_TGEDPARAM_SECTION);
    SQL_WHERE = '';
    
    -- Ajout du critre sur la section si le paramtre est pass
    IF (I_TGEDPARAM_SECTION != '') THEN
        SQL_WHERE='TGEDPARAM.SECTION=''' || :I_TGEDPARAM_SECTION || '''';

    -- Dernier filtre sur class
    IF (I_TGEDPARAM_CLASS!='') THEN
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDPARAM_CLASS,'TGEDPARAM.CLASS') INTO SQL_WHERE_CLASS;

	FOR
        EXECUTE STATEMENT
            'SELECT
                TGEDPARAMPROF.TPROFILE_ID,
                TGEDPARAM.SECTION,
                TGEDPARAM.NAME,
                TGEDPARAM."TYPE",
                COALESCE(TGEDPARAMPROF."VALUE",''''),
                IIF(TGEDPARAMPROF.VALUEBLB IS NULL,0,1),
                COALESCE(TGEDPARAM."COMMENT",''''),
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMPROF.MODIF_DATE)),
                TGEDPARAM.ID,
                TGEDPARAM.CLASS,
                TGEDPARAM.PROTECTION,
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
				COALESCE(TGEDPARAM.TOWNER_ID,0),
				COALESCE(TGEDPARAM.TLIBRARY_ID,0),
				COALESCE(TGEDPARAM.DEFAULTVALUE,''''),
                TPROFILE.TOWNER_ID,
                TOWNER.STATE
            FROM TGEDPARAMPROF 
                INNER JOIN TGEDPARAM ON TGEDPARAMPROF.TGEDPARAM_ID = TGEDPARAM.ID
                INNER JOIN TPROFILE ON TGEDPARAMPROF.TPROFILE_ID=TPROFILE.ID
                    INNER JOIN TOWNER ON TPROFILE.TOWNER_ID=TOWNER.ID
                
            WHERE TGEDPARAMPROF.TPROFILE_ID=' || :I_TPROFILE_ID || 
            IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '') || 
            IIF (:SQL_WHERE_CLASS !='','AND ' || :SQL_WHERE_CLASS,'') || '
            ORDER BY TGEDPARAM.SECTION,TGEDPARAM.NAME'
		INTO
			:PROFILE_ID,
			:GEDPARAM_SECTION,
			:GEDPARAM_NAME,
			:GEDPARAM_TYPE,
			:GEDPARAMPROF_VALUE,
			:GEDPARAMPROF_VALUEBLB_FILLED,
			:GEDPARAM_COMMENT,
			:GEDPARAMPROF_MODIF_DATE,
            :GEDPARAM_ID,
			:GEDPARAM_CLASS,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID,
			:GEDPARAM_DEFAULTVALUE,
			:OWNER_ID,
			:OWNER_STATE
	DO
		SUSPEND;


END ^

ALTER PROCEDURE GET_GEDPARAMPROF_VALUEBLB (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL)
RETURNS (GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMPROF_VALUEBLB BLOB,
GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER)
AS 
/*
	Retourne une valeur BLOB pour un paramtre GED d'un profil
	Les STATES ne sont PAS  valus
	Le paramtre concern doit exister pralablement  l'appel de cette PS

V22 :
    - Cration
    
V40 :
    - Factorisation GEDPARAM
    - Ajout d'infos GEDPARAM en sortie
*/
BEGIN
    FOR
        SELECT
			TGEDPARAM."TYPE",
			COALESCE(TGEDPARAMPROF."VALUE",''),
            COALESCE(TGEDPARAMPROF.VALUEBLB,''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMPROF.MODIF_DATE)),
			TGEDPARAM.ID,
			TGEDPARAM.CLASS,
			TGEDPARAM.PROTECTION,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
			COALESCE(TGEDPARAM.TOWNER_ID,0),
			COALESCE(TGEDPARAM.TLIBRARY_ID,0)
	        
        FROM TGEDPARAMPROF
            INNER JOIN TGEDPARAM ON TGEDPARAMPROF.TGEDPARAM_ID = TGEDPARAM.ID
        -- V40 V2
		WHERE TGEDPARAMPROF.TPROFILE_ID = :I_TPROFILE_ID AND TGEDPARAMPROF.TGEDPARAM_ID=:I_TGEDPARAM_ID --TGEDPARAM.SECTION = :I_TGEDPARAM_SECTION AND TGEDPARAM.NAME = :I_TGEDPARAM_NAME
        INTO
            :GEDPARAM_TYPE,
            :GEDPARAMPROF_VALUE,
            :GEDPARAMPROF_VALUEBLB,
            :GEDPARAMPROF_MODIF_DATE,
			:GEDPARAM_ID,
			:GEDPARAM_CLASS,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID
            
    DO
        SUSPEND;
        
	IF (ROW_COUNT = 0) THEN EXCEPTION EX_NOGEDPARAMPROF;
END ^

ALTER PROCEDURE GET_GEDPARAMS (I_TGEDPARAM_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_CLASS VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAM_CLASS INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDPARAM_DEFAULTVALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie tous les paramtres de la table TGEDPARAM

	Aucune erreur n'est leve (pas de critre), mais le resultset est vide si aucun paramtre n'existe on ne rpond aux ventuels critres OWNER_ID/LIB_ID
	
	Les dmarches suivantes sont appliques :
	- Si OWNER_ID et LIB_ID ne sont pas fournis, on renvoie tous les paramtres NON affects  un OWNER et/ou une LIB (ie les paramtres globaux)
	- Si un OWNER_ID est fourni, on renvoie tous les paramtres de ce OWNER (pas les globaux, ni ceux affects aux libraries)
	- Si un LIB_ID est fourni, on renvoi tous les paramtres associs  cette LIB seulement (et aucun autre)
	
	MAJ V40 :
	On applique les rgles de systmatisation de valeurs NULL, donc les rgles nnonces ci-dessus sont obsoltes :
	- Si OWNER_ID et/ou LIB_ID sont fournis  0 : on ne tient pas compte de ces paramtres en critres
	- S'ils sont fournis  TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL : on recherche spcifiquement les paramtres non affects (ie. OWNER_ID IS NULL et/ou LIB_ID IS NULL)
      Donc soit un GEDPARAM du dico standard (les 2  TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL), soit un GEDPARAM dico sous-domaine (OWNER_ID <> 0 et LIB_ID = TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL)
      soit un GEDPARAM dico bibliothque (OWNER_ID <> 0 et LIB_ID <> 0)

MAJ V11 : Ajout SYSTEM

V20 :
    - SYSTEM ==> PROTECTION

V21 :
	- ajout TGEDDPARAM.CLASS
	
V38 :
    - ajout filtre entre I_TGEDPARAM_CLASS
    
V40 :
	- Ajout d'infos GEDPARAM en sortie
    - Systmatisation des paramtres reprsentant NULL en entre (utilisation de TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL)    
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_CLASS VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_PARAM VARCHAR(8000);

DECLARE VARIABLE NULL_PARAM INTEGER;

BEGIN   

    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TGEDPARAM_CLASS=TRIM(I_TGEDPARAM_CLASS);

    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_CLASS = '';

    -- Dummy pour simplifaction des concatnation de filtre...
    SQL_WHERE_PARAM='1=1';

	-- Rcupration du DOM_PARAM reprsentant la recherche de valeur NULL
	NULL_PARAM=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','PARAM_EQUIV_NULL')),-9);


    IF (I_TGEDPARAM_TOWNER_ID = NULL_PARAM) THEN
        SQL_WHERE_PARAM = :SQL_WHERE_PARAM || ' AND TGEDPARAM.TOWNER_ID IS NULL';
    ELSE
    BEGIN
        IF (I_TGEDPARAM_TOWNER_ID!=0) THEN
        BEGIN
            IF (I_TOWNER_STATE = '' ) THEN
                /* Etat de visibilit par dfaut */
                SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
            ELSE 
                /* Etat de visibilit demand */
                SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;
                
            -- Ajout du STATE pour gestion LEFT JOIN            
            SQL_WHERE_OWNER=IIF(SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ' OR TOWNER.STATE IS NULL)', '');
                    
            -- Ajout des critres OWNER_ID - Si OWNER ID est pass, on ne renvoie QUE les paramtres de ce OWNER (mais pas ceux affects aux LIBRARIES)
            SQL_WHERE_PARAM= :SQL_WHERE_PARAM ||' AND TGEDPARAM.TOWNER_ID=' || :I_TGEDPARAM_TOWNER_ID || :SQL_WHERE_OWNER;
        END
    END
    

    IF (I_TGEDPARAM_TLIBRARY_ID= NULL_PARAM) THEN
        SQL_WHERE_PARAM = :SQL_WHERE_PARAM || ' AND TGEDPARAM.TLIBRARY_ID IS NULL';
    ELSE
    BEGIN    
        IF (I_TGEDPARAM_TLIBRARY_ID!=0) THEN
        BEGIN
            IF (I_TLIBRARY_STATE = '') THEN
                /* Etat de visibilit par dfaut */
                SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
            ELSE 
                /* Etat de visibilit demand */
                SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB;

            -- Ajout du STATE pour gestion LEFT JOIN
            SQL_WHERE_LIB=IIF(SQL_WHERE_LIB!='', ' AND (' || SQL_WHERE_LIB || ' OR TLIBRARY.STATE IS NULL)','');

           /* Serveur Firebird (si non Null) utilisable outrepassable...*/
            IF (:I_TFBSERVER_STATE = '' ) THEN
                /* Etat de visibilit par dfaut */
                SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
            ELSE 
                /* Etat de visibilit demand */
                SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

            -- Ajout du STATE pour gestion LEFT JOIN
            SQL_WHERE_FBSERVER=IIF(SQL_WHERE_FBSERVER!='', ' AND (' || SQL_WHERE_FBSERVER || ' OR TFBSERVER.STATE IS NULL)','');
                
            -- Ajout des critres LIBRARY_ID - Si LIBRARY ID est pass, on ne renvoie QUE les paramtres de cette LIBRARY
            SQL_WHERE_PARAM = SQL_WHERE_PARAM || ' AND TGEDPARAM.TLIBRARY_ID=' || :I_TGEDPARAM_TLIBRARY_ID || :SQL_WHERE_LIB || :SQL_WHERE_FBSERVER;
        END
    END
    
    -- Dernier filtre sur class
    IF (I_TGEDPARAM_CLASS!='') THEN
    BEGIN
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDPARAM_CLASS,'TGEDPARAM.CLASS') INTO :SQL_WHERE_CLASS;
        SQL_WHERE_PARAM = :SQL_WHERE_PARAM || IIF(:SQL_WHERE_CLASS != '', ' AND ' || :SQL_WHERE_CLASS, '');
    END
        
            
	FOR 
        EXECUTE STATEMENT '
            SELECT 
                TGEDPARAM.ID,
                TGEDPARAM.SECTION,
                COALESCE(TGEDPARAM.NAME,''''),
                TGEDPARAM."TYPE",
				TGEDPARAM."CLASS",
                COALESCE(TGEDPARAM.DEFAULTVALUE,''''),
                IIF(TGEDPARAM.DEFAULTVALUEBLB IS NULL,0,1),
                COALESCE(TGEDPARAM."COMMENT",''''),
				TGEDPARAM.PROTECTION,
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
                COALESCE(TGEDPARAM.TOWNER_ID,0),
                COALESCE(TGEDPARAM.TLIBRARY_ID,0),
                COALESCE(TLIBRARY.TFBSERVER_ID,0),
                COALESCE(TOWNER.STATE,0),
                COALESCE(TLIBRARY.STATE,0),
                COALESCE(TFBSERVER.STATE,0)
            FROM TGEDPARAM
                LEFT JOIN TOWNER ON TGEDPARAM.TOWNER_ID=TOWNER.ID
                LEFT JOIN TLIBRARY ON TGEDPARAM.TLIBRARY_ID=TLIBRARY.ID
                    LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE ' || :SQL_WHERE_PARAM ||
            '
            ORDER BY TGEDPARAM.SECTION, TGEDPARAM.NAME
            '
        INTO
            :GEDPARAM_ID,
            :GEDPARAM_SECTION,
            :GEDPARAM_NAME,
            :GEDPARAM_TYPE,
			:GEDPARAM_CLASS,
            :GEDPARAM_DEFAULTVALUE,
            :GEDPARAM_DEFAULTVALUEBLB_FILLED,
            :GEDPARAM_COMMENT,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
            :OWNER_ID,
            :LIBRARY_ID,
            :FBSERVER_ID,
            :OWNER_STATE,
            :LIBRARY_STATE,
            :FBSERVER_STATE

	DO
		SUSPEND;
                
END ^

ALTER PROCEDURE GET_GEDPARAMUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
LIBRARY_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMUSER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDUSER_STATE STATE,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie le dtail d'un paramtre pour un Utilisateur GED, une section et une LIBRARY donne

MAJ V11 :
    - Ajout MODIF_DATE

V22 :
    - GEDPARAMUSER_VALUEBLB est remplac par GEDPARAMUSER_VALUEBLB_FILLED (boolean)
    
V40 :
    - Factorisation GEDPARAM
    - Ajout d'infos GEDPARAM en sortie

*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);

DECLARE VARIABLE REC_FOUND INTEGER;

DECLARE VARIABLE ID_OK Integer;    

BEGIN


    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
	I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

	ID_OK = Null;

    SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
    SQL_WHERE_GEDUSER = '';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    -- Utilisateur existant et modifiable...
    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

    EXECUTE STATEMENT '
        SELECT TGEDUSER.ID FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
        
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;

    IF (I_TLIBRARY_ID != 0) THEN
    BEGIN
        ID_OK=Null;
        
       /* Serveur Firebird (si non Null) utilisable outrepassable...*/
        IF (:I_TFBSERVER_STATE = '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;

        -- Library existante et modifiable...
        IF (:I_TLIBRARY_STATE ='' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
        ELSE 
            /* Etat de visibilit demand */
             SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 


        /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
        EXECUTE STATEMENT '
            SELECT TLIBRARY.ID
            FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
                IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
                IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
                IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
            INTO :ID_OK;
                
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;
        
        -- Rinit WHERE LIB pour la requte suivante
        SQL_WHERE_LIB=IIF (:SQL_WHERE_LIB != '', :SQL_WHERE_LIB || ' AND ','') || 'TGEDPARAMUSER.TLIBRARY_ID=' || I_TLIBRARY_ID;
    END
    ELSE
    BEGIN
        -- Dans ce cas, on ne renvoi que les paramtres NON associs  une LIBRARY
        SQL_WHERE_LIB='TGEDPARAMUSER.TLIBRARY_ID IS NULL';
    END
    
    -- V40 V2 : on travaille sur GEDPARAM_ID
--    -- Ajout du critre sur la section
--    I_TGEDPARAM_SECTION=TRIM(I_TGEDPARAM_SECTION);
--    -- Ajout du critre NAME
--    I_TGEDPARAM_NAME=TRIM(I_TGEDPARAM_NAME);

	FOR
        EXECUTE STATEMENT
            'SELECT
                TGEDPARAMUSER.TGEDUSER_ID,
                COALESCE(TGEDPARAMUSER.TLIBRARY_ID,0),
                TGEDPARAM.SECTION,
                TGEDPARAM.NAME,
                TGEDPARAM."TYPE",
                COALESCE(TGEDPARAMUSER."VALUE",''''),
                IIF(TGEDPARAMUSER.VALUEBLB IS NULL,0,1),
                COALESCE(TGEDPARAM."COMMENT",''''),
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMUSER.MODIF_DATE)),
                TGEDUSER.TOWNER_ID,
                COALESCE(TLIBRARY.TFBSERVER_ID,0),
                TGEDPARAM.ID,
                TGEDPARAM.CLASS,
                TGEDPARAM.PROTECTION,
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
				COALESCE(TGEDPARAM.TOWNER_ID,0),
				COALESCE(TGEDPARAM.TLIBRARY_ID,0),
				COALESCE(TGEDPARAM.DEFAULTVALUE,''''),
                TGEDUSER.STATE,
                TOWNER.STATE,
                COALESCE(TLIBRARY.STATE,0),
                COALESCE(TFBSERVER.STATE,0)
            FROM TGEDPARAMUSER
                INNER JOIN TGEDPARAM ON TGEDPARAMUSER.TGEDPARAM_ID = TGEDPARAM.ID
                INNER JOIN TGEDUSER ON TGEDPARAMUSER.TGEDUSER_ID=TGEDUSER.ID
                    INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
                LEFT JOIN TLIBRARY ON TGEDPARAMUSER.TLIBRARY_ID=TLIBRARY.ID
                    LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE TGEDPARAMUSER.TGEDUSER_ID=' || :I_TGEDUSER_ID || 
                ' AND ' || :SQL_WHERE_LIB  ||
				-- V40 V2
--                 ' AND TGEDPARAM.SECTION=''' || :I_TGEDPARAM_SECTION || '''' ||
--                 ' AND TGEDPARAM.NAME=''' || :I_TGEDPARAM_NAME || '''' ||
				' AND TGEDPARAMUSER.TGEDPARAM_ID=' || : I_TGEDPARAM_ID || 
                IIF (:SQL_WHERE_OWNER != '' , ' AND ' || :SQL_WHERE_OWNER , '')
		INTO
			:GEDUSER_ID,
			:LIBRARY_ID,
			:GEDPARAM_SECTION,
			:GEDPARAM_NAME,
			:GEDPARAM_TYPE,
			:GEDPARAMUSER_VALUE,
			:GEDPARAMUSER_VALUEBLB_FILLED,
			:GEDPARAM_COMMENT,
			:GEDPARAMUSER_MODIF_DATE,
			:OWNER_ID,
			:FBSERVER_ID,
			:GEDPARAM_ID,
			:GEDPARAM_CLASS,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID,
			:GEDPARAM_DEFAULTVALUE,
			:GEDUSER_STATE,
			:OWNER_STATE,
			:LIBRARY_STATE,
			:FBSERVER_STATE
	DO
	BEGIN
        REC_FOUND=:REC_FOUND+1;
		SUSPEND;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOGEDPARAMUSER;
END ^

ALTER PROCEDURE GET_GEDPARAMUSERS_FOR_USER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
LIBRARY_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMUSER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDUSER_STATE STATE,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie la liste de tous les paramtres pour un Utilisateur GED
	
	Particularits :
	- Pour des raisons de performances NAS, GEDPARAMUSER_VALUEBLB_FILLED ne renvoie pas la valeur du BLOB
	mais indique si VALUEBLB est utilis (NOT NULL) ou NON
	- Le paramtre SECTION permet de filtrer le rsultat par rapport  une seule section dans TGEDPARAMUSER pour le PROFILE_ID donn (ie. pas tous les paramtres du profil)
	- Si le paramtre I_TLIBRARY_ID est <> 0 on ne renvoie QUE les paramtres pour cette LIBRARY
	- Dans le cas contraire (I_TLIBRARY_ID est = 0 ), on ne renvoie QUE les paramtres non associs  une LIBRARY...
	On utilisera la PS GET_GEDPARAMUSER pour obtenir la valeur de ce blob, le cas chant...
	
V40 :
    - Factorisation GEDPARAM
    - Ajout d'infos GEDPARAM en sortie
	
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_SECTION VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    

BEGIN


    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
	I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

	ID_OK = Null;

    SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
    SQL_WHERE_GEDUSER = '';
    SQL_WHERE_SECTION = '';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    -- Utilisateur existant et modifiable...
    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

    EXECUTE STATEMENT '
        SELECT TGEDUSER.ID FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
        
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;

    IF (I_TLIBRARY_ID != 0) THEN
    BEGIN
        ID_OK=Null;
        
       /* Serveur Firebird (si non Null) utilisable outrepassable...*/
        IF (:I_TFBSERVER_STATE = '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;

        -- Library existante et modifiable...
        IF (:I_TLIBRARY_STATE ='' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 


        /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
        EXECUTE STATEMENT '
            SELECT TLIBRARY.ID
            FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
                IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
                IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
                IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
            INTO :ID_OK;
                
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;
        
        -- Rinit WHERE LIB pour la requte suivante
        SQL_WHERE_LIB=IIF (:SQL_WHERE_LIB != '', :SQL_WHERE_LIB || ' AND ','') || 'TGEDPARAMUSER.TLIBRARY_ID=' || I_TLIBRARY_ID;
    END
    ELSE
        -- Dans ce cas, on ne renvoi aue les paramtres NON associs  une LIBRARY
        SQL_WHERE_LIB='TGEDPARAMUSER.TLIBRARY_ID IS NULL';
        
    
    -- Ajout du critre sur la section si le paramtre est pass
    I_TGEDPARAM_SECTION=TRIM(I_TGEDPARAM_SECTION);
    IF (I_TGEDPARAM_SECTION != '') THEN
        SQL_WHERE_SECTION='TGEDPARAM.SECTION=''' || :I_TGEDPARAM_SECTION || '''';

	FOR
        EXECUTE STATEMENT
            'SELECT
                TGEDPARAMUSER.TGEDUSER_ID,
                COALESCE(TGEDPARAMUSER.TLIBRARY_ID,0),
                TGEDPARAM.SECTION,
                TGEDPARAM.NAME,
                TGEDPARAM."TYPE",
                COALESCE(TGEDPARAMUSER."VALUE",''''),
                IIF(TGEDPARAMUSER.VALUEBLB IS NULL,0,1),
                COALESCE(TGEDPARAM."COMMENT",''''),
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMUSER.MODIF_DATE)),
                TGEDUSER.TOWNER_ID,
                COALESCE(TLIBRARY.TFBSERVER_ID,0),
                TGEDPARAM.ID,
                TGEDPARAM.CLASS,
                TGEDPARAM.PROTECTION,
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
				COALESCE(TGEDPARAM.TOWNER_ID,0),
				COALESCE(TGEDPARAM.TLIBRARY_ID,0),
				COALESCE(TGEDPARAM.DEFAULTVALUE,''''),
                TGEDUSER.STATE,
                TOWNER.STATE,
                COALESCE(TLIBRARY.STATE,0),
                COALESCE(TFBSERVER.STATE,0)
            FROM TGEDPARAMUSER INNER JOIN TGEDUSER ON TGEDPARAMUSER.TGEDUSER_ID=TGEDUSER.ID
                INNER JOIN TGEDPARAM ON TGEDPARAMUSER.TGEDPARAM_ID = TGEDPARAM.ID
                INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
                LEFT JOIN TLIBRARY ON TGEDPARAMUSER.TLIBRARY_ID=TLIBRARY.ID
                    LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE TGEDPARAMUSER.TGEDUSER_ID=' || :I_TGEDUSER_ID || 
                IIF (:SQL_WHERE_LIB != '' , ' AND ' || :SQL_WHERE_LIB, '') ||
                IIF (:SQL_WHERE_SECTION != '' ,' AND ' || :SQL_WHERE_SECTION, '') || 
                IIF (:SQL_WHERE_OWNER != '' , ' AND ' || :SQL_WHERE_OWNER , '') ||
            '
            ORDER BY TGEDPARAM.SECTION,TGEDPARAM.NAME'
		INTO
			:GEDUSER_ID,
			:LIBRARY_ID,
			:GEDPARAM_SECTION,
			:GEDPARAM_NAME,
			:GEDPARAM_TYPE,
			:GEDPARAMUSER_VALUE,
			:GEDPARAMUSER_VALUEBLB_FILLED,
			:GEDPARAM_COMMENT,
			:GEDPARAMUSER_MODIF_DATE,
			:OWNER_ID,
			:FBSERVER_ID,
			:GEDPARAM_ID,
			:GEDPARAM_CLASS,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID,
			:GEDPARAM_DEFAULTVALUE,
			:GEDUSER_STATE,
			:OWNER_STATE,
			:LIBRARY_STATE,
			:FBSERVER_STATE
	DO
		SUSPEND;

END ^

ALTER PROCEDURE GET_GEDPARAMUSER_VALUEBLB (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0)
RETURNS (GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMUSER_VALUEBLB BLOB,
GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER)
AS 
/*
	Retourne une valeur BLOB pour un paramtre GED d'un utilisateur
	Les STATES ne sont PAS  valus
	Le paramtre concern doit exister pralablement  l'appel de cette PS

V22 :
    - Cration
    
V40 :
    - Factorisation GEDPARAM
    - Ajout d'infos GEDPARAM en sortie

*/
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE REC_FOUND INTEGER;
BEGIN
	SQL_WHERE_LIB = '';
	REC_FOUND=0;

    IF (I_TLIBRARY_ID = 0) THEN
        SQL_WHERE_LIB='TGEDPARAMUSER.TLIBRARY_ID IS NULL';
    ELSE
        SQL_WHERE_LIB='TGEDPARAMUSER.TLIBRARY_ID=' || :I_TLIBRARY_ID;
    

    FOR EXECUTE STATEMENT
        'SELECT 
            TGEDPARAM."TYPE",
            COALESCE(TGEDPARAMUSER."VALUE",''''),
            COALESCE(TGEDPARAMUSER.VALUEBLB,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMUSER.MODIF_DATE)),
			TGEDPARAM.ID,
			TGEDPARAM.CLASS,
			TGEDPARAM.PROTECTION,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
			COALESCE(TGEDPARAM.TOWNER_ID,0),
			COALESCE(TGEDPARAM.TLIBRARY_ID,0)
            
        FROM TGEDPARAMUSER
            INNER JOIN TGEDPARAM ON TGEDPARAMUSER.TGEDPARAM_ID = TGEDPARAM.ID            

        WHERE TGEDPARAMUSER.TGEDUSER_ID=' || :I_TGEDUSER_ID 
            || ' AND ' || :SQL_WHERE_LIB 
			-- V40 V2
--             || ' AND TGEDPARAM."SECTION"=''' || :I_TGEDPARAM_SECTION || ''''
--             || ' AND TGEDPARAM."NAME"=''' || :I_TGEDPARAM_NAME || ''''
			|| ' AND TGEDPARAMUSER.TGEDPARAM_ID=' || : I_TGEDPARAM_ID
        INTO 
            :GEDPARAM_TYPE,
            :GEDPARAMUSER_VALUE,
            :GEDPARAMUSER_VALUEBLB,
            :GEDPARAMUSER_MODIF_DATE,
			:GEDPARAM_ID,
			:GEDPARAM_CLASS,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
			:GEDPARAM_OWNER_ID,
			:GEDPARAM_LIBRARY_ID
    DO
    BEGIN
        REC_FOUND=:REC_FOUND+1;
		SUSPEND;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOGEDPARAMUSER;
                    
END ^

ALTER PROCEDURE GET_GEDPARAM_DEFAULTVALUEBLB (I_TGEDPARAM_ID INTEGER NOT NULL)
RETURNS (GEDPARAM_TYPE TYPE_PARAM,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDPARAM_DEFAULTVALUEBLB BLOB,
OWNER_ID INTEGER)
AS 
/*
	Retourne une valeur BLOB pour un paramtre GED
	Les STATES ne sont PAS  valus
	Le paramtre concern doit exister pralablement  l'appel de cette PS

V22 :
    - Cration
*/
BEGIN
    FOR
        SELECT
            TGEDPARAM."TYPE",
            COALESCE(TGEDPARAM.DEFAULTVALUE,''''),
            COALESCE(TGEDPARAM.DEFAULTVALUEBLB,''),
            COALESCE(TGEDPARAM.TOWNER_ID,0)
        FROM TGEDPARAM
        WHERE
            TGEDPARAM.ID=:I_TGEDPARAM_ID
            INTO :GEDPARAM_TYPE, :GEDPARAM_DEFAULTVALUE, :GEDPARAM_DEFAULTVALUEBLB, :OWNER_ID
    DO
        SUSPEND;
        
	IF (ROW_COUNT = 0) THEN
		EXCEPTION EX_NOGEDPARAM;
            
END ^

ALTER PROCEDURE GET_GEDPARAM_FOR_NAME (I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TGEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAM_CLASS INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
GEDPARAM_DEFAULTVALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie les informations dtailles d"'un paramtre GED par rapport  un nom ET une section
	La SECTION ne peut pas tre NULL (un NAME NULL ne peut apparaitre qu'une seule fois par section...)
	
    V40 (prcision)
	Cette PS est cens ne renvoyer qu'un seul lment, il s'agit donc de l'appeler de la manire la plus prcise possible
	On ajoute donc des possibilits de filtrage plus fines :
		- Si I_TGEDPARAM_TOWNER_ID = TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL : On recherche les paramtres qui sont spcifiquement non affects (dico standard)
		- Si I_TGEDPARAM_TOWNER_ID = 0 : interdit car cela pourrait alors techniquement renvoyer des doublons, mme si des rgles de gestion interdisent d'ajouter un GEDPARAM OWNER/LIB
            avec les mmes SECTION/NAME que les paramtres standard, cela reste possible par un INSERT/UPDATE manuel, ie. hors PS SET_GEDPARAM...
        - Si I_TGEDPARAM_TOWNER_ID > 0 : on recherche un paramtre spcifique  un OWNER
        - Mmes principes pour TLIBRARY_ID
        


	Une erreur est leve si le paramtre n'existe pas...

MAJ V11 : Ajout SYSTEM

V20 :
    - SYSTEM ==> PROTECTION

V21 :
	- ajout TGEDDPARAM.CLASS

V22 :
    - GEDPARAM_DEFAULTVALUEBLB est remplac par GEDPARAM_DEFAULTVALUEBLB_FILLED (boolean)
    
V40 :
	- Ajout d'infos GEDPARAM en sortie
    - Systmatisation des paramtres reprsentant NULL en entre (utilisation de TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL)

    

*/
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE REC_FOUND INTEGER;

DECLARE VARIABLE NULL_PARAM INTEGER;


BEGIN
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';

    REC_FOUND=0;
    
    -- V 40 : on rend OWNER/LIB obligatoire en entre : Soit un ID <>0, soit TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL
    IF (I_TGEDPARAM_TOWNER_ID = 0 OR I_TGEDPARAM_TLIBRARY_ID = 0 ) THEN
        EXCEPTION EX_BAD_PARAM;

	-- Rcupration du DOM_PARAM reprsentant la recherche de valeur NULL
	NULL_PARAM=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','PARAM_EQUIV_NULL')),-9);

    IF (I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;
        
    -- Ajout du STATE pour gestion LEFT JOIN
    SQL_WHERE_OWNER=IIF(SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ' OR TOWNER.STATE IS NULL)', '');
        
    -- On ajoute le critre sur TGEDPARAM.TOWNER_ID
    IF (I_TGEDPARAM_TOWNER_ID = NULL_PARAM) THEN
        SQL_WHERE_OWNER=:SQL_WHERE_OWNER || ' AND TGEDPARAM.TOWNER_ID IS NULL';
    ELSE
        SQL_WHERE_OWNER=:SQL_WHERE_OWNER || ' AND TGEDPARAM.TOWNER_ID = ' || :I_TGEDPARAM_TOWNER_ID;

    IF (I_TLIBRARY_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
        
    -- Ajout du STATE pour gestion LEFT JOIN
    SQL_WHERE_LIB=IIF(SQL_WHERE_LIB!='', ' AND (' || SQL_WHERE_LIB || ' OR TLIBRARY.STATE IS NULL)','');
        
    -- On ajoute le critre sur TGEDPARAM.TLIBRARY_ID
    IF (I_TGEDPARAM_TLIBRARY_ID = NULL_PARAM) THEN
        SQL_WHERE_LIB=:SQL_WHERE_LIB || ' AND TGEDPARAM.TLIBRARY_ID IS NULL';
    ELSE
        SQL_WHERE_LIB=:SQL_WHERE_LIB || ' AND TGEDPARAM.TLIBRARY_ID = ' || :I_TGEDPARAM_TLIBRARY_ID;

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;

    -- Ajout du STATE pour gestion LEFT JOIN
    SQL_WHERE_FBSERVER=IIF(SQL_WHERE_FBSERVER!='', ' AND (' || SQL_WHERE_FBSERVER || ' OR TFBSERVER.STATE IS NULL)','');

/*
-- DEBUG
GEDPARAM_COMMENT=:SQL_WHERE_OWNER;
GEDPARAM_COMMENT= GEDPARAM_COMMENT || :SQL_WHERE_LIB;
GEDPARAM_COMMENT= GEDPARAM_COMMENT || :SQL_WHERE_FBSERVER;
SUSPEND;
EXIT;
*/

    I_TGEDPARAM_SECTION=TRIM(I_TGEDPARAM_SECTION);
    I_TGEDPARAM_NAME=TRIM(I_TGEDPARAM_NAME);
    
    -- Init du OWNER par dfaut de la lib
    IF (I_TGEDPARAM_TLIBRARY_ID!=0 AND I_TGEDPARAM_TOWNER_ID=0) THEN
        SELECT TOWNER_ID FROM TLIBRARY WHERE ID=:I_TGEDPARAM_TLIBRARY_ID INTO I_TGEDPARAM_TOWNER_ID;

	FOR
        EXECUTE STATEMENT 
            'SELECT
                TGEDPARAM.ID,
                TGEDPARAM.SECTION,
                COALESCE(TGEDPARAM.NAME,''''),
                TGEDPARAM."TYPE",
				TGEDPARAM."CLASS",
                COALESCE(TGEDPARAM.DEFAULTVALUE,''''),
                IIF(TGEDPARAM.DEFAULTVALUEBLB IS NULL,0,1),
                COALESCE(TGEDPARAM."COMMENT",''''),
				TGEDPARAM.PROTECTION,
                (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)),
                COALESCE(TGEDPARAM.TOWNER_ID, 0),
                COALESCE(TGEDPARAM.TLIBRARY_ID,0),
                COALESCE(TFBSERVER.ID,0),
                COALESCE(TOWNER.STATE,0),
                COALESCE(TLIBRARY.STATE,0),
                COALESCE(TFBSERVER.STATE,0)
            FROM TGEDPARAM 
                LEFT JOIN TOWNER ON TGEDPARAM.TOWNER_ID=TOWNER.ID
                LEFT JOIN TLIBRARY ON TGEDPARAM.TLIBRARY_ID=TLIBRARY.ID
                    LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TGEDPARAM.SECTION =''' || :I_TGEDPARAM_SECTION  || ''' AND COALESCE(TGEDPARAM.NAME,'''')=''' || :I_TGEDPARAM_NAME || '''' ||
            IIF (:SQL_WHERE_OWNER != '', :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_LIB != '' , :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , :SQL_WHERE_FBSERVER, '')
                
        INTO
            :GEDPARAM_ID,
            :GEDPARAM_SECTION,
            :GEDPARAM_NAME,
            :GEDPARAM_TYPE,
			:GEDPARAM_CLASS,
            :GEDPARAM_DEFAULTVALUE,
            :GEDPARAM_DEFAULTVALUEBLB_FILLED,
            :GEDPARAM_COMMENT,
			:GEDPARAM_PROTECTION,
			:GEDPARAM_MODIF_DATE,
            :OWNER_ID,
            :LIBRARY_ID,
            :FBSERVER_ID,
            :OWNER_STATE,
            :LIBRARY_STATE,
            :FBSERVER_STATE
	DO
    BEGIN
		SUSPEND;
        REC_FOUND=:REC_FOUND+1;
    END


    IF (REC_FOUND=0) THEN EXCEPTION EX_NOGEDPARAM;
END ^

ALTER PROCEDURE GET_GEDPARAM_SECTION_OWNER_OK (SECTION VARCHAR(40) CHARACTER SET UTF8)
RETURNS (OK BOOLEAN)
AS 
/*
    Recherche d'une section autorise en ajout pour un GEDPARAM de sous-domaine ou bibliothque
    On rcupre le DOMPARAM DOMAIN/GEDPARAM_SECTIONS_OWNER_CREATE pour connaitre ces sections (liste de nom de section spar par DOMPARAM DOMAIN/MDF_FIELD_SEP)
    Si ce paramtre n'existe pas ou est vide, on renvoie toujours false (ie. aucune section autorise)
    Si la passe section existe dans cette liste, on renvoie 1, sinon 0
    
V40 :
    Cration
*/

BEGIN

    -- Rcupration de la liste des sections autorises
    IF (:SECTION IN (SELECT RESULTS FROM SPLIT_BLOB('SELECT TRIM(DOMPARAM_VALUEBLB) FROM GET_DOMPARAM_VALUEBLB(''DOMAIN'',''GEDPARAM_SECTIONS_OWNER_CREATE'')'))) THEN
        OK=1;
    ELSE
        OK=0;
    SUSPEND;
END ^

ALTER PROCEDURE GET_GEDUSERS_COUNT_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_GEDUSERS_COUNT INTEGER)
AS 
/*
	Nombre de geduser "total" (en fonction des STATES) associs  une LIBRARY donne

V34
    - Cration
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER_COUNT VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;

BEGIN

    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDUSER_COUNT = '';
	ID_OK= Null;
	
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 
        
    /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 
    

    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID FROM
        TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
            LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID || 
        IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
        IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
        IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '')
        INTO ID_OK;
        
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;

    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;

    EXECUTE STATEMENT 
        'SELECT TGEDUSERLIB.TLIBRARY_ID, COUNT(TGEDUSERLIB.TGEDUSER_ID)
        FROM TGEDUSERLIB INNER JOIN TGEDUSER ON TGEDUSERLIB.TGEDUSER_ID=TGEDUSER.ID
        WHERE TGEDUSERLIB.TLIBRARY_ID=' || :I_TLIBRARY_ID
        || IIF (:SQL_WHERE_GEDUSER_COUNT != '' , ' AND (' || :SQL_WHERE_GEDUSER_COUNT || ')', '') || '
        GROUP BY TGEDUSERLIB.TLIBRARY_ID'
    INTO
        :LIBRARY_ID,
        :LIBRARY_GEDUSERS_COUNT;

    SUSPEND;
END ^

ALTER PROCEDURE GET_GEDUSERS_COUNT_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDGROUP_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COUNT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDUSERS_COUNT INTEGER)
AS 
/*
	Nombre de geduser "total" (en fonction des STATES) d'un OWNER/GROUP donn

	Si I_TGEDGROUP_ID = TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL, on renvoie le nombre de GEDUSERS NON associe  un groupe
	Si I_TGEDGROUP_ID = 0, on renvoie le nombre de GEDUSERS du OWNER
	Si I_TGEDGROUP_ID > 0, on renvoie le nombre de GEDUSERS du groupe cibl

V34
    - Cration
    
V40 :
    - Systmatisation des paramtres reprsentant NULL en entre (utilisation de TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL)
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER_COUNT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GROUP VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;

DECLARE VARIABLE NULL_PARAM INTEGER;


BEGIN

    I_TGEDUSER_COUNT_STATE=TRIM(I_TGEDUSER_COUNT_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_GEDUSER_COUNT = '';
	SQL_WHERE_GROUP = '';
	ID_OK= Null;
	
	-- Rcupration du DOM_PARAM reprsentant la recherche de valeur NULL
	NULL_PARAM=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','PARAM_EQUIV_NULL')),-9);
	
    -- Au moins 1 de ces paramtres doit-tre pass
	IF (:I_TOWNER_ID=0 AND (:I_TGEDGROUP_ID=0 OR :I_TGEDGROUP_ID=NULL_PARAM)) THEN EXCEPTION EX_BAD_PARAM;
	
    IF (:I_TOWNER_STATE = '' ) THEN
            /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;

    IF (:I_TOWNER_ID!=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID FROM TOWNER
            WHERE ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO ID_OK;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;
    END
    
    IF (:I_TGEDGROUP_ID=NULL_PARAM) THEN
            SQL_WHERE_GROUP='NOT EXISTS (SELECT TGEDUSER_ID FROM TGEDGROUPUSER WHERE TGEDGROUPUSER.TGEDUSER_ID=TGEDUSER.ID)';
    ELSE
    BEGIN
        IF (:I_TGEDGROUP_ID != 0) THEN
        BEGIN
            ID_OK= Null;
            EXECUTE STATEMENT '
                SELECT TGEDGROUP.ID FROM TGEDGROUP INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
                WHERE TGEDGROUP.ID=' || :I_TGEDGROUP_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
            INTO ID_OK;
            
            IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDGROUP;
            
            SQL_WHERE_GROUP='TGEDGROUPUSER.TGEDGROUP_ID=' || :I_TGEDGROUP_ID;
        END
    END

    IF (:I_TOWNER_ID!=0) THEN 
        SQL_WHERE_OWNER='TGEDUSER.TOWNER_ID=' || :I_TOWNER_ID;
    ELSE
        SQL_WHERE_OWNER='';

    IF (I_TGEDUSER_COUNT_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_COUNT_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER_COUNT;

    EXECUTE STATEMENT 
        'SELECT TGEDUSER.TOWNER_ID, ' ||
        :I_TGEDGROUP_ID || ',
        COALESCE(COUNT(TGEDUSER.ID),0)
        FROM TGEDUSER ' ||
        IIF (:I_TGEDGROUP_ID != 0 AND I_TGEDGROUP_ID!=NULL_PARAM,'INNER JOIN TGEDGROUPUSER ON TGEDUSER.ID = TGEDGROUPUSER.TGEDUSER_ID','') || '
        WHERE 1=1 '
        || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        || IIF (:SQL_WHERE_GEDUSER_COUNT != '' , ' AND (' || :SQL_WHERE_GEDUSER_COUNT || ')', '')
        || IIF (:SQL_WHERE_GROUP != '' , ' AND (' || :SQL_WHERE_GROUP || ')', '') || '
        GROUP BY TGEDUSER.TOWNER_ID'
    INTO
        :OWNER_ID,
        :GEDGROUP_ID,
        :GEDUSERS_COUNT;
    
    -- Retour NULL de la requte, on init avec des valeurs exploitables...
    IF (:OWNER_ID IS NULL) THEN
    BEGIN
        OWNER_ID=I_TOWNER_ID;
        GEDGROUP_ID=I_TGEDGROUP_ID;
        GEDUSERS_COUNT=0;
    END

    SUSPEND;
END ^

ALTER PROCEDURE GET_GEDUSERS_FOR_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TGEDUSER_LOGIN_FILTER VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_NAME_FILTER VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_FIRSTNAME_FILTER VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_MAX_ROWS INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
GEDUSER_ID INTEGER,
GEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
GEDUSER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDUSER_CHARGEABLE BOOLEAN,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
PROFILE_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
GEDUSER_STATE STATE,
CONTACT_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie les Utilisateurs GED  lis  une bibliothque dans la table TGEDUSERLIB
	
MAJ V22 :
    - Ajout informaitons dtailles GEDUSER + CONTACT pour amliorations performances NAS

MAJ V 24 :
    - CONTTYPES_INFOS renvoy en tant que BLOB
    - ORDER BY TGEDUSER.LOGIN

MAJ V32 :
	- Ajout  GEDGROUP_ID
	- Ajout de TCONTACT.ORGANIZATION, etc...

MAJ V34
    - Ajout I_TGEDUSER_LOGIN_FILTER, I_TCONTACT_NAME_FILTER, I_TCONTACT_FIRSTNAME_FILTER, I_MAX_ROWS
    moins important car un grand nombre d'utilisateurs en accs directs  une lib ne devrait pas arriver (puisque c'est cens passer par un groupe...)
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
BEGIN

    I_TGEDUSER_LOGIN_FILTER=TRIM(I_TGEDUSER_LOGIN_FILTER);
    I_TCONTACT_NAME_FILTER=TRIM(I_TCONTACT_NAME_FILTER);
    I_TCONTACT_FIRSTNAME_FILTER=TRIM(I_TCONTACT_FIRSTNAME_FILTER);
    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDUSER = '';
	ID_OK = Null;


    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY et TPROFILE */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;

    -- Utilisateur GED 
    IF (I_TGEDUSER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

	/* Recherche des Utilisateurs */
	FOR EXECUTE STATEMENT '
		SELECT
			TGEDUSERLIB.TLIBRARY_ID,
			TGEDUSERLIB.TGEDUSER_ID,
			COALESCE(TGEDUSERLIB.TPROFILE_ID,0),
			TGEDUSER.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			TLIBRARY.STATE,
			TGEDUSER.STATE,
            TOWNER.STATE,
			COALESCE(TFBSERVER.STATE,0),
			
            -- Ajout V22
			TGEDUSER.LOGIN,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.SUBSCRIBE_END)),
            COALESCE(TGEDUSER."COMMENT",''''),
            TGEDUSER.CHARGEABLE,
			COALESCE(TGEDUSER.TGEDGROUP_ID,0),
  
            COALESCE(TGEDUSER.TCONTACT_ID,0),
			COALESCE(TCONTACT.NAME,''''),
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),

			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),

            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			COALESCE(TCONTACT.STATE,0)
			
		FROM TGEDUSERLIB
            INNER JOIN TGEDUSER ON TGEDUSERLIB.TGEDUSER_ID=TGEDUSER.ID '
                    /*
                    Performance : le LEFT JOIN est trs lent si un critre est pos sur TCONTACT.NAME ou TCONTACT.FIRSTNAME
                    Donc, on positionne un LEFT JOIN si aucun critre ou un INNER JOIN si un critre est pass
                    Fonctionnelement quivalent (si un critre est pass, dans notre contexte, on ne cherche pas un NULL)...
                    */
                    || IIF (:I_TCONTACT_NAME_FILTER != '' OR  :I_TCONTACT_FIRSTNAME_FILTER != '','INNER','LEFT') || ' JOIN TCONTACT ON TGEDUSER.TCONTACT_ID=TCONTACT.ID
            INNER JOIN TLIBRARY  ON TGEDUSERLIB.TLIBRARY_ID=TLIBRARY.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
		WHERE
			TGEDUSERLIB.TLIBRARY_ID=' || :I_TLIBRARY_ID || 
            IIF (:I_TGEDUSER_LOGIN_FILTER != '' ,' AND TGEDUSER.LOGIN LIKE ''' || :I_TGEDUSER_LOGIN_FILTER || '''', '') ||
            IIF (:I_TCONTACT_NAME_FILTER != '' ,' AND TCONTACT.NAME LIKE ''' || :I_TCONTACT_NAME_FILTER || '''', '') ||
            IIF (:I_TCONTACT_FIRSTNAME_FILTER != '' ,' AND TCONTACT.FIRSTNAME LIKE ''' || :I_TCONTACT_FIRSTNAME_FILTER || '''', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '') ||
        ' ORDER BY  ' ||
            IIF (:I_TCONTACT_NAME_FILTER != '' ,
                'TCONTACT.NAME, TCONTACT.FIRSTNAME',
                IIF(:I_TCONTACT_FIRSTNAME_FILTER != '',
                    'TCONTACT.FIRSTNAME, TCONTACT.NAME',
                    'TGEDUSER.LOGIN'
                )
             ) || ' ' ||
        IIF (:I_MAX_ROWS != 0 ,'ROWS 1 TO '|| :I_MAX_ROWS,'')
        
		INTO
			:LIBRARY_ID,
			:GEDUSER_ID,
			:PROFILE_ID,
			:OWNER_ID,
			:FBSERVER_ID,
			:LIBRARY_STATE,
			:GEDUSER_STATE,
			:OWNER_STATE,
			:FBSERVER_STATE,

			-- Ajout V22
            :GEDUSER_LOGIN,
            :GEDUSER_CREATE_DATE,
            :GEDUSER_MODIF_DATE,
            :GEDUSER_SUBSCRIBE_START,
            :GEDUSER_SUBSCRIBE_END,
            :GEDUSER_COMMENT,
            :GEDUSER_CHARGEABLE,
			:GEDUSER_GEDGROUP_ID,

            :CONTACT_ID,
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			:CONTACT_STATE 			
			
			
	DO
	BEGIN
        SELECT CONTTYPES_INFOS FROM GET_CONTTYPE_MDF(:CONTACT_ID) INTO :CONTTYPES_INFOS;
		SUSPEND;
    END
END ^

ALTER PROCEDURE GET_GEDUSERS_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDGROUP_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_LOGIN_FILTER VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_NAME_FILTER VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_FIRSTNAME_FILTER VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_MAX_ROWS INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDGROUP_ID INTEGER,
GEDUSER_ID INTEGER,
GEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
GEDUSER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDUSER_CHARGEABLE BOOLEAN,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
PROFILE_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
OWNER_STATE STATE,
GEDUSER_STATE STATE,
CONTACT_STATE STATE)
AS 
/*
	Renvoie la liste des Utilisateurs GED associs  un Propritaire ou  un Groupe...

	
	V34 : volutions pour renvoyer les membres d'un groupe, de la manire suivante :
	- Renomme de GET_GEDUSERS_FOR_OWNER en GET_GEDUSERS_FOR_OWNER_OR_GROUP
	- I_TGEDGROUP_ID > 0 : on renvoie les membres du groupe vis
	- I_TGEDGROUP_ID = 0 : on ne tient pas compte du paramtre (ie. on traite les GEDUSER par rapport aux OWNER)
	- I_TGEDGROUP_ID = TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL : On recherche les GEDUSER qui ne sont membres d'aucun groupe (ie, pas d'association prsente dans TGEDGROUPUSER)

    On doit au moins passer soit un OWNER_ID (ignor si GEDGROUP_ID>0), soit un GEDGROUP_ID (erreur BAD_PARAM dans le cas contraire)
    La requte est construite dynamiquement (et optimise ;-) ), en fonction des diffrents paramtres

MAJ V22 :
    Ajout des informations dtailles GEDUSER et CONTACT pour gain de performance NAS

MAJ V 24 :
    - CONTTYPES_INFOS renvoy en tant que BLOB
    - ORDER BY TGEDUSER.LOGIN

MAJ V32 :
	- Ajout  GEDGROUP_ID
	- Ajout de TCONTACT.ORGANIZATION, etc...

MAJ V34
    - Ajout I_TGEDUSER_LOGIN_FILTER, I_TCONTACT_NAME_FILTER, I_TCONTACT_FIRSTNAME_FILTER, I_MAX_ROWS
    - Traitements pour rcupration des membres de groupe
	- GEDGROUP_ID renomm GEDUSER_GEDGROUP_ID en sortie

V40 :
    - Systmatisation des paramtres reprsentant NULL en entre (utilisation de TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL)

*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_QUERY VARCHAR(8000);
DECLARE VARIABLE SQL_QUERY VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;

DECLARE VARIABLE NULL_PARAM INTEGER;

BEGIN

    I_TGEDUSER_LOGIN_FILTER=TRIM(I_TGEDUSER_LOGIN_FILTER);
    I_TCONTACT_NAME_FILTER=TRIM(I_TCONTACT_NAME_FILTER);
    I_TCONTACT_FIRSTNAME_FILTER=TRIM(I_TCONTACT_FIRSTNAME_FILTER);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_GEDUSER = '';
	ID_OK= Null;

	-- dummy pour faciliter les concatnations
	SQL_WHERE_QUERY = '1=1';

	-- Rcupration du DOM_PARAM reprsentant la recherche de valeur NULL
	NULL_PARAM=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','PARAM_EQUIV_NULL')),-9);
	
    -- Au moins 1 de ces paramtres doit-tre pass
    IF (:I_TOWNER_ID=0 AND (:I_TGEDGROUP_ID=0 OR :I_TGEDGROUP_ID=NULL_PARAM)) THEN EXCEPTION EX_BAD_PARAM;

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;

    IF (:I_TOWNER_ID!=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID FROM TOWNER
            WHERE ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
            INTO ID_OK;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;
    END
	
	IF (:I_TGEDGROUP_ID>0) THEN
	BEGIN
        ID_OK= Null;
        EXECUTE STATEMENT '
            SELECT TGEDGROUP.ID FROM TGEDGROUP INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
            WHERE TGEDGROUP.ID=' || :I_TGEDGROUP_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO ID_OK;
        
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDGROUP;
        
    END

    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;

    -- Query de base
    SQl_QUERY= '
		SELECT
			TGEDUSER.TOWNER_ID, ' ||
			:I_TGEDGROUP_ID || ',
			TGEDUSER.ID,
            COALESCE(TGEDUSER.TPROFILE_ID,0),
			TOWNER.STATE AS TOWNER_STATE,
			TGEDUSER.STATE,

            -- Ajout V22
			TGEDUSER.LOGIN,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.SUBSCRIBE_END)),
            COALESCE(TGEDUSER."COMMENT",''''),
            TGEDUSER.CHARGEABLE,
			COALESCE(TGEDUSER.TGEDGROUP_ID,0),
  
            COALESCE(TGEDUSER.TCONTACT_ID,0),
			COALESCE(TCONTACT.NAME,''''),
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),

			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),

            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			COALESCE(TCONTACT.STATE,0)

		FROM
			TGEDUSER
                LEFT OUTER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID '
                    /*
                    Performance : le LEFT JOIN est trs lent si un critre est pos sur TCONTACT.NAME ou TCONTACT.FIRSTNAME
                    Donc, on positionne un LEFT JOIN si aucun critre ou un INNER JOIN si un critre est pass
                    Fonctionnelement quivalent (si un critre est pass, dans notre contexte, on ne cherche pas un NULL)...
                    */
                    || IIF (:I_TCONTACT_NAME_FILTER != '' OR  :I_TCONTACT_FIRSTNAME_FILTER != '','INNER','LEFT') || ' JOIN TCONTACT ON TGEDUSER.TCONTACT_ID=TCONTACT.ID ';

    
    -- Chaine de critres
    
    -- On ne s'occupe du OWNER que si il est explicitement pass
    SQL_WHERE_QUERY= SQL_WHERE_QUERY || IIF(:I_TOWNER_ID!=0 ,' AND TGEDUSER.TOWNER_ID=' || :I_TOWNER_ID,'');

    IF (:I_TGEDGROUP_ID!=0) THEN
        -- Beaucoup plus performant qu'un JOIN...
        SQL_WHERE_QUERY= SQL_WHERE_QUERY || -- IIF(:SQL_WHERE_QUERY!='', ' AND ' ,'') || 
            IIF(:I_TGEDGROUP_ID=NULL_PARAM,
                ' AND TGEDUSER.ID NOT IN (SELECT TGEDGROUPUSER.TGEDUSER_ID FROM TGEDGROUPUSER WHERE TGEDGROUPUSER.TGEDUSER_ID=TGEDUSER.ID)',
                ' AND TGEDUSER.ID IN (SELECT TGEDGROUPUSER.TGEDUSER_ID FROM TGEDGROUPUSER WHERE TGEDGROUPUSER.TGEDGROUP_ID=' || :I_TGEDGROUP_ID || ')'
            );
    /*
    IF (:I_TGEDGROUP_ID>0) THEN SQL_WHERE_QUERY=:SQL_WHERE_QUERY || IIF(:SQL_WHERE_QUERY!='', ' AND ' ,'') || 'TGEDGROUPUSER.TGEDGROUP_ID=' || :I_TGEDGROUP_ID;
    IF (:I_TGEDGROUP_ID=-1) THEN SQL_WHERE_QUERY=:SQL_WHERE_QUERY || IIF(:SQL_WHERE_QUERY!='', ' AND ' ,'') || 'TGEDGROUPUSER.TGEDGROUP_ID IS NULL';
    */
    SQL_WHERE_QUERY=:SQL_WHERE_QUERY || 
        IIF (:I_TGEDUSER_LOGIN_FILTER != '' ,' AND TGEDUSER.LOGIN LIKE ''' || :I_TGEDUSER_LOGIN_FILTER || '''', '') ||
        IIF (:I_TCONTACT_NAME_FILTER != '' ,' AND TCONTACT.NAME LIKE ''' || :I_TCONTACT_NAME_FILTER || '''', '') ||
        IIF (:I_TCONTACT_FIRSTNAME_FILTER != '' ,' AND TCONTACT.FIRSTNAME LIKE ''' || :I_TCONTACT_FIRSTNAME_FILTER || '''', '') ||
        IIF (:SQL_WHERE_GEDUSER != '' , ' AND (' || :SQL_WHERE_GEDUSER || ')', '');


                    
        SQL_QUERY=:SQL_QUERY || '
            WHERE ' || :SQL_WHERE_QUERY;

        SQL_QUERY=:SQL_QUERY || '
         ORDER BY  ' ||
            IIF (:I_TCONTACT_NAME_FILTER != '' ,
                'TCONTACT.NAME, TCONTACT.FIRSTNAME',
                IIF(:I_TCONTACT_FIRSTNAME_FILTER != '',
                    'TCONTACT.FIRSTNAME, TCONTACT.NAME',
                    'TGEDUSER.LOGIN'
                )
             ) || ' ' ||
        IIF (:I_MAX_ROWS != 0 ,'ROWS 1 TO '|| :I_MAX_ROWS,'');

/*
    -- DEBUG
    GEDUSER_COMMENT=:SQL_QUERY;
    SUSPEND;
    EXIT;
*/    

	/* Recherche des Utilisateurs GED */
	FOR EXECUTE STATEMENT
        :SQL_QUERY
        
		INTO
			:OWNER_ID,
			:GEDGROUP_ID,
			:GEDUSER_ID,
			:PROFILE_ID,
			:OWNER_STATE,
			:GEDUSER_STATE,
			
			-- Ajout V22
            :GEDUSER_LOGIN,
            :GEDUSER_CREATE_DATE,
            :GEDUSER_MODIF_DATE,
            :GEDUSER_SUBSCRIBE_START,
            :GEDUSER_SUBSCRIBE_END,
            :GEDUSER_COMMENT,
            :GEDUSER_CHARGEABLE,
			:GEDUSER_GEDGROUP_ID,

            :CONTACT_ID,
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			:CONTACT_STATE 			
	DO
	BEGIN
        SELECT CONTTYPES_INFOS FROM GET_CONTTYPE_MDF(:CONTACT_ID) INTO :CONTTYPES_INFOS;
		SUSPEND;
    END
END ^

ALTER PROCEDURE GET_GEDUSER_ID (I_TOWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDUSER_PASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
OWNER_ID INTEGER,
PROFILE_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
GEDGROUP_PROFILE_ID INTEGER,
CONTACT_ID INTEGER,
GEDUSER_STATE STATE)
AS 
/*
	Recherche d'un code identifiant d'utilisateur GED dans la table "TGEDUSER"

	Attention : les GED_LOGIN sont uniques pour CHAQUE OWNER
	Il faut donc passer le OWNER_SUBDOMAIN  cette procdure afin qu'elle puisse identifier un GEDUSER_LOGIN
	par rapport  un OWNER donn...

    Attend :
	- I_TGEDUSER_LOGIN : Login d'un utilisateur GED
	- I_TGEDUSER_PASSWD : password (hach SHA2556) d'un utilisateur
	- GEDUSER_STATE/OWNER_STATE : voir documentation STATE


	Des erreurs sont leves si le login et/ou le password sont incorrect...

MAJ V12 :
	- GED_LOGIN/GED_PASSWD ==> LOGIN/PASSWD
	
MAJ V22 :
    - PASSWD non obligatoire en entre et test seulement sur LOGIN si PASSWD non pass

MAJ V32 :
	- Ajout  GEDGROUP_ID + GEDGROUP_PROFILE_ID
	
- MAJ V34
    - GEDGROUP_ID renomm GEDUSER_GEDGROUP_ID en sortie

*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE PASSWD VARCHAR(100); 

BEGIN

    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    
    SQL_WHERE_OWNER = '';
    SQL_WHERE_GEDUSER = '';

    
    IF (:I_TOWNER_STATE ='' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;

    /* Nettoyage des paramtres */
    I_TOWNER_SUBDOMAIN = TRIM(I_TOWNER_SUBDOMAIN);
    I_TGEDUSER_LOGIN = TRIM(I_TGEDUSER_LOGIN);
    I_TGEDUSER_PASSWD = TRIM(UPPER(I_TGEDUSER_PASSWD));

	EXECUTE STATEMENT 
        'SELECT
            TGEDUSER.ID,
            TGEDUSER.PASSWD,
            COALESCE(TGEDUSER.TPROFILE_ID,0),
			COALESCE(TGEDUSER.TGEDGROUP_ID,0),
			COALESCE(TGEDGROUP.TPROFILE_ID,0),
            COALESCE(TGEDUSER.TCONTACT_ID,0),
            TGEDUSER.STATE,
            TOWNER.ID
		FROM TGEDUSER
			INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
			LEFT JOIN TGEDGROUP ON TGEDUSER.TGEDGROUP_ID=TGEDGROUP.ID
        WHERE TGEDUSER.LOGIN =''' || :I_TGEDUSER_LOGIN || ''' AND TOWNER.SUBDOMAIN=''' || :I_TOWNER_SUBDOMAIN || '''' ||
			IIF (SQL_WHERE_OWNER != '',' AND ' || SQL_WHERE_OWNER, '') ||
			IIF (SQL_WHERE_GEDUSER != '',' AND ' || SQL_WHERE_GEDUSER, '')
		INTO
            :GEDUSER_ID,
            :PASSWD,
            :PROFILE_ID,
			:GEDUSER_GEDGROUP_ID,
			:GEDGROUP_PROFILE_ID,
            :CONTACT_ID,
            :GEDUSER_STATE,
            :OWNER_ID;

    -- Non trouv...
    IF (:GEDUSER_ID IS NULL) THEN EXCEPTION EX_BAD_GED_LOGIN;

	IF (I_TGEDUSER_PASSWD!='' AND UPPER(:PASSWD)!=UPPER(:I_TGEDUSER_PASSWD)) THEN EXCEPTION EX_BAD_DOM_PASSWD;
		
	/* Ici, tout est ok, on renvoit donc l'ID et le flag d'activit */
	SUSPEND;
		
END ^

ALTER PROCEDURE GET_GEDUSER_INFOS (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
GEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
GEDUSER_PASSWD VARCHAR(100) CHARACTER SET UTF8,
GEDUSER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
GEDUSER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
GEDUSER_CHARGEABLE BOOLEAN,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
OWNER_ID INTEGER,
PROFILE_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
GEDGROUP_PROFILE_ID INTEGER,
GEDUSER_STATE STATE,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
/*
	Renvoie les informations dtailles sur un Utilisateur GED...

MAJ V12 :
	- GED_LOGIN ==> LOGIN (interne)
	
V16 :
    - Ajout de GEDUSER_PASSWD (pour vrification mot de passe pralable  une modification de mot de passe)
    
V22 :
    - Ajout informations dtailles CONTACT pour amliorations performances NAS

MAJ V 24 :
    - CONTTYPES_INFOS renvoy en tant que BLOB

MAJ V32 :
	- Ajout  GEDGROUP_ID
	- Ajout de TCONTACT.ORGANIZATION, etc...
	
MAJ V34 :
    - GEDGROUP_ID renomm GEDUSER_GEDGROUP_ID en sortie

*/
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE REC_FOUND INTEGER;

BEGIN

    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

	REC_FOUND=0;
	SQL_WHERE_GEDUSER='';
	SQL_WHERE_OWNER='';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;

    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;

    /* Recherche des utlisateurs */
    FOR EXECUTE STATEMENT '
        SELECT
            TGEDUSER.ID,
			TGEDUSER.LOGIN,
			TGEDUSER.PASSWD,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDUSER.SUBSCRIBE_END)),
            COALESCE(TGEDUSER."COMMENT",''''),
            TGEDUSER.CHARGEABLE,
            TGEDUSER.TOWNER_ID,
            COALESCE(TGEDUSER.TPROFILE_ID,0),
			COALESCE(TGEDUSER.TGEDGROUP_ID,0),
			COALESCE(TGEDGROUP.TPROFILE_ID,0),
            COALESCE(TGEDUSER.TCONTACT_ID,0),
            TGEDUSER.STATE,
            TOWNER.STATE,
            
            -- Ajout V22
			COALESCE(TCONTACT.NAME,''''),
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),

			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),

            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			COALESCE(TCONTACT.STATE,0)
            
        FROM TGEDUSER
            INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
            LEFT JOIN TCONTACT ON TGEDUSER.TCONTACT_ID=TCONTACT.ID
			LEFT JOIN TGEDGROUP ON TGEDUSER.TGEDGROUP_ID=TGEDGROUP.ID
        WHERE
            TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_GEDUSER != '' , ' AND (' || :SQL_WHERE_GEDUSER || ')', '') ||
            IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO
            :GEDUSER_ID,
            :GEDUSER_LOGIN,
            :GEDUSER_PASSWD,
            :GEDUSER_CREATE_DATE,
            :GEDUSER_MODIF_DATE,
            :GEDUSER_SUBSCRIBE_START,
            :GEDUSER_SUBSCRIBE_END,
            :GEDUSER_COMMENT,
            :GEDUSER_CHARGEABLE,
            :OWNER_ID,
            :PROFILE_ID,
			:GEDUSER_GEDGROUP_ID,
			:GEDGROUP_PROFILE_ID,
            :CONTACT_ID,
            :GEDUSER_STATE,
            :OWNER_STATE,
            
            -- Ajout V22
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			:CONTACT_STATE 			
            
    DO
    BEGIN
        REC_FOUND=:REC_FOUND+1;
        SELECT CONTTYPES_INFOS FROM GET_CONTTYPE_MDF(:CONTACT_ID) INTO :CONTTYPES_INFOS;
        SUSPEND;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOGEDUSER;
END ^

ALTER PROCEDURE GET_LASTSYNC_MDF (I_TLIBRARY_ID INTEGER NOT NULL)
RETURNS (LOGSYNCS_INFOS BLOB CHARACTER SET UTF8)
AS 
/*
    Retourne une chaine contenant la concatnation des informations de synchro pour des synchros donnees 
    pour la dernire synchronisation ayant t effectue pour une bibliothque donnes

- V24 : 
	- Cration

MAJ V25
	- Optimisation performance (modifs TLIBRARY)
*/
DECLARE VARIABLE LOGSYNC_ID INTEGER;

BEGIN
    SELECT TLIBRARY.TLOGSYNC_ID FROM TLIBRARY WHERE TLIBRARY.ID=:I_TLIBRARY_ID INTO LOGSYNC_ID;
    -- Pas de synchro ralise, on renvoie ''
    IF (LOGSYNC_ID IS NULL) THEN
        LOGSYNCS_INFOS='';
    ELSE
        SELECT LOGSYNCS_INFOS FROM GET_LOGSYNC_MDF(:LOGSYNC_ID) INTO LOGSYNCS_INFOS;

    SUSPEND;
END ^

ALTER PROCEDURE GET_LIBRARIES (I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
PROFILE_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
    Renvoie les informations associes  toutes les bibliothques

    Il est possible qu'il y en ai aucune (pas de librairie visible)
    ==> recordset vide

    Attend :
    - STATE (voir documentation sur ce point)
      
MAJ V13:
	- Ajout LIBRARY_GUID
	
MAJ V24 :
    - SIZE_MB BIGINT
	- Ajout LASTSYNC_INFOS

MAV V 25
    - Ajout LOGSYNC_ID

MAJ V31 :
	- Ajout ACCESS_MODE

MAJ V32:
	- Ajout LISTORDER

MAJ V 36
    - LIBRARY_SIZE_MB_ORG en sortie

-V40
	GUID VARCHAR(40) => VARCHAR(255)
	Ajout TLIBRARY.VERSION

*/
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);

BEGIN

    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

    SQL_WHERE_LIB = '';
	SQL_WHERE_OWNER = '';
	SQL_WHERE_FBSERVER = '';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER; 

    IF (:I_TLIBRARY_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB;


    /* Recherche des bibliothques et des serveurs associs */
    FOR EXECUTE STATEMENT '
        SELECT
			TLIBRARY.ID,
            COALESCE(TLIBRARY."COMMENT",''''),
			COALESCE((SELECT LIBRARY_CONNECT FROM GET_LIBRARY_CONNECT(TLIBRARY.ID)),'''') AS PATH,            
            COALESCE(TLIBRARY.TITLE,''''),
            COALESCE(TLIBRARY.GUID, ''''),
            COALESCE(TLIBRARY.VERSION, 0),
            COALESCE(TLIBRARY.DBPATH,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_END)),
			TLIBRARY.ACCESS_MODE,
            COALESCE(TLIBRARY.ACCESS_TYPE,0),
            TLIBRARY.CHARGEABLE,
            COALESCE(TLIBRARY.SIZE_MB,0),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.LAST_SIZE_CHECK)),
            COALESCE(TLIBRARY.SIZE_MB_ORG,0),
            TLIBRARY.TOWNER_ID,
            COALESCE(TLIBRARY.TFBSERVER_ID,0),
            COALESCE(TLIBRARY.TPROFILE_ID,0),
            COALESCE(TFBSERVER.STATE,0),
            TLIBRARY.STATE AS LIBRARY_STATE,
            TOWNER.STATE AS OWNER_STATE,
            
            -- Ajout V25
            COALESCE(TLIBRARY.TLOGSYNC_ID,0),

			-- Ajout V32
            COALESCE(TLIBRARY.LISTORDER,0)
			

        FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID '
        -- WHERE "bidon" pour simplification des traietments des aautres critres (AND ...)
        || ' WHERE (1=1)' ||
			IIF (:SQL_WHERE_LIB != '' , ' AND (' || :SQL_WHERE_LIB || ')', '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||              
            IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '') 
        || ' ORDER BY TLIBRARY.TITLE'
        INTO
            :LIBRARY_ID,
            :LIBRARY_COMMENT,
            :LIBRARY_CONNECT,
            :LIBRARY_TITLE,
            :LIBRARY_GUID,
			-- Ajout V40
			:LIBRARY_VERSION,
            :LIBRARY_DBPATH,
            :LIBRARY_CREATE_DATE,
            :LIBRARY_MODIF_DATE,
            :LIBRARY_SUBSCRIBE_START,
            :LIBRARY_SUBSCRIBE_END,

            :LIBRARY_ACCESS_MODE,
            :LIBRARY_ACCESS_TYPE,
            :LIBRARY_CHARGEABLE,
            :LIBRARY_SIZE_MB,
            :LIBRARY_LAST_SIZE_CHECK,
            :LIBRARY_SIZE_MB_ORG,
            :OWNER_ID,
            :FBSERVER_ID,
			:PROFILE_ID,
            :FBSERVER_STATE,
            :LIBRARY_STATE,
            :OWNER_STATE,
            -- Ajout en V25
            :LOGSYNC_ID,
			-- Ajout V32
			:LIBRARY_LISTORDER
            
	DO
    BEGIN
        SELECT LOGSYNCS_INFOS FROM GET_LASTSYNC_MDF(:LIBRARY_ID) INTO :LASTSYNC_INFOS;
        SUSPEND;
    END

END ^

ALTER PROCEDURE GET_LIBRARIES_FOR_FBSERVER (I_TFBSERVER_ID INTEGER NOT NULL,
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (FBSERVER_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
OWNER_ID INTEGER,
PROFILE_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
FBSERVER_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE)
AS 
/*
	Renvoie la liste des bilbiothques associes  un serveur Firebird

	Il est possible qu'il y en ai aucune (pas de librairie visible/active pour 1 propritaire ou un serveur FB donn)
	==> recordset vide

	Attend :
	- I_TFBSERVER_ID : un code numrique identifiant de Serveur (FK TFBSERVER)
	- OWNER_STATE : Etat particulier du owner (0 ==> actif par dfaut)
	- LIBRARY_STATE : critre de slection Etat de library
	- I_TFBSERVER_STATE : critre de slection  tat de serveur FB

MAJ V22 :
    - Ajout des informations dtailles LIB pour gain de performance NAS

MAJ V24
	- ORDER BY TLIBRARY.TITLE (au lieu de ID)
    - SIZE_MB BIGINT
	- Ajout LASTSYNC_INFOS

MAV V 25
    - Ajout LOGSYNC_ID

MAJ V31 :
	- Ajout ACCESS_MODE

V32 :
	- Ajout LISTORDER
	
MAJ V 36
    - LIBRARY_SIZE_MB_ORG en sortie

-V40
	GUID VARCHAR(40) => VARCHAR(255)
	Ajout TLIBRARY.VERSION


*/
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    
    /* construction des WHERE */
    SQL_WHERE_OWNER = '';
    SQL_WHERE_LIB = '';
    SQL_WHERE_FBSERVER='';

	ID_OK = Null;
    
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER; 

    EXECUTE STATEMENT '
        SELECT ID FROM TFBSERVER
        WHERE ID=' || :I_TFBSERVER_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_FBSERVER || ')', '')
        INTO ID_OK;
        
	IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOFBSER;

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    IF (:I_TLIBRARY_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 
    


	/* Recherche des bibliothques et des serveurs associs */
	FOR EXECUTE STATEMENT '
		SELECT
			TLIBRARY.ID,
            TLIBRARY.STATE AS TLIBRARY_STATE,
			TLIBRARY.TOWNER_ID,
			TOWNER.STATE AS TOWNER_STATE,
			TLIBRARY.TFBSERVER_ID,
            TFBSERVER.STATE,
            COALESCE(TLIBRARY.TPROFILE_ID,0),

            -- Ajout en V22
            COALESCE(TLIBRARY."COMMENT",''''),
			COALESCE((SELECT LIBRARY_CONNECT FROM GET_LIBRARY_CONNECT(TLIBRARY.ID)),'''') AS PATH,
            COALESCE(TLIBRARY.TITLE,''''),
            COALESCE(TLIBRARY.GUID, ''''),
            COALESCE(TLIBRARY.VERSION, 0),
            COALESCE(TLIBRARY.DBPATH,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_END)),
			TLIBRARY.ACCESS_MODE,
            COALESCE(TLIBRARY.ACCESS_TYPE,0),
            TLIBRARY.CHARGEABLE,
            COALESCE(TLIBRARY.SIZE_MB,0),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.LAST_SIZE_CHECK)),
            COALESCE(TLIBRARY.SIZE_MB_ORG,0),

            -- Ajout V25
            COALESCE(TLIBRARY.TLOGSYNC_ID,0),

			-- Ajout V32
            COALESCE(TLIBRARY.LISTORDER,0)


            
		FROM
			TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID INNER JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TLIBRARY.TFBSERVER_ID=' || :I_TFBSERVER_ID ||
			IIF (:SQL_WHERE_LIB != '' , ' AND (' || :SQL_WHERE_LIB || ')', '') ||
			IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '') ||
            ' ORDER BY TLIBRARY.TITLE'
		INTO
			:LIBRARY_ID,
			:LIBRARY_STATE,
			:OWNER_ID,
			:OWNER_STATE,
			:FBSERVER_ID,
			:FBSERVER_STATE,
			:PROFILE_ID,
			
			-- Ajouts en version 22
            :LIBRARY_COMMENT,
            :LIBRARY_CONNECT,
            :LIBRARY_TITLE,
            :LIBRARY_GUID,
			-- Ajout V40
			:LIBRARY_VERSION,
            :LIBRARY_DBPATH,
            :LIBRARY_CREATE_DATE,
            :LIBRARY_MODIF_DATE,
            :LIBRARY_SUBSCRIBE_START,
            :LIBRARY_SUBSCRIBE_END,
			:LIBRARY_ACCESS_MODE,
            :LIBRARY_ACCESS_TYPE,
            :LIBRARY_CHARGEABLE,
            :LIBRARY_SIZE_MB,
            :LIBRARY_LAST_SIZE_CHECK,
            :LIBRARY_SIZE_MB_ORG,

            -- Ajout en V25
            :LOGSYNC_ID,

			-- Ajout en V32
			:LIBRARY_LISTORDER
			
	DO
	BEGIN
        SELECT LOGSYNCS_INFOS FROM GET_LASTSYNC_MDF(:LIBRARY_ID) INTO :LASTSYNC_INFOS;
		SUSPEND;
    END

END ^

ALTER PROCEDURE GET_LIBRARIES_FOR_GEDGROUP (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (GEDGROUP_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
GEDUSER_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie les bibliothques lies  un Groupe d'utilisateur GED dans la table TGEDGROUPLIB
	
- V32
	- Cration

MAJ V 36
    - LIBRARY_SIZE_MB_ORG en sortie

-V40
	GUID VARCHAR(40) => VARCHAR(255)
	Ajout TLIBRARY.VERSION

*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	ID_OK = Null;


    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY et TPROFILE */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    /* Existence/visibilit du groupe d'utilisateur GED lui-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TGEDGROUP.ID
		FROM TGEDGROUP INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
        WHERE TGEDGROUP.ID=' || :I_TGEDGROUP_ID ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') 
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDGROUP;

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

	/* Recherche des Bibliothques */
	FOR EXECUTE STATEMENT '
		SELECT
			TGEDGROUPLIB.TLIBRARY_ID,
			TGEDGROUPLIB.TGEDGROUP_ID,
			COALESCE(TGEDGROUPLIB.TPROFILE_ID,0),
			TGEDGROUP.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			TLIBRARY.STATE,
            TOWNER.STATE,
			COALESCE(TFBSERVER.STATE,0),
			
            COALESCE(TLIBRARY."COMMENT",''''),
			COALESCE((SELECT LIBRARY_CONNECT FROM GET_LIBRARY_CONNECT(TLIBRARY.ID)),'''') AS PATH,
            COALESCE(TLIBRARY.TITLE,''''),
            COALESCE(TLIBRARY.GUID, ''''),
            COALESCE(TLIBRARY.VERSION, 0),
            COALESCE(TLIBRARY.DBPATH,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_END)),
			TLIBRARY.ACCESS_MODE,
            COALESCE(TLIBRARY.ACCESS_TYPE,0),
            TLIBRARY.CHARGEABLE,
			COALESCE(TLIBRARY.LISTORDER,0),
            COALESCE(TLIBRARY.SIZE_MB,0),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.LAST_SIZE_CHECK)),
            COALESCE(TLIBRARY.SIZE_MB_ORG,0),

            -- Ajout V25
            COALESCE(TLIBRARY.TLOGSYNC_ID,0)
            
            			
		FROM TGEDGROUPLIB INNER JOIN TGEDGROUP ON TGEDGROUPLIB.TGEDGROUP_ID=TGEDGROUP.ID
            INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
            INNER JOIN TLIBRARY  ON TGEDGROUPLIB.TLIBRARY_ID=TLIBRARY.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TGEDGROUPLIB.TGEDGROUP_ID=' || :I_TGEDGROUP_ID || 
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
        '
        ORDER BY TLIBRARY.LISTORDER, TLIBRARY.TITLE '
		INTO
			:LIBRARY_ID,
			:GEDGROUP_ID,
			:PROFILE_ID,
			:OWNER_ID,
			:FBSERVER_ID,
			:LIBRARY_STATE,
			:OWNER_STATE,
			:FBSERVER_STATE,
			-- Ajouts en version 22
            :LIBRARY_COMMENT,
            :LIBRARY_CONNECT,
            :LIBRARY_TITLE,
            :LIBRARY_GUID,
			-- Ajout V40
			:LIBRARY_VERSION,
            :LIBRARY_DBPATH,
            :LIBRARY_CREATE_DATE,
            :LIBRARY_MODIF_DATE,
            :LIBRARY_SUBSCRIBE_START,
            :LIBRARY_SUBSCRIBE_END,
			:LIBRARY_ACCESS_MODE,
            :LIBRARY_ACCESS_TYPE,
            :LIBRARY_CHARGEABLE,
			:LIBRARY_LISTORDER,
            :LIBRARY_SIZE_MB,
            :LIBRARY_LAST_SIZE_CHECK,
            :LIBRARY_SIZE_MB_ORG,
            -- Ajout en V25
            :LOGSYNC_ID
			
	DO
	BEGIN
        SELECT LOGSYNCS_INFOS FROM GET_LASTSYNC_MDF(:LIBRARY_ID) INTO :LASTSYNC_INFOS;	
		SUSPEND;
    END
END ^

ALTER PROCEDURE GET_LIBRARIES_FOR_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
GEDUSER_GEDGROUP_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
GEDUSER_STATE STATE,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie les bibliothques lies  un utilisateur GED dans la table TGEDUSERLIB
	
MAJ V22 :
    - Ajout des colonnes dtails de bibliothques


MAJ V24
	- ORDER BY TLIBRARY.TITLE (au lieu de TGEDUSER.ID)
    - SIZE_MB BIGINT
	- Ajout LASTSYNC_INFOS

MAV V 25
    - Ajout LOGSYNC_ID

MAJ V31 :
	- Ajout ACCESS_MODE

MAJ V32 :
	- Ajout de ORDER + Tri sur ORDER...
	- Ajout GEDGROUP_ID
	
- MAJ V34
    - GEDGROUP_ID renomm GEDUSER_GEDGROUP_ID en sortie 

- MAJ V36
    - LIBRARY_SIZE_MB_ORG en sortie

-V40
	GUID VARCHAR(40) => VARCHAR(255)
	Ajout TLIBRARY.VERSION
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDUSER = '';
	ID_OK = Null;


    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY et TPROFILE */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    -- Utilisateur GED 
    IF (I_TGEDUSER_STATE = '') THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 


    /* Existence/visibilit de l'utilisateur GED lui-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TGEDUSER.ID
		FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

	/* Recherche des Bibliothques */
	FOR EXECUTE STATEMENT '
		SELECT
			TGEDUSERLIB.TLIBRARY_ID,
			TGEDUSERLIB.TGEDUSER_ID,
			COALESCE(TGEDUSERLIB.TPROFILE_ID,0),
			-- Ajout V32
			COALESCE(TGEDUSER.TGEDGROUP_ID,0),
			TGEDUSER.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			TLIBRARY.STATE,
			TGEDUSER.STATE,
            TOWNER.STATE,
			COALESCE(TFBSERVER.STATE,0),
			
            COALESCE(TLIBRARY."COMMENT",''''),
			COALESCE((SELECT LIBRARY_CONNECT FROM GET_LIBRARY_CONNECT(TLIBRARY.ID)),'''') AS PATH,
            COALESCE(TLIBRARY.TITLE,''''),
            COALESCE(TLIBRARY.GUID, ''''),
            COALESCE(TLIBRARY.VERSION, 0),
            COALESCE(TLIBRARY.DBPATH,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_END)),
			TLIBRARY.ACCESS_MODE,
            COALESCE(TLIBRARY.ACCESS_TYPE,0),
            TLIBRARY.CHARGEABLE,
			-- Ajout V32
            COALESCE(TLIBRARY.LISTORDER,0),
            COALESCE(TLIBRARY.SIZE_MB,0),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.LAST_SIZE_CHECK)),
            COALESCE(TLIBRARY.SIZE_MB_ORG,0),

            -- Ajout V25
            COALESCE(TLIBRARY.TLOGSYNC_ID,0)
            
            			
		FROM TGEDUSERLIB INNER JOIN TGEDUSER ON TGEDUSERLIB.TGEDUSER_ID=TGEDUSER.ID
            INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
            INNER JOIN TLIBRARY  ON TGEDUSERLIB.TLIBRARY_ID=TLIBRARY.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TGEDUSERLIB.TGEDUSER_ID=' || :I_TGEDUSER_ID || 
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
        '
        ORDER BY TLIBRARY.LISTORDER, TLIBRARY.TITLE '
		INTO
			:LIBRARY_ID,
			:GEDUSER_ID,
			:PROFILE_ID,
			:GEDUSER_GEDGROUP_ID,
			:OWNER_ID,
			:FBSERVER_ID,
			:LIBRARY_STATE,
			:GEDUSER_STATE,
			:OWNER_STATE,
			:FBSERVER_STATE,
			-- Ajouts en version 22
            :LIBRARY_COMMENT,
            :LIBRARY_CONNECT,
            :LIBRARY_TITLE,
			-- Ajout V40
            :LIBRARY_GUID,
            :LIBRARY_VERSION,
            :LIBRARY_DBPATH,
            :LIBRARY_CREATE_DATE,
            :LIBRARY_MODIF_DATE,
            :LIBRARY_SUBSCRIBE_START,
            :LIBRARY_SUBSCRIBE_END,
			:LIBRARY_ACCESS_MODE,
            :LIBRARY_ACCESS_TYPE,
            :LIBRARY_CHARGEABLE,
			:LIBRARY_LISTORDER,
            :LIBRARY_SIZE_MB,
            :LIBRARY_LAST_SIZE_CHECK,
            :LIBRARY_SIZE_MB_ORG,
            -- Ajout en V25
            :LOGSYNC_ID
            
			
	DO
	BEGIN
        SELECT LOGSYNCS_INFOS FROM GET_LASTSYNC_MDF(:LIBRARY_ID) INTO :LASTSYNC_INFOS;	
		SUSPEND;
    END
END ^

ALTER PROCEDURE GET_LIBRARIES_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT'')
RETURNS (OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
FBSERVER_ID INTEGER,
PROFILE_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
	Renvoie la liste des bilbiothques associes  un propritaire

	Il est possible qu'il y en ai aucune (pas de librairie visible/active pour 1 propritaire ou un serveur FB donn)
	==> recordset vide

	Attend :
	- I_TOWNER_ID : un code numrique identifiant de propritaire (FK TOWNER)
	- OWNER_STATE : Etat particulier du owner (0 ==> actif par dfaut)
	- LIBRARY_STATE : critre de slection Etat de library
	- I_TFBSERVER_STATE : critre de slection  tat de serveur FB

V22 :
    - Ajout des informations complte LIBRARY pour gain de performance NAS

MAJ V24
	- ORDER BY TLIBRARY.TITLE (au lieu de ID)
    - SIZE_MB BIGINT
	- Ajout LASTSYNC_INFOS

MAV V 25
    - Ajout LOGSYNC_ID

MAJ V31 :
	- Ajout ACCESS_MODE

MAJ V32 :
	- Ajout de LISTORDER + Tri sur LISTORDER...

- MAJ V36
    - LIBRARY_SIZE_MB_ORG en sortie

-V40
	GUID VARCHAR(40) => VARCHAR(255)
	Ajout TLIBRARY.VERSION
*/
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    
    /* construction des WHERE */
    SQL_WHERE_OWNER = '';
    SQL_WHERE_LIB = '';
    SQL_WHERE_FBSERVER='';

	ID_OK = Null;
    
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO ID_OK;
        
	IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;

    IF (:I_TLIBRARY_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 
    
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER; 


	/* Recherche des bibliothques et des serveurs associs */
	FOR EXECUTE STATEMENT '
		SELECT
			TLIBRARY.ID,
            TLIBRARY.STATE AS TLIBRARY_STATE,
			TLIBRARY.TOWNER_ID,
			TOWNER.STATE AS TOWNER_STATE,
			COALESCE(TLIBRARY.TFBSERVER_ID,0),
            COALESCE(TFBSERVER.STATE,0),
            COALESCE(TLIBRARY.TPROFILE_ID,0),
            
            COALESCE(TLIBRARY."COMMENT",''''),
			COALESCE((SELECT LIBRARY_CONNECT FROM GET_LIBRARY_CONNECT(TLIBRARY.ID)),'''') AS PATH,
            COALESCE(TLIBRARY.TITLE,''''),
            COALESCE(TLIBRARY.GUID, ''''),
            COALESCE(TLIBRARY.VERSION, 0),
            COALESCE(TLIBRARY.DBPATH,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_END)),
			TLIBRARY.ACCESS_MODE,
            COALESCE(TLIBRARY.ACCESS_TYPE,0),
            TLIBRARY.CHARGEABLE,
            COALESCE(TLIBRARY.SIZE_MB,0),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.LAST_SIZE_CHECK)),
            COALESCE(TLIBRARY.SIZE_MB_ORG,0),
            
            -- Ajout V25
            COALESCE(TLIBRARY.TLOGSYNC_ID,0),

			-- Ajout V32
            COALESCE(TLIBRARY.LISTORDER,0)


		FROM
			TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TLIBRARY.TOWNER_ID=' || :I_TOWNER_ID ||
			IIF (:SQL_WHERE_LIB != '' , ' AND (' || :SQL_WHERE_LIB || ')', '') ||
            /* Attention, la colonne TFBERVER_ID accepte les valeurs Null ... */
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') || '
		-- MAJ V32
        ORDER BY TLIBRARY.LISTORDER, TLIBRARY.TITLE
        '
		INTO
			:LIBRARY_ID,
			:LIBRARY_STATE,
			:OWNER_ID,
			:OWNER_STATE,
			:FBSERVER_ID,
			:FBSERVER_STATE,
			:PROFILE_ID,
			-- Ajouts en version 22
            :LIBRARY_COMMENT,
            :LIBRARY_CONNECT,
            :LIBRARY_TITLE,
            :LIBRARY_GUID,
			-- Ajout V40
            :LIBRARY_VERSION,
            :LIBRARY_DBPATH,
            :LIBRARY_CREATE_DATE,
            :LIBRARY_MODIF_DATE,
            :LIBRARY_SUBSCRIBE_START,
            :LIBRARY_SUBSCRIBE_END,
			:LIBRARY_ACCESS_MODE,
            :LIBRARY_ACCESS_TYPE,
            :LIBRARY_CHARGEABLE,
            :LIBRARY_SIZE_MB,
            :LIBRARY_LAST_SIZE_CHECK,
            :LIBRARY_SIZE_MB_ORG,
            -- Ajout en V25
            :LOGSYNC_ID,
			-- Ajout V32
			:LIBRARY_LISTORDER
			
	DO
    BEGIN
        SELECT LOGSYNCS_INFOS FROM GET_LASTSYNC_MDF(:LIBRARY_ID) INTO :LASTSYNC_INFOS;
        SUSPEND;
    END

END ^

ALTER PROCEDURE GET_LIBRARY_CONNECT (I_TLIBRARY_ID INTEGER NOT NULL)
RETURNS (LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8)
AS 
/*
    Renvoi la chaine de connexion  une bibliothque par rapport  un serveur Firebird
    Ou NULL si aucun serveur n'est associ
    
    Attend :
    - I_TLIBRARY_ID : Id library
    
    renvoi :
    - LIBRARY_CONNECT VARCHAR(500) : Chaine de connexion complte (rseau/local)  la librairie

	En ce qui concerne les path separators, on prend en compte les lments spcifis dans le DBPATH et on construit en fonction de ce path :
		Si DBPATH contient "\" ==> on utilise "\"
		Sinon, on utilise "/"

V16 :
	- MAJ TDOMPARAM NOVAXEL_VOL_PRINC ==> GED_FILENAME

V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/
BEGIN
    FOR 
        SELECT
            IIF(NOT TLIBRARY.TFBSERVER_ID IS NULL,
                TFBSERVER.HOST
                    || IIF (TFBSERVER.TCPPORT IS NULL,'', '/' || TFBSERVER.TCPPORT)
                || ':',
                '')
                || TLIBRARY.DBPATH ||
                IIF(POSITION('\',TLIBRARY.DBPATH)=0,'/','\') || (SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('GED','FILENAME')) AS PATH
        FROM 
            TLIBRARY LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=:I_TLIBRARY_ID
        
        INTO LIBRARY_CONNECT
    DO
        SUSPEND;
    
END  ^

ALTER PROCEDURE GET_LIBRARY_INFOS (I_TLIBRARY_ID INTEGER NOT NULL,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_CONNECT VARCHAR(500) CHARACTER SET UTF8,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
LIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_VERSION INTEGER,
LIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8,
LIBRARY_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_ACCESS_MODE SMALLINT,
LIBRARY_ACCESS_TYPE INTEGER,
LIBRARY_SIZE_MB BIGINT,
LIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8,
LIBRARY_SIZE_MB_ORG BIGINT,
LIBRARY_CHARGEABLE BOOLEAN,
LIBRARY_LISTORDER INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
PROFILE_ID INTEGER,
LOGSYNC_ID INTEGER,
LASTSYNC_INFOS BLOB CHARACTER SET UTF8,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
    Renvoie les informations associes  une bibliothque

    Il est possible qu'il y en ai aucune (pas de librairie visible/active avec ID donn)
    ==> recordset vide

    Attend :
    - I_TLIBRARY_ID : un code numrique identifiant de bibliothque
     
MAJ V13:
	- Ajout LIBRARY_GUID

V18 :
	- Force les paramtres NOT NULL En entre...
	
MAJ V24 :
    - SIZE_MB BIGINT
	- Ajout LASTSYNC_INFOS

MAV V 25
    - Ajout LOGSYNC_ID

MAJ V31 :
	- Ajout ACCESS_MODE

MAN V32
	- Ajout LISTORDER

- MAJ V36
    - LIBRARY_SIZE_MB_ORG en sortie

-V40
	GUID VARCHAR(40) => VARCHAR(255)
	Ajout TLIBRARY.VERSION
*/
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);

DECLARE VARIABLE REC_FOUND INTEGER;

BEGIN

    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

    REC_FOUND=0;

    SQL_WHERE_LIB = '';
	SQL_WHERE_OWNER = '';
	SQL_WHERE_FBSERVER='';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;

    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;

    IF (:I_TLIBRARY_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB;

    /* Recherche des bibliothques et des serveurs associs */
    FOR EXECUTE STATEMENT '
        SELECT
            TLIBRARY.ID,
            COALESCE(TLIBRARY."COMMENT",''''),
            COALESCE((SELECT LIBRARY_CONNECT FROM GET_LIBRARY_CONNECT(TLIBRARY.ID)),'''') AS PATH,           
            COALESCE(TLIBRARY.TITLE,''''),
            COALESCE(TLIBRARY.GUID, ''''),
            COALESCE(TLIBRARY.VERSION, 0),
            COALESCE(TLIBRARY.DBPATH,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.SUBSCRIBE_END)),
			TLIBRARY.ACCESS_MODE,
            COALESCE(TLIBRARY.ACCESS_TYPE,0),
            TLIBRARY.CHARGEABLE,
            TLIBRARY.SIZE_MB,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLIBRARY.LAST_SIZE_CHECK)),
            COALESCE(TLIBRARY.SIZE_MB_ORG,0),
            TLIBRARY.TOWNER_ID,
            COALESCE(TLIBRARY.TFBSERVER_ID,0),
            COALESCE(TFBSERVER.STATE,0) AS FBSERVER_STATE,
            TLIBRARY.STATE AS LIBRARY_STATE,
            TOWNER.STATE AS OWNER_STATE,
            COALESCE(TLIBRARY.TPROFILE_ID,0),
            
            -- Ajout V25
            COALESCE(TLIBRARY.TLOGSYNC_ID,0),

			-- Ajout V32
            COALESCE(TLIBRARY.LISTORDER,0)

        FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE
            TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' , ' AND (' || :SQL_WHERE_LIB || ')', '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||             
            IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO
            :LIBRARY_ID,
            :LIBRARY_COMMENT,
            :LIBRARY_CONNECT,
            :LIBRARY_TITLE,
            :LIBRARY_GUID,
			-- Ajout V40
            :LIBRARY_VERSION,
            :LIBRARY_DBPATH,
            :LIBRARY_CREATE_DATE,
            :LIBRARY_MODIF_DATE,
            :LIBRARY_SUBSCRIBE_START,
            :LIBRARY_SUBSCRIBE_END,
			:LIBRARY_ACCESS_MODE,
            :LIBRARY_ACCESS_TYPE,
            :LIBRARY_CHARGEABLE,
            :LIBRARY_SIZE_MB,
            :LIBRARY_LAST_SIZE_CHECK,
            :LIBRARY_SIZE_MB_ORG,
            :OWNER_ID,
            :FBSERVER_ID,
            :FBSERVER_STATE,
            :LIBRARY_STATE,
            :OWNER_STATE,
            :PROFILE_ID,
            -- Ajout en V25
            :LOGSYNC_ID,
			:LIBRARY_LISTORDER
            
    DO
    BEGIN
        REC_FOUND=:REC_FOUND+1;
        SELECT LOGSYNCS_INFOS FROM GET_LASTSYNC_MDF(:LIBRARY_ID) INTO :LASTSYNC_INFOS;
        SUSPEND;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOLIB;

END ^

ALTER PROCEDURE GET_LOGSYNCS (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TIME_CRIT_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TIME_CRIT_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_STATE_CRIT BOOLEAN NOT NULL DEFAULT 32767,
I_MAX_ROWS INTEGER NOT NULL DEFAULT 0)
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
OWNER_ID INTEGER,
OWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
SYNC_START VARCHAR(20) CHARACTER SET UTF8,
SYNC_STOP VARCHAR(20) CHARACTER SET UTF8,
SYNC_DURATION BIGINT,
SYNC_SIZE_BEFORE BIGINT,
SYNC_SIZE_AFTER BIGINT,
SYNC_SIZE_TRANSFERED BIGINT,
SYNC_STATE BOOLEAN,
SYNC_ERR_COMMENT VARCHAR(4196) CHARACTER SET UTF8)
AS 
/*
    Retourne les logs de synchronisation associs  une library donne et/ou un owner donn
    Les paramtre de dates permettent de filtres les enregistrements

   
V13 :
    - cration

V23 :
	- Modification de l'ORDER BY
	
V24 :
	- Modification de l'ORDER BY
	- Inversin des colonnes SYNC_SIZE_BEFORE/SYNC_SIZE_AFTER corrige en sortie

V40 :
	- ORDER BY modifi pour que la PS renvoie les logs en ordre dcroissant (plus rcentes  la plus ancienne)
	- ajout de I_MAX_ROWS en entre pour limiter le nombre de ligne en retour (si 0 : illimit)

*/

-- Chaine SQL_WHERE  appliquer sur la requte en fonction des paramtres passs
DECLARE VARIABLE SQL_WHERE VARCHAR(8190);

BEGIN

    -- Dummy WHERE
    SQL_WHERE = '1=1';
   
    -- Construction de la chaine WHERE en fonction des paramtres passs...
    IF (I_TOWNER_ID != 0) THEN
    BEGIN
        IF (NOT EXISTS (SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN
            EXCEPTION EX_NOOWNER;
        ELSE
            SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.TOWNER_ID=' || I_TOWNER_ID ||')';
    END

    IF (I_TLIBRARY_ID !=0) THEN
    BEGIN
        IF (NOT EXISTS (SELECT ID FROM TLIBRARY WHERE ID=:I_TLIBRARY_ID)) THEN
            EXCEPTION EX_NOLIB;
        ELSE
            SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.TLIBRARY_ID=' || I_TLIBRARY_ID ||')';
    END
   
    IF (I_TIME_CRIT_START != '') THEN SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.TIME_END>=''' || (SELECT DATE_STRING FROM SET_STRING_DATE(:I_TIME_CRIT_START)) ||''')';
    IF (I_TIME_CRIT_END != '') THEN SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.TIME_END<=''' || (SELECT DATE_STRING FROM SET_STRING_DATE(:I_TIME_CRIT_END)) ||''')';
   
    IF (I_STATE_CRIT !=32767) THEN SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.STATE=' || :I_STATE_CRIT||')';
   
    FOR EXECUTE STATEMENT
        -- Dans ce cas la sous-requte est bien plus performante qu'un JOIN ...
        'SELECT
            TLOGSYNC.TOWNER_ID,
            (SELECT TOWNER.NAME FROM TOWNER WHERE TLOGSYNC.TOWNER_ID=TOWNER.ID),
            TLOGSYNC.TLIBRARY_ID,
            (SELECT TLIBRARY.TITLE FROM TLIBRARY WHERE TLOGSYNC.TLIBRARY_ID=TLIBRARY.ID),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLOGSYNC.TIME_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TLOGSYNC.TIME_END)),
            TLOGSYNC.DURATION,
            TLOGSYNC.SIZE_BEFORE,
            TLOGSYNC.SIZE_AFTER,
            TLOGSYNC.SIZE_TRANSFERED,
            TLOGSYNC.STATE,
            TLOGSYNC.ERR_COMMENT
        FROM
            TLOGSYNC
        WHERE ' ||
            :SQL_WHERE
        || '
        ORDER BY
            TLOGSYNC.TOWNER_ID, TLOGSYNC.TLIBRARY_ID,TLOGSYNC.TIME_END DESC
        ' || 
		IIF (:I_MAX_ROWS != 0 ,'ROWS 1 TO '|| :I_MAX_ROWS,'')

        INTO
            :OWNER_ID,
            :OWNER_NAME,
            :LIBRARY_ID,
            :LIBRARY_TITLE,
            :SYNC_START,
            :SYNC_STOP,
            :SYNC_DURATION,
            :SYNC_SIZE_BEFORE,
            :SYNC_SIZE_AFTER,
            :SYNC_SIZE_TRANSFERED,
            :SYNC_STATE,
            :SYNC_ERR_COMMENT
    DO
        SUSPEND;
       

END ^

ALTER PROCEDURE GET_LOGSYNCSTATS (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TIME_CRIT_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TIME_CRIT_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_STATE_CRIT BOOLEAN NOT NULL DEFAULT 32767)
RETURNS (LIBRARY_ID INTEGER,
LIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8,
OWNER_ID INTEGER,
OWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
SYNC_NB INTEGER,
SYNC_SIZE_TRANSFERED_SUM BIGINT,
SYNC_SIZE_TRANSFERED_AVG BIGINT,
SYNC_DURATION_SUM BIGINT,
SYNC_DURATION_AVG BIGINT)
AS 
/*
    Retourne des statistiques sur les logs de synchronisation associs  une library donne
    Les paramtre de dates permettent de filtres les enregistrements

   
V13 :
    - cration

V23 :
	- Modification de l'ORDER BY

V 25 :
	- Optimisation requte sous-jacente
*/

-- Chaine SQL_WHERE  appliquer sur la requte en fonction des paramtres passs
DECLARE VARIABLE SQL_WHERE VARCHAR(8190);

BEGIN

    -- Dummy WHERE
    SQL_WHERE = '1=1';
   
    -- Construction de la chaine WHERE en fonction des paramtres passs...
    IF (I_TOWNER_ID != 0) THEN
    BEGIN
        IF (NOT EXISTS (SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN
            EXCEPTION EX_NOOWNER;
        ELSE
            SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.TOWNER_ID=' || I_TOWNER_ID ||')';
    END

    IF (I_TLIBRARY_ID !=0) THEN
    BEGIN
        IF (NOT EXISTS (SELECT ID FROM TLIBRARY WHERE ID=:I_TLIBRARY_ID)) THEN
            EXCEPTION EX_NOLIB;
        ELSE
            SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.TLIBRARY_ID=' || I_TLIBRARY_ID ||')';
    END
   
    IF (I_TIME_CRIT_START != '') THEN SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.TIME_END>=''' || (SELECT DATE_STRING FROM SET_STRING_DATE(:I_TIME_CRIT_START)) ||''')';
    IF (I_TIME_CRIT_END != '') THEN SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.TIME_END<=''' || (SELECT DATE_STRING FROM SET_STRING_DATE(:I_TIME_CRIT_END)) ||''')';
   
    IF (I_STATE_CRIT !=32767) THEN SQL_WHERE = :SQL_WHERE || ' AND (TLOGSYNC.STATE=' || :I_STATE_CRIT||')';
   
    FOR EXECUTE STATEMENT
        'SELECT
            TLOGSYNC.TOWNER_ID,
			(SELECT TOWNER.NAME FROM TOWNER WHERE TOWNER.ID=TLOGSYNC.TOWNER_ID),
            TLOGSYNC.TLIBRARY_ID,
			(SELECT TLIBRARY.TITLE FROM TLIBRARY WHERE TLIBRARY.ID=TLOGSYNC.TLIBRARY_ID),
            COUNT(TLOGSYNC.ID) AS NB,
            SUM(TLOGSYNC.SIZE_TRANSFERED) AS SIZETRANSFSUM,
            AVG(TLOGSYNC.SIZE_TRANSFERED) AS SIZETRANSAVG,
            SUM(TLOGSYNC.DURATION) AS DURATIONSUM,
            AVG(TLOGSYNC.DURATION) AS DURATIONAVG
        FROM TLOGSYNC
        WHERE ' ||
            :SQL_WHERE
        || '
        GROUP BY TLOGSYNC.TOWNER_ID, TLOGSYNC.TLIBRARY_ID
        '
        INTO
            :OWNER_ID,
            :OWNER_NAME,
            :LIBRARY_ID,
            :LIBRARY_TITLE,
            :SYNC_NB,
            :SYNC_SIZE_TRANSFERED_SUM,
            :SYNC_SIZE_TRANSFERED_AVG,
            :SYNC_DURATION_SUM,
            :SYNC_DURATION_AVG
    DO
        SUSPEND;
       

END ^

ALTER PROCEDURE GET_LOGSYNC_MDF (I_TLOGSYNC_ID INTEGER NOT NULL)
RETURNS (LOGSYNCS_INFOS BLOB CHARACTER SET UTF8)
AS 
/*
    Retourne une chaine contenant la concatnation des informations de synchro pour la synchros donnee, par exemple 
"72";"COGEREC 75";"58";"2012-08-22 10:29:11";"2012-08-22 10:29:38";"27";"41542112320";"41542116457";"4137";"1";""
- V24 : 
	- Cration
- V25 :
	- Suppression des possibiits de filtre sur TOWNER.ID et/ou TLIBRARY.ID (trop long au runtime, donc inexploitable)
*/

DECLARE VARIABLE FIELD_SEP VARCHAR(5);
--DECLARE VARIABLE RECORD_SEP VARCHAR(5);

BEGIN
    LOGSYNCS_INFOS = '';

	SELECT COALESCE(CAST(DOMPARAM_VALUE AS VARCHAR(5)),';') FROM GET_DOMPARAM('DOMAIN','MDF_FIELD_SEP')  INTO FIELD_SEP;

	SELECT 
		'"' || TLOGSYNC.TOWNER_ID || '"' || :FIELD_SEP  || 
		'"' || (SELECT TOWNER.NAME FROM TOWNER WHERE TOWNER.ID=TLOGSYNC.TOWNER_ID) || '"' || :FIELD_SEP  || 
		'"' || TLOGSYNC.TLIBRARY_ID || '"' || :FIELD_SEP || 
		'"' || (SELECT DATE_STRING FROM GET_DATE_STRING(TLOGSYNC.TIME_START)) || '"' || :FIELD_SEP || 
		'"' || (SELECT DATE_STRING FROM GET_DATE_STRING(TLOGSYNC.TIME_END)) || '"' || :FIELD_SEP || 
		'"' || TLOGSYNC.DURATION || '"' || :FIELD_SEP || 
		'"' || COALESCE(TLOGSYNC.SIZE_BEFORE,0) || '"' || :FIELD_SEP || 
		'"' || COALESCE(TLOGSYNC.SIZE_AFTER,0) || '"' || :FIELD_SEP || 
		'"' || TLOGSYNC.SIZE_TRANSFERED || '"' || :FIELD_SEP || 
		'"' || TLOGSYNC.STATE || '"' || :FIELD_SEP || 
		'"' || COALESCE(TLOGSYNC.ERR_COMMENT,'') || '"'
	FROM TLOGSYNC
	WHERE TLOGSYNC.ID=:I_TLOGSYNC_ID
    INTO :LOGSYNCS_INFOS;
    SUSPEND;
END ^

ALTER PROCEDURE GET_OWNERS (I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
OWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
OWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
OWNER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
OWNER_EXTERNAL_ID VARCHAR(100) CHARACTER SET UTF8,
OWNER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
OWNER_ISADMIN BOOLEAN,
OWNER_SIZE_MB BIGINT,
OWNER_SIZE_MB_CHARGEABLE BIGINT,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
GEDPARAMOWNERS_INFOS BLOB CHARACTER SET UTF8,
PROFILE_ID INTEGER,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
/*
    Renvoie la liste des propritaires du Cloud (propritaires actifs seulement par dfaut) + les informations contacts et types de contact associes pour test de performance
    
MAJ V 22 :
    - Ajout des informations des contacts pour gian de performances

MAJ V 24 :
    - CONTTYPES_INFOS renvoy en tant que BLOB
	- Ajout de GEDPARAMS_INFOS renvoy en tant que BLOB

MAJ V31 :
	- Ajout SIZE_MB + SIZE_MB_CHARGEABLE

MAJ V32 :
	- Ajout de ORGANIZATION, etc...

*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);

BEGIN
    I_TOWNER_STATE= TRIM(I_TOWNER_STATE);
    
    SQL_WHERE_OWNER = '';
    
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    FOR EXECUTE STATEMENT '
        SELECT
            TOWNER.ID,
            TOWNER.NAME,
            TOWNER.SUBDOMAIN,
            TOWNER.LOGIN,
            TOWNER.STATE,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TOWNER.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TOWNER.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TOWNER.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TOWNER.SUBSCRIBE_END)),
            COALESCE(TOWNER.EXTERNAL_ID,''''),
            COALESCE(TOWNER."COMMENT",''''),
            COALESCE(TOWNER.TPROFILE_ID,0),
            COALESCE(TOWNER.TCONTACT_ID,0),
            (SELECT OWNER_ADMIN FROM GET_OWNER_IS_ADMIN(TOWNER.ID)) AS IS_ADMIN,
			COALESCE(TOWNER.SIZE_MB,0),
			COALESCE(TOWNER.SIZE_MB_CHARGEABLE,0),

			COALESCE(TCONTACT.NAME,''''),
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),
			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			COALESCE(TCONTACT.STATE,0)
            
        FROM TOWNER LEFT JOIN TCONTACT ON TOWNER.TCONTACT_ID=TCONTACT.ID' || IIF (:SQL_WHERE_OWNER != '' ,' WHERE ' || :SQL_WHERE_OWNER, '') || '
        ORDER BY TOWNER.SUBDOMAIN;'
        INTO 
			:OWNER_ID,
			:OWNER_NAME,
			:OWNER_SUBDOMAIN,
			:OWNER_LOGIN,
			:OWNER_STATE,
			:OWNER_CREATE_DATE,
			:OWNER_MODIF_DATE,
			:OWNER_SUBSCRIBE_START,
			:OWNER_SUBSCRIBE_END,
			:OWNER_EXTERNAL_ID,
			:OWNER_COMMENT,
			:PROFILE_ID,
			:CONTACT_ID,
			:OWNER_ISADMIN,
			:OWNER_SIZE_MB,
			:OWNER_SIZE_MB_CHARGEABLE,
			-- Ajout V22
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			:CONTACT_STATE 			

    DO
    BEGIN
        -- Ajout V22
        SELECT CONTTYPES_INFOS FROM GET_CONTTYPE_MDF(:CONTACT_ID) INTO :CONTTYPES_INFOS;

        -- Ajout V24
        SELECT GEDPARAMOWNERS_INFOS FROM GET_GEDPARAMOWNER_MDF(:OWNER_ID) INTO GEDPARAMOWNERS_INFOS;
        
        SUSPEND;
    END
    
END ^

ALTER PROCEDURE GET_OWNER_ID (I_TOWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_PASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
PROFILE_ID INTEGER,
CONTACT_ID INTEGER,
OWNER_STATE STATE)
AS 
/*
	Recherche d'un code identifiant d'utilisateur du domaine dans la table "TOWNER"

    Attend :
	- I_TOWNER_LOGIN : Login d'un utilisateur
	- I_TOWNER_DOM_PASSWD : password (hach SHA2556) d'un utilisateur
	- OWNER_STATE : Etat particulier de propritaire (NULL ou non pass ==> 1 ==> actif par dfaut) (voir commentaire procdure GET_STATE_CRITERIA)
    

	renvoi l'ID  etstate du owner
	
	Des erreurs sont leves si le login et/ou le password sont incorrect...

MAJ V12 :
	- DOM_LOGIN/DOM_PASSWD ==> LOGIN/PASSWD

MAJ V20 :
    - PASSWD non obligatoire en entre et test seulement sur LOGIN si PASSWD non pass
    ==> Gestion des sessions NAS
    
MAJ V22 :
    - Ajout de TCONTACT_ID et TPROFILE_ID en sortie
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE PASSWD VARCHAR(100); 

BEGIN

    I_TOWNER_STATE= TRIM(I_TOWNER_STATE);
    
    SQL_WHERE_OWNER = '';
    
    IF (:I_TOWNER_STATE ='' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    /* Nettoyage des paramtres */
    I_TOWNER_LOGIN = TRIM(:I_TOWNER_LOGIN);
    I_TOWNER_PASSWD = TRIM(UPPER(:I_TOWNER_PASSWD));

	EXECUTE STATEMENT 
        'SELECT ID,PASSWD,STATE, COALESCE(TPROFILE_ID,0), COALESCE(TCONTACT_ID,0) FROM TOWNER
        WHERE LOGIN =''' || :I_TOWNER_LOGIN || '''' || IIF (SQL_WHERE_OWNER != '',' AND ' || SQL_WHERE_OWNER, '') || ';'
		INTO :OWNER_ID, :PASSWD, :OWNER_STATE, :PROFILE_ID, CONTACT_ID;

    -- Non trouv...
    IF (:OWNER_ID IS NULL) THEN EXCEPTION EX_BAD_DOM_LOGIN;

		
	IF (I_TOWNER_PASSWD!='' AND (UPPER(:PASSWD)!=:I_TOWNER_PASSWD)) THEN EXCEPTION EX_BAD_DOM_PASSWD;
		
	/* Ici, tout est ok, on renvoit donc l'ID et le flag d'activit */
	SUSPEND;
		
END ^

ALTER PROCEDURE GET_OWNER_INFOS (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
OWNER_NAME VARCHAR(100) CHARACTER SET UTF8,
OWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8,
OWNER_PASSWD VARCHAR(100) CHARACTER SET UTF8,
OWNER_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8,
OWNER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8,
OWNER_EXTERNAL_ID VARCHAR(100) CHARACTER SET UTF8,
OWNER_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
OWNER_ISADMIN BOOLEAN,
OWNER_SIZE_MB BIGINT,
OWNER_SIZE_MB_CHARGEABLE BIGINT,
CONTACT_ID INTEGER,
CONTACT_NAME VARCHAR(150) CHARACTER SET UTF8,
CONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8,
CONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8,
CONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8,
CONTACT_TEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8,
CONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8,
CONTACT_REGION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CITY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8,
CONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8,
CONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8,
CONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8,
CONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8,
CONTACT_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
CONTTYPES_INFOS BLOB CHARACTER SET UTF8,
GEDPARAMOWNERS_INFOS BLOB CHARACTER SET UTF8,
PROFILE_ID INTEGER,
OWNER_STATE STATE,
CONTACT_STATE STATE)
AS 
/*
    Renvoit les informations dtailles associes  un propritaire
    Il est possible qu'il y en ai aucun (pas de propritaire visible/actif avec ID donn)
    ==> recordset vide
    Attend :
    - I_TOWNER_ID : un code numrique identifiant de propritaire (FK TOWNER)
    
MAJ V12 :
    - Ajout TCONTACT_ID
	- DOM_LOGIN ==> LOGIN

MAJ V14 :
	- ajout de l'empreinte SHA du password (pour exploitation par les scripts en "interne NAS", ie seulement les scripts serveur... Le flux json ponyme renvoy par le NAS n'est pas cens retourner cette valeur)

V22 :
    - Ajout informations dtailles CONTACT pour amliorations performances NAS

MAJ V 24 :
    - CONTTYPES_INFOS renvoy en tant que BLOB
	- Ajout GEDPARAMOWNERS_INFOS

MAJ V31 :
	- Ajout SIZE_MB + SIZE_MB_CHARGEABLE

MAJ V32 :
	- Ajout de ORGANIZATION, etc...
*/
DECLARE VARIABLE REC_FOUND INTEGER;
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);

BEGIN

    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

    REC_FOUND=0;

    SQL_WHERE_OWNER = '';
    
    IF (:I_TOWNER_STATE ='' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    FOR EXECUTE STATEMENT '
        SELECT
            TOWNER.ID,
            TOWNER.NAME,
			TOWNER.SUBDOMAIN,
            TOWNER.LOGIN,
			TOWNER.PASSWD,
            TOWNER.STATE,
            (SELECT DATE_STRING FROM GET_DATE_STRING(TOWNER.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TOWNER.MODIF_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TOWNER.SUBSCRIBE_START)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TOWNER.SUBSCRIBE_END)),
            COALESCE(TOWNER.EXTERNAL_ID,''''),
            COALESCE(TOWNER."COMMENT",''''),
            COALESCE(TOWNER.TPROFILE_ID,0),
            COALESCE(TOWNER.TCONTACT_ID,0),
            (SELECT OWNER_ADMIN FROM GET_OWNER_IS_ADMIN(TOWNER.ID)) AS IS_ADMIN,
			COALESCE(TOWNER.SIZE_MB,0),
			COALESCE(TOWNER.SIZE_MB_CHARGEABLE,0),
            
            -- Ajout V22
			COALESCE(TCONTACT.NAME,''''),
			COALESCE(TCONTACT.FIRSTNAME,''''),
			COALESCE(TCONTACT.PREFIX,''''),
			COALESCE(TCONTACT.EMAIL,''''),
			COALESCE(TCONTACT.TEL,''''),
			COALESCE(TCONTACT.ADDRESS,''''),
			COALESCE(TCONTACT.POSTCODE,''''),
			COALESCE(TCONTACT.REGION,''''),
			COALESCE(TCONTACT.CITY,''''),
			COALESCE(TCONTACT.COUNTRY,''''),
			COALESCE(TCONTACT.ORGANIZATION,''''),
			COALESCE(TCONTACT.SERVICE,''''),
			COALESCE(TCONTACT.IDENTIFIER,''''),
			COALESCE(TCONTACT.CELLTEL,''''),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.CREATE_DATE)),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TCONTACT.MODIF_DATE)),
			COALESCE(TCONTACT.STATE,0)
            
        FROM TOWNER
            LEFT JOIN TCONTACT ON TOWNER.TCONTACT_ID=TCONTACT.ID
        WHERE TOWNER.ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO 
			:OWNER_ID,
			:OWNER_NAME,
			:OWNER_SUBDOMAIN,
			:OWNER_LOGIN,
			:OWNER_PASSWD,
			:OWNER_STATE,
			:OWNER_CREATE_DATE,
			:OWNER_MODIF_DATE,
			:OWNER_SUBSCRIBE_START,
			:OWNER_SUBSCRIBE_END,
			:OWNER_EXTERNAL_ID,
			:OWNER_COMMENT,
			:PROFILE_ID,
            :CONTACT_ID,
			:OWNER_ISADMIN,
			:OWNER_SIZE_MB,
			:OWNER_SIZE_MB_CHARGEABLE,
			
            -- Ajout V22
			:CONTACT_NAME,
			:CONTACT_FIRSTNAME, 
			:CONTACT_PREFIX ,
			:CONTACT_EMAIL,
			:CONTACT_TEL,
			:CONTACT_ADDRESS,
			:CONTACT_POSTCODE,
			:CONTACT_REGION,
			:CONTACT_CITY,
			:CONTACT_COUNTRY,

			-- Ajout V32
			:CONTACT_ORGANIZATION,
			:CONTACT_SERVICE,
			:CONTACT_IDENTIFIER,
			:CONTACT_CELLTEL,

            :CONTACT_CREATE_DATE,
            :CONTACT_MODIF_DATE,
			:CONTACT_STATE 			
			
    	DO
        BEGIN
            REC_FOUND=:REC_FOUND+1;
            -- Ajout V22
            SELECT CONTTYPES_INFOS FROM GET_CONTTYPE_MDF(:CONTACT_ID) INTO :CONTTYPES_INFOS;
            -- Ajout V24
            SELECT GEDPARAMOWNERS_INFOS FROM GET_GEDPARAMOWNER_MDF(:OWNER_ID) INTO GEDPARAMOWNERS_INFOS;
            
            SUSPEND;
        END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOOWNER;
END ^

ALTER PROCEDURE GET_OWNER_IS_ADMIN (I_TOWNER_ID INTEGER NOT NULL)
RETURNS (OWNER_ADMIN BOOLEAN,
OWNER_STATE STATE)
AS 
/*
    Renvoi True si un utlisateur donn est administrateur du domaine (ne rpond qu' cette question, voir plus loin)
    2 cas :
        - administrateur principal : ID = -1
        - autres administrateur : tat contient "DOM_OWNER_ADMIN" (4)
        
        Attention : Cette procdure ne prend pas en compte les autres tats ventuellement positionn sur le STATE,
        donc si un OWNER est DELETED, par exemple, cette procdure renverra quand mme OWNER_ADMIN = 1
        Autrement dit, on ne teste ici que l'tat admin SANS prendre en compte les autres tats possibles dans STATE...

V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/

BEGIN

    I_TOWNER_ID= TRIM(I_TOWNER_ID);
    
    /* Existence du owner demand */
    IF (NOT EXISTS(SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN EXCEPTION EX_NOOWNER;

    /* On se base sur un paramtre de domaine ou la valeur 4 si ce dernier n'est pas trouv */
    FOR EXECUTE STATEMENT
        'SELECT IIF(ID=-1 OR BIN_AND(COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM(''DOMAIN'',''OWNER_ADMIN'')),4),STATE)!=0,1,0), STATE FROM TOWNER WHERE ID=' || :I_TOWNER_ID
        INTO :OWNER_ADMIN, :OWNER_STATE
    DO
        SUSPEND;
    
END ^

ALTER PROCEDURE GET_PROFILES_FOR_OWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
LIBRARY_ID INTEGER,
GEDUSER_ID INTEGER,
PROFILE_ID INTEGER,
PROFILE_NAME VARCHAR(100) CHARACTER SET UTF8,
PROFILE_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
PROFILE_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
PROFILE_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
FBSERVER_STATE STATE,
GEDUSER_STATE STATE)
AS 
/*
    Renvoie les Profils d'un Propritaire donne
	(Attention, pas le profil par dfaut associ au propritaire)
    Il est possible qu'il y en ai aucun (pas de profile visible/actif avec ID donn)
    ==> recordset vide

    Attend :
    - I_TOWNER_ID : un code numrique identifiant Propitaire
    
	Les dmarches suivantes sont appliques :
	- Si LIB_ID et GEDUSER_ID ne sont pas fournis, on renvoie tous les profils affects  une LIB et/ou un GEDUSER (ie les profils globaux)
	- Si un LIB_ID est fourni, on renvoi tous les profils associs  cette LIB seulement (et aucun autre) et  aucun GEDUSER
        - Si un GEDUSER_ID est fourni et =TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL, on renvoie tous les profils associs  cette LIB pour tous les GEDUSERS
	- Si un GEDUSER_ID est fourni et >0, on renvoie tous les profils de ce GEDUSER (et aucun autre) et  aucune LIBRARY
	- Si LIB_ID ET GEDUSER_ID sont fournis on ne renvoie que les profils associs  ce GEDUSER et cette LIB
	
	ATTENTION : MAJ V40, les principes nnoncs ci-dessus ne sont PLUS les bons (systmatisation des paramtres NULL), on dit maintenant :
	- Si LIB_ID et/ou GEDUSER_ID ne sont pas fourni (ie pass  0) : on en tient pas compte en critre
	- Si LIB_ID = TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL ou GEDUSER_ID = = TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL : on recherche explicitement les uns ou les autres  NULL
	- Sinon, on echerche avec les ID passs...
    
V18 :
	- Force les paramtres NOT NULL En entre...
	
V 36 :
    - GEDUSER_ID =TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL en entre pour rcuprer tous les profils de LIB...
    
V40 :
    - Systmatisation des paramtres reprsentant NULL en entre (utilisation de TDOMPARAM:DOMAIN/PARAM_EQUIV_NULL)
    
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_PROFILE VARCHAR(8000);

DECLARE VARIABLE NULL_PARAM INTEGER;

DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
    -- Dummy WHERE pour simplification des concatnations...
	SQL_WHERE_PROFILE='1=1';

	ID_OK = Null;
	
    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO ID_OK;
        
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;
    
    -- Ajout des critres OWNER
    SQL_WHERE_PROFILE = :SQL_WHERE_PROFILE || ' AND TPROFILE.TOWNER_ID=' || :I_TOWNER_ID;
    
	-- Rcupration du DOM_PARAM reprsentant la recherche de valeur NULL
	NULL_PARAM=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','PARAM_EQUIV_NULL')),-9);
	
	IF (I_TLIBRARY_ID = NULL_PARAM) THEN
        SQL_WHERE_PROFILE = :SQL_WHERE_PROFILE || ' AND TPROFILE.TLIBRARY_ID IS NULL';
    ELSE
    BEGIN
        IF (I_TLIBRARY_ID!=0) THEN
        BEGIN
            IF (I_TLIBRARY_STATE = '') THEN
                /* Etat de visibilit par dfaut */
                SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
            ELSE 
                /* Etat de visibilit demand */
                SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
                
            -- Ajout du STATE pour gestion LEFT JOIN
            SQL_WHERE_LIB=IIF(SQL_WHERE_LIB!='', ' AND (' || SQL_WHERE_LIB || ' OR TLIBRARY.STATE IS NULL)','');

           /* Serveur Firebird (si non Null) utilisable outrepassable...*/
            IF (:I_TFBSERVER_STATE = '' ) THEN
                /* Etat de visibilit par dfaut */
                SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
            ELSE 
                /* Etat de visibilit demand */
                SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

            -- Ajout du STATE pour gestion LEFT JOIN
            SQL_WHERE_FBSERVER=IIF(SQL_WHERE_FBSERVER!='', ' AND (' || SQL_WHERE_FBSERVER || ' OR TFBSERVER.STATE IS NULL)','');
                
            -- Ajout des critres LIBRARY
            SQL_WHERE_PROFILE = :SQL_WHERE_PROFILE || ' AND TPROFILE.TLIBRARY_ID=' || :I_TLIBRARY_ID || :SQL_WHERE_LIB || :SQL_WHERE_FBSERVER;
            
        END
    END

    -- Modif V40 : systmatisation des paramtres reprsentant NULL en entre
    IF (I_TGEDUSER_ID = NULL_PARAM) THEN
        SQL_WHERE_PROFILE = :SQL_WHERE_PROFILE || ' AND TPROFILE.TGEDUSER_ID IS NULL';
    ELSE
    BEGIN
        IF (I_TGEDUSER_ID!=0) THEN
        BEGIN
            IF (I_TGEDUSER_STATE = '') THEN
                /* Etat de visibilit par dfaut */
                SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
            ELSE 
                /* Etat de visibilit demand */
                SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;

            -- Ajout du STATE pour gestion LEFT JOIN
            SQL_WHERE_GEDUSER=IIF(SQL_WHERE_GEDUSER!='', ' AND (' || SQL_WHERE_GEDUSER || ' OR TGEDUSER.STATE IS NULL)','');

            -- Ajout des critres GEDUSER
            SQL_WHERE_PROFILE=:SQL_WHERE_PROFILE || ' AND TPROFILE.TGEDUSER_ID=' || :I_TGEDUSER_ID || :SQL_WHERE_GEDUSER;
        END
    END

/*
-- DEBUG
PROFILE_COMMENT=:SQL_WHERE_PROFILE;
SUSPEND;
EXIT;
*/

	FOR
        EXECUTE STATEMENT '
            SELECT
                TPROFILE.TOWNER_ID,
                TPROFILE.ID,
                COALESCE(TPROFILE.TLIBRARY_ID,0),
                COALESCE(TPROFILE.TGEDUSER_ID,0),
                COALESCE(TLIBRARY.TFBSERVER_ID,0),
                TOWNER.STATE AS TOWNER_STATE,
                COALESCE(TLIBRARY.STATE,0),
                COALESCE(TFBSERVER.STATE,0),
                COALESCE(TGEDUSER.STATE,0),
                
                -- Ajout V22
                TPROFILE.NAME,
                COALESCE(TPROFILE."COMMENT",''''),
				(SELECT DATE_STRING FROM GET_DATE_STRING(TPROFILE.CREATE_DATE)),
				(SELECT DATE_STRING FROM GET_DATE_STRING(TPROFILE.MODIF_DATE))
                
            FROM 
                TPROFILE
                    INNER JOIN TOWNER ON TOWNER.ID=TPROFILE.TOWNER_ID
                    LEFT JOIN TLIBRARY ON TPROFILE.TLIBRARY_ID=TLIBRARY.ID
                        LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
                    LEFT JOIN TGEDUSER ON TPROFILE.TGEDUSER_ID=TGEDUSER.ID
            WHERE ' || :SQL_WHERE_PROFILE || 
            ' 
            ORDER BY TPROFILE.ID'
        INTO
            :OWNER_ID,
            :PROFILE_ID,
            :LIBRARY_ID,
            :GEDUSER_ID,
            :FBSERVER_ID,
            :OWNER_STATE,
            :LIBRARY_STATE,
            :FBSERVER_STATE,
            :GEDUSER_STATE,
            -- Ajout V22
            :PROFILE_NAME,
			:PROFILE_COMMENT,
			:PROFILE_CREATE_DATE,
			:PROFILE_MODIF_DATE
        
        DO
			SUSPEND;

END ^

ALTER PROCEDURE GET_PROFILE_FOR_GEDGROUPLIB (I_TLIBRARY_ID INTEGER NOT NULL,
I_TGEDGROUP_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
GEDGROUP_ID INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
    Renvoie le Profil li  une bibliothque et un Groupe d'utilisateur GED dans la table TGEDGROUPLIB (il peut y en avoir qu'un ou aucun...)

V32
	- Cration...
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

	ID_OK = Null;
	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
    
    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY, TPROFILE et TGEDUSER */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;

	ID_OK = Null;

    /* Existence/visibilit du groupe d'utilisateur GED lui-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TGEDGROUP.ID
		FROM TGEDGROUP INNER JOIN TOWNER ON TGEDGROUP.TOWNER_ID=TOWNER.ID
        WHERE TGEDGROUP.ID=' || :I_TGEDGROUP_ID ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDGROUP;

	/* Recherche des Profils */
	FOR
		SELECT
			TGEDGROUPLIB.TLIBRARY_ID,
			TGEDGROUPLIB.TGEDGROUP_ID,
			TGEDGROUPLIB.TPROFILE_ID,
			TLIBRARY.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			TLIBRARY.STATE,
            TOWNER.STATE,
			COALESCE(TFBSERVER.STATE,0)
		FROM
            TGEDGROUPLIB INNER JOIN TGEDGROUP ON TGEDGROUPLIB.TGEDGROUP_ID = TGEDGROUP.ID
            INNER JOIN TLIBRARY  ON TGEDGROUPLIB.TLIBRARY_ID=TLIBRARY.ID
                INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TGEDGROUPLIB.TLIBRARY_ID=:I_TLIBRARY_ID AND TGEDGROUPLIB.TGEDGROUP_ID=:I_TGEDGROUP_ID
		INTO
			:LIBRARY_ID,
			:GEDGROUP_ID,
			:PROFILE_ID,
			:OWNER_ID,
			:FBSERVER_ID,
			:LIBRARY_STATE,
			:OWNER_STATE,
			:FBSERVER_STATE
	DO
		SUSPEND;
END ^

ALTER PROCEDURE GET_PROFILE_FOR_GEDUSERLIB (I_TLIBRARY_ID INTEGER NOT NULL,
I_TGEDUSER_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER,
GEDUSER_ID INTEGER,
PROFILE_ID INTEGER,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
LIBRARY_STATE STATE,
OWNER_STATE STATE,
FBSERVER_STATE STATE,
GEDUSER_STATE STATE)
AS 
/*
    Renvoie le Profil li  une bibliothque et un Utilisateur GED dans la table TGEDUSERLIB (il peut y en avoir qu'un ou aucun...)
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

	ID_OK = Null;
	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDUSER = '';
    
    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
	/* Mme OWNER pour TLIBRARY, TPROFILE et TGEDUSER */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

   -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;

	ID_OK = Null;

    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;

    /* Existence/visibilit de l'utilisateur GED lui-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TGEDUSER.ID
		FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '') ||
            IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;

	/* Recherche des Profils */
	FOR
		SELECT
			TGEDUSERLIB.TLIBRARY_ID,
			TGEDUSERLIB.TGEDUSER_ID,
			TGEDUSERLIB.TPROFILE_ID,
			TGEDUSER.TOWNER_ID,
			COALESCE(TFBSERVER.ID,0),
			TLIBRARY.STATE,
            TOWNER.STATE,
			COALESCE(TFBSERVER.STATE,0),
			TGEDUSER.STATE
		FROM
            TGEDUSERLIB INNER JOIN TGEDUSER ON TGEDUSERLIB.TGEDUSER_ID = TGEDUSER.ID
                INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
            INNER JOIN TLIBRARY  ON TGEDUSERLIB.TLIBRARY_ID=TLIBRARY.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
		WHERE
			TGEDUSERLIB.TLIBRARY_ID=:I_TLIBRARY_ID AND TGEDUSERLIB.TGEDUSER_ID=:I_TGEDUSER_ID
		INTO
			:LIBRARY_ID,
			:GEDUSER_ID,
			:PROFILE_ID,
			:OWNER_ID,
			:FBSERVER_ID,
			:LIBRARY_STATE,
			:OWNER_STATE,
			:FBSERVER_STATE,
			:GEDUSER_STATE
	DO
		SUSPEND;
END ^

ALTER PROCEDURE GET_PROFILE_INFOS (I_TPROFILE_ID INTEGER NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER,
PROFILE_NAME VARCHAR(100) CHARACTER SET UTF8,
OWNER_ID INTEGER,
PROFILE_COMMENT VARCHAR(8164) CHARACTER SET UTF8,
LIBRARY_ID INTEGER,
GEDUSER_ID INTEGER,
PROFILE_CREATE_DATE VARCHAR(20) CHARACTER SET UTF8,
PROFILE_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
FBSERVER_ID INTEGER,
OWNER_STATE STATE,
LIBRARY_STATE STATE,
GEDUSER_STATE STATE,
FBSERVER_STATE STATE)
AS 
/*
    Renvoie les informations dtailles associes  un profil 
    Il est possible qu'il y en ai aucun (pas de profile visible/actif avec ID donn)
    ==> recordset vide

    Attend :
    - I_TPROFILE_ID : un code numrique identifiant 

V18 :
	- force paramtres NOT NULL
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);

DECLARE VARIABLE REC_FOUND INTEGER;

BEGIN

    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

    REC_FOUND=0;

    SQL_WHERE_LIB = '';
	SQL_WHERE_OWNER = '';
	SQL_WHERE_FBSERVER='';
	SQL_WHERE_GEDUSER='';
	
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;

    IF (:I_TLIBRARY_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB;

    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;

    IF (:I_TGEDUSER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;

	FOR
        EXECUTE STATEMENT '
            SELECT
                TPROFILE.ID,
                TPROFILE.NAME,
                TPROFILE.TOWNER_ID,
                COALESCE(TPROFILE."COMMENT",''''),
                COALESCE(TPROFILE.TLIBRARY_ID,0),
				COALESCE(TPROFILE.TGEDUSER_ID, 0),
				(SELECT DATE_STRING FROM GET_DATE_STRING(TPROFILE.CREATE_DATE)),
				(SELECT DATE_STRING FROM GET_DATE_STRING(TPROFILE.MODIF_DATE)),
				COALESCE(TLIBRARY.TFBSERVER_ID,0),
                TOWNER.STATE AS TOWNER_STATE,
                COALESCE(TLIBRARY.STATE,0),
				COALESCE(TGEDUSER.STATE,0),
                COALESCE(TFBSERVER.STATE,0)
            FROM 
                TPROFILE INNER JOIN TOWNER ON TOWNER.ID=TPROFILE.TOWNER_ID
                    LEFT JOIN TLIBRARY ON TPROFILE.TLIBRARY_ID=TLIBRARY.ID
                        LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
                    LEFT JOIN TGEDUSER ON TPROFILE.TGEDUSER_ID=TGEDUSER.ID
            WHERE
                TPROFILE.ID=' || :I_TPROFILE_ID ||
                    IIF (:SQL_WHERE_OWNER != '' , ' AND ' || :SQL_WHERE_OWNER, '') || 
                    IIF (:SQL_WHERE_LIB != '' , ' AND (' || :SQL_WHERE_LIB || 'OR TLIBRARY.STATE IS NULL)', '') || -- Attention LIB LEFT JOIN...
                    IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
                    IIF (:SQL_WHERE_GEDUSER != '' , ' AND (' || :SQL_WHERE_GEDUSER || 'OR TGEDUSER.STATE IS NULL)', '') || -- Attention GEDUSER LEFT JOIN...
            '
            ORDER BY TPROFILE.ID'
        INTO
            :PROFILE_ID,
            :PROFILE_NAME,
            :OWNER_ID,
			:PROFILE_COMMENT,
			:LIBRARY_ID,
			:GEDUSER_ID,
			:PROFILE_CREATE_DATE,
			:PROFILE_MODIF_DATE,
			:FBSERVER_ID,
            :OWNER_STATE,
            :LIBRARY_STATE,
			:GEDUSER_STATE,
            :FBSERVER_STATE
        
        DO
    BEGIN
        REC_FOUND=:REC_FOUND+1;
        SUSPEND;
    END

    IF (REC_FOUND=0) THEN EXCEPTION EX_NOPROFILE;
END ^

ALTER PROCEDURE GET_STATES (I_TARGETED_TABLE VARCHAR(255) CHARACTER SET UTF8 NOT NULL,
I_CRITERIA VARCHAR(8000) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_RETURN_COLUMN VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT 'ID',
I_TARGETED_COLUMN VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT 'STATE')
RETURNS (COLUMN_ID VARCHAR(8000) CHARACTER SET UTF8,
STATE STATE)
AS 
/*
    Cette procdure renvoi l'tat d'une colonne STATE pour des enregistrements donns
    
    Attend :
    - I_TARGETED_TABLE : nom d'une table  impacter
    - I_CRITERIA : critre  appliquer pour la mise  jour
    - I_RETURN_COLUMN  : Nom d'une colonne devant accompagn le rsultat
    - I_TARGETED_COLUMN : Nom de la colonne STATE dans I_TARGETED_TABLE ('STATE' par dfaut)
    
    Retourne :
    - COLUMN_ID : Valeur de la colonne "I_RETURN_COLUMN" au format VARCHAR (Attention  convertir cette valeur dans le rsultat, le cas chant)
    - STATE : Etat 
        
V31 :
	- Exception spcifique
*/

BEGIN

    I_CRITERIA = TRIM(:I_CRITERIA);
    I_TARGETED_TABLE = TRIM(:I_TARGETED_TABLE);
    I_TARGETED_COLUMN= TRIM(I_TARGETED_COLUMN);
    I_RETURN_COLUMN = TRIM(I_RETURN_COLUMN);
    
    IF (NOT EXISTS 
        (SELECT RDB$RELATION_NAME FROM RDB$RELATION_FIELDS WHERE RDB$RELATION_NAME=:I_TARGETED_TABLE AND RDB$FIELD_NAME=:I_TARGETED_COLUMN AND RDB$SYSTEM_FLAG=0)
        ) THEN
        EXCEPTION EX_NOTABLEORCOL;
    IF (NOT EXISTS 
        (SELECT RDB$RELATION_NAME FROM RDB$RELATION_FIELDS WHERE RDB$RELATION_NAME=:I_TARGETED_TABLE AND RDB$FIELD_NAME=:I_RETURN_COLUMN AND RDB$SYSTEM_FLAG=0)
        ) THEN
        EXCEPTION EX_NOTABLEORCOL;

/*
    FOR EXECUTE STATEMENT '
        SELECT  ' || I_RETURN_COLUMN || ', ' || I_TARGETED_COLUMN || ' FROM ' || I_TARGETED_TABLE || IIF(I_CRITERIA='','',' WHERE ' || I_CRITERIA)
            INTO :COLUMN_ID, :STATE
    DO
        SUSPEND;
*/        
    
    FOR EXECUTE STATEMENT '
        SELECT  CAST(' || :I_RETURN_COLUMN || ' AS VARCHAR(8000)), ' || :I_TARGETED_COLUMN || ' FROM ' || :I_TARGETED_TABLE || IIF(:I_CRITERIA='','',' WHERE ' || :I_CRITERIA)
            INTO :COLUMN_ID, :STATE
    DO
        SUSPEND;
    
END ^

ALTER PROCEDURE GET_STATE_CRITERIA (I_EXPR_CRIT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL,
I_TARGETED_COLUMN VARCHAR(1000) CHARACTER SET UTF8 NOT NULL)
RETURNS (CRIT_FOR_STATE VARCHAR(1000) CHARACTER SET UTF8)
AS 
DECLARE VARIABLE OP_BIN CHAR(1);
DECLARE VARIABLE COMP_VAL INTEGER;
DECLARE VARIABLE COMP_VAL_STR VARCHAR(15);
/*
    Cette procdure renvoi une chaine de critre de test d'tat (colonnes STATE dans les diffrentes tables)
    
    Attend :
    - I_EXPR_CRIT_STATE : une expression de critre sous la forme : oprateur+valeur (aucun espace ou autre caractre de sparation) o :
        -> Oprateur peut tre :
        "=" pour "gal" (correspondance atomique dans la colonne cible),
        "#" pour "diffrent" (non correspondance atomique dans la colonne cible)
        "~" pour "correspond" (correspondance non atomique  dans la colonne cible, donc renvoi les enregistrements ayant les valeurs actives et d'autres)
        "&" pour "ne correspond pas" (non correpondance non atomique  dans la colonne cible, donc renvoi les enregistrements ayant les valeurs actives et d'autres)
        "*" pour aucun critre (ncessaire car, par dfaut, les appelants initialise l'tat  0 et qu'il faut leur donner un moyen de demander tous les enregistrements)
        -> valeur peut-tre toute valeur ou toute combinaison de valeur (doit tre vide si I_EXPR_CRIT_STATE = "*")
    - I_TARGETED_COLUMN : nom d'une colonne (pleinement qualifie prconis)
    
    Retourne :
    - CRIT_FOR_STATE : une chaine correpond  un critre final construit et utilisable dans une clause WHERE
    
    Exemple :
    SELECT GET_STATE_CRITERIA('=2','COLNAME') ==> 'COLNAME=2'
    SELECT GET_STATE_CRITERIA('#2','COLNAME') ==> 'COLNAME!=2'
    SELECT GET_STATE_CRITERIA('~2','COLNAME') ==> 'BIN_AND(COLNAME,2)!=0'
    SELECT GET_STATE_CRITERIA('~2','COLNAME') ==> 'BIN_AND(COLNAME,2)=0'
    
    si "=" on cherche la valeur atomique (donc la valeur de la colonne doit tre pleinement gale  celle de la valeur)
    si "~# on cherche la valeur prsente (donc la valeur de la colonne soit au moins avoir cette valeur prsente ventuellement cumule avec d'autres)
    Donc, pour un enregistrement contenant la valeur STATE = 5 (donc les tats 4 + 1) :
    '=5' ==> TRUE
    '=4' ==> FALSE
    '=1' ==> FALSE
    '~5' ==> TRUE
    '~4' ==> TRUE
    '~1' ==> TRUE
    '~2' ==> FALSE
    ...
    Il est possible de tester des combinaisons d'tat, par exemple
    '~7' (4+2+1) va renvoyer les enregistrements qui ont TOUS ces tats actifs et ventuellement d'autres
        par exemple un enregistrement ayant un tat 15 (4 + 2 + 1 + 8) sera BIEN montr
    '=7' (4+2+1) va renvoyer les enregistrement qui correspondent exactement  7 (si d'autres tats sont positionns, les enregitrements ne seront pas pris en compte,
        par exemple un enregistrement ayant un tat 15 (4 + 2 + 1 + 8) ne sera PAS montr
*/
BEGIN
    I_EXPR_CRIT_STATE=TRIM(I_EXPR_CRIT_STATE);
    I_TARGETED_COLUMN=TRIM(I_TARGETED_COLUMN);

    /* Extraction de l'oprateur */
    OP_BIN = LEFT(I_EXPR_CRIT_STATE,1);
    IF (OP_BIN ='' OR (OP_BIN NOT IN ('=','#','~','&','*'))) THEN
        EXCEPTION EX_BAD_PARAM;
    
    /* Extraction de la valeur de comparaison */
    COMP_VAL_STR = TRIM(SUBSTRING(I_EXPR_CRIT_STATE FROM 2));
    IF (COMP_VAL_STR = '' AND I_EXPR_CRIT_STATE !='*') THEN
        EXCEPTION EX_BAD_PARAM;
    ELSE
        COMP_VAL=IIF(COMP_VAL_STR='',NULL,CAST(COMP_VAL_STR AS INTEGER));
    
    /* galit atomique */
    IF (OP_BIN = '=') THEN
        CRIT_FOR_STATE = :I_TARGETED_COLUMN || ' = ' || :COMP_VAL;
    /* Diffrence atomique */
    ELSE IF (OP_BIN = '#') THEN
        CRIT_FOR_STATE = :I_TARGETED_COLUMN || ' != ' || :COMP_VAL;
    /* Contient */
    ELSE IF (OP_BIN = '~') THEN
        CRIT_FOR_STATE = 'BIN_AND(' || :I_TARGETED_COLUMN || ',' || :COMP_VAL || ')!=0';
    /* Ne contient pas */
    ELSE IF (OP_BIN = '&') THEN
        CRIT_FOR_STATE = 'BIN_AND(' || :I_TARGETED_COLUMN || ',' || :COMP_VAL || ')=0';
    /* Tous les enregistrements ==> Pas de critre */
    ELSE IF (OP_BIN = '*') THEN
        CRIT_FOR_STATE = '';
    ELSE
        EXCEPTION EX_BAD_PARAM;
    
    SUSPEND;
    
END ^

ALTER PROCEDURE GET_STORAGES (I_TOWNER_ID INTEGER NOT NULL,
I_TSTORAGE_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TSTORAGE_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDUSER_ID INTEGER,
LIBRARY_ID INTEGER,
STORAGE_SECTION VARCHAR(40) CHARACTER SET UTF8,
STORAGE_NAME VARCHAR(80) CHARACTER SET UTF8,
STORAGE_VALUE VARCHAR(8000) CHARACTER SET UTF8,
STORAGE_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
/*
	Renvoie une liste (ou un seul) paramtre TSTORAGE

	Si TLIBRARY_ID et/ou TGEDUSER_ID est pass, on ne vrifie pas qu'il(s) corresponde(nt) au OWNER_ID...
	Les STATES OWNER/GEDUSER/LIBRARY ne sont PAS values par cette procdure...
	On pratique par filtage successif sur les paramtres passs, DANS l'ORDRE de l'index "STORAGE_UNI" (pour l'accrocher)
	TODO :
		Revoir les index car si TOWNER et/ou SECTION/NAME non passe(s) on n'accroche pas l'index TSTORAGE_UNI
		Prvoi rdes index additionnels sur SECTION/NAME ?
	
	

V40 :
	- Cration

*/


DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE NULL_PARAM INTEGER;

BEGIN

    -- OWNER obligatoire si GEDUSER/LIBRARY non fourni
    IF (:I_TOWNER_ID=0 AND :I_TSTORAGE_TGEDUSER_ID<=0 AND I_TSTORAGE_TLIBRARY_ID<=0) THEN
        EXCEPTION EX_BAD_PARAM;
    
    -- dummy WHERE pour OWNER_ID non pass...
    -- Dans ce cas, on n'accroche pas l'index :-(
    SQL_WHERE=IIF(:I_TOWNER_ID!=0,'TOWNER_ID=' || :I_TOWNER_ID,'1=1');
        
    I_TSTORAGE_NAME = TRIM(:I_TSTORAGE_NAME);
    I_TSTORAGE_SECTION = TRIM(:I_TSTORAGE_SECTION);
    
    SQL_WHERE=:SQL_WHERE || IIF(:I_TSTORAGE_SECTION!='',' AND SECTION=''' || :I_TSTORAGE_SECTION ||'''','');
    
    SQL_WHERE=:SQL_WHERE || IIF(:I_TSTORAGE_NAME!='',' AND "NAME"=''' || :I_TSTORAGE_NAME ||'''','');

	-- Rcupration du DOM_PARAM reprsentant la recherche de valeur NULL
	NULL_PARAM=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','PARAM_EQUIV_NULL')),-9);
    
    IF (:I_TSTORAGE_TGEDUSER_ID!=0) THEN
        SQL_WHERE=:SQL_WHERE || ' AND TGEDUSER_ID' || IIF(:I_TSTORAGE_TGEDUSER_ID=NULL_PARAM,' IS NULL', '=' || :I_TSTORAGE_TGEDUSER_ID);
    
    IF (:I_TSTORAGE_TLIBRARY_ID!=0) THEN
        SQL_WHERE=:SQL_WHERE || ' AND TLIBRARY_ID' || IIF(:I_TSTORAGE_TLIBRARY_ID=NULL_PARAM,' IS NULL', '=' || :I_TSTORAGE_TLIBRARY_ID);
        
    FOR EXECUTE STATEMENT
        'SELECT 
            TOWNER_ID,
            COALESCE(TGEDUSER_ID,0),
            COALESCE(TLIBRARY_ID,0),
            SECTION,
            NAME,
            "VALUE",
            (SELECT DATE_STRING FROM GET_DATE_STRING(MODIF_DATE))
        FROM TSTORAGE
        WHERE ' ||:SQL_WHERE
        INTO
            :OWNER_ID,
            :GEDUSER_ID,
            :LIBRARY_ID,
            :STORAGE_SECTION,
            :STORAGE_NAME,
            :STORAGE_VALUE,
            :STORAGE_MODIF_DATE
            
        DO
            SUSPEND;
END ^

ALTER PROCEDURE GET_SUBDOMAIN_EXISTS (I_TOWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
PROFILE_ID INTEGER)
AS 
/*
    Renvoi l'ID du propritaire d'un sous domaine donn
    
    Attend :
    - I_TOWNER_SUBDOMAIN : Nom du sous-domaine recherch (UNIQUE)
    
    Retourne :
    - OWNER_ID : Code du propritaire ou vide si non trouv...
    
    NB : Cette procdure ne lve pas d'exception en cas de sous-domain inexistant OU non visible (OWNER.STATE)
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);

BEGIN
    SQL_WHERE_OWNER = '';
    
    IF (:I_TOWNER_STATE ='' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_VISIBILITY FROM GET_VISIBILITY_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    FOR EXECUTE STATEMENT
        'SELECT
            ID,
            COALESCE(TOWNER.TPROFILE_ID,0)
        FROM TOWNER
		WHERE SUBDOMAIN=''' || :I_TOWNER_SUBDOMAIN || '''' || IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
		INTO :OWNER_ID, PROFILE_ID
    DO
        SUSPEND;
END ^

ALTER PROCEDURE GET_VISIBILITY_STATE_OK (I_TARGETED_COLUMN VARCHAR(1000) CHARACTER SET UTF8 NOT NULL)
RETURNS (SQL_WHERE_DEFAULT_VISIBILITY VARCHAR(255) CHARACTER SET UTF8)
AS 
/*
    Cette procdure renvoit la valeur d'tat de visibilit *par dfaut*
    Rappel : Les procdures stockes de slection permettent de modifier cet tat par dfaut par l'intermdiaire d'un paramtre formel, le cas chant
    
    On utilise deux paramtres du domaine (DOM_RECORD_VISIBILITY_KO et ADM_RECORDS_VISIBILITY_KO) afin de connaitre les tats NE PERMETTANT PAS la visualisation.
        - Le premier est rattach  l'application (et ne devrait pas tre modifi par d'autres personnes que les programmeurs)
        - Pour l'instant (V7) nous considrons que l'tat 1 (deleted) ne doit jamais tre affich par dfaut
        - Le second est laisser  la discrtion de l'administrateur de site afin qu'il gre ces propres tats de non visibiit
        - La valeur de ce second paramtre est ajout  la valeur du premier afin de dterminer, finalement, quels sont les enregistrements visibles ou pas...
    
    Ces paramtres doivent indiquer les combinaisons d'tat ne permettant pas une visualisation, par exemple :
    - DOM_RECORDS_VISIBILITY_KO = 1
        ==> seuls les enregistrements STATE ne contenant pas 1 sont visibles (valeur par dfaut)
    - ADM_RECORD_VISIBILITY_KO = 1 (inutile car cet tat est dja considr comme invisible par dfaut dans DOM_RECORDS_VISIBILITY_KO)
    - DOM_RECORD_VISIBILITY_KO = 6 ==> seuls les enregistrements STATE = 0 ou tat ne contient pas 1 (DOM_RECORDS_VISIBILITY_KO) ou tat ne contient pas 2 ou tat ne contient pas 4 sont visibles
        (attention, ce n'est pas la valeur atomique de la colonne qui est prise en compte, mais le ou les tats prsents ou non dans cette colonne)
	
V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/

DECLARE VARIABLE STATE_TEST STATE;
BEGIN

	I_TARGETED_COLUMN=TRIM(I_TARGETED_COLUMN);
	IF (I_TARGETED_COLUMN = '') THEN EXCEPTION EX_BAD_PARAM;

    /*
    Si le paramtre DOM_RECORDS_ALTER_KO n'est pas trouv, on essai avec (au moins) le paramtres des enregistrements supprim (DOM_RECORD_DELETED)
    Si aucun des paramtres n'est disponible, on init en dur  1
    */
    STATE_TEST=COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','RECORDS_VISIBILITY_KO')),
        (SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')),1);

    /* Init des tats Admin  tester */
    STATE_TEST=BIN_OR(:STATE_TEST,COALESCE((SELECT CAST(DOMPARAM_VALUE AS INTEGER) FROM GET_DOMPARAM('ADMIN','RECORDS_VISIBILITY_KO')),0)); 
    
    /*
    On compare la colonne par rapport au paramtre en ajoutant les tats considrs comme devant tre TOUJOURS masqus
    */
    SQL_WHERE_DEFAULT_VISIBILITY =  'BIN_AND(' || :I_TARGETED_COLUMN || ',' || :STATE_TEST || ')=0';
    
    SUSPEND;
    
END ^

ALTER PROCEDURE PURGE_ALL (I_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_PURGE_LOGSYNC BOOLEAN NOT NULL DEFAULT 0)
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
/*
	Purge des tables purgeables
	On appelle les PS de PURGE avec des paramtres 'standards'
	Cette PS ne puge *que* les enregistrements marqus DELETED dans les tables principales (et ventuellement les enfants dans les tables lies)
	Pour des purges plus fines (bases sur STATE/ou un ID particulier par exemple), il faut utiliser la PS PURGE_XXXX correspondante et lui passer les bons arguments
    
TODO : 
    
V34 :
    - Cration
*/

BEGIN

    FOR SELECT RESULT FROM PURGE_OWNERS(0,:I_MODIF_DATE) INTO :RESULT
        DO SUSPEND;

    -- Suppression des TLIBRARY
    FOR SELECT RESULT FROM PURGE_LIBRARIES(0,:I_MODIF_DATE,0) INTO :RESULT
        DO SUSPEND;
    
    -- Suppression des contacts (non supprims par PURGE_OWNERS)
    FOR SELECT RESULT FROM PURGE_CONTACTS(0,:I_MODIF_DATE,0) INTO :RESULT
        DO SUSPEND;

    -- Suppression des gedusers
    FOR SELECT RESULT FROM PURGE_GEDUSERS(0,:I_MODIF_DATE,0) INTO :RESULT
        DO SUSPEND;
        
    IF (I_PURGE_LOGSYNC!=0) THEN
    BEGIN
        -- On force la suppression en passant la date du jour +1 en paramtre
        FOR SELECT RESULT FROM PURGE_LOGSYNC(0,0,IIF(:I_MODIF_DATE!='',:I_MODIF_DATE,(SELECT DATE_STRING FROM GET_DATE_STRING(DATEADD(DAY,+1,CURRENT_DATE))))) INTO :RESULT
            DO SUSPEND;
    END

        
END ^

ALTER PROCEDURE PURGE_CONTACTS (I_TCONTACT_ID INTEGER NOT NULL DEFAULT 0,
I_TCONTACT_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
/*
    Purge des contacts
    
TODO : 

V34 :
    -Cration
*/
DECLARE VARIABLE CONT_ID INTEGER;
DECLARE VARIABLE SQL_WHERE_CONT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_STATE VARCHAR(8000);

BEGIN

    I_TCONTACT_MODIF_DATE=TRIM(I_TCONTACT_MODIF_DATE);
    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);

    -- Construction de la chaine de critre
    SQL_WHERE_CONT='';
    SQL_WHERE_STATE='';
    
    IF (:I_TCONTACT_ID!=0) THEN
    BEGIN
        IF (NOT EXISTS(SELECT ID FROM TCONTACT WHERE ID=:I_TCONTACT_ID)) THEN
            EXCEPTION EX_NOCONTACT;
        SQL_WHERE_CONT='TCONTACT.ID=' || :I_TCONTACT_ID;
    END
    
    IF (:I_TOWNER_ID!=0) THEN
	BEGIN
		IF (NOT EXISTS(SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN
			EXCEPTION EX_NOOWNER;
        SQL_WHERE_CONT=:SQL_WHERE_CONT || IIF(:SQL_WHERE_CONT!='',' AND ','') || 'TCONTACT.TOWNER_ID=' || :I_TOWNER_ID;
	END
    
    -- On ne prend en compte que les STATE DELETED par dfaut...
    IF (:I_TCONTACT_STATE='') THEN
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA('~' ||
            COALESCE(
                (SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')),
                '1'
            ),
            'TCONTACT.STATE'
        ) INTO :SQL_WHERE_STATE;
    ELSE -- STATE pass en argument...
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE,'TCONTACT.STATE') INTO :SQL_WHERE_STATE;

    SQL_WHERE_CONT=:SQL_WHERE_CONT || IIF(:SQL_WHERE_CONT!='' and :SQL_WHERE_STATE!='',' AND ','') || SQL_WHERE_STATE;
        
    -- DATE MAJ
    IF (I_TCONTACT_MODIF_DATE!='') THEN
        SQL_WHERE_CONT=:SQL_WHERE_CONT || IIF(:SQL_WHERE_CONT!='',' AND ','') || 'TCONTACT.MODIF_DATE <=''' || (SELECT DATE_STRING FROM SET_STRING_DATE(:I_TCONTACT_MODIF_DATE)) || '''';

    -- Aucun critre, on refuse
    IF (:SQL_WHERE_CONT='' ) THEN
        EXCEPTION EX_BAD_PARAM;
        
/*
	-- DEBUG
    RESULT=:SQL_WHERE_CONT;
    SUSPEND;
    EXIT;
*/
    

    -- Rcupration des TCONTACTS  traiter...
    /*
    On ne peut pas crer de cursor avec FOR EXECUTE STATEMENT, dommage...
    Dans cette boucle, on fait donc :
        - le mnage dans les tables dpendantes
        - suppression du contact en cours
    */
    FOR EXECUTE STATEMENT
        'SELECT ID FROM TCONTACT 
        WHERE ' || :SQL_WHERE_CONT
        INTO CONT_ID
    DO
    BEGIN
        RESULT=' Suppression du contact : ' || CAST(CONT_ID AS VARCHAR(10)) || ' : ';
    
        -- Suppression des TCONTLIB
        DELETE FROM TCONTLIB WHERE TCONTACT_ID=:CONT_ID;
        RESULT=RESULT || CAST(ROW_COUNT AS VARCHAR(10)) || ' TCONTLIB supprim(s)';

        -- Suppression des TCONTOWNER
        DELETE FROM TCONTOWNER WHERE TCONTACT_ID=:CONT_ID;
        RESULT=RESULT ||  '- ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TCONTOWNER supprim(s)';

        -- Mise  NULL des TGEDUSER
        UPDATE TGEDUSER SET TCONTACT_ID=NULL WHERE TCONTACT_ID=:CONT_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDUSER mis  NULL';

        -- Mise  NULL des TOWNER
        UPDATE TOWNER SET TCONTACT_ID=NULL WHERE TCONTACT_ID=:CONT_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TOWNER mis  NULL';

        -- Je ne sais pas si c'est bien propre ? Mais a passe, manifestement
        DELETE FROM TCONTACT WHERE ID=:CONT_ID;

        SUSPEND;
    END



END ^

ALTER PROCEDURE PURGE_GEDUSERS (I_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
/*
        Purge des Utilisateurs

TODO : 
    
V34 :
    -Cration

V40
    - Traitement TSTORAGE
*/

DECLARE VARIABLE GEDU_ID INTEGER;
DECLARE VARIABLE SQL_WHERE_GEDU VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_STATE VARCHAR(8000);
BEGIN

    I_TGEDUSER_MODIF_DATE=TRIM(I_TGEDUSER_MODIF_DATE);
    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

    -- Construction de la chaine de critre
    SQL_WHERE_GEDU='';
    SQL_WHERE_STATE='';
    
    IF (:I_TGEDUSER_ID!=0) THEN
    BEGIN
        IF (NOT EXISTS(SELECT ID FROM TGEDUSER WHERE ID=:I_TGEDUSER_ID)) THEN
            EXCEPTION EX_NOGEDUSER;
        SQL_WHERE_GEDU='TGEDUSER.ID=' || :I_TGEDUSER_ID;
    END
    
    IF (:I_TOWNER_ID!=0) THEN
	BEGIN
		IF (NOT EXISTS(SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN
			EXCEPTION EX_NOOWNER;
        SQL_WHERE_GEDU=:SQL_WHERE_GEDU || IIF(:SQL_WHERE_GEDU!='',' AND ','') || 'TGEDUSER.TOWNER_ID=' || :I_TOWNER_ID;
	END
    
    -- On ne prend en compte que les STATE DELETED par dfaut...
    IF (:I_TGEDUSER_STATE='') THEN
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA('~' ||
            COALESCE(
                (SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')),
                '1'
            ),
            'TGEDUSER.STATE'
        ) INTO SQL_WHERE_STATE;
    ELSE -- STATE pass en argument...
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE,'TGEDUSER.STATE') INTO SQL_WHERE_STATE;

    SQL_WHERE_GEDU=:SQL_WHERE_GEDU || IIF(:SQL_WHERE_GEDU!='' AND SQL_WHERE_STATE!='' ,' AND ','') || :SQL_WHERE_STATE;
        
    -- DATE MAJ
    IF (I_TGEDUSER_MODIF_DATE!='') THEN
        SQL_WHERE_GEDU=:SQL_WHERE_GEDU || IIF(:SQL_WHERE_GEDU!='',' AND ','') || 'TGEDUSER.MODIF_DATE <=''' || (SELECT DATE_STRING FROM SET_STRING_DATE(:I_TGEDUSER_MODIF_DATE)) || '''';

    -- Aucun critre, on refuse
    IF (:SQL_WHERE_GEDU='' ) THEN
        EXCEPTION EX_BAD_PARAM;
        
/*
    -- DEBUG
    RESULT=:SQL_WHERE_GEDU;
    SUSPEND;
    EXIT;
*/
    -- Rcupration des TGEDUSER  traiter...
    /*
    On ne peut pas crer de cursor avec FOR EXECUTE STATEMENT, dommage...
    Dans cette boucle, on fait donc :
        - le mnage dans les tables dpendantes
        - suppression du geduser en cours
    */
    FOR EXECUTE STATEMENT
        'SELECT ID FROM TGEDUSER 
        WHERE ' || :SQL_WHERE_GEDU
        INTO GEDU_ID
    DO
    BEGIN
        RESULT=' Suppression de l''utilisateur : ' || CAST(GEDU_ID AS VARCHAR(10)) || ' : ';
    
        -- Suppression des TGEDUSERLIB
        DELETE FROM TGEDUSERLIB WHERE TGEDUSER_ID=:GEDU_ID;
        RESULT=RESULT || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDUSERLIB supprim(s)';

        -- Suppression des TGEDPARAMUSER
        DELETE FROM TGEDPARAMUSER WHERE TGEDUSER_ID=:GEDU_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDPARAMUSER supprim(s)';

        -- Suppression des TGEDGROUPUSER
        DELETE FROM TGEDGROUPUSER WHERE TGEDUSER_ID=:GEDU_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDGROUPUSER supprim(s)';

        -- Suppression TSTORAGE
        DELETE FROM TSTORAGE WHERE TGEDUSER_ID=:GEDU_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TSTORAGE supprim(s)';

        -- Mise  NULL des TPROFILE
        UPDATE TPROFILE SET TGEDUSER_ID=NULL WHERE TGEDUSER_ID=:GEDU_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TPROFILE mis  NULL';
        
        -- Je ne sais pas si c'est bien propre ? Mais a passe, manifestement
        DELETE FROM TGEDUSER WHERE ID=:GEDU_ID;

        SUSPEND;
    END

END ^

ALTER PROCEDURE PURGE_LIBRARIES (I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
/*
        Purge des Libraries

TODO : 
    - Voir purge LOG SYNC ???
    
V34 :
    - Cration
    
V40 :
    - SUppression TSTORAGE
*/

DECLARE VARIABLE LIB_ID INTEGER;
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_STATE VARCHAR(8000);
BEGIN

    I_TLIBRARY_MODIF_DATE=TRIM(I_TLIBRARY_MODIF_DATE);
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);

    -- Construction de la chaine de critre
    SQL_WHERE_LIB='';
    SQL_WHERE_STATE='';
    
    IF (:I_TLIBRARY_ID!=0) THEN
    BEGIN
        IF (NOT EXISTS(SELECT ID FROM TLIBRARY WHERE ID=:I_TLIBRARY_ID)) THEN
            EXCEPTION EX_NOLIB;
        SQL_WHERE_LIB='TLIBRARY.ID=' || :I_TLIBRARY_ID;
    END
    
    IF (:I_TOWNER_ID!=0) THEN
	BEGIN
		IF (NOT EXISTS(SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN
			EXCEPTION EX_NOOWNER;
        SQL_WHERE_LIB=:SQL_WHERE_LIB || IIF(:SQL_WHERE_LIB!='',' AND ','') || 'TLIBRARY.TOWNER_ID=' || :I_TOWNER_ID;
	END
    
    -- On ne prend en compte que les STATE DELETED par dfaut...
    IF (:I_TLIBRARY_STATE='') THEN
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA('~' ||
            COALESCE(
                (SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')),
                '1'
            ),
            'TLIBRARY.STATE'
        ) INTO SQL_WHERE_STATE;
    ELSE -- STATE pass en argument...
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE,'TLIBRARY.STATE') INTO SQL_WHERE_STATE;

    SQL_WHERE_LIB=:SQL_WHERE_LIB || IIF(:SQL_WHERE_LIB!='' AND :SQL_WHERE_STATE!='',' AND ','') || :SQL_WHERE_STATE;
        
    -- DATE MAJ
    IF (I_TLIBRARY_MODIF_DATE!='') THEN
        SQL_WHERE_LIB=:SQL_WHERE_LIB || IIF(:SQL_WHERE_LIB!='',' AND ','') || 'TLIBRARY.MODIF_DATE <=''' || COALESCE((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TLIBRARY_MODIF_DATE)),'1=1') || '''';

    -- Aucun critre, on refuse
    IF (:SQL_WHERE_LIB='' ) THEN
        EXCEPTION EX_BAD_PARAM;
        
/*
    -- DEBUG
    RESULT=:SQL_WHERE_LIB;
    SUSPEND;
    EXIT;
*/


    -- Rcupration des TLIBRARY  traiter...
    /*
    On ne peut pas crer de cursor avec FOR EXECUTE STATEMENT, dommage...
    Dans cette boucle, on fait donc :
        - le mnage dans les tables dpendantes
        - suppression du geduser en cours
    */
    FOR EXECUTE STATEMENT
        'SELECT ID FROM TLIBRARY 
        WHERE ' || :SQL_WHERE_LIB
        INTO LIB_ID
    DO
    BEGIN
        RESULT=' Suppression de la Bibiothque : ' || CAST(LIB_ID AS VARCHAR(10)) || ' : ';
        
        -- Suppression des TGEDUSERLIB
        DELETE FROM TGEDUSERLIB WHERE TLIBRARY_ID=:LIB_ID;
        RESULT=RESULT || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDUSERLIB supprim(s)';

        -- Suppression des TGEDGROUPLIB
        DELETE FROM TGEDGROUPLIB WHERE TLIBRARY_ID=:LIB_ID;
        RESULT=RESULT || ' - ' ||  CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDGROUPLIB supprim(s)';

        -- Suppression des TCONTLIB
        DELETE FROM TCONTLIB WHERE TLIBRARY_ID=:LIB_ID;
        RESULT=RESULT || ' - ' ||  CAST(ROW_COUNT AS VARCHAR(10)) || ' TCONTLIB supprim(s)';

        -- Suppression des TGEDPARAMUSER
        DELETE FROM TGEDPARAMUSER WHERE TLIBRARY_ID=:LIB_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDPARAMUSER supprim(s)';

        -- Suppression TSTORAGE
        DELETE FROM TSTORAGE WHERE TLIBRARY_ID=:LIB_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TSTORAGE supprim(s)';

/*
        -- Suppression des TLOGSYNC (on garde trace en ERR_COMMENT)
        DELETE FROM TLOGSYNC
            WHERE TLOGSYNC.TLIBRARY_ID=:LIB_ID;
        RESULT=RESULT || '- ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TLOGSYNC supprim(s)';
*/

        -- Mise  NULL des TPROFILE
        UPDATE TPROFILE SET TLIBRARY_ID=NULL WHERE TLIBRARY_ID=:LIB_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TPROFILE mis  NULL';

        -- Mise  NULL des TGEDPARAM
        UPDATE TGEDPARAM SET TLIBRARY_ID=NULL WHERE TLIBRARY_ID=:LIB_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDPARAM mis  NULL';

        -- Je ne sais pas si c'est bien propre ? Mais a passe, manifestement
        DELETE FROM TLIBRARY WHERE ID=:LIB_ID;

        SUSPEND;
    END

END ^

ALTER PROCEDURE PURGE_LOGSYNC (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TIME_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
/*
        Purge des log de synchros
TODO : 
    
V34 :
    - Cration
*/
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE COUNT_DEL INTEGER;
BEGIN

    I_TIME_END=TRIM(I_TIME_END);

    SQL_WHERE='';
    
    IF (:I_TOWNER_ID!=0) THEN
        SQL_WHERE='TOWNER_ID=' || :I_TOWNER_ID;
        
    IF (:I_TLIBRARY_ID!=0) THEN
        SQL_WHERE=:SQL_WHERE || IIF(:SQL_WHERE!='',' AND ', '') || 'TLIBRARY_ID=' || :I_TLIBRARY_ID;
    
    IF (:I_TIME_END!='') THEN
        SQL_WHERE=:SQL_WHERE || IIF(:SQL_WHERE!='',' AND ', '') || 'TIME_END<=''' || CAST((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TIME_END)) AS TIMESTAMP) || '''';

    -- Aucun critre pass, on refuse
    IF (:SQL_WHERE='' ) THEN
        EXCEPTION EX_BAD_PARAM;
        
    -- Ajout d'un critre pour ne pas effacer les LOGSYNC utiliss en tant que dernier SYNCHRO au niveau des LIB (TLIBRARY.TLOGSYNC_ID)
    SQL_WHERE=:SQL_WHERE || ' AND TLOGSYNC.ID NOT IN (SELECT DISTINCT TLIBRARY.TLOGSYNC_ID FROM TLIBRARY WHERE TLIBRARY.TLOGSYNC_ID IS NOT NULL)';
    
/*
    -- DEBUG
    RESULT=:SQL_WHERE;
    SUSPEND;
    EXIT;
*/
            
    EXECUTE STATEMENT 'SELECT COUNT(ID) FROM TLOGSYNC WHERE ' || :SQL_WHERE INTO COUNT_DEL;
    EXECUTE STATEMENT 'DELETE FROM TLOGSYNC WHERE ' || :SQL_WHERE;

    RESULT=CAST(COUNT_DEL AS VARCHAR(10)) || ' TLOGSYNC supprim(s)';
    
    SUSPEND;
    
END ^

ALTER PROCEDURE PURGE_OWNERS (I_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
/*
        Purge des Propritaires

TODO : 
    
V34 :
    - Cration

V39 :
	- MAJ pour effacement TGEDPARAM + TGEDGROUP ventuellement affects...
*/
DECLARE VARIABLE OWNER_ID INTEGER;
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_STATE VARCHAR(8000);

DECLARE VARIABLE GEDGROUP_ID INTEGER;

DECLARE VARIABLE RESULT_TEMP VARCHAR(8000);

BEGIN

    I_TOWNER_MODIF_DATE=TRIM(I_TOWNER_MODIF_DATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

    -- Construction de la chaine de critre
    SQL_WHERE_OWNER='';
    SQL_WHERE_STATE='';

    IF (:I_TOWNER_ID!=0) THEN
    BEGIN
        IF (NOT EXISTS(SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN
            EXCEPTION EX_NOOWNER;
        SQL_WHERE_OWNER='TOWNER.ID=' || :I_TOWNER_ID;
    END
    
    -- On ne prend en compte que les STATE DELETED par dfaut...
    IF (:I_TOWNER_STATE='') THEN
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA('~' ||
            COALESCE(
                (SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')),
                '1'
            ),
            'TOWNER.STATE'
        ) INTO :SQL_WHERE_STATE;
    ELSE -- STATE pass en argument...
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE,'TOWNER.STATE') INTO :SQL_WHERE_STATE;

    SQL_WHERE_OWNER=:SQL_WHERE_OWNER || IIF(:SQL_WHERE_OWNER!='' AND :SQL_WHERE_STATE!='',' AND ','') || :SQL_WHERE_STATE;
        
    -- DATE MAJ
    IF (I_TOWNER_MODIF_DATE!='') THEN
        SQL_WHERE_OWNER=:SQL_WHERE_OWNER || IIF(:SQL_WHERE_OWNER!='',' AND ','') || 'TOWNER.MODIF_DATE <=''' || (SELECT DATE_STRING FROM SET_STRING_DATE(:I_TOWNER_MODIF_DATE)) || '''';

    -- Aucun critre, on refuse
    IF (:SQL_WHERE_OWNER='' ) THEN
        EXCEPTION EX_BAD_PARAM;
        
/*
    -- DEBUG
    RESULT=:SQL_WHERE_OWNER;
    SUSPEND;
    EXIT;
*/

    -- Rcupration des TGEDUSER  traiter...
    /*
    On ne peut pas crer de cursor avec FOR EXECUTE STATEMENT, dommage...
    Dans cette boucle, on fait donc :
        - le mnage dans les tables dpendantes
        - suppression du geduser en cours
    */
    FOR EXECUTE STATEMENT
        'SELECT ID FROM TOWNER 
        WHERE ' || :SQL_WHERE_OWNER
        INTO OWNER_ID
    DO
    BEGIN
        RESULT=' Suppression du Propritaire : ' || CAST(OWNER_ID AS VARCHAR(10)) || ' : ';
        SUSPEND;
        
        -- Suppression des contacts
        FOR SELECT RESULT FROM PURGE_CONTACTS(0,'',:OWNER_ID,'*') INTO :RESULT
            DO SUSPEND;

        -- Suppression des gedusers
        FOR SELECT RESULT FROM PURGE_GEDUSERS(0,'',:OWNER_ID,'*') INTO :RESULT
            DO SUSPEND;

        -- Suppression des PROFILES
        FOR SELECT RESULT FROM  PURGE_PROFILES(0,'',:OWNER_ID) INTO :RESULT 
            DO SUSPEND;

        -- Suppression des TGEDGROUP
        -- On supprime les dpendances dans TGEDGROUPLIB...
        FOR SELECT ID FROM TGEDGROUP WHERE TOWNER_ID=:OWNER_ID INTO GEDGROUP_ID
        DO
        BEGIN
            DELETE FROM TGEDGROUPLIB WHERE TGEDGROUP_ID=:GEDGROUP_ID;
            RESULT=CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDGROUPLIB supprim(s)';
            SUSPEND;
        END
        DELETE FROM TGEDGROUP WHERE TOWNER_ID=:OWNER_ID;
        RESULT=CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDGROUP supprim(s)';
        SUSPEND;
        
        -- Suppression des TGEDPARAM
        DELETE FROM TGEDPARAM WHERE TOWNER_ID=:OWNER_ID;
        RESULT=CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDPARAM supprim(s)';
        SUSPEND;

        -- Suppression des TGEDPARAMOWNER
        DELETE FROM TGEDPARAMOWNER WHERE TOWNER_ID=:OWNER_ID;
        RESULT=CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDPARAMOWNER supprim(s)';
        SUSPEND;

        -- Suppression des TLIBRARY
        FOR SELECT RESULT FROM PURGE_LIBRARIES(0,'',:OWNER_ID,'*') INTO :RESULT
            DO SUSPEND;

        -- Suppression TSTORAGE
        DELETE FROM TSTORAGE WHERE TOWNER_ID=:OWNER_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TSTORAGE supprim(s)';
        
        -- Je ne sais pas si c'est bien propre ? Mais a passe, manifestement
        DELETE FROM TOWNER WHERE ID=:OWNER_ID;
    END

END ^

ALTER PROCEDURE PURGE_PROFILES (I_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TPROFILE_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_ID INTEGER NOT NULL DEFAULT 0)
RETURNS (RESULT VARCHAR(8000) CHARACTER SET UTF8)
AS 
/*
        Purge des Profils
        Attention : les profils n'ont pas de STATE, la suppression est donc directe...

TODO : 
    
V34 :
    - Cration
*/

DECLARE VARIABLE PROF_ID INTEGER;
DECLARE VARIABLE SQL_WHERE_PROF VARCHAR(8000);
BEGIN

    I_TPROFILE_MODIF_DATE=TRIM(I_TPROFILE_MODIF_DATE);

    -- Construction de la chaine de critre
    SQL_WHERE_PROF='';
    
    IF (:I_TPROFILE_ID!=0) THEN
    BEGIN
        IF (NOT EXISTS(SELECT ID FROM TPROFILE WHERE ID=:I_TPROFILE_ID)) THEN
            EXCEPTION EX_NOPROFILE;
        SQL_WHERE_PROF='TPROFILE.ID=' || :I_TPROFILE_ID;
    END

    IF (:I_TOWNER_ID!=0) THEN
    BEGIN
        IF (NOT EXISTS(SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN
            EXCEPTION EX_NOOWNER;
        SQL_WHERE_PROF='TPROFILE.TOWNER_ID=' || :I_TOWNER_ID;
    END
    
    -- DATE MAJ
    IF (I_TPROFILE_MODIF_DATE!='') THEN
        SQL_WHERE_PROF=:SQL_WHERE_PROF || IIF(:SQL_WHERE_PROF!='',' AND ','') || 'TPROFILE.MODIF_DATE <=''' || (SELECT DATE_STRING FROM SET_STRING_DATE(:I_TPROFILE_MODIF_DATE)) || '''';

    -- Aucun critre, on refuse
    IF (:SQL_WHERE_PROF='' ) THEN
        EXCEPTION EX_BAD_PARAM;
        
/*
    -- DEBUG
    RESULT=:SQL_WHERE_PROF;
    SUSPEND;
    EXIT;
*/
    -- Rcupration des PROFILES  traiter...
    /*
    On ne peut pas crer de cursor avec FOR EXECUTE STATEMENT, dommage...
    Dans cette boucle, on fait donc :
        - le mnage dans les tables dpendantes
        - suppression du geduser en cours
    */
    FOR EXECUTE STATEMENT
        'SELECT ID FROM TPROFILE 
        WHERE ' || :SQL_WHERE_PROF
        INTO PROF_ID
    DO
    BEGIN
        RESULT=' Suppression du Profil : ' || CAST(PROF_ID AS VARCHAR(10)) || ' : ';
        
        -- Suppression des TGEDPARAMPROF
        DELETE FROM TGEDPARAMPROF WHERE TPROFILE_ID=:PROF_ID;
        RESULT=RESULT || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDPARAMPROF supprim(s)';

        -- Mise  NULL des TGEDGROUP
        UPDATE TGEDGROUP SET TPROFILE_ID=NULL WHERE TPROFILE_ID=:PROF_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDGROUP mis  NULL';

        -- Mise  NULL des TGEDUSER
        UPDATE TGEDUSER SET TPROFILE_ID=NULL WHERE TPROFILE_ID=:PROF_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDUSER mis  NULL';

        -- Mise  NULL des TGEDUSERLIB
        UPDATE TGEDUSERLIB SET TPROFILE_ID=NULL WHERE TPROFILE_ID=:PROF_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDUSERLIB mis  NULL';

        -- Mise  NULL des TGEDGROUPLIB
        UPDATE TGEDGROUPLIB SET TPROFILE_ID=NULL WHERE TPROFILE_ID=:PROF_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TGEDGROUPLIB mis  NULL';

        -- Mise  NULL des TLIBRARY
        UPDATE TLIBRARY SET TPROFILE_ID=NULL WHERE TPROFILE_ID=:PROF_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TLIBRARY mis  NULL';

        -- Mise  NULL des TOWNER
        UPDATE TOWNER SET TPROFILE_ID=NULL WHERE TPROFILE_ID=:PROF_ID;
        RESULT=RESULT || ' - ' || CAST(ROW_COUNT AS VARCHAR(10)) || ' TOWNER mis  NULL';

        DELETE FROM TPROFILE WHERE ID=:PROF_ID;

        SUSPEND;
    END

END ^

ALTER PROCEDURE SET_CONTACT_INFOS (I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTACT_TOWNER_ID INTEGER NOT NULL,
I_TCONTACT_NAME VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_FIRSTNAME VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_PREFIX VARCHAR(30) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_EMAIL VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_TEL VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_ADDRESS VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_POSTCODE VARCHAR(50) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_REGION VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_CITY VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_COUNTRY VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_ORGANIZATION VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_SERVICE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_IDENTIFIER VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_CELLTEL VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTACT_ID INTEGER)
AS 
/*
    Ajout/modification d'un contact dans la table correspondante
    
    Si l'ID est NULL ==> Insertion
    Si ID pass ==> mise  jour d'un contact existant
    
    Paramtres : cf table TCONTACT

    Particularits :
     - Les cls externes (TOWNER_ID) sont vrifies avant l'insertion et les exceptions correspondantes sont leves si non prsents
    - I_TCONTACT_STATE permet de prciser le STATE de MAJ (pas d'initialiser les colonnes STATE des tables (cf. PS SET_STATE ou DEL_CONTACT pour a)    
    -  propos des rgles de MAJ en update (en insertion le problme est plus simple) et des STATES :
        * Si un parent est inactif (STATE interdisant les modifications) on considre qu'il peut toutefois tre mis  jour si le nouveau parent est actif
        * Les paramtres I_XXX_STATE permettent donc de prciser si on autorise la MAJ avec un nuveau parent qui ne serait pas actif (on ne teste pas l'ancien parent)
        * Par exemple, pour le OWNER :
            * on ne se proccupe pas de TCONTACT.TOWNER_ID existant (STATE non valu)
            * on regarde si le I_TOWNER_ID est utilisable
                - Si c'est le cas, on peut modifier le OWNER_ID
                - Dans le cas contraire, on prend en compte le I_TOWNER_STATE pour savoir si l'on a le droit d'utiliser un OWNER_ID dsactiv
 
    renvoie :
        CONTACT_ID : Identifiant du contact insr/modifi si russite
        
    Attention
    - cette procdure lve des erreurs en cas d'insertion/mise  jour impossible (erreurs sous-jacentes)
    
    Les tats (colonne STATE) ne sont pas pris en compte pour les insertions...

V22 :
	Exception EX_NONULL codifie ('Nom contact' ==> '%%CONTACT_NAME%%')

MAJ V32 :
	- Ajout de ORGANIZATION, etc...
	- Exception EX_NONULL recodifie "%...%" (uniformisation des dlimiteurs de macros)

MAJ V34
    -NAME NULL OK...
    
MAJ V39
    - Les dates MAJ sont initialises ici (plus dans le trigger) via I_TCONTACT_NO_MODIF_DATE
*/
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
DECLARE VARIABLE MODIF_DATE TIMESTAMP;
BEGIN

    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);

    SQL_WHERE='';
    ID_OK=Null;

    /* Contact prsent et modifiable */
    IF (:I_TCONTACT_ID != 0 ) THEN
    BEGIN    
        IF (:I_TCONTACT_STATE= '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE; 

		-- On en profite pour rcuprer la dernre date de modif (ventuellement crase plus loin)
        EXECUTE STATEMENT '
            SELECT ID, MODIF_DATE FROM TCONTACT
            WHERE TCONTACT.ID=' || :I_TCONTACT_ID|| IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '')
            INTO :ID_OK, :MODIF_DATE;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOCONTACT;
     END
     
    SQL_WHERE=Null;
    ID_OK=Null;
    
    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE ID=' || :I_TCONTACT_TOWNER_ID || IIF (:SQL_WHERE != '' , ' AND (' || :SQL_WHERE || ')', '')
        INTO ID_OK;
        
	IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;
        
        
    /* Nettoyage des paramtres */
    I_TCONTACT_NAME = TRIM(:I_TCONTACT_NAME);
    /*
    MAJ V34 : NAME NULL autoris
    IF (I_TCONTACT_NAME= '') THEN EXCEPTION EX_NONULL (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME = 'EX_NONULL')
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%')
		|| 'CONTACT_NAME'
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%'); 
    */

    I_TCONTACT_FIRSTNAME=TRIM(:I_TCONTACT_FIRSTNAME);
    I_TCONTACT_PREFIX=TRIM(:I_TCONTACT_PREFIX);
    I_TCONTACT_EMAIL=TRIM(:I_TCONTACT_EMAIL);
    -- TODO : Contrle forme email ???
    I_TCONTACT_TEL=TRIM(:I_TCONTACT_TEL);
    I_TCONTACT_ADDRESS=TRIM(:I_TCONTACT_ADDRESS);
    I_TCONTACT_POSTCODE=TRIM(:I_TCONTACT_POSTCODE);
    I_TCONTACT_REGION=TRIM(:I_TCONTACT_REGION);
    I_TCONTACT_CITY=TRIM(:I_TCONTACT_CITY);
    I_TCONTACT_COUNTRY=TRIM(:I_TCONTACT_COUNTRY);

	-- Ancienne date de modif init plus haut ; on rinit le cas chant
	IF (:I_TCONTACT_ID = 0 OR :I_TCONTACT_NO_MODIF_DATE = 0) THEN MODIF_DATE = CURRENT_TIMESTAMP;


    BEGIN 
        UPDATE OR INSERT INTO TCONTACT(ID, MODIF_DATE, NAME,TOWNER_ID,FIRSTNAME,PREFIX,EMAIL,TEL,ADDRESS,POSTCODE,REGION,CITY,COUNTRY, ORGANIZATION, SERVICE, IDENTIFIER, CELLTEL)
        VALUES(
            NULLIF(:I_TCONTACT_ID,0),
            :MODIF_DATE,
            NULLIF(:I_TCONTACT_NAME,''),
            :I_TCONTACT_TOWNER_ID,
            NULLIF(:I_TCONTACT_FIRSTNAME,''),
            NULLIF(:I_TCONTACT_PREFIX,'') ,
            NULLIF(:I_TCONTACT_EMAIL,''),
            NULLIF(:I_TCONTACT_TEL,''),
            NULLIF(:I_TCONTACT_ADDRESS,''),
            NULLIF(:I_TCONTACT_POSTCODE,''),
            NULLIF(:I_TCONTACT_REGION,''),
            NULLIF(:I_TCONTACT_CITY,''),
            NULLIF(:I_TCONTACT_COUNTRY,''),
            NULLIF(:I_TCONTACT_ORGANIZATION,''),
            NULLIF(:I_TCONTACT_SERVICE,''),
            NULLIF(:I_TCONTACT_IDENTIFIER,''),
            NULLIF(:I_TCONTACT_CELLTEL,'')
        )
        MATCHING (ID)
        RETURNING ID INTO CONTACT_ID;
    
        SUSPEND;
        
        --		Pour l'instant on laisse l'erreur FB...
-- 		WHEN ANY DO
--             -- Rcupration du code gnrique d'erreur et ajout d'informations complmentaires...
--             EXCEPTION EX_ERRGEN (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME='EX_ERRGEN') ||
--                 IIF(:I_TCONTACT_ID IS NULL,'Ajout','Mise  jour') || ' de TCONTACT (SET_CONTACT_INFOS) impossible suite  l''erreur non prise en charge suivante : ' ||
--                 'GDS : "' || GDSCODE || '" - SQL : "' || SQLCODE || '"';

    END
END ^

ALTER PROCEDURE SET_CONTACT_TYPE_TO_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL,
I_TCONTACT_ID INTEGER NOT NULL,
I_TCONTTYPE_ID INTEGER NOT NULL,
I_TCONTLIB_SYNC_SENDMAIL SYNC_MAIL NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
AS 
/*
    Ajout d'un contact  une biliothque donne (ie. insertion dans la table TCONTLIB)
    
    Le contact ET la bibliothque doivent exister pralamblement  l'appel de cette procdure
    
    Les colonnes "STATE" des tables parentes (et niveaux suprieurs) sont values afin de savoir s'il est possible d'utiliser l'un et/ou l'autre (cf. gestion des colonnes STATE dans la documentation)
    
    Ne renvoi rien (ie. si pas d'erreur, insertion Ok)
    
    Si le couple existe dj, une erreur SQL standard est leve (violation PK)
    
V16 :
	Cration : Annule et remplace "ADD_CONTACT_TYPE_TO_LIBRARY" pour gestion MAJ 
*/

DECLARE VARIABLE SQL_WHERE_CONTACT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_TCONTACT_STATE=TRIM(I_TCONTACT_STATE );

    /* construction des WHERE */
    SQL_WHERE_CONTACT = '';
    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';

    ID_OK=Null;

   /* Serveur Firebird (si non Null) utilisable outrepassable...*/
    IF (:I_TFBSERVER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;         

    /* Owner utilisable outrepassable)... */
    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    -- Library existante et modifiable...
    IF (:I_TLIBRARY_STATE ='' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

    /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
    EXECUTE STATEMENT '
        SELECT TLIBRARY.ID
		FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
			LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
        WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
            IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
            IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;


    ID_OK=Null;

    /* contact utilisable outrepassable)... */
    IF (:I_TCONTACT_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE_CONTACT;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE_CONTACT; 

    EXECUTE STATEMENT '
        SELECT TCONTACT.ID
        FROM TCONTACT INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
        WHERE TCONTACT.ID=' || :I_TCONTACT_ID ||
            IIF (:SQL_WHERE_CONTACT != '' , ' AND (' || :SQL_WHERE_CONTACT || ')', '') || 
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOCONTACT;

	/* Type de contact prsent */
	IF (NOT EXISTS (SELECT ID FROM TCONTTYPE WHERE ID=:I_TCONTTYPE_ID)) THEN EXCEPTION EX_NOCONTTYPE;

    /* L'environnement est correct, on peut insrer */
    BEGIN
        UPDATE OR INSERT INTO TCONTLIB(TLIBRARY_ID, TCONTACT_ID, TCONTTYPE_ID, SYNC_SENDMAIL)
        VALUES(
            :I_TLIBRARY_ID,
            :I_TCONTACT_ID,
            :I_TCONTTYPE_ID,
			:I_TCONTLIB_SYNC_SENDMAIL
        )
		MATCHING (TLIBRARY_ID, TCONTACT_ID, TCONTTYPE_ID);
        
        /* Traitement violation PK */
        WHEN GDSCODE unique_key_violation DO
            EXCEPTION EX_CONTLIB_EXISTS;
    END

END ^

ALTER PROCEDURE SET_CONTTYPE_INFOS (I_TCONTTYPE_ID INTEGER NOT NULL DEFAULT 0,
I_TCONTTYPE_NAME VARCHAR(150) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (CONTTYPE_ID INTEGER)
AS 
/*
    Cration MAJ d'un type de contact
    
    Si l'ID est 0 ==> Insertion
    Si ID pass ==> mise  jour d'un contact existant
    
    Paramtres : cf table TCONTACT

V22 :
	- Exception EX_NONULL codifie ('Nom Type contact' ==> '%%CONTTYPE_NAME%%')

V32 :
	- Exception EX_NONULL recodifie "%...%" (uniformisation des dlimiteurs de macros)
*/

BEGIN
    /* MAJ possible */
    IF (:I_TCONTTYPE_ID !=0 AND NOT EXISTS(SELECT ID FROM TCONTTYPE WHERE ID=:I_TCONTTYPE_ID)) THEN EXCEPTION EX_NOCONTTYPE;
    
    /* Nettoyage des paramtres */
    I_TCONTTYPE_NAME = TRIM(:I_TCONTTYPE_NAME);

    /* Insertion chaine vide */
    IF (:I_TCONTTYPE_NAME = '') THEN EXCEPTION EX_NONULL (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME = 'EX_NONULL')
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%')
		|| 'CONTTYPE_NAME'
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%');
        
    BEGIN
        IF (I_TCONTTYPE_ID = 0) THEN
        BEGIN
            INSERT INTO TCONTTYPE(NAME)
            VALUES(
                :I_TCONTTYPE_NAME
            )
            RETURNING ID INTO CONTTYPE_ID;
        END
        ELSE
        BEGIN
            UPDATE TCONTTYPE SET
                NAME=:I_TCONTTYPE_NAME
            WHERE ID=:I_TCONTTYPE_ID
            RETURNING ID INTO CONTTYPE_ID;
        END
        
        SUSPEND;

--		Pour l'instant on laisse l'erreur FB...
--         WHEN ANY DO
--             -- Rcupration du code gnrique d'erreur et ajout d'informations complmentaires...
--             EXCEPTION EX_ERRGEN (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME='EX_ERRGEN') ||
--                 IIF(:I_TCONTTYPE_ID IS NULL,'Ajout','Mise  jour') || ' de TCONTTYPE (SET_CONTTYPE_INFOS) impossible suite  l''erreur non prise en charge suivante : ' ||
--                 'GDS : "' || GDSCODE || '" - SQL : "' || SQLCODE || '"';
        
    END
END ^

ALTER PROCEDURE SET_DOMPARAM (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TDOMPARAM_TYPE TYPE_PARAM NOT NULL DEFAULT 1,
I_TDOMPARAM_COMMENT VARCHAR(512) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TDOMPARAM_PROTECTION STATE NOT NULL DEFAULT 2)
RETURNS (DOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
DOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
DOMPARAM_VALUE VARCHAR(255) CHARACTER SET UTF8)
AS 
DECLARE VARIABLE TPARAM_ID INTEGER;
    
BEGIN
    /*
    Cette procdure ajoute ou met  jour un paramtre (dans la table TDOMPARAM)
    - Si le paramtre existe dj, on met  jour toutes les colonnes non NULL
    - Dans le cas contraire, on essai d'ajouter le paramtre dans la table correspondante
    (attention au typo donc, si un nom de paramtre ou une section incorrect est donn dans le cadre d'une MAJ, un nouveau paramtre sera cr...)

V17 :
	- Autorisation d'une VALUE vide
	- Ajout SECTION...

V21 :
	- Correction VALUE vide finalement autorise

V22 :
	Exception EX_NONULL codifie ('Libell du paramtre' ==> '%%DOMPARAM_NAME%%')

V30 :
	- Correction I_TDOMPARAM_COMMENT en entre (255 -> 512)

V32
	- Exception EX_NONULL recodifie "%...%" (uniformisation des dlimiteurs de macros)
*/
    
    /* Nettoyage des paramtres */
    I_TDOMPARAM_NAME = TRIM(I_TDOMPARAM_NAME);
    IF (I_TDOMPARAM_NAME = '') THEN EXCEPTION EX_NONULL (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME = 'EX_NONULL')
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%')
		|| 'DOMPARAM_NAME'
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%');
 
    I_TDOMPARAM_VALUE = TRIM(I_TDOMPARAM_VALUE);
	-- V21 : oublie de dsactiver a en V17 ==> VALUE vide ==> EXCEPTION :-((((
    -- IF (I_TDOMPARAM_VALUE = '') THEN EXCEPTION EX_NONULL (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME = 'EX_NONULL') || 'Valeur du paramtre'; 
    I_TDOMPARAM_COMMENT = TRIM(I_TDOMPARAM_COMMENT);
    
    
    UPDATE OR INSERT INTO TDOMPARAM ("SECTION", "NAME", "TYPE", "VALUE", "COMMENT", PROTECTION)
        VALUES (
			:I_TDOMPARAM_SECTION,
            :I_TDOMPARAM_NAME,
            :I_TDOMPARAM_TYPE,
            NULLIF(:I_TDOMPARAM_VALUE,''),
            NULLIF(:I_TDOMPARAM_COMMENT,''),
            :I_TDOMPARAM_PROTECTION
        )
        MATCHING (SECTION, NAME)
        RETURNING "SECTION", "NAME", "VALUE"
        INTO :DOMPARAM_SECTION, :DOMPARAM_NAME, :DOMPARAM_VALUE;

    SUSPEND;
END ^

ALTER PROCEDURE SET_DOMPARAM_VALUEBLB (I_TDOMPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL,
I_TDOMPARAM_VALUEBLB BLOB NOT NULL DEFAULT '')
AS 
/*
	MAJ d'une valeur BLOB pour un paramtre domaine
	Les STATES ne sont PAS  valus
	Le paramtre concern doit exister pralablement  l'appel de cette PS

V15 :
    - Cration
    
V17 :
    - Ajout SECTION
*/
BEGIN
    UPDATE TDOMPARAM
        SET VALUEBLB = NULLIF(:I_TDOMPARAM_VALUEBLB,'')
        WHERE
            SECTION = :I_TDOMPARAM_SECTION AND  NAME =:I_TDOMPARAM_NAME;
	IF (ROW_COUNT = 0) THEN
		EXCEPTION EX_NODOMPARAM;
            
END ^

ALTER PROCEDURE SET_FBSERVER_INFOS (I_TFBSERVER_ID INTEGER NOT NULL,
I_TFBSERVER_NAME VARCHAR(50) CHARACTER SET UTF8 NOT NULL,
I_TFBSERVER_HOST VARCHAR(255) CHARACTER SET UTF8 NOT NULL,
I_TFBSERVER_FBADMLOGIN VARCHAR(31) CHARACTER SET UTF8 NOT NULL,
I_TFBSERVER_FBADMPASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_TCPPORT TCPPORT NOT NULL DEFAULT 0,
I_TFBSERVER_TUNNELPORT TCPPORT NOT NULL DEFAULT 0,
I_TFBSERVER_TUNNELHOST VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_LIBROOTPATH VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (FBSERVER_ID INTEGER)
AS 
/*
    Ajout/modification d'un serveur Firebird dans la table correspondante
    
    Paramtres : cf table TFBSERVER

    Particularits :
    - TCPPORT est un domaine Firebird (V7)
    - I_TFBSERVER_STATE permet de prciser les conditions de STATE de MAJ (pas d'initialiser les colonnes STATE des tables (cf. PS SET_STATE ou DEL_FBSERVER pour a)
        
    renvoie :
        FBSERVER_ID : Identifiant du serveur insr/modifi si russite
        
    Attention, cette procdure lve des erreurs en cas d'insertion impossible (erreurs sous-jacentes)

MAJ V13 :
    - Ajout FBSERVER_LIB_ROOT_PATH
    - Ajout FBADM

V22 :
	Exception EX_NONULL codifie

V32
	- Exception EX_NONULL recodifie "%...%" (uniformisation des dlimiteurs de macros)

*/
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
BEGIN

    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

	SQL_WHERE_FBSERVER = '';
	ID_OK = Null;
    
    /* MAJ : on vrifie l'tat */
    IF (I_TFBSERVER_ID != 0 ) THEN 
    BEGIN
        IF (:I_TFBSERVER_STATE= '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;   
                  
        EXECUTE STATEMENT '
            SELECT ID FROM TFBSERVER
            WHERE ID=' || :I_TFBSERVER_ID || IIF (:SQL_WHERE_FBSERVER != '' ,' AND ' || :SQL_WHERE_FBSERVER, '')
            INTO :ID_OK;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOFBSER;
    END

    ID_OK = 0; -- On se servira de cette variable pour les tests sur IP/Htes...
    
    /* Nettoyage des paramtres */
    I_TFBSERVER_NAME = TRIM(:I_TFBSERVER_NAME);
    IF (:I_TFBSERVER_NAME = '') THEN EXCEPTION EX_NONULL (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME = 'EX_NONULL')
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%')
		|| 'FBSERVER_NAME'
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%'); 

    I_TFBSERVER_FBADMLOGIN = TRIM(I_TFBSERVER_FBADMLOGIN);
    IF (I_TFBSERVER_FBADMLOGIN = '') THEN EXCEPTION EX_NONULL (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME = 'EX_NONULL')
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%')
		|| 'FBSERVER_FBADMLOGIN'
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%');

    I_TFBSERVER_FBADMPASSWD = TRIM(I_TFBSERVER_FBADMPASSWD);
    I_TFBSERVER_LIBROOTPATH=TRIM(I_TFBSERVER_LIBROOTPATH);
    
    /*
        Vrification des IP/Hostname (HOST peut-tre un nom d'hte ou une IP V4/V6
        On teste 
        - IPV4 (la plus contraignante en terme de forme)
        - Puis une IP V6
        - Puis un nom d'hte
        Si aucun ne passe, on considre que l'on a pass une IP/Nom d'hte invalide
        Attention, ces tests sont relativments peu complets (REGEXP FB +/- limites)
        Idalement, les Clients/NAS devraient tester  leur niveau  l'aide de bib. de test plus abouties
        Les limitations suivantes doivent tre prisent en compte
        IPV4 : (rappel : 011 [0 non reprsentatif] est valide dans n'importe que segment ...)
            Centaine : normallement Ok (si prsente, doivent tre 0->2
            Dizaine/Unit : Impossible  tester correctement, par exemple 277 est possible car 177 l'est (il faudrait pouvoir tester par rapport  la centaine)...
        IPV6 : Normallement Ok sauf que le quantifer {1,8} ne fonctionne pas sur l'expression souhaite (on dit donc que le groupe de 2 octeets doit exister au moins deux fois)
        Nom d'hote : Accepte tous les ALPHANUM  (taille de chaque segment de 63 caractres)
            Attention, un nom d'hote peut-tre prcis en forme courte (ie toto vs toto.titi.fr) (cf. suffixe DNS etc)
            Attention, un nom d'hte peut tre valide sous la forme numrique XXX.XXX.XXX.XXX (conflit avec IPV4), par exemple 465.123.789.158
                Pour contourner cela, si un nom d'hte est prcis sous cette forme, la vrification considre que c'est une IPV4 (choix arbitraire)
    */
    I_TFBSERVER_HOST = TRIM(:I_TFBSERVER_HOST);
    IF (I_TFBSERVER_HOST != '' ) THEN
    BEGIN
        -- S'il n'y a que des numriques et des points, on considres que l'on donne une IPV4
        -- Attention : RE incomplte, car autorise >255 sur les segments...
        -- TODO : La forme [[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}(.[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}){3} (quantifier 3) ne fonctionne pas pour une raison qui m'chappe ???
        IF (I_TFBSERVER_HOST SIMILAR TO
            '[[:DIGIT:]]{1,3}.[[:DIGIT:]]{1,3}.[[:DIGIT:]]{1,3}.[[:DIGIT:]]{1,3}' -- Dotted dash notation ==> IPV4
            ) THEN -- On essai d'aller plus loin...
        BEGIN
--            TEST='IPV4';
            IF (I_TFBSERVER_HOST NOT SIMILAR TO 
            '[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}.[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}.[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}.[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}'
            ) THEN 
                EXCEPTION EX_BAD_HOSTNAME;
        END
        -- Si le caractre ":" est prsent, on considre que c'est une IPV6 (":" interdit en hostname)
        ELSE IF (I_TFBSERVER_HOST SIMILAR TO -- IPV6 pratiquement impossible  traiter avec les REGEXP ( fortiori FB), on effectue donc un test de base
        -- L aussi le quantifier {1,8} ne fonctionne pas ???
            '[0-9a-fA-F]{1,4}(:[0-9a-fA-F]{1,4})+'
            ) THEN 
        BEGIN
--            TEST='IPV6';
            ID_OK=1;
        END

        ELSE -- Reste hostname valide  tester...  Hostname (RFC 952 + 1123)
        BEGIN
            -- S'il y a un point, on considre que le hostname fourni est FQDN
            IF (POSITION('.' IN I_TFBSERVER_HOST) != 0) THEN
            BEGIN
--                TEST='HOST FQDN';
                IF (I_TFBSERVER_HOST NOT SIMILAR TO -- Hostname (RFC 1123)  (on teste donc le TLD qui doit forcment tre alpha)
                    '[[:ALNUM:]][[:ALNUM:]-]{1,61}(.?[[:ALNUM:]-]{1,62})*.[[:ALPHA:]]{1,62}'
                ) THEN
                    EXCEPTION EX_BAD_HOSTNAME;
            END
            ELSE -- pas de point, il ne reste qu'un nom d'hte non FQDN (ie un mot sans point) valide
            BEGIN
--                TEST='HOST NO FQDN';
                IF (I_TFBSERVER_HOST NOT SIMILAR TO
                    '[[:ALNUM:]][[:ALNUM:]-]{1,61}'
                ) THEN
                    EXCEPTION EX_BAD_HOSTNAME;
            END
        END
    END
    
    ELSE -- Host vide ==> rejet
        EXCEPTION EX_NONULL (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME = 'EX_NONULL')
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%')
		|| 'FBSERVER_HOST'
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%'); 
    
    I_TFBSERVER_TUNNELHOST = TRIM(:I_TFBSERVER_TUNNELHOST);
    -- Voir au-dessus pour commentaire sur ces tests...
    IF (I_TFBSERVER_TUNNELHOST != '' ) THEN
    BEGIN
        IF (I_TFBSERVER_TUNNELHOST SIMILAR TO
            '[[:DIGIT:]]{1,3}.[[:DIGIT:]]{1,3}.[[:DIGIT:]]{1,3}.[[:DIGIT:]]{1,3}' 
            ) THEN
        BEGIN
--            TEST='IPV4';
            IF (I_TFBSERVER_TUNNELHOST NOT SIMILAR TO 
            '[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}.[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}.[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}.[[:DIGIT:]^3-9]?[[:DIGIT:]]{1,2}'
            ) THEN 
                EXCEPTION EX_BAD_HOSTNAME;
        END
        ELSE IF (I_TFBSERVER_TUNNELHOST SIMILAR TO
            '[0-9a-fA-F]{1,4}(:[0-9a-fA-F]{1,4})+'
            ) THEN 
        BEGIN
--            TEST='IPV6';
            ID_OK=1;
        END

        ELSE
        BEGIN
            IF (POSITION('.' IN I_TFBSERVER_TUNNELHOST) != 0) THEN
            BEGIN
--                TEST='HOST FQDN';
                IF (I_TFBSERVER_TUNNELHOST NOT SIMILAR TO
                    '[[:ALNUM:]][[:ALNUM:]-]{1,61}(.?[[:ALNUM:]-]{1,62})*.[[:ALPHA:]]{1,62}'
                ) THEN
                    EXCEPTION EX_BAD_HOSTNAME;
            END
            ELSE
            BEGIN
--               TEST='HOST NO FQDN';
                IF (I_TFBSERVER_TUNNELHOST NOT SIMILAR TO
                    '[[:ALNUM:]][[:ALNUM:]-]{1,61}'
                ) THEN
                    EXCEPTION EX_BAD_HOSTNAME;
            END
        END
    END

    BEGIN
        UPDATE OR INSERT INTO TFBSERVER (ID, NAME, TCPPORT, HOST, TUNNELPORT, TUNNELHOST,LIBROOTPATH, FBADMLOGIN, FBADMPASSWD)
        VALUES (
            NULLIF(:I_TFBSERVER_ID,0),
            :I_TFBSERVER_NAME, 
            NULLIF(:I_TFBSERVER_TCPPORT,0), 
            :I_TFBSERVER_HOST, 
            NULLIF(:I_TFBSERVER_TUNNELPORT,0), 
            NULLIF(:I_TFBSERVER_TUNNELHOST,''),
            NULLIF(:I_TFBSERVER_LIBROOTPATH,''),
            :I_TFBSERVER_FBADMLOGIN,
            NULLIF(:I_TFBSERVER_FBADMPASSWD,'')
        )
        MATCHING (ID)
        RETURNING ID INTO FBSERVER_ID;

		SUSPEND;
        
--		Pour l'instant on laisse l'erreur FB...
--         WHEN ANY DO
--             -- Rcupration du code gnrique d'erreur et ajout d'informations complmentaires...
--             EXCEPTION EX_ERRGEN (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME='EX_ERRGEN') ||
--                 IIF(:I_TFBSERVER_ID IS NULL,'Ajout','Mise  jour') || ' de TFBSERVER SET_FBSERVER_INFOS) impossible suite  l''erreur non prise en charge suivante : ' ||
--                 'GDS : "' || GDSCODE || '" - SQL : "' || SQLCODE || '"';

    END
END  ^

ALTER PROCEDURE SET_GEDGROUP_INFOS (I_TGEDGROUP_ID INTEGER NOT NULL,
I_TGEDGROUP_TOWNER_ID INTEGER NOT NULL,
I_TGEDGROUP_NAME VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDGROUP_TYPE SMALLINT NOT NULL DEFAULT 0,
I_TGEDGROUP_COMMENT VARCHAR(8164) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDGROUP_PROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDGROUP_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDGROUP_ID INTEGER)
AS 
/*
	Cration (ID=0) ou MAJ d'un Groupe d'utilisateur GED

V22 :
	Exception EX_NONULL codifie

MAJ V32 :
	- Ajout TYPE + PROFILE ID
	- Exception EX_NONULL recodifie "%...%" (uniformisation des dlimiteurs de macros)

MAJ V39
    - Les dates MAJ sont initialises ici (plus dans le trigger) via I_TOWNER_NO_MODIF_DATE

*/
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
DECLARE VARIABLE MODIF_DATE TIMESTAMP;

BEGIN
    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);

    ID_OK = Null;
    
    -- Modif V39 : on rcupre les infos du groupe pour notamment la date MODIF_DATE et on en profite pour ajouter un contrle sur la prsence
    IF (I_TGEDGROUP_ID !=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID, MODIF_DATE FROM TGEDGROUP
            WHERE TGEDGROUP.ID=' || :I_TGEDGROUP_ID
            INTO :ID_OK, MODIF_DATE;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDGROUP;
    END

    ID_OK = Null;
    SQL_WHERE = '';
    
    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 
    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE TOWNER.ID=' || :I_TGEDGROUP_TOWNER_ID || IIF (:SQL_WHERE != '' , ' AND (' || :SQL_WHERE || ')', '')
        INTO ID_OK;

	IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;

    ID_OK = Null;
    
    /* Profil (si pass non Null) utilisable...*/
    IF (I_TGEDGROUP_PROFILE_ID !=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID FROM TPROFILE
            WHERE ID=' || I_TGEDGROUP_PROFILE_ID
            INTO :ID_OK;
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOPROFILE;
    END

    I_TGEDGROUP_NAME=TRIM(I_TGEDGROUP_NAME);
    IF (I_TGEDGROUP_NAME = '') THEN
        EXCEPTION EX_NONULL (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME = 'EX_NONULL')
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%')
		|| 'GEDGROUP_NAME'
		|| COALESCE((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','MACRO_DELIM')),'%');
    
	-- Ancienne date de modif init plus haut ; on rinit le cas chant
	IF (:I_TGEDGROUP_ID = 0 OR :I_TGEDGROUP_NO_MODIF_DATE = 0) THEN MODIF_DATE = CURRENT_TIMESTAMP;

    BEGIN
        UPDATE OR INSERT INTO TGEDGROUP (ID,MODIF_DATE, TOWNER_ID, NAME, "TYPE", "COMMENT",TPROFILE_ID)
        VALUES (
            NULLIF(:I_TGEDGROUP_ID,0), -- NULL si 0 (insertion car non existant)
            :MODIF_DATE,
            :I_TGEDGROUP_TOWNER_ID, 
			:I_TGEDGROUP_NAME,
			NULLIF(:I_TGEDGROUP_TYPE,0),
			NULLIF(:I_TGEDGROUP_COMMENT,''),
			NULLIF(:I_TGEDGROUP_PROFILE_ID,0)
        )
        MATCHING (ID)
        RETURNING ID INTO GEDGROUP_ID;
        SUSPEND;
        WHEN GDSCODE unique_key_violation DO -- Violation OWNER/NAME...
            EXCEPTION EX_GEDGROUP_EXISTS;
	END
END ^

ALTER PROCEDURE SET_GEDPARAM (I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TGEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_TYPE TYPE_PARAM NOT NULL DEFAULT 1,
I_TGEDPARAM_CLASS INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDPARAM_PROTECTION STATE NOT NULL DEFAULT 2,
I_TGEDPARAM_TOWNER_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAM_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
/*
	Ajoute ou MAJ (ID=0) d'un paramtre GED

	Les STATES OWNER et LIB sont valus
	
	L'unicit est dclare dans la table, au niveau de SETION + NAME + OWNER_ID
	Toutefois, ceci n'est pas suffisant car :
	- Un paramtre spcifique  un OWNER ne doit pas pouvoir tre ajout s'il existe dj globalement (OWNER_ID IS NULL AND I_TGEDPARAM_TOWNER_ID <>0 [idem NOT NULL])
	- Un paramtre spcifique  un OWNER peut-tre tre ajout s'il existe dj pour un autre OWNER (OWNER_ID IS NOT NULL AND <> I_TGEDPARAM_TOWNER_ID)
	- L'administrateur ne doit pas pouvoir ajouter un paramtre dj existant pour un OWNER (ONWER_ID IS NOT NULL)

MAJ V11 : 
- Ajout SYSTEM
- Suppression paramtre VALUEBLB mis  jour par ailleurs

V20 :
    - SYSTEM ==> PROTECTION

V21 :
	- ajout TGEDDPARAM.CLASS

V31 :
	- Exception spcifique

V40 :
	- Ajout GEDPARAM_MODIF_DATE en sortie
    - Ajout de contraintes en cration 
        * pas de doublons sur dico standard ou dico sous-domaine sauf au niveau des libs
        * On vrifie que les sections OWNER/LIB soit correctes si cration pour un sous-domaine et/ou une bibliothque
            - Au niveau des sections autorises par TDOMPARAM:DOMAIN/GEDPARAM_SECTIONS_OWNER_CREATE (PS GET_GEDPARAM_SECTION_OWNER_OK)
            ou
            - Au niveau des sections autorises par TDOMPARAM:DOMAIN/GEDPARAM_SECTIONS_OWNER (sous-domaine) ou TDOMPARAM:DOMAIN/GEDPARAM_SECTIONS_LIB (bilbiothque)

*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);

DECLARE VARIABLE SECTION_OK BOOLEAN;

DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);

	ID_OK = Null;
	SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	
    /* Nettoyage des paramtres */
    I_TGEDPARAM_SECTION = TRIM(I_TGEDPARAM_SECTION);
	
	-- Tentative de MAJ, on vrifie que le GEDPARAM existe dj
	IF (I_TGEDPARAM_ID != 0) THEN
	BEGIN
        IF (NOT EXISTS(SELECT ID FROM TGEDPARAM WHERE ID=:I_TGEDPARAM_ID)) THEN EXCEPTION EX_NOGEDPARAM;
    END
	
    IF (I_TGEDPARAM_TLIBRARY_ID != 0) THEN
    BEGIN
        ID_OK=Null;

       /* Serveur Firebird (si non Null) utilisable outrepassable...*/
        IF (:I_TFBSERVER_STATE = '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;

        -- Library existante et modifiable...
        IF (:I_TLIBRARY_STATE ='' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

        /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
        EXECUTE STATEMENT '
            SELECT TLIBRARY.ID
            FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE TLIBRARY.ID=' || :I_TGEDPARAM_TLIBRARY_ID ||
                IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
                IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
                IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
            INTO :ID_OK;
                
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;
        
        -- Vrification de la prsence du OWNER_ID en paramtre
        IF (I_TGEDPARAM_TOWNER_ID !=0) THEN
        BEGIN
            IF (NOT EXISTS(SELECT ID FROM TLIBRARY WHERE ID=:I_TGEDPARAM_TLIBRARY_ID AND TOWNER_ID=:I_TGEDPARAM_TOWNER_ID)) THEN
                EXCEPTION EX_BADOWNER;
        END
        ELSE -- sinon on l'initialise nous-mme
            SELECT TOWNER_ID FROM TLIBRARY
            WHERE ID=:I_TGEDPARAM_TLIBRARY_ID
            INTO :I_TGEDPARAM_TOWNER_ID;
            
        -- Les vrifications de section OK sont effectues plus bas...

    END

    -- I_TGEDPARAM_TOWNER_ID peut-tre pass en paramtre ou initialis plus haut dans les traitements de vrification de lib
    IF (I_TGEDPARAM_TOWNER_ID !=0) THEN
    BEGIN
        /* Owner utilisable outrepassable)... */
        IF (:I_TOWNER_STATE = '' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

        EXECUTE STATEMENT '
            SELECT ID FROM TOWNER
            WHERE ID=' || :I_TGEDPARAM_TOWNER_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
            INTO ID_OK;

        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;
        
        -- Quelque soit le type de GEDPARAM (OWNER.LIB), on vrifie que la section corresponde  une section autorise
        SELECT OK FROM GET_GEDPARAM_SECTION_OWNER_OK(:I_TGEDPARAM_SECTION) INTO SECTION_OK;
        
        -- Section gnrale non autorise, on regarde si on est dans une section valide en fonction du type de paramtre (OWNER/LIB)
        IF (SECTION_OK!=1) THEN
        BEGIN

            -- GEDPARAM OWNER, on vrifie la section
            IF (I_TGEDPARAM_TLIBRARY_ID = 0) THEN
            BEGIN
                IF ((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','GEDPARAM_SECTION_OWNER')) != I_TGEDPARAM_SECTION) THEN
                    EXCEPTION EX_GEDPARAM_SECTION_KO;
            END

            -- GEDPARAM LIB, on vrifie la section
            ELSE
            BEGIN
                IF ((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','GEDPARAM_SECTION_LIB')) != I_TGEDPARAM_SECTION) THEN
                    EXCEPTION EX_GEDPARAM_SECTION_KO;
            END
        END
        

        /*
        -- Pour mmoire, ne devrait plus arriver avec les sections ddies...

        -- On vrifie que la section + name n'existe pas globalement (si c'est un autre OWNER, c'est Ok)...
        -- V40 : Normalement cette vrification n'est plus si importante car on doit maintenant utiliser des sections/obligatoires pour les GEDPARAM OWNER/LIB
        -- Mais a ne mange pas de pain (TODO voir perf de la PS avec et sans cette vrification ?)
        IF (EXISTS(SELECT ID FROM TGEDPARAM WHERE ID!=:I_TGEDPARAM_ID AND SECTION=:I_TGEDPARAM_SECTION AND NAME=:I_TGEDPARAM_NAME AND TOWNER_ID IS NULL)) THEN
            EXCEPTION EX_GEDPARAM_EXISTS;

        -- idem
        IF (EXISTS(SELECT ID FROM TGEDPARAM WHERE ID!=:I_TGEDPARAM_ID AND SECTION=:I_TGEDPARAM_SECTION AND NAME=:I_TGEDPARAM_NAME AND TOWNER_ID=:I_TGEDPARAM_TOWNER_ID AND TLIBRARY_ID IS NOT NULL)) THEN
            EXCEPTION EX_GEDPARAM_EXISTS;
        */
    END
    ELSE
    BEGIN
        /* On essaie d'initialiser un paramtre global, on vrifie donc que le mme paramtre n'existe pas dj pour un autre OWNER/LIB */
        IF (:I_TGEDPARAM_SECTION IN(
            (SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','GEDPARAM_SECTION_OWNER')),
            (SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','GEDPARAM_SECTION_LIB'))
        )) THEN
            EXCEPTION EX_BAD_PARAM;
    END

    /* Nettoyage des autres paramtres */
    I_TGEDPARAM_NAME = TRIM(I_TGEDPARAM_NAME);
    I_TGEDPARAM_DEFAULTVALUE = TRIM(I_TGEDPARAM_DEFAULTVALUE);
    I_TGEDPARAM_COMMENT = TRIM(I_TGEDPARAM_COMMENT);	

    UPDATE OR INSERT INTO TGEDPARAM (ID, "SECTION", "NAME", "TYPE", "CLASS", DEFAULTVALUE, "COMMENT", PROTECTION, TOWNER_ID, TLIBRARY_ID)
        VALUES (
			NULLIF(:I_TGEDPARAM_ID,0),
            :I_TGEDPARAM_SECTION,
            NULLIF(:I_TGEDPARAM_NAME,''),
            :I_TGEDPARAM_TYPE,
			:I_TGEDPARAM_CLASS,
            NULLIF(:I_TGEDPARAM_DEFAULTVALUE,''),
            NULLIF(:I_TGEDPARAM_COMMENT,''),
			:I_TGEDPARAM_PROTECTION,
            NULLIF(:I_TGEDPARAM_TOWNER_ID,0),
            NULLIF(:I_TGEDPARAM_TLIBRARY_ID,0)
        )
        MATCHING (ID)
        RETURNING ID, (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)) INTO :GEDPARAM_ID, :GEDPARAM_MODIF_DATE;

		SUSPEND;

		WHEN GDSCODE unique_key_violation DO -- Violation SECTION/NAME/OWNER
			EXCEPTION EX_GEDPARAM_EXISTS;

END ^

ALTER PROCEDURE SET_GEDPARAMOWNER (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMOWNER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMOWNER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8,
OWNER_STATE STATE)
AS 
/*
	Ajout/MAJ d'un paramtre GED  un OWNER
	
	L'ensemble des datas doit tre pass  cette procdure

	Une erreur est leve si le paramtre existe dj dans la section dfinie...
	
V21 :
- Cration

V40 :
	- Factorisation TGEDPARAM
	- retourne les mmes valeurs que GET_GEDPARAMOWNER (Attention, cette PS devient SELECTABLE)

*/

DECLARE VARIABLE ID_OK Integer;
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);

BEGIN

	ID_OK = Null;
	SQL_WHERE = '';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    /* Existence/visibilit du OWNER demand */
    EXECUTE STATEMENT '
        SELECT TOWNER.ID
		FROM TOWNER
        WHERE TOWNER.ID=' || :I_TOWNER_ID ||
            IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '') 
        INTO :ID_OK;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;

    /* Nettoyage des paramtres */

	-- V40 V2 : on travaille directement sur GEDPARAM_ID
-- 	I_TGEDPARAM_SECTION = TRIM(I_TGEDPARAM_SECTION);
-- 	I_TGEDPARAM_NAME = TRIM(I_TGEDPARAM_NAME);
    -- V40 : TGEDPARAM.COMMENT
	-- I_TGEDPARAMOWNER_COMMENT = TRIM(I_TGEDPARAMOWNER_COMMENT);

    I_TGEDPARAMOWNER_VALUE = TRIM(I_TGEDPARAMOWNER_VALUE);

	SELECT 
        ID,
        SECTION,
        "NAME",
        "TYPE",
        COALESCE("COMMENT",''),
        CLASS,
		PROTECTION,
        (SELECT DATE_STRING FROM GET_DATE_STRING(MODIF_DATE)),
		COALESCE(TOWNER_ID,0),
		COALESCE(TLIBRARY_ID,0),
		COALESCE(DEFAULTVALUE,'')
        
	FROM TGEDPARAM
	WHERE ID=:I_TGEDPARAM_ID
	INTO
        GEDPARAM_ID,
        GEDPARAM_SECTION,
        GEDPARAM_NAME,
        GEDPARAM_TYPE,
        GEDPARAM_COMMENT,
        GEDPARAM_CLASS,
        GEDPARAM_PROTECTION,
        GEDPARAM_MODIF_DATE,	
        GEDPARAM_OWNER_ID,
        GEDPARAM_LIBRARY_ID,
		GEDPARAM_DEFAULTVALUE
    ;
        

    IF (:GEDPARAM_ID IS NULL) THEN EXCEPTION EX_NOGEDPARAM;

	UPDATE OR INSERT INTO TGEDPARAMOWNER(TGEDPARAM_ID, TOWNER_ID, "VALUE")
	VALUES (
		:GEDPARAM_ID,
		:I_TOWNER_ID,
		NULLIF(:I_TGEDPARAMOWNER_VALUE,'')
	)
	MATCHING (TOWNER_ID, TGEDPARAM_ID)
	RETURNING 
		TOWNER_ID,
		COALESCE("VALUE",''),
		IIF(VALUEBLB IS NULL,0,1),
        (SELECT DATE_STRING FROM GET_DATE_STRING(MODIF_DATE))
    
    INTO
        OWNER_ID,
        GEDPARAMOWNER_VALUE,
        GEDPARAMOWNER_VALUEBLB_FILLED,
        GEDPARAMOWNER_MODIF_DATE
    ;
	
	SUSPEND;

END ^

ALTER PROCEDURE SET_GEDPARAMOWNER_VALUEBLB (I_TOWNER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAMOWNER_VALUEBLB BLOB NOT NULL DEFAULT '')
RETURNS (GEDPARAMOWNER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
/*
	MAJ d'une valeur BLOB pour un paramtre GED Profil

	Les STATES ne sont PAS  valus

	Le paramtre concern doit exister pralablement  l'appel de cette PS

V40 :
	- Factorisation TGEDPARAM
	- retourne GEDPARAMOWNER_MODIF_DATE (Attention, cette PS devient SELECTABLE)
*/

DECLARE VARIABLE ID_OK Integer;
BEGIN

    /* Nettoyage des paramtres */
	-- V40 V2 : on travaille sur GEDPARAM_ID
-- 	I_TGEDPARAM_SECTION = TRIM(I_TGEDPARAM_SECTION);
-- 	I_TGEDPARAM_NAME = TRIM(I_TGEDPARAM_NAME);

	-- V40 : Vrification de l'existence du GEDPARAM...
	ID_OK = NULL;
	
	SELECT ID
	FROM TGEDPARAM
	-- V40 V2 : on travaille directement sur GEDPARAM_ID
	--WHERE "SECTION" = :I_TGEDPARAM_SECTION AND "NAME" = :I_TGEDPARAM_NAME 
	WHERE ID=:I_TGEDPARAM_ID
	INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDPARAM;

    UPDATE TGEDPARAMOWNER
        SET VALUEBLB = NULLIF(:I_TGEDPARAMOWNER_VALUEBLB,'')
        WHERE
            TOWNER_ID = :I_TOWNER_ID
			AND TGEDPARAM_ID = :ID_OK
        RETURNING (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMOWNER.MODIF_DATE)) INTO :GEDPARAMOWNER_MODIF_DATE;

        SUSPEND;

	IF (ROW_COUNT = 0) THEN
		EXCEPTION EX_NOGEDPARAMOWNER;
            
END ^

ALTER PROCEDURE SET_GEDPARAMPROF (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMPROF_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMPROF_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8)
AS 
/*
	Ajout/MAJ d'un paramtre GED  un Profil
	
	L'ensemble des datas doit tre pass  cette procdure

	Une erreur est leve si le paramtre existe dj dans la section dfinie...
	
MAJ V11 :
    - Suppression I_TGEDPARAMPROF_VALUEBLB

V40 :
    - Factorisation GEDPARAM
	- retourne les mmes valeurs que GET_GEDPARAMPROF (Attention, cette PS devient SELECTABLE)
*/

DECLARE VARIABLE ID_OK Integer;
DECLARE VARIABLE SQL_WHERE VARCHAR(8000);


BEGIN

	ID_OK = Null;
	SQL_WHERE = '';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    /* Existence/visibilit du PROFILE demand (OWNER STATE OK)*/
    EXECUTE STATEMENT '
        SELECT TPROFILE.ID, TPROFILE.TOWNER_ID
		FROM TPROFILE INNER JOIN TOWNER ON TPROFILE.TOWNER_ID=TOWNER.ID
        WHERE TPROFILE.ID=' || :I_TPROFILE_ID ||
            IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '') 
        INTO :ID_OK, :OWNER_ID;
            
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOPROFILE;

    /* Nettoyage des paramtres */
	-- V40 V2 : on travaille directement sur GEDPARAM_ID
-- 	I_TGEDPARAM_SECTION = TRIM(I_TGEDPARAM_SECTION);
-- 	I_TGEDPARAM_NAME = TRIM(I_TGEDPARAM_NAME);
    -- V40 : TGEDPARAM.COMMENT
	--I_TGEDPARAMPROF_COMMENT = TRIM(I_TGEDPARAMPROF_COMMENT);	
    I_TGEDPARAMPROF_VALUE = TRIM(I_TGEDPARAMPROF_VALUE);

	-- V40 : Vrification de l'existence du GEDPARAM...
	ID_OK = NULL;
	
	SELECT 
        ID,
        SECTION,
        "NAME",
        "TYPE",
        COALESCE("COMMENT",''),
        CLASS,
		PROTECTION,
        (SELECT DATE_STRING FROM GET_DATE_STRING(MODIF_DATE)),
		COALESCE(TOWNER_ID,0),
		COALESCE(TLIBRARY_ID,0),
		COALESCE(DEFAULTVALUE,'')
        
	FROM TGEDPARAM
	WHERE ID=:I_TGEDPARAM_ID
	INTO
        GEDPARAM_ID,
        GEDPARAM_SECTION,
        GEDPARAM_NAME,
        GEDPARAM_TYPE,
        GEDPARAM_COMMENT,
        GEDPARAM_CLASS,
        GEDPARAM_PROTECTION,
        GEDPARAM_MODIF_DATE,	
        GEDPARAM_OWNER_ID,
        GEDPARAM_LIBRARY_ID,
		GEDPARAM_DEFAULTVALUE
    ;

    IF (:GEDPARAM_ID IS NULL) THEN EXCEPTION EX_NOGEDPARAM;

	BEGIN
		UPDATE OR INSERT INTO TGEDPARAMPROF(TGEDPARAM_ID, TPROFILE_ID, "VALUE")
		VALUES (
            :GEDPARAM_ID,
			:I_TPROFILE_ID,
			NULLIF(:I_TGEDPARAMPROF_VALUE,'')
		)
		MATCHING (TPROFILE_ID, TGEDPARAM_ID)
        RETURNING
            TPROFILE_ID,            
			COALESCE(TGEDPARAMPROF."VALUE",''),
			IIF(TGEDPARAMPROF.VALUEBLB IS NULL,0,1),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMPROF.MODIF_DATE))
        INTO
            PROFILE_ID,
            -- OWNER_ID,==> Init plus haut lors de la recherche de PROFILE OK
            GEDPARAMPROF_VALUE,
            GEDPARAMPROF_VALUEBLB_FILLED,
            GEDPARAMPROF_MODIF_DATE
        ;
        
        SUSPEND;

	END

END ^

ALTER PROCEDURE SET_GEDPARAMPROF_VALUEBLB (I_TPROFILE_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAMPROFVALUEBLB BLOB NOT NULL DEFAULT '')
RETURNS (GEDPARAMPROF_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
/*
	MAJ d'une valeur BLOB pour un paramtre GED Profil

	Les STATES ne sont PAS  valus

	Le paramtre concern doit exister pralablement  l'appel de cette PS
	
V40 :
	- Factorisation TGEDPARAM	
	- retourne GEDPARAMPROF_MODIF_DATE (Attention, cette PS devient SELECTABLE)

*/

DECLARE VARIABLE ID_OK Integer;

BEGIN

    /* Nettoyage des paramtres */
	-- V40 V2 : on travaille sur GEDPARAM_ID
--	I_TGEDPARAM_SECTION = TRIM(I_TGEDPARAM_SECTION);
--	I_TGEDPARAM_NAME = TRIM(I_TGEDPARAM_NAME);

	-- V40 : Vrification de l'existence du GEDPARAM...
	ID_OK = NULL;
	
	SELECT ID
	FROM TGEDPARAM
	-- V40 V2 : on travaille directement sur GEDPARAM_ID
	--WHERE "SECTION" = :I_TGEDPARAM_SECTION AND "NAME" = :I_TGEDPARAM_NAME 
	WHERE ID=:I_TGEDPARAM_ID
	INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDPARAM;

    UPDATE TGEDPARAMPROF
        SET VALUEBLB = NULLIF(:I_TGEDPARAMPROFVALUEBLB,'')
        WHERE
            TPROFILE_ID = :I_TPROFILE_ID 
            AND TGEDPARAM_ID = :ID_OK
        RETURNING (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMPROF.MODIF_DATE)) INTO :GEDPARAMPROF_MODIF_DATE;

        SUSPEND;


	IF (ROW_COUNT = 0) THEN
		EXCEPTION EX_NOGEDPARAMPROF;
            
END ^

ALTER PROCEDURE SET_GEDPARAMUSER (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER,
LIBRARY_ID INTEGER,
GEDPARAM_SECTION VARCHAR(40) CHARACTER SET UTF8,
GEDPARAM_NAME VARCHAR(80) CHARACTER SET UTF8,
GEDPARAM_TYPE TYPE_PARAM,
GEDPARAMUSER_VALUE VARCHAR(100) CHARACTER SET UTF8,
GEDPARAMUSER_VALUEBLB_FILLED BOOLEAN,
GEDPARAM_COMMENT VARCHAR(8190) CHARACTER SET UTF8,
GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
OWNER_ID INTEGER,
FBSERVER_ID INTEGER,
GEDPARAM_ID INTEGER,
GEDPARAM_CLASS INTEGER,
GEDPARAM_PROTECTION STATE,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8,
GEDPARAM_OWNER_ID INTEGER,
GEDPARAM_LIBRARY_ID INTEGER,
GEDPARAM_DEFAULTVALUE VARCHAR(255) CHARACTER SET UTF8)
AS 
/*
	Ajout/MAJ d'un paramtre GED pour un utilisateur GED
	
	L'ensemble des datas doit tre pass  cette procdure

	Une erreur est leve si le paramtre existe dj dans la section dfinie...
	
MAJ V11 :
- Suppression de VALUEBLOB en entre (MAJ par ailleurs)

V40 :
	- Factorisation GEDPARAM
	- retourne les mmes valeurs que GET_GEDPARAMUSER (Attention, cette PS devient SELECTABLE)
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
	I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);

	ID_OK = Null;

    SQL_WHERE_OWNER = '';
	SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
    SQL_WHERE_GEDUSER = '';

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER;

    -- Utilisateur existant et modifiable...
    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

    EXECUTE STATEMENT '
        SELECT TGEDUSER.ID, TGEDUSER.TOWNER_ID FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID ||
            IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '') ||
            IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :ID_OK, :OWNER_ID;
        
    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;

    FBSERVER_ID=0;

    IF (I_TLIBRARY_ID != 0) THEN
    BEGIN
        ID_OK=Null;

       /* Serveur Firebird (si non Null) utilisable outrepassable...*/
        IF (:I_TFBSERVER_STATE = '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;

        -- Library existante et modifiable...
        IF (:I_TLIBRARY_STATE ='' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

        /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
        EXECUTE STATEMENT '
            SELECT TLIBRARY.ID, TLIBRARY.TFBSERVER_ID
            FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID ||
                IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
                IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
                IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
            INTO :ID_OK,:FBSERVER_ID ;
                
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;
    END
    
    /* Nettoyage des paramtres */
	-- V40 V2 : on travaille directement sur GEDPARAM_ID
-- 	T_TGEDPARAM_SECTION = TRIM(T_TGEDPARAM_SECTION);
-- 	I_TGEDPARAM_NAME = TRIM(I_TGEDPARAM_NAME);
    -- V40 : TGEDPARAM.COMMENT
	-- I_TGEDPARAMUSER_COMMENT = TRIM(I_TGEDPARAMUSER_COMMENT);
    I_TGEDPARAMUSER_VALUE = TRIM(I_TGEDPARAMUSER_VALUE);
    
	SELECT 
        ID,
        SECTION,
        "NAME",
        "TYPE",
        COALESCE("COMMENT",''),
        CLASS,
		PROTECTION,
        (SELECT DATE_STRING FROM GET_DATE_STRING(MODIF_DATE)),
		COALESCE(TOWNER_ID,0),
		COALESCE(TLIBRARY_ID,0),
		COALESCE(DEFAULTVALUE,'')
        
	FROM TGEDPARAM
	WHERE ID=:I_TGEDPARAM_ID
	INTO
        GEDPARAM_ID,
        GEDPARAM_SECTION,
        GEDPARAM_NAME,
        GEDPARAM_TYPE,
        GEDPARAM_COMMENT,
        GEDPARAM_CLASS,
        GEDPARAM_PROTECTION,
        GEDPARAM_MODIF_DATE,	
        GEDPARAM_OWNER_ID,
        GEDPARAM_LIBRARY_ID,
		GEDPARAM_DEFAULTVALUE
    ;

    IF (:GEDPARAM_ID IS NULL) THEN EXCEPTION EX_NOGEDPARAM;
    
	
	BEGIN
		UPDATE OR INSERT INTO TGEDPARAMUSER(TGEDPARAM_ID, TGEDUSER_ID, TLIBRARY_ID, "VALUE")
		VALUES (
            :GEDPARAM_ID,
			:I_TGEDUSER_ID,
			NULLIF(:I_TLIBRARY_ID,0),
			NULLIF(:I_TGEDPARAMUSER_VALUE,'')
		)
		MATCHING (TGEDUSER_ID, TLIBRARY_ID, TGEDPARAM_ID)
        RETURNING
            TGEDUSER_ID,
            COALESCE(TLIBRARY_ID,0),
            COALESCE("VALUE",''),
            IIF(VALUEBLB IS NULL,0,1),
            (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMUSER.MODIF_DATE))
        INTO
            :GEDUSER_ID,
            :LIBRARY_ID,
            :GEDPARAMUSER_VALUE,
            :GEDPARAMUSER_VALUEBLB_FILLED,            
            :GEDPARAMUSER_MODIF_DATE
        ;
        
        SUSPEND;

	END

END ^

ALTER PROCEDURE SET_GEDPARAMUSER_VALUEBLB (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDPARAM_ID INTEGER NOT NULL,
I_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDPARAMUSER_VALUEBLB BLOB NOT NULL DEFAULT '')
RETURNS (GEDPARAMUSER_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
/*
	MAJ d'une valeur BLOB pour un paramtre GED USER

	Les STATES ne sont PAS  valus

	Le paramtre concern doit exister pralablement  l'appel de cette PS
	
	
V40 :
	- Factorisation TGEDPARAM	
	- retourne GEDPARAMUSER_MODIF_DATE (Attention, cette PS devient SELECTABLE)

*/

DECLARE VARIABLE ID_OK Integer;

BEGIN


	-- V40 : Vrification de l'existence du GEDPARAM...
	ID_OK = NULL;
	
	SELECT ID
	FROM TGEDPARAM
	-- V40 V2 : on travaille directement sur GEDPARAM_ID
	--WHERE "SECTION" = :I_TGEDPARAM_SECTION AND "NAME" = :I_TGEDPARAM_NAME 
	WHERE ID=:I_TGEDPARAM_ID
	INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDPARAM;

    UPDATE TGEDPARAMUSER
        SET VALUEBLB = NULLIF(:I_TGEDPARAMUSER_VALUEBLB,'')
        WHERE
            TGEDUSER_ID = :I_TGEDUSER_ID AND
            COALESCE(TLIBRARY_ID,0)=:I_TLIBRARY_ID AND
            TGEDPARAM_ID = :ID_OK
        RETURNING (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAMUSER.MODIF_DATE)) INTO :GEDPARAMUSER_MODIF_DATE;
        
    SUSPEND;
            
	IF (ROW_COUNT = 0) THEN
		EXCEPTION EX_NOGEDPARAMUSER;
            
END ^

ALTER PROCEDURE SET_GEDPARAM_DEFAULTVALUEBLB (I_TGEDPARAM_ID INTEGER NOT NULL,
I_TGEDPARAM_DEFAULTVALUEBLB BLOB NOT NULL DEFAULT '')
RETURNS (GEDPARAM_ID INTEGER,
GEDPARAM_MODIF_DATE VARCHAR(20) CHARACTER SET UTF8)
AS 
/*
	MAJ d'une valeur BLOB pour un paramtre GED

	Les STATES ne sont PAS  valus

	Le paramtre concern doit exister pralablement  l'appel de cette PS
	

V40 :
	- Ajout d'infos GEDPARAM en sortie
*/
BEGIN

	-- update du paramtre
	UPDATE TGEDPARAM
	SET DEFAULTVALUEBLB=NULLIF(:I_TGEDPARAM_DEFAULTVALUEBLB,'')
	WHERE ID=:I_TGEDPARAM_ID
	RETURNING TGEDPARAM.ID, (SELECT DATE_STRING FROM GET_DATE_STRING(TGEDPARAM.MODIF_DATE)) INTO :GEDPARAM_ID, :GEDPARAM_MODIF_DATE;

	SUSPEND;

	IF (ROW_COUNT = 0) THEN
		EXCEPTION EX_NOGEDPARAM;

END ^

ALTER PROCEDURE SET_GEDUSER_INFOS (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_TOWNER_ID INTEGER NOT NULL,
I_TGEDUSER_LOGIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDUSER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_COMMENT VARCHAR(8164) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TGEDUSER_CHARGEABLE BOOLEAN DEFAULT 0,
I_TGEDUSER_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_TGEDGROUP_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_TCONTACT_ID INTEGER NOT NULL DEFAULT 0,
I_TGEDUSER_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TCONTACT_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER)
AS 
/*
	Cration (ID=0) ou MAJ d'un utilisateur GED

MAJ V12 :
	- GED_LOGIN/GED_PASSWD ==> LOGIN/PASSWD

MAJ V14 :
	- Suppression des filtres sur LOGIN

MAJ V32 :
	- Ajout  GEDGROUP_ID

MAJ V39
    - Les dates MAJ sont initialises ici (plus dans le trigger) via I_TGEDUSER_NO_MODIF_DATE
*/

DECLARE VARIABLE SQL_WHERE_CONTACT VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
DECLARE VARIABLE MODIF_DATE TIMESTAMP;


BEGIN
    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TGEDUSER_STATE = TRIM(I_TGEDUSER_STATE);
    I_TCONTACT_STATE = TRIM(I_TCONTACT_STATE);

    ID_OK = Null;

    /* Vrification prsence de d'utilisateur ET STATE Ok si MAJ */
    IF (I_TGEDUSER_ID != 0 ) THEN
    BEGIN
        -- Utilisateur existant et modifiable...
        IF (I_TGEDUSER_STATE = '' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

        EXECUTE STATEMENT '
            SELECT ID, MODIF_DATE FROM TGEDUSER
            WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID || IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '')
            INTO :ID_OK, MODIF_DATE;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;
    END
        
    ID_OK=Null;
    
    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE TOWNER.ID=' || :I_TGEDUSER_TOWNER_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO ID_OK;
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;

    ID_OK=Null;

    /* contact utilisable outrepassable)... */
    IF (I_TGEDUSER_TCONTACT_ID!=0) THEN
    BEGIN
        IF (:I_TCONTACT_STATE = '' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TCONTACT.STATE') INTO :SQL_WHERE_CONTACT;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TCONTACT_STATE, 'TCONTACT.STATE') INTO :SQL_WHERE_CONTACT; 

        EXECUTE STATEMENT '
            SELECT TCONTACT.ID
            FROM TCONTACT INNER JOIN TOWNER ON TCONTACT.TOWNER_ID=TOWNER.ID
            WHERE TCONTACT.ID=' || :I_TGEDUSER_TCONTACT_ID ||
                IIF (:SQL_WHERE_CONTACT != '' , ' AND (' || :SQL_WHERE_CONTACT || ')', '') || 
                IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
            INTO ID_OK;

        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOCONTACT;
    END

    ID_OK=Null;
    
    /* Profil (si pass non Null) utilisable...*/
    IF (I_TGEDUSER_TPROFILE_ID !=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID FROM TPROFILE
            WHERE ID=' || :I_TGEDUSER_TPROFILE_ID
            INTO :ID_OK;
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOPROFILE;
    END

    ID_OK=Null;
    
    /* GEDGROUP (si pass non Null) utilisable...*/
    IF (I_TGEDUSER_TGEDGROUP_ID !=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID FROM TGEDGROUP
            WHERE ID=' || :I_TGEDUSER_TGEDGROUP_ID
            INTO :ID_OK;
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDGROUP;
    END
    
    
    /* Nettoyage des paramtres */
    I_TGEDUSER_LOGIN = TRIM(I_TGEDUSER_LOGIN);
	/* Contrle de donnes supprime en V14 */
	/*
    IF (I_TGEDUSER_LOGIN NOT SIMILAR TO '([[:ALNUM:]]|\_|.)+' ESCAPE '\') THEN
        EXCEPTION EX_ALPHAONLY_DOM_LOGIN;
	*/

    I_TGEDUSER_COMMENT = TRIM(I_TGEDUSER_COMMENT);

	-- Ancienne date de modif init plus haut ; on rinit le cas chant
	IF (:I_TGEDUSER_ID = 0 OR :I_TGEDUSER_NO_MODIF_DATE = 0) THEN MODIF_DATE = CURRENT_TIMESTAMP;

    BEGIN
    
        UPDATE OR INSERT INTO TGEDUSER (ID, MODIF_DATE, TOWNER_ID, LOGIN, SUBSCRIBE_START, SUBSCRIBE_END, "COMMENT", CHARGEABLE, TPROFILE_ID, TGEDGROUP_ID, TCONTACT_ID)
        VALUES (
            NULLIF(:I_TGEDUSER_ID,0), -- NULL si 0 (insertion car non existant)
            :MODIF_DATE,
            :I_TGEDUSER_TOWNER_ID, 
			:I_TGEDUSER_LOGIN,
            COALESCE(CAST((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TGEDUSER_SUBSCRIBE_START)) AS DATE),NULL), 
            COALESCE(CAST((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TGEDUSER_SUBSCRIBE_END)) AS DATE), NULL), 
            NULLIF(:I_TGEDUSER_COMMENT,''), 
            :I_TGEDUSER_CHARGEABLE,
            NULLIF(:I_TGEDUSER_TPROFILE_ID,0),
            NULLIF(:I_TGEDUSER_TGEDGROUP_ID,0),
            NULLIF(:I_TGEDUSER_TCONTACT_ID,0)
        )
        MATCHING (ID)
        RETURNING ID INTO GEDUSER_ID;

        SUSPEND;

        WHEN GDSCODE unique_key_violation DO -- Violation OWNER/TTITLE...
            EXCEPTION EX_GED_LOGIN_EXISTS;
	END
END ^

ALTER PROCEDURE SET_GEDUSER_PASSWD (I_TGEDUSER_ID INTEGER NOT NULL,
I_TGEDUSER_PASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TGEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (GEDUSER_ID INTEGER)
AS 
/*
    Modification du mot de passe d'un utilisateur GED
    
    Paramtres :
    - I_TGEDUSER_ID : Code Utilisateur GED
    - I_TGEDUSER_GED_PASSWD : nouveau mot de passe crypt SHA256 (impossible d'effectuer cette manipulation dans Firebird)
    - I_TOWNER_STATE : voir documentation STATE
    - I_TGEDUSER_STATE : voir documentation STATE

    Particularits :

    renvoie :
        GEDUSER_ID_ID : Identifiant de l'utilisateur
        
    Attention
    - cette procdure lve des erreurs en cas d'insertion/mise  jour impossible (erreurs sous-jacentes)
    
MAJ V12 :
	- GED_PASSWD ==> PASSWD
	
V39 :
    - MAJ inconditionnelle de MODIF_DATE
*/

DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
BEGIN

	ID_OK= Null;
	SQL_WHERE = '';

    I_TGEDUSER_STATE=TRIM(I_TGEDUSER_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    
    EXECUTE STATEMENT '
        SELECT ID FROM TGEDUSER
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID || IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '')
        INTO ID_OK;
        
    IF (ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;
    

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    EXECUTE STATEMENT '
        SELECT TOWNER_ID FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
        WHERE TGEDUSER.ID=' || :I_TGEDUSER_ID || IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '')
        INTO ID_OK;
        
    IF (ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;

	SQL_WHERE=Null;
	ID_OK= Null;

    IF (I_TGEDUSER_STATE = '' ) THEN
        /* Etat de visibilit par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE;
    ELSE
        /* Etat de visibilit demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TGEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE;

    /* Nettoyage des paramtres */
    I_TGEDUSER_PASSWD = TRIM(UPPER(I_TGEDUSER_PASSWD));
    
    /* Mise  jour */
    BEGIN
        UPDATE TGEDUSER
        SET PASSWD=NULLIF(:I_TGEDUSER_PASSWD,''), MODIF_DATE=CURRENT_TIMESTAMP
        WHERE ID=:I_TGEDUSER_ID
        RETURNING ID INTO GEDUSER_ID;
        
        SUSPEND;

    END
END ^

ALTER PROCEDURE SET_LIBRARY_INFOS (I_TLIBRARY_ID INTEGER NOT NULL,
I_TLIBRARY_TOWNER_ID INTEGER NOT NULL,
I_TLIBRARY_TFBSERVER_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_DBPATH VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_TITLE VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_GUID VARCHAR(255) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_VERSION INTEGER NOT NULL DEFAULT '',
I_TLIBRARY_COMMENT VARCHAR(500) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_CHARGEABLE BOOLEAN NOT NULL DEFAULT 0,
I_TLIBRARY_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_ACCESS_MODE SMALLINT NOT NULL DEFAULT 0,
I_TLIBRARY_ACCESS_TYPE INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_SIZE_MB BIGINT NOT NULL DEFAULT 0,
I_TLIBRARY_LAST_SIZE_CHECK VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_SIZE_MB_ORG BIGINT NOT NULL DEFAULT 0,
I_TLIBRARY_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_LISTORDER INTEGER NOT NULL DEFAULT 0,
I_TLIBRARY_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (LIBRARY_ID INTEGER)
AS 
/*
    Ajout/modification d'une bibliothque Novaxel dans la table correspondante (TLIBRARY)

    Si l'ID est NULL ==> Insertion
    Si ID pass ==> mise  jour d'une librairie existante
    
    Paramtres : cf table TLIBRARY

    Particularits :
    - Les cls externes (TFBSERVER_ID [si pass NOT NULL] et TOWNER_ID) sont vrifies avant l'insertion et les exceptions correspondantes sont leves si non prsents/disponibles
    - TITLE peut ne pas tre connu au moment de l'insertion (Null autoris)
    - DBPATH n'est PAS vrifi (accs au systme de fichier pas toujours possible, etc.)
    - CHARGEABLE : initialise  1 (True) si pass  Null
    - SUBSCRIBE_START : initialis  la date de l'insertion si pass  Null...
    - SUBSCRIBE_END : Initialis  la date SUBSCRIBE_START + 1 an si pass  NULL...
    - ACCESS_TYPE : inutilis actuellement
    - I_TOWNER_STATE et I_TLIBRARY_STATE permettent de prciser les STATE de MAJ (pas d'initialiser les colonnes STATE des tables (cf. PS SET_STATE pour a)
    -  propos des rgles de MAJ en update (en insertion le problme est plus simple) et des STATES :
        * Si un parent est inactif (STATE interdisant les modifications) on considre qu'il peut toutefois tre mis  jour si le nouveau parent est actif
        * Les paramtres I_XXX_STATE permettent donc de prciser si on autorise la MAJ avec un nuveau parent qui ne serait pas actif (on ne teste pas l'ancien parent)
        * Par exemple, pour le OWNER :
            * on ne se proccupe pas de TLIBRARY.TOWNER_ID existant (STATE non valu)
            * on regarde si le I_TOWNER_ID est utilisable
                - Si c'est le cas, on peut modifier le OWNER_ID
                - Dans le cas contraire, on prend en compte le I_TOWNER_STATE pour savoir si l'on a le droit d'utiliser un OWNER_ID dsactiv
    
    renvoie :
        LIBRARY_ID : Identifiant de la bibliothque insre si russite
        
    Attention, cette procdure lve des erreurs en cas d'insertion/mise  jour impossible (erreurs sous-jacentes)
    Les tats des enregistrments parents sont pris en compte pour les modification ou insertion

MAJ V13:
	- Ajout LIBRARY_GUID

V18 :
	- Force les paramtres NOT NULL En entre...

V23 :
    - Ajout de SIZE_MB + LAST_SIZE_CHECK en entre
    
V24 :
    - SIZE_MB BIGINT

V26 :
	- Dates de souscription vides possibles...
	
V31 :
    - Ajout ACCESS_MODE

V32 :
	- Ajout LISTORDER

- MAJ V36
    - Ajout LIBRARY_SIZE_MB_ORG

MAJ V39
    - Les dates MAJ sont initialises ici (plus dans le trigger) via I_TLIBRARY_NO_MODIF_DATE

-V40
	GUID VARCHAR(40) => VARCHAR(255)
	Ajout TLIBRARY.VERSION
*/

DECLARE VARIABLE SQL_WHERE VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    

DECLARE VARIABLE MODIF_DATE TIMESTAMP;

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    I_TLIBRARY_STATE = TRIM(I_TLIBRARY_STATE);
    I_TFBSERVER_STATE= TRIM(I_TFBSERVER_STATE);

    ID_OK=Null;
    SQL_WHERE= '';

    /* Vrification prsence de librairie ET STATE Ok si MAJ */
    IF (:I_TLIBRARY_ID != 0 ) THEN
    BEGIN
        -- Library existante et modifiable...
        IF (:I_TLIBRARY_STATE = '' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE; 

        EXECUTE STATEMENT '
            SELECT ID, MODIF_DATE FROM TLIBRARY
            WHERE TLIBRARY.ID=' || :I_TLIBRARY_ID || IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '')
            INTO :ID_OK, MODIF_DATE;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;
    END
        
    ID_OK=Null;
    SQL_WHERE= Null;
    
    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE ID=' || :I_TLIBRARY_TOWNER_ID || IIF (:SQL_WHERE != '' , ' AND (' || :SQL_WHERE || ')', '')
        INTO ID_OK;
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;

    ID_OK=Null;
    SQL_WHERE= Null;
        
    /* Serveur Firebird (si pass non Null) utilisable outrepassable (test en ajout/MAJ)...*/
    IF (I_TLIBRARY_TFBSERVER_ID !=0) THEN
    BEGIN
        IF (:I_TFBSERVER_STATE= '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE;         

        EXECUTE STATEMENT '
            SELECT ID FROM TFBSERVER
            WHERE ID=' || :I_TLIBRARY_TFBSERVER_ID || IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '')
            INTO :ID_OK;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOFBSER;
    END
    
    ID_OK=Null;
    SQL_WHERE= Null;

    /* Profil (si pass non Null) utilisable...*/
    IF (I_TLIBRARY_TPROFILE_ID !=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID FROM TPROFILE
            WHERE ID=' || :I_TLIBRARY_TPROFILE_ID
            INTO :ID_OK;
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOPROFILE;
    END
    
    
    /* Nettoyage des paramtres */
    I_TLIBRARY_COMMENT = TRIM(:I_TLIBRARY_COMMENT);
    -- TODO : Voir si contrainte de TITLE dans NOVAXEL.FDB.TCONFIG ???
    I_TLIBRARY_TITLE = TRIM(:I_TLIBRARY_TITLE);
    -- Pour l'instant le PATH est obligatoire dans la table, mais pas dans la PS (doute ;-) ) on l'insre donc  '' le cas chant
    I_TLIBRARY_DBPATH = TRIM(:I_TLIBRARY_DBPATH);
    
    I_TLIBRARY_GUID=TRIM(I_TLIBRARY_GUID);

	-- Ancienne date de modif init plus haut ; on rinit le cas chant
	IF (:I_TLIBRARY_ID = 0 OR :I_TLIBRARY_NO_MODIF_DATE = 0) THEN MODIF_DATE = CURRENT_TIMESTAMP;
    
    BEGIN
    
        UPDATE OR INSERT INTO TLIBRARY (ID,MODIF_DATE, TOWNER_ID, TFBSERVER_ID, "COMMENT", TITLE, GUID, "VERSION", DBPATH, SUBSCRIBE_START, SUBSCRIBE_END, ACCESS_MODE, ACCESS_TYPE, SIZE_MB, LAST_SIZE_CHECK, SIZE_MB_ORG, CHARGEABLE, TPROFILE_ID, LISTORDER)
        VALUES (
            NULLIF(:I_TLIBRARY_ID,0), -- NULL si 0 (insertion car non existant)
            :MODIF_DATE,
            :I_TLIBRARY_TOWNER_ID, 
            NULLIF(:I_TLIBRARY_TFBSERVER_ID,0), 
            NULLIF(:I_TLIBRARY_COMMENT,''), 
            NULLIF(:I_TLIBRARY_TITLE,''), 
            NULLIF(:I_TLIBRARY_GUID,''), 
            NULLIF(:I_TLIBRARY_VERSION,0), 
            :I_TLIBRARY_DBPATH, 
            CAST((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TLIBRARY_SUBSCRIBE_START)) AS TIMESTAMP), 
            CAST((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TLIBRARY_SUBSCRIBE_END)) AS TIMESTAMP), 
			:I_TLIBRARY_ACCESS_MODE,
            NULLIF(:I_TLIBRARY_ACCESS_TYPE,0), --NULL si 0
            :I_TLIBRARY_SIZE_MB, -- 0 si non pass
            CAST((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TLIBRARY_LAST_SIZE_CHECK)) AS TIMESTAMP),  -- NULL si non pass (ie pass  '')
            :I_TLIBRARY_SIZE_MB_ORG, -- 0 si non pass
            :I_TLIBRARY_CHARGEABLE,
            NULLIF(:I_TLIBRARY_TPROFILE_ID,0),
            NULLIF(:I_TLIBRARY_LISTORDER,0)

        )
        MATCHING (ID)
        RETURNING ID INTO LIBRARY_ID;

        SUSPEND;

        WHEN GDSCODE unique_key_violation DO -- Violation OWNER/TTITLE...
            EXCEPTION EX_LIBTITLE_EXISTS;
            
        WHEN GDSCODE  check_constraint DO -- Check ACCESS_MODE
            EXCEPTION EX_BADACCESSMODE;
            



--		Pour l'instant on laisse l'erreur FB...
--         WHEN ANY DO
--             -- Rcupration du code gnrique d'erreur et ajout d'informations complmentaires...
--             EXCEPTION EX_ERRGEN (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME='EX_ERRGEN') ||
--                 IIF(:I_TLIBRARY_ID IS NULL,'Ajout','Mise  jour') || ' de TLIBRARY (SET_LIB_INFOS) impossible suite  l''erreur non prise en charge suivante : ' ||
--                 'GDS : "' || GDSCODE || '" - SQL : "' || SQLCODE || '"';
    END

END ^

ALTER PROCEDURE SET_OWNER_INFOS (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_LOGIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_SUBDOMAIN VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_NAME VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_SUBSCRIBE_START VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_SUBSCRIBE_END VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_EXTERNAL_ID VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_COMMENT VARCHAR(8164) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TOWNER_TPROFILE_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_TCONTACT_ID INTEGER NOT NULL DEFAULT 0,
I_TOWNER_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER)
AS 
/*
    Ajout/modification d'un propritaire dans la table correspondante
    
    Si l'ID est NULL ==> Insertion
    Si ID pass ==> mise  jour d'un owner existant
    
    Paramtres : cf table TOWNER

    Particularits :
        - La date de MAJ (TOWNER.MODIF_DATE) est toujours mise  jour par le trigger "AINC_TOWNER"
        - I_TFBSERVER_STATE permet de prciser les conditions de STATE de MAJ (pas d'initialiser les colonnes STATE des tables (cf. PS SET_STATE ou DEL_OWNER pour a)    

    renvoie :
        OWNER_ID : Identifiant du propritaire insr/modifi si russite
        
    Attention
    - cette procdure lve des erreurs en cas d'insertion/mise  jour impossible (erreurs sous-jacentes)
    - En cas de mise  jour, la colonne TOWNER.STATE est value par le trigger de la table et une erreur peut-tre leve si le owner n'est pas modifiable...
    
    Les tats (colonne STATE) ne sont pas pris en compte pour les insertions...

MAJ V12 :
	- Ajout TCONTACT_ID
	- DOM_LOGIN ==> LOGIN

MAJ V14 :
	- Suppression des filtres sur LOGIN/SUBDOMAIN

V26 :
	- Optimisation CAST sur dates souscriptions
	
MAJ V39
    - Les dates MAJ sont initialises ici (plus dans le trigger) via I_TOWNER_NO_MODIF_DATE
	
*/

DECLARE VARIABLE SQL_WHERE VARCHAR(8000);
DECLARE VARIABLE ID_OK Integer;    
DECLARE VARIABLE MODIF_DATE TIMESTAMP;

BEGIN

    I_TOWNER_STATE = TRIM(I_TOWNER_STATE);
    
    ID_OK=Null;
    SQL_WHERE= '';

    /* Vrification prsence ET STATE Ok si MAJ */
    IF (:I_TOWNER_ID != 0) THEN
    BEGIN
        IF (:I_TOWNER_STATE ='' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE; 

        EXECUTE STATEMENT '
            SELECT ID, MODIF_DATE FROM TOWNER
            WHERE TOWNER.ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE != '' ,' AND ' || :SQL_WHERE, '')
            INTO :ID_OK, MODIF_DATE;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;
    END

    ID_OK=Null;
    SQL_WHERE= '';

    /* Profil (si pass non Null) utilisable...*/
    IF (I_TOWNER_TPROFILE_ID !=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID FROM TPROFILE
            WHERE ID=' || I_TOWNER_TPROFILE_ID
            INTO :ID_OK;
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOPROFILE;
    END
    
    ID_OK=Null;
    /* Contact (si pass non Null) utilisable...*/
    IF (I_TOWNER_TCONTACT_ID !=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID FROM TCONTACT
            WHERE ID=' || I_TOWNER_TCONTACT_ID
            INTO :ID_OK;
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOCONTACT;
    END

    /* Nettoyage des paramtres */
    I_TOWNER_NAME = TRIM(:I_TOWNER_NAME);
    I_TOWNER_LOGIN=TRIM(:I_TOWNER_LOGIN);

    /* Au moins 1 caractre ALPHANUM - Supprim en V14 */
	/*
    IF (:I_TOWNER_LOGIN NOT SIMILAR TO '([[:ALNUM:]]|\_|.)+' ESCAPE '\') THEN
        EXCEPTION EX_ALPHAONLY_DOM_LOGIN;
    I_TOWNER_SUBDOMAIN=TRIM(:I_TOWNER_SUBDOMAIN);
	*/

    /* Au moins 1 caractre ALPHANUM  - Supprim en V14 */
	/*
    IF (:I_TOWNER_SUBDOMAIN NOT SIMILAR TO '([[:ALNUM:]]|\_|.)+' ESCAPE '\') THEN
        EXCEPTION EX_ALPHAONLY_SUBDOMAIN;
	*/

    
    I_TOWNER_EXTERNAL_ID=TRIM(:I_TOWNER_EXTERNAL_ID);
    I_TOWNER_COMMENT=TRIM(:I_TOWNER_COMMENT);

	-- Ancienne date de modif init plus haut ; on rinit le cas chant
	IF (:I_TOWNER_ID = 0 OR :I_TOWNER_NO_MODIF_DATE = 0) THEN MODIF_DATE = CURRENT_TIMESTAMP;
    
    BEGIN
        UPDATE OR INSERT INTO TOWNER (ID, MODIF_DATE, NAME, SUBDOMAIN, LOGIN, SUBSCRIBE_START,SUBSCRIBE_END, EXTERNAL_ID, "COMMENT",TPROFILE_ID, TCONTACT_ID)
        VALUES (
            NULLIF(:I_TOWNER_ID,0), -- NULL si 0 (insertion car non existant)
            :MODIF_DATE,
            NULLIF(:I_TOWNER_NAME,''), -- NULL autoris depuis V7...
			:I_TOWNER_SUBDOMAIN, -- Unique
            :I_TOWNER_LOGIN, -- Unique
            CAST((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TOWNER_SUBSCRIBE_START)) AS DATE), 
            CAST((SELECT DATE_STRING FROM SET_STRING_DATE(:I_TOWNER_SUBSCRIBE_END)) AS DATE), 
            NULLIF(:I_TOWNER_EXTERNAL_ID,''), -- Unique
            NULLIF(:I_TOWNER_COMMENT,''),
            NULLIF(:I_TOWNER_TPROFILE_ID,0),
            NULLIF(:I_TOWNER_TCONTACT_ID,0)
        )
        MATCHING (ID)
        RETURNING ID INTO OWNER_ID;
        
        SUSPEND;

        /* LOGIN (TABLE CONSTRAINT) dj existant (recr aprs suppression logique initiale) */
        WHEN GDSCODE unique_key_violation DO EXCEPTION EX_DOM_LOGIN_EXISTS;
        
        -- EXTERNAL_ID/SUBDOMAIN existant (IDX Unique)
        WHEN GDSCODE no_dup DO EXCEPTION EX_OWNER_INFOS_DUPLICATE;
        
    END
END ^

ALTER PROCEDURE SET_OWNER_PASSWD (I_TOWNER_ID INTEGER NOT NULL,
I_TOWNER_PASSWD VARCHAR(100) CHARACTER SET UTF8 NOT NULL,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (OWNER_ID INTEGER)
AS 
/*
    Modification du mot de passe du propritaire
    
    Paramtres :
    - I_TOWNER_ID : Code du propritaire
    - I_TOWNER_PASSWD : nouveau mot de passe HASH SHA256 (impossible d'effectuer cette manipulation dans Firebird)
    - I_TOWNER_STATE : voir documentation STATE

    Particularits :

    renvoie :
        OWNER_ID : Identifiant du propritaire insr/modifi si russite
        
    Attention
    - cette procdure lve des erreurs en cas d'insertion/mise  jour impossible (erreurs sous-jacentes)
    
MAJ V12 :
	- DOM_PASSWD ==> PASSWD
	
V39 :
    - MAJ inconditionnelle de MODIF_DATE
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE OWNER_ID_MODIF_OK Integer;    
BEGIN

	SQL_WHERE_OWNER = '';
	OWNER_ID_MODIF_OK = Null;

    IF (:I_TOWNER_STATE = '' ) THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE TOWNER.ID=' || :I_TOWNER_ID || IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
        INTO :OWNER_ID_MODIF_OK;
        
    IF (:OWNER_ID_MODIF_OK IS NULL) THEN EXCEPTION EX_NOOWNER;


    /* Nettoyage des paramtres */
    I_TOWNER_PASSWD = TRIM(UPPER(:I_TOWNER_PASSWD));
    
    /* Mise  jour */
    BEGIN
        UPDATE TOWNER
        SET PASSWD=NULLIF(:I_TOWNER_PASSWD,''), MODIF_DATE=CURRENT_TIMESTAMP
        WHERE ID=:I_TOWNER_ID
        RETURNING ID INTO OWNER_ID;
        
        SUSPEND;

--		Pour l'instant on laisse l'erreur FB...        
--         WHEN ANY DO
--             -- Rcupration du code gnrique d'erreur et ajout d'informations complmentaires...
--             EXCEPTION EX_ERRGEN (SELECT RDB$MESSAGE FROM RDB$EXCEPTIONS WHERE RDB$EXCEPTION_NAME='EX_ERRGEN') ||
--                 'Mise  jour de TOWNER.PASSWORD (SET_OWNER_DOM_PASSWD) impossible suite  l''erreur non prise en charge suivante : ' ||
--                 'GDS : "' || GDSCODE || '" - SQL : "' || SQLCODE || '"';
    END
END ^

ALTER PROCEDURE SET_PROFILE_INFOS (I_TPROFILE_ID INTEGER NOT NULL,
I_TPROFILE_OWNER_ID INTEGER NOT NULL,
I_TPROFILE_NAME VARCHAR(100) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TPROFILE_COMMENT VARCHAR(8164) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TPROFILE_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0,
I_TPROFILE_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TPROFILE_NO_MODIF_DATE BOOLEAN NOT NULL DEFAULT 0,
I_TOWNER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TLIBRARY_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_TFBSERVER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '',
I_GEDUSER_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (PROFILE_ID INTEGER)
AS 
/*
Mise  jour ou Cration (ID=0) d'un Profil

MAJ V39
    - Les dates MAJ sont initialises ici (plus dans le trigger) via I_TPROFILE_NO_MODIF_DATE
*/

DECLARE VARIABLE SQL_WHERE_OWNER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_LIB VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_FBSERVER VARCHAR(8000);
DECLARE VARIABLE SQL_WHERE_GEDUSER VARCHAR(8000);

DECLARE VARIABLE ID_OK Integer;    

DECLARE VARIABLE MODIF_DATE TIMESTAMP;


BEGIN
    I_TLIBRARY_STATE=TRIM(I_TLIBRARY_STATE);
    I_TOWNER_STATE=TRIM(I_TOWNER_STATE);
    I_TFBSERVER_STATE=TRIM(I_TFBSERVER_STATE);
    I_GEDUSER_STATE=TRIM(I_GEDUSER_STATE);

    SQL_WHERE_OWNER= '';
    SQL_WHERE_LIB = '';
	SQL_WHERE_FBSERVER = '';
	SQL_WHERE_GEDUSER = '';

    ID_OK=Null;
    
    /* V 39 : On vrifie la prsence d'un profil existant en MAJ mme si STATE non gr en TPROFILE (permet aussi de rcuprer la MODIF DATE) */
    IF (:I_TPROFILE_ID !=0) THEN
    BEGIN
        EXECUTE STATEMENT '
            SELECT ID, MODIF_DATE FROM TPROFILE
            WHERE TPROFILE.ID=' || :I_TPROFILE_ID
            INTO :ID_OK, MODIF_DATE;
            
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOPROFILE;
    END
        
    ID_OK=Null;

    /* Owner utilisable outrepassable (test en ajout/MAJ)... */
    IF (:I_TOWNER_STATE = '') THEN
        /* Etat de modification par dfaut */
        SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TOWNER.STATE') INTO :SQL_WHERE_OWNER;
    ELSE 
        /* Etat de modification demand */
        SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TOWNER_STATE, 'TOWNER.STATE') INTO :SQL_WHERE_OWNER; 

    EXECUTE STATEMENT '
        SELECT ID FROM TOWNER
        WHERE ID=' || :I_TPROFILE_OWNER_ID || IIF (:SQL_WHERE_OWNER != '' , ' AND (' || :SQL_WHERE_OWNER || ')', '')
        INTO ID_OK;

    IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOOWNER;
    
    IF (I_TPROFILE_TLIBRARY_ID != 0) THEN
    BEGIN
        ID_OK=Null;

       /* Serveur Firebird (si non Null) utilisable outrepassable...*/
        IF (:I_TFBSERVER_STATE = '' ) THEN
            /* Etat de visibilit par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;
        ELSE 
            /* Etat de visibilit demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TFBSERVER_STATE, 'TFBSERVER.STATE') INTO :SQL_WHERE_FBSERVER;

        -- Library existante et modifiable...
        IF (:I_TLIBRARY_STATE ='' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TLIBRARY.STATE') INTO :SQL_WHERE_LIB;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_TLIBRARY_STATE, 'TLIBRARY.STATE') INTO :SQL_WHERE_LIB; 

        /* Existence/visibilit de la librairie demande (elle-mme et ses parents)*/
        EXECUTE STATEMENT '
            SELECT TLIBRARY.ID
            FROM TLIBRARY INNER JOIN TOWNER ON TLIBRARY.TOWNER_ID=TOWNER.ID
                LEFT JOIN TFBSERVER ON TLIBRARY.TFBSERVER_ID=TFBSERVER.ID
            WHERE TLIBRARY.ID=' || :I_TPROFILE_TLIBRARY_ID ||
                IIF (:SQL_WHERE_LIB != '' ,' AND ' || :SQL_WHERE_LIB, '') ||
                IIF (:SQL_WHERE_FBSERVER != '' , ' AND (' || :SQL_WHERE_FBSERVER || 'OR TFBSERVER.STATE IS NULL)', '') ||
                IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
            INTO :ID_OK;
                
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOLIB;
    END

    IF (I_TPROFILE_TGEDUSER_ID != 0) THEN
    BEGIN
        ID_OK=Null;

        -- Utilisateur existant et modifiable...
        IF (I_GEDUSER_STATE ='' ) THEN
            /* Etat de modification par dfaut */
            SELECT SQL_WHERE_DEFAULT_ALTER FROM GET_ALTER_STATE_OK('TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER;
        ELSE 
            /* Etat de modification demand */
            SELECT CRIT_FOR_STATE FROM GET_STATE_CRITERIA(:I_GEDUSER_STATE, 'TGEDUSER.STATE') INTO :SQL_WHERE_GEDUSER; 

        /* Existence/visibilit de l'utilisateur demand (lui-mme et ses parents)*/
        EXECUTE STATEMENT '
            SELECT TGEDUSER.ID
            FROM TGEDUSER INNER JOIN TOWNER ON TGEDUSER.TOWNER_ID=TOWNER.ID
            WHERE TGEDUSER.ID=' || :I_TPROFILE_TGEDUSER_ID ||
                IIF (:SQL_WHERE_GEDUSER != '' ,' AND ' || :SQL_WHERE_GEDUSER, '') ||
                IIF (:SQL_WHERE_OWNER != '' ,' AND ' || :SQL_WHERE_OWNER, '')
            INTO :ID_OK;
                
        IF (:ID_OK IS NULL) THEN EXCEPTION EX_NOGEDUSER;
    END


    /* Nettoyage des paramtres */
    I_TPROFILE_NAME = TRIM(I_TPROFILE_NAME);
    I_TPROFILE_COMMENT = TRIM(I_TPROFILE_COMMENT);

	-- Ancienne date de modif init plus haut ; on rinit le cas chant
	IF (:I_TPROFILE_ID = 0 OR :I_TPROFILE_NO_MODIF_DATE = 0) THEN MODIF_DATE = CURRENT_TIMESTAMP;

	BEGIN
        UPDATE OR INSERT INTO TPROFILE (ID,MODIF_DATE, TOWNER_ID, "NAME", "COMMENT", TLIBRARY_ID, TGEDUSER_ID)
        VALUES (
            NULLIF(:I_TPROFILE_ID,0), -- NULL si 0 (insertion car non existant)
            :MODIF_DATE,
            :I_TPROFILE_OWNER_ID, 
            NULLIF(:I_TPROFILE_NAME,''), 
            NULLIF(:I_TPROFILE_COMMENT,''),
            NULLIF(:I_TPROFILE_TLIBRARY_ID,0),
			NULLIF(:I_TPROFILE_TGEDUSER_ID,0)
        )
        MATCHING (ID)
        RETURNING ID INTO PROFILE_ID;

		SUSPEND;

		WHEN GDSCODE unique_key_violation DO -- Violation OWNER/NAME...
			EXCEPTION EX_PROFILE_EXISTS;
	END
END ^

ALTER PROCEDURE SET_STATE (I_EXPR_STATE VARCHAR(15) CHARACTER SET UTF8 NOT NULL,
I_CRITERIA VARCHAR(8000) CHARACTER SET UTF8 NOT NULL,
I_TARGETED_TABLE VARCHAR(255) CHARACTER SET UTF8 NOT NULL,
I_TARGETED_COLUMN VARCHAR(255) CHARACTER SET UTF8 DEFAULT 'STATE')
RETURNS (NEW_STATE STATE)
AS 
/*
    Cette procdure modifie l'tat d'une colonne STATE
    
    Attend :
    - I_EXPR_STATE : une expression de mise  jour d'tat sous la forme : oprateur+valeur (aucun espace ou autre caractre de sparation) o :
        -> Oprateur peut tre :
        "=" pour "gal" (mise  jour d'un tat atomique),
        "+" pour ajouter un ou plusieurs tats
        "-" pour retirer un ou plusieurs tats
        -> valeur peut-tre toute valeur ou toute combinaison de valeur (doit tre vide si EXPR_CRIT_STATE = "*")
    - I_TARGETED_TABLE : nom d'une table  impacter
    - I_CRITERIA : critre  appliquer pour la mise  jour
    - I_TARGETED_COLUMN : Nom de la colonne STATE dans I_TARGETED_TABLE ('STATE' par dfaut)
    
    Retourne :
    - NEW_STATE : Nouvel tat obtenu aprs application
    
    Attention cette procdure n'interdit pas de modifier un tat pour un enregistrement "inactif" (elle peut-tre utilise pour cela, justement) ; par exemple, cette procdure 
    permet de remettre un tat "0" pour un propritaire en tat 1 (supprim)...
    
    Exemple :
    SELECT SET_STATE('=2','TOWNER','ID=15') ==> Mise jour atomique de l'tat de la colonne STATE (par dfaut) dans la table TOWNER pour le propritaire 15
        Rsultat ==> 2
    SELECT SET_STATE('+2','TOWNER','ID=15') ==> Mise jour ajout de l'tat de la colonne STATE (par dfaut) dans la table TOWNER pour le propritaire 15
        Rsultat ==> dpendant de la valeur initiale, par exemple si STATE tait 3 => 3 (rien  faire car 2 dj positionn), si STATE tait 4 ==> 6, ...
    SELECT SET_STATE('-3','TOWNER','ID=15') ==> Mise jour ajout de l'tat de la colonne STATE (par dfaut) dans la table TOWNER pour le propritaire 15
        Rsultat ==> dpendant de la valeur initiale, par exemple si STATE tait 3 => 0, si STATE tait 2 => 2 (rien  retirer), si STATE tait 7 ==> 4, ...

     ce jour (version 7), les tats suivants sont rfrencs :
    - 0 ==> aucun tat particulier donc mise  jour/visibilit active inconditionnelement (donc, ce n'est pas  proprement parler un tat ;-) )
    - 1 ==> Enregistrement supprim donc mise  jour/visibilit normalement inactive
        (voir les paramtres de domaine "DOM_RECORD_ALTER_KO" et/ou "DOM_RECORD_VISIBILITY_KO")
    
    Les tats <= 8192 sont rservs  la gestion de domaine Novaxel (soit 14 possibilits)
    Les tats > 8192 peuvent tre utiliss par les administrateurs pour grer leurs propres spcificits de domaine
        (soit 14 possibilits ; valeur maximum autorise dans un Integer FB : 134217728)

    TODO : revoir la possibilit de MAJ multiligne :
    - Actuellement on fait confiance  la colonne ID (en dur) pour rcuprer les enregistrements  UPDATER
    - Voir rcupration de PK + Type, etc et MAJ en fonction de ces lments ...

V31 :
	- Exception spcifique
*/

DECLARE VARIABLE OP_BIN CHAR(1);
DECLARE VARIABLE VAL_INIT INTEGER;
DECLARE VARIABLE VAL_INIT_STR VARCHAR(15);
DECLARE VARIABLE SET_VAL VARCHAR(300);
DECLARE VARIABLE TEMP_ID INTEGER;
BEGIN
    I_EXPR_STATE=TRIM(I_EXPR_STATE);
    I_TARGETED_TABLE=TRIM(I_TARGETED_TABLE);
    I_CRITERIA=TRIM(I_CRITERIA);
    I_TARGETED_COLUMN=TRIM(I_TARGETED_COLUMN);
    
    /* paramtres obligatoire */
    IF (I_EXPR_STATE='' OR I_TARGETED_TABLE='' OR I_CRITERIA='') THEN 
        EXCEPTION EX_BAD_PARAM;

    IF (NOT EXISTS 
        (SELECT RDB$RELATION_NAME FROM RDB$RELATION_FIELDS WHERE RDB$RELATION_NAME=:I_TARGETED_TABLE AND RDB$FIELD_NAME=:I_TARGETED_COLUMN AND RDB$SYSTEM_FLAG=0)
        ) THEN
        EXCEPTION EX_NOTABLEORCOL;

    /* Extraction de l'oprateur */
    OP_BIN = LEFT(I_EXPR_STATE,1);
    IF (OP_BIN ='' OR (OP_BIN NOT IN ('=','+','-'))) THEN
        EXCEPTION EX_BAD_PARAM;
    
    /* Extraction de la valeur  */
    VAL_INIT_STR = TRIM(SUBSTRING(I_EXPR_STATE FROM 2));
    IF (VAL_INIT_STR = '') THEN
        EXCEPTION EX_BAD_PARAM;
    ELSE
        VAL_INIT=CAST(VAL_INIT_STR AS INTEGER);
    
    /* gal ==> = */
    IF (OP_BIN = '=') THEN
        SET_VAL = I_TARGETED_COLUMN || '=' || VAL_INIT;
    /* Ajout ==> BIN_OR */
    ELSE IF (OP_BIN = '+') THEN
        SET_VAL = I_TARGETED_COLUMN || ' = BIN_OR(' || I_TARGETED_COLUMN || ',' || VAL_INIT || ')';
    /* Retrait ==> VAL-BIN_AND */
    ELSE IF (OP_BIN = '-') THEN
        SET_VAL = I_TARGETED_COLUMN || ' = ' || I_TARGETED_COLUMN || ' - BIN_AND(' || I_TARGETED_COLUMN || ',' || VAL_INIT || ')';
    ELSE
        EXCEPTION EX_BAD_PARAM;


    FOR EXECUTE STATEMENT --'
        --UPDATE ' || :I_TARGETED_TABLE || ' SET ' || :SET_VAL || ' WHERE ' || :I_CRITERIA || ' RETURNING STATE '
        'SELECT ID FROM ' || :I_TARGETED_TABLE || ' WHERE ' || :I_CRITERIA
        INTO :TEMP_ID
        DO
        BEGIN
            EXECUTE STATEMENT 'UPDATE ' || :I_TARGETED_TABLE || ' SET ' || :SET_VAL || ' WHERE ID=' || :TEMP_ID || ' RETURNING STATE '
            INTO :NEW_STATE;
            SUSPEND;
        END

END ^

ALTER PROCEDURE SET_STORAGE (I_TSTORAGE_TOWNER_ID INTEGER NOT NULL,
I_TSTORAGE_SECTION VARCHAR(40) CHARACTER SET UTF8 NOT NULL,
I_TSTORAGE_NAME VARCHAR(80) CHARACTER SET UTF8 NOT NULL,
I_TSTORAGE_VALUE VARCHAR(8000) CHARACTER SET UTF8 NOT NULL,
I_TSTORAGE_TGEDUSER_ID INTEGER NOT NULL DEFAULT 0,
I_TSTORAGE_TLIBRARY_ID INTEGER NOT NULL DEFAULT 0)
AS 
/*
	Ajoute ou MAJ (ID=0) d'un paramtre en TSTORAGE

	L'unicit est dclare dans la table, au niveau de OWNER_ID, GEDUSER_ID, LIBRARY_ID,SECTION, NAME
	Si TLIBRARY_ID et/ou TGEDUSER_ID est pass, on ne vrifie pas qu'il(s) corresponde(nt) au OWNER_ID...
	Les STATES OWNER/GEDUSER/LIBRARY ne sont PAS values par cette procdure...

V40 :
	- Cration

*/


DECLARE VARIABLE ID_OWNER Integer;    

BEGIN

    ID_OWNER= Null;

    IF (:I_TSTORAGE_TGEDUSER_ID !=0) THEN
    BEGIN
        -- On vrifie que le GEDUSER est OK
        SELECT TOWNER_ID FROM TGEDUSER WHERE TGEDUSER.ID=:I_TSTORAGE_TGEDUSER_ID INTO :ID_OWNER;
        IF (ID_OWNER IS NULL) THEN EXCEPTION EX_NOGEDUSER;
    END
    
    IF (:I_TSTORAGE_TLIBRARY_ID != 0) THEN
    BEGIN
        ID_OWNER= Null;
        -- On vrifie que le GEDUSER est OK
        SELECT TOWNER_ID FROM TLIBRARY WHERE TLIBRARY.ID=:I_TSTORAGE_TLIBRARY_ID INTO :ID_OWNER;
        IF (ID_OWNER IS NULL) THEN EXCEPTION EX_NOLIB;
    END
    
    IF (:I_TSTORAGE_TOWNER_ID !=0) THEN
    BEGIN
        -- On vrifie que le OWNER est OK
        IF (NOT EXISTS(SELECT ID FROM TOWNER WHERE ID=:I_TSTORAGE_TOWNER_ID)) THEN
            EXCEPTION EX_NOOWNER;
        ELSE
            ID_OWNER=:I_TSTORAGE_TOWNER_ID;
    END
    ELSE
        -- Si pas de OWNER pass, ni trouv auparavant, on lve l'erreur
        IF (:ID_OWNER IS NULL) THEN EXCEPTION EX_NOOWNER;

    /* Nettoyage des paramtres */
    I_TSTORAGE_NAME = TRIM(I_TSTORAGE_NAME);
    I_TSTORAGE_SECTION = TRIM(I_TSTORAGE_SECTION);
    I_TSTORAGE_VALUE = TRIM(I_TSTORAGE_VALUE);

    UPDATE OR INSERT INTO TSTORAGE (TOWNER_ID, "SECTION", "NAME", "VALUE", TLIBRARY_ID, TGEDUSER_ID, MODIF_DATE)
        VALUES (
			:ID_OWNER,
            :I_TSTORAGE_SECTION,
            :I_TSTORAGE_NAME,
            :I_TSTORAGE_VALUE,
            NULLIF(:I_TSTORAGE_TLIBRARY_ID,0),
            NULLIF(:I_TSTORAGE_TGEDUSER_ID,0),
            CURRENT_TIMESTAMP
        )
        MATCHING (TOWNER_ID,TGEDUSER_ID, TLIBRARY_ID,SECTION,NAME);

        -- Dans la pratique, ne devrait jamais arriver avec UPDATE OR INSERT...
		WHEN GDSCODE unique_key_violation DO -- Violation UNIQUE TABLE
			EXCEPTION EX_STORAGE_EXISTS;

END ^

ALTER PROCEDURE SET_STRING_DATE (I_STRING VARCHAR(20) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (DATE_STRING TIMESTAMP)
AS 
/*
    Renvoi un type timestamp (applicable aux date/time/timestamp)
    
    Si I_STRING='', renvoi NULL
    
    Si la chaine pass est incorrecte une erreur de conversion est leve par FB (GDSCODE 335544334)
    
    On renvoi la date correspondante  la chaine reu sans traitement particulier...
*/
BEGIN
    IF (TRIM(I_STRING ) = '') THEN
        DATE_STRING=NULL;
    ELSE
        DATE_STRING=I_STRING;
    
    SUSPEND;
END ^

ALTER PROCEDURE SPLIT_BLOB (SQL_GETBLOB VARCHAR(8000) CHARACTER SET UTF8 NOT NULL,
FIELD_SEP VARCHAR(5) CHARACTER SET UTF8 NOT NULL DEFAULT '')
RETURNS (RESULTS VARCHAR(255) CHARACTER SET UTF8)
AS 
/*
    Procdure outil gnrique
    Permet de rcuprer une valeur/BLOB (SUBTYPE 1) et de retourner chaque lment
    
V40 :
    Cration
*/


DECLARE VARIABLE VALUE_BLOB BLOB CHARACTER SET UTF8; 

DECLARE VARIABLE LEN_VALUE_BLOB INTEGER;
DECLARE VARIABLE CURRENT_VALUE VARCHAR(40);
DECLARE VARIABLE LAST_POS INTEGER;
DECLARE VARIABLE POS INTEGER;

BEGIN

    -- Sparateur DOMAIN (; par dfaut) si non pass
	FIELD_SEP=TRIM(:FIELD_SEP);
	IF (:FIELD_SEP = '' ) THEN SELECT TRIM(COALESCE(CAST(DOMPARAM_VALUE AS VARCHAR(5)),';')) FROM GET_DOMPARAM('DOMAIN','MDF_FIELD_SEP')  INTO FIELD_SEP;

    VALUE_BLOB='';

    -- Rcupration de la valeur par rapport  la requte passe
    -- On laisse FB trappe les EXCEPTION...
    EXECUTE STATEMENT SQL_GETBLOB INTO :VALUE_BLOB;
    
    -- Rien dans le blob
	IF (VALUE_BLOB='') THEN EXIT;
    	
    LEN_VALUE_BLOB=CHARACTER_LENGTH(VALUE_BLOB);

	-- On ajoute un dernier SEP en fin de VALUE_BLOB pour faciliter les traitements de la boucle plus loin (recherche de sep)
	VALUE_BLOB=IIF(RIGHT(VALUE_BLOB,CHARACTER_LENGTH(FIELD_SEP))=FIELD_SEP,VALUE_BLOB,VALUE_BLOB || FIELD_SEP);
	
    LAST_POS=1;
    POS=1;
    
/*
-- DEBUG    
    RESULTS='VALUE_BLOB : ' || VALUE_BLOB;
    SUSPEND;
-- DEBUG    
    RESULTS='Taille VALUE_BLOB : ' || LEN_VALUE_BLOB;
    SUSPEND;
*/
    
    WHILE (LAST_POS<LEN_VALUE_BLOB) DO
    BEGIN

/*
-- DEBUG    
        RESULTS='LAST_POS : ' || LAST_POS;
        SUSPEND;
*/
        POS=POSITION(FIELD_SEP, VALUE_BLOB, LAST_POS+1);

/*        
-- DEBUG    
        RESULTS='POS : ' || POS;
        SUSPEND;
*/
        
        RESULTS=SUBSTRING(VALUE_BLOB FROM LAST_POS FOR POS-LAST_POS); --(CHARACTER_LENGTH(VALUE_BLOB)-(CHARACTER_LENGTH(VALUE_BLOB)-POS)+LAST_POS)-1
        
        SUSPEND;
        
        LAST_POS=POS+1;
    END

END  ^

ALTER PROCEDURE UNDEL_CONTACT (I_TCONTACT_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Annulation de la suppression logique d'un contact dans la table correspondante
    
    Paramtres : 
    - I_CONTACT_ID : Code contact

    Particularits :
    Annualtion de la suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
        
    Retourne :
    - NEW_STATE : Nouvel tat du proritaire obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppresion" (mise  jour de colonne STATE) impossible

V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/

BEGIN

    /* Contact existant */
    IF (NOT EXISTS (SELECT ID FROM TCONTACT WHERE ID=:I_TCONTACT_ID)) THEN EXCEPTION EX_NOCONTACT;
    
    /* MAJ de la colonne STATE, on ajoute la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('-' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TCONTACT.ID=' || :I_TCONTACT_ID,'TCONTACT','STATE') INTO :NEW_STATE;
    SUSPEND;
    
END ^

ALTER PROCEDURE UNDEL_FBSERVER (I_TFBSERVER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Annualtion suppression logique d'un Serveur Firebirf dans la table correspondante
    
    Paramtres : 
    - I_TFBSERVER_ID : Code serveur Firebird

    Particularits :
    Annulation suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
        
    Retourne :
    - NEW_STATE : Nouvel tat du proritaire obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppresion" (mise  jour de colonne STATE) impossible
    
V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/

BEGIN

    /* Serveur existant */
    IF (NOT EXISTS (SELECT ID FROM TFBSERVER WHERE ID=:I_TFBSERVER_ID)) THEN EXCEPTION EX_NOFBSER;

    /* MAJ de la colonne STATE, on retire la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('-' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TFBSERVER.ID=' || :I_TFBSERVER_ID,'TFBSERVER','STATE') INTO :NEW_STATE;
    SUSPEND;
    
END ^

ALTER PROCEDURE UNDEL_GEDUSER (I_TGEDUSER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Annulation suppression logique d'un Utilisateur GED
    
    Paramtres : 
    - I_TGEDUSER_ID : Code Utilisateur GED

    Particularits :
    Annualtion suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
        
    Retourne :
    - NEW_STATE : Nouvel tat de l'utilisateur obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppresion" (mise  jour de colonne STATE) impossible
    
V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/

BEGIN

    /* Utilisateur GED existante */
    IF (NOT EXISTS (SELECT ID FROM TGEDUSER WHERE ID=:I_TGEDUSER_ID)) THEN EXCEPTION EX_NOGEDUSER;    
    
    /* MAJ de la colonne STATE, on ajoute la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('-' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TGEDUSER.ID=' || :I_TGEDUSER_ID,'TGEDUSER','STATE') INTO :NEW_STATE;

    SUSPEND;
    
	-- LOGIN dj existant (recr aprs suppression logique initiale)
    WHEN GDSCODE unique_key_violation DO EXCEPTION EX_GED_LOGIN_EXISTS;
    
END ^

ALTER PROCEDURE UNDEL_LIBRARY (I_TLIBRARY_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Annulation d'une Suppression logique d'une bibliothque dans la table correspondante
    
    Paramtres : 
    - I_TLIBRARY_ID : Code bibliothque

    Particularits :
    Annule une suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
    On ne teste aucun STATE (ni parent, ni enfant), puisqu'on est en train de le mettre  jour...
        
    Retourne :
    - NEW_STATE : Nouvel tat de la bibliothque obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppression" (mise  jour de colonne STATE) impossible
    
V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/

BEGIN

    /* Library existante */
    IF (NOT EXISTS (SELECT ID FROM TLIBRARY WHERE ID=:I_TLIBRARY_ID)) THEN EXCEPTION EX_NOLIB;    
    
    /* MAJ de la colonne STATE, on retire la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('-' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TLIBRARY.ID=' || :I_TLIBRARY_ID,'TLIBRARY','STATE') INTO :NEW_STATE;

    SUSPEND;
    
	-- Title dj existant (recr aprs suppression logique initiale)
    WHEN GDSCODE unique_key_violation DO EXCEPTION EX_LIBTITLE_EXISTS;

END ^

ALTER PROCEDURE UNDEL_OWNER (I_TOWNER_ID INTEGER NOT NULL)
RETURNS (NEW_STATE STATE)
AS 
/*
    Annulation suppression logique d'un propritaire dans la table correspondante
    
    Paramtres : 
    - I_TOWNER_ID : Code propritaire

    Particularits :
    Annualtion suppression logique (ie. on garde l'enregistrement physique prsent dans la table) qui correspond  la mise  jour
    de la colonne STATE de l'enregistrement cible avec la valeur "1" (valeur d'tat rfrence comme tant la suppression)
        
    Retourne :
    - NEW_STATE : Nouvel tat du proritaire obtenu aprs suppression logique
        
    Attention
    - cette procdure lve des erreurs en cas de "suppresion" (mise  jour de colonne STATE) impossible
    
V17 :
    - Nouvelle Gestion SECTION TDOMPARAM
*/

BEGIN

    /* Owner existant */
    IF (NOT EXISTS (SELECT ID FROM TOWNER WHERE ID=:I_TOWNER_ID)) THEN EXCEPTION EX_NOOWNER;
    
    /* MAJ de la colonne STATE, on retire la valeur DOM_RECORD_DELETED (1 par dfaut) */
    SELECT NEW_STATE FROM SET_STATE('-' || COALESCE(CAST((SELECT DOMPARAM_VALUE FROM GET_DOMPARAM('DOMAIN','RECORD_DELETED')) AS INTEGER),1),'TOWNER.ID=' || :I_TOWNER_ID,'TOWNER','STATE') INTO :NEW_STATE;

    SUSPEND;

	-- LOGIN dj existant (recr aprs suppression logique initiale)
    WHEN GDSCODE unique_key_violation DO EXCEPTION EX_DOM_LOGIN_EXISTS;
    
END ^
SET TERM ; ^
COMMIT WORK ;
SET AUTODDL ON;
SET TERM ^ ;

/* Triggers only will work for SQL triggers */
CREATE TRIGGER AINC_TCONTACT FOR TCONTACT 
ACTIVE BEFORE INSERT POSITION 100 
AS 
/*
	MAJ V39 : plus de MAJ DATE_MODIF en UPDATE (donc trigger activ seulement sur INSERT)
*/
BEGIN 
    /* MAJ ID*/
    IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_CONTACT, 1); 
    /* MAJ DATE_CREATE */
    IF (NEW.CREATE_DATE IS NULL) THEN NEW.CREATE_DATE=CURRENT_TIMESTAMP;
    /* MAJ DATE_MODIF (idem DATE_CREATE dans contexte insert) */
    IF (NEW.MODIF_DATE IS NULL) THEN NEW.MODIF_DATE=CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER AINC_TCONTTYPE FOR TCONTTYPE 
ACTIVE BEFORE INSERT POSITION 100 
AS 
BEGIN 
  IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_CONTTYPE, 1); 
END ^

CREATE TRIGGER AINC_TFBSERVER FOR TFBSERVER 
ACTIVE BEFORE INSERT POSITION 100 
AS 
BEGIN 
  IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_FBSERVER, 1); 
END ^

CREATE TRIGGER AINC_TGEDGROUP FOR TGEDGROUP 
ACTIVE BEFORE INSERT POSITION 100 
AS 
/*
	MAJ V39 : plus de MAJ DATE_MODIF en UPDATE (donc trigger activ seulement sur INSERT)
*/
BEGIN 

    /* MAJ ID*/
    IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_GEDGROUP, 1); 
    /* MAJ DATE_CREATE */
    IF (NEW.CREATE_DATE IS NULL) THEN NEW.CREATE_DATE=CURRENT_TIMESTAMP;
    /* MAJ DATE_MODIF (idem DATE_CREATE dans contexte insert) */
    IF (NEW.MODIF_DATE IS NULL) THEN NEW.MODIF_DATE=CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER AINC_TGEDPARAM FOR TGEDPARAM 
ACTIVE BEFORE INSERT POSITION 100 
AS 
BEGIN 
  IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_GEDPARAM, 1); 
END ^

CREATE TRIGGER TGEDPARAM_STAMP FOR TGEDPARAM 
ACTIVE BEFORE INSERT OR UPDATE POSITION 100 
AS
/*
	MAJ DATE_MODIF si non passe
	
V40 :
    -Cration
*/
BEGIN
	IF (NEW.MODIF_DATE IS NULL OR NEW.MODIF_DATE=OLD.MODIF_DATE) THEN NEW.MODIF_DATE = CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER TGEDPARAMOWNER_STAMP FOR TGEDPARAMOWNER 
ACTIVE BEFORE INSERT OR UPDATE POSITION 100 
AS
/*
	Cration en V21
	MAJ DATE_MODIF si non passe
*/
BEGIN
	IF (NEW.MODIF_DATE IS NULL OR NEW.MODIF_DATE=OLD.MODIF_DATE) THEN NEW.MODIF_DATE = CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER TGEDPARAMPROF_STAMP FOR TGEDPARAMPROF 
ACTIVE BEFORE INSERT OR UPDATE POSITION 100 
AS
/*
	Cration en V11
	MAJ DATE_MODIF si non passe
*/
BEGIN
	IF (NEW.MODIF_DATE IS NULL OR NEW.MODIF_DATE=OLD.MODIF_DATE) THEN NEW.MODIF_DATE = CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER TGEDPARAMUSER_STAMP FOR TGEDPARAMUSER 
ACTIVE BEFORE INSERT OR UPDATE POSITION 100 
AS
/*
	Cration en V11
	MAJ DATE_MODIF si non passe
*/
BEGIN
	IF (NEW.MODIF_DATE IS NULL OR NEW.MODIF_DATE=OLD.MODIF_DATE) THEN NEW.MODIF_DATE = CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER AINC_TGEDUSER FOR TGEDUSER 
ACTIVE BEFORE INSERT POSITION 100 
AS 
/*
	MAJ V39 : plus de MAJ DATE_MODIF en UPDATE (donc trigger activ seulement sur INSERT)
*/
BEGIN 
    /* MAJ ID*/
    IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_GEDUSER, 1); 
    /* MAJ DATE_CREATE */
    IF (NEW.CREATE_DATE IS NULL) THEN NEW.CREATE_DATE=CURRENT_TIMESTAMP;
    /* MAJ DATE_MODIF (idem DATE_CREATE dans contexte insert) */
    IF (NEW.MODIF_DATE IS NULL) THEN NEW.MODIF_DATE=CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER AINC_TLIBRARY FOR TLIBRARY 
ACTIVE BEFORE INSERT POSITION 100 
AS 
/*
	MAJ V39 : plus de MAJ DATE_MODIF en UPDATE (donc trigger activ seulement sur INSERT)
*/
BEGIN 
    /* MAJ ID */
    IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_LIBRARY, 1); 
    /* MAJ CREATE_DATE */
    IF (NEW.CREATE_DATE IS NULL) THEN NEW.CREATE_DATE=CURRENT_TIMESTAMP; 
    
    /* Version 6 : Si un title est Null, on initialise avec une chaine */
    IF (NEW.TITLE IS NULL) THEN NEW.TITLE='Bibliothque N ' || NEW.ID;
    
    IF (NEW.MODIF_DATE IS NULL) THEN NEW.MODIF_DATE=CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER UPDSIZE_TLIBRARY FOR TLIBRARY 
ACTIVE AFTER INSERT OR UPDATE POSITION 100 
AS 
/*
    Mise  jour des tailles occupes dans les tables TOWNER et TFBSERVER...

V31 :
	- Cration

V36 :
	- Prise en compte SIZE_MB_ORG pour le calcul de TOWNER.SIZE_MB_CHARGEABLE
*/
BEGIN 
    -- MAJ seulement si taille de bib modifie
    IF ((COALESCE(NEW.SIZE_MB,0)!=COALESCE(OLD.SIZE_MB,0)) OR (COALESCE(NEW.SIZE_MB_ORG,0)!=COALESCE(OLD.SIZE_MB_ORG,0))) THEN
    BEGIN
        -- OWNER : seulement les lib en tat Ok (not deleted)
        UPDATE TOWNER o
            SET o.SIZE_MB = (
                SELECT SUM(l.SIZE_MB)
                    FROM TLIBRARY l
                    WHERE o.ID=l.TOWNER_ID
                        AND BIN_AND(l.STATE, COALESCE((SELECT CAST("VALUE" AS INTEGER) FROM TDOMPARAM WHERE SECTION='DOMAIN' AND "NAME"='RECORD_DELETED'),1))=0
                );
        UPDATE TOWNER o
            SET o.SIZE_MB_CHARGEABLE = (
            -- Prise en compte, si access_mode=2 (Full saas) => Synchro impossible
                SELECT SUM(
                    IIF(l.ACCESS_MODE!=2, -- Synchro possible pour ces modes, on prend en compte les tailles SIZE_MB_ORG en priorit (sinon la taille SIZE_MB)
                        IIF (SIZE_MB_ORG<>0,l.SIZE_MB_ORG,l.SIZE_MB),
                        l.SIZE_MB -- Sinon, on prend la taille locale inconditionnelement
                    )
                )
                FROM TLIBRARY l
                WHERE o.ID=l.TOWNER_ID AND l.CHARGEABLE=1
                    AND BIN_AND(l.STATE, COALESCE((SELECT CAST("VALUE" AS INTEGER) FROM TDOMPARAM WHERE SECTION='DOMAIN' AND "NAME"='RECORD_DELETED'),1))=0
                );

        -- FBSERVEUR : Toutes les bases hberges (occupation "relle" disque)
        UPDATE TFBSERVER f
            SET f.SIZE_MB = (SELECT SUM(l.SIZE_MB)
                FROM TLIBRARY l
                WHERE f.ID=l.TFBSERVER_ID);
	END
END ^

CREATE TRIGGER AINC_TLOGSYNC FOR TLOGSYNC 
ACTIVE BEFORE INSERT POSITION 100 
AS 
BEGIN 
  IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_LOGSYNC, 1); 
  SELECT TLIBRARY.TOWNER_ID FROM TLIBRARY WHERE TLIBRARY.ID=NEW.TLIBRARY_ID INTO NEW.TOWNER_ID;
END ^

CREATE TRIGGER ULIB_TLOGSYNC FOR TLOGSYNC 
ACTIVE AFTER INSERT POSITION 100 
AS 
/*
    Mise  jour de TLOGYSNC_ID dans TLIBRARY
*/
BEGIN 
  UPDATE TLIBRARY SET TLOGSYNC_ID=NEW.ID WHERE TLIBRARY.ID=NEW.TLIBRARY_ID; 
END ^

CREATE TRIGGER AINC_TOWNER FOR TOWNER 
ACTIVE BEFORE INSERT POSITION 100 
AS 
/*
	MAJ V39 : plus de MAJ DATE_MODIF en UPDATE (donc trigger activ seulement sur INSERT)
*/
BEGIN 
  /* Mise  jour des donnes en insertion seulement */
    /* MAJ ID*/
    IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_OWNER, 1); 
    /* MAJ DATE_CREATE */
    IF (NEW.CREATE_DATE IS NULL) THEN NEW.CREATE_DATE=CURRENT_TIMESTAMP;
    /* MAJ DATE_MODIF (idem DATE_CREATE dans contexte insert) */
    IF (NEW.MODIF_DATE IS NULL) THEN NEW.MODIF_DATE=CURRENT_TIMESTAMP;
END ^

CREATE TRIGGER AINC_TPROFILE FOR TPROFILE 
ACTIVE BEFORE INSERT POSITION 100 
AS 
/*
	MAJ V39 : plus de MAJ DATE_MODIF en UPDATE (donc trigger activ seulement sur INSERT)
*/
BEGIN 
    /* MAJ ID*/
    IF (NEW.ID IS NULL) THEN NEW.ID=GEN_ID(SEQ_PROFILE, 1); 
    /* MAJ DATE_CREATE */
    IF (NEW.CREATE_DATE IS NULL) THEN NEW.CREATE_DATE=CURRENT_TIMESTAMP;
    /* MAJ DATE_MODIF (idem DATE_CREATE dans contexte insert) */
    IF (NEW.MODIF_DATE IS NULL) THEN NEW.MODIF_DATE=CURRENT_TIMESTAMP;
END ^

COMMIT WORK ^
SET TERM ; ^
CREATE VIEW ADMBD_EXCEPTIONS ("Nom", "Description", "Code FB", "Code NAS", "Message NAS", "Message") AS

  
    
SELECT
    TRIM(RDB$EXCEPTION_NAME) "Nom",
    TRIM(RDB$DESCRIPTION) "Description",
    TRIM(RDB$EXCEPTION_NUMBER) "Code FB",
    LEFT(RDB$MESSAGE,5) "Code NAS",
    TRIM(SUBSTRING(RDB$MESSAGE FROM 7)) "Message NAS",
    TRIM(RDB$MESSAGE) "Message"
FROM RDB$EXCEPTIONS
ORDER BY LEFT(RDB$MESSAGE,5);
CREATE VIEW ADMBD_PS ("Procdure", "Description", "Paramtre", "Type Paramtre", "Type Donne", "Taille") AS


SELECT
    TRIM(p.RDB$PROCEDURE_NAME) "Procdure",
	TRIM(p.RDB$DESCRIPTION) "Description",
    TRIM(a.RDB$PARAMETER_NAME) "Paramtre",
    DECODE(a.RDB$PARAMETER_TYPE,0,'Entre',1,'Sortie') "Type Paramtre",
    DECODE(fs.RDB$FIELD_TYPE,7,'smallint', 8,'integer', 12,'date', 13,'time', 14,'char', 16,'bigint', 27,'double precision', 35,'timestamp', 37,'varchar', 261,'blob') "Type Donne",
    fs.RDB$CHARACTER_LENGTH "Taille"

FROM RDB$PROCEDURES p
    INNER JOIN RDB$PROCEDURE_PARAMETERS a ON p.RDB$PROCEDURE_NAME = a.RDB$PROCEDURE_NAME
        INNER JOIN RDB$FIELDS fs ON a.RDB$FIELD_SOURCE = fs.RDB$FIELD_NAME
        
ORDER BY p.RDB$PROCEDURE_NAME, a.RDB$PARAMETER_TYPE,a.RDB$PARAMETER_NUMBER;
CREATE VIEW GET_LAST_SYNC (ID, LIBRARY, OWNER, TIME_START, TIME_END, SIZE_BEFORE, SIZE_AFTER, SIZE_TRANSFERED, STATE) AS

      
SELECT FIRST 100 log.ID,COALESCE(lib.TITLE, lib.COMMENT) AS LIBRARY, own.NAME AS OWNER,
    (SELECT DATE_STRING FROM GET_DATE_STRING(log.TIME_START)) AS TIME_START,
    (SELECT DATE_STRING FROM GET_DATE_STRING(log.TIME_END)) AS TIME_END,
    log.SIZE_BEFORE,log.SIZE_AFTER,log.SIZE_TRANSFERED, log.STATE
FROM
    TLOGSYNC log
        INNER JOIN TLIBRARY lib ON lib.ID=log.TLIBRARY_ID
        INNER JOIN TOWNER own ON lib.TOWNER_ID=own.ID
ORDER BY TIME_END DESC;
CREATE VIEW GET_LIB_CUSTOMERS ("Code Bib Cloud", "Code prop", "Propritaire", "Genesys", "Nom Bib", "Titre Bib", "Bib Facturable") AS

     
SELECT l.ID as "Code Bib Cloud", l.TOWNER_ID AS "Code prop", o.NAME AS "Propritaire", o.EXTERNAL_ID AS "Genesys", l.COMMENT AS "Nom Bib", l.TITLE AS "Titre Bib", l.CHARGEABLE AS "Bib Facturable"
FROM TLIBRARY l INNER JOIN TOWNER o ON l.TOWNER_ID=o.ID;
CREATE VIEW GET_SYNC_DAILY_STATS (BIB, BIB_NAME, FIN_OK, NO_OK, CLIENT, SERVEUR, DOSSIER, DEBUT, FIN, MO_AVANT, MO_APRES, KO_TRANSF) AS

      
SELECT
        lib.ID AS BIB, COALESCE(lib.TITLE, lib.COMMENT) AS BIB_NAME,
        IIF(log.STATE=1,'OK','KO') AS FIN_OK, IIF(log.STATE=1,'','*****') AS NO_OK,
        o.NAME AS CLIENT,s.NAME AS SERVEUR,
        lib.DBPATH AS DOSSIER,
        LPAD(EXTRACT(DAY FROM log.TIME_START),2,'0') || '/' || LPAD(EXTRACT(MONTH FROM log.TIME_START),2,'0') || '/' || LPAD(EXTRACT(YEAR FROM log.TIME_START),4,'0') || ' ' || LPAD(EXTRACT(HOUR FROM log.TIME_START),2,'0') || ':' || LPAD(EXTRACT(MINUTE FROM log.TIME_START),2,'0') AS DEBUT,
        LPAD(EXTRACT(DAY FROM log.TIME_END),2,'0') || '/' || LPAD(EXTRACT(MONTH FROM log.TIME_END),2,'0') || '/' || LPAD(EXTRACT(YEAR FROM log.TIME_END),4,'0') || ' ' || LPAD(EXTRACT(HOUR FROM log.TIME_END),2,'0') || ':' || LPAD(EXTRACT(MINUTE FROM log.TIME_END),2,'0') AS FIN,
        CAST(log.SIZE_BEFORE/POWER(1024,2) AS INTEGER) AS MO_AVANT,
        CAST(log.SIZE_AFTER/POWER(1024,2) AS INTEGER) AS MO_APRES,
        CAST (log.SIZE_TRANSFERED/POWER(1024,1) AS INTEGER) AS KO_TRANSF
FROM
    TLIBRARY AS lib INNER JOIN TFBSERVER AS s
        ON lib.TFBSERVER_ID=s.ID
    INNER JOIN TOWNER AS o
        ON o.ID=lib.TOWNER_ID
    INNER JOIN TLOGSYNC AS log ON
        lib.ID=log.TLIBRARY_ID
WHERE
    TIME_END BETWEEN DATEADD(-1 DAY TO CAST(current_date || ' 08:00' AS timestamp)) AND CAST(current_date || ' 08:00' AS timestamp)
ORDER BY FIN ASC;
CREATE VIEW ADMBD_DICO ("Nom Table", "Description Table", "Nom Colonne", "Description Colonne", "Position", "Null Interdit", "Default value", "Type Donne", "Taille", "Collation", "Character Set") AS

 
  
SELECT
    TRIM(r.RDB$RELATION_NAME) "Nom Table",
    TRIM(r.RDB$DESCRIPTION) "Description Table",
    TRIM(f.RDB$FIELD_NAME) "Nom Colonne", TRIM(f.RDB$DESCRIPTION) "Description Colonne", f.RDB$FIELD_POSITION "Position",
    COALESCE(f.RDB$NULL_FLAG,0) "Null Interdit",
    COALESCE(SUBSTRING(IIF(f.RDB$DEFAULT_SOURCE IS NULL, fs.RDB$DEFAULT_SOURCE,f.RDB$DEFAULT_SOURCE) FROM 9),'NULL') "Default value",
    DECODE(fs.RDB$FIELD_TYPE,7,'smallint', 8,'integer', 12,'date', 13,'time', 14,'char', 16,'bigint', 27,'double precision', 35,'timestamp', 37,'varchar', 261,'blob') "Type Donne",
    fs.RDB$CHARACTER_LENGTH "Taille",
    TRIM(co.RDB$COLLATION_NAME) "Collation",
    TRIM(cs.RDB$CHARACTER_SET_NAME) "Character Set"
FROM
    RDB$RELATIONS r
        INNER JOIN RDB$RELATION_FIELDS f ON r.RDB$RELATION_NAME = f.RDB$RELATION_NAME
            INNER JOIN RDB$FIELDS fs ON f.RDB$FIELD_SOURCE = fs.RDB$FIELD_NAME
                LEFT JOIN RDB$CHARACTER_SETS cs ON fs.RDB$CHARACTER_SET_ID=cs.RDB$CHARACTER_SET_ID
                    LEFT JOIN RDB$COLLATIONS co ON (f.RDB$COLLATION_ID=co.RDB$COLLATION_ID AND fs.RDB$CHARACTER_SET_ID=co.RDB$CHARACTER_SET_ID)
WHERE
    r.RDB$SYSTEM_FLAG!=1 AND r.RDB$RELATION_TYPE=0

ORDER BY
    r.RDB$RELATION_NAME,f.RDB$FIELD_POSITION;
CREATE VIEW GET_OWNERS_STATS (ID, SUBDOMAIN, LOGIN, CREATION, NBJOURPRESENT, NBLIB, NBSYNC, LIBSIZE, NBGRP, NBUSER, NBCNT, NBPROF, NBDICOGEDPARAM, NBGEDPARAM) AS


SELECT OWN.ID, OWN.SUBDOMAIN, OWN.LOGIN, EXTRACT(YEAR FROM OWN.CREATE_DATE) || '-' || LPAD(EXTRACT(MONTH FROM OWN.CREATE_DATE),2,'0') || '-' || LPAD(EXTRACT(DAY FROM OWN.CREATE_DATE),2,'0') AS CREATION, DATEDIFF(DAY,OWN.CREATE_DATE,CURRENT_DATE) AS NBJOURPRESENT,
    (SELECT COUNT(LIB.ID) FROM TLIBRARY LIB WHERE LIB.TOWNER_ID=OWN.ID AND BIN_AND(LIB.STATE,1)=0) AS NBLIB,
    (SELECT COUNT(SYNC.ID) FROM TLOGSYNC SYNC WHERE SYNC.TOWNER_ID=OWN.ID) AS NBSYNC,
    COALESCE((SELECT SUM(LIB2.SIZE_MB) FROM TLIBRARY LIB2 WHERE LIB2.TOWNER_ID=OWN.ID AND BIN_AND(LIB2.STATE,1)=0),0) AS LIBSIZE,
    (SELECT COUNT(GRP.ID) FROM TGEDGROUP GRP WHERE GRP.TOWNER_ID=OWN.ID) AS NBGRP,
    (SELECT COUNT(USR.ID) FROM TGEDUSER USR WHERE USR.TOWNER_ID=OWN.ID AND BIN_AND(USR.STATE,1)=0) AS NBUSER,
    (SELECT COUNT(CNT.ID) FROM TCONTACT CNT WHERE CNT.TOWNER_ID=OWN.ID AND BIN_AND(CNT.STATE,1)=0) AS NBCNT,
    (SELECT COUNT(PROF.ID) FROM TPROFILE PROF WHERE PROF.TOWNER_ID=OWN.ID) AS NBPROF,
    (SELECT COUNT(GEDP.ID) FROM TGEDPARAM GEDP WHERE GEDP.TOWNER_ID=OWN.ID) AS NBDICOGEDPARAM,
    (SELECT COUNT(GEDPO.TOWNER_ID) FROM TGEDPARAMOWNER GEDPO WHERE GEDPO.TOWNER_ID=OWN.ID) AS NBGEDPARAM
FROM TOWNER OWN
WHERE BIN_AND(OWN.STATE,1)=0 AND OWN.ID>0
ORDER BY OWN.CREATE_DATE, OWN.LOGIN;
COMMENT ON DOMAIN       BOOLEAN IS 'Valeurs SmallInt 0/1 (0 par dfaut) *NOT NULL* pour la gestion des colonnes  2 tats - 32767 est utilis pour ne pas tenir compte d''une colonne BOOLEAN dans un critre de Procdure stocke';
COMMENT ON DOMAIN       STATE IS 'Utilis dans la plupart des tables pour identifier des tats spcifiques d''enregistrement (0 ==> tat normal, >0 ==> tat anormal) ; doit tre trait comme "binaire" (0,1,2,4,8,...)';
COMMENT ON DOMAIN       SYNC_MAIL IS 'Envoi de mail de rapport de synchronisation : 0 => pas de mail (valeur par dfaut) ; 1 => mail si chec seulement ; 2 => mail dans tous les cas';
COMMENT ON DOMAIN       TCPPORT IS 'Valeurs Integer acceptable pour les ports TCP/UDP 0 (admis pour gestion des colonnes NULL dans les PS) jusqu'' 65536 * DEFAULT NULL';
COMMENT ON DOMAIN       TYPE_PARAM IS 'Domaine utilis par les colonnes "TYPE" des tables de paramtres';
COMMENT ON TABLE        TCONTACT IS 'Tables des contacts associs  un propritaire et/ou une Bibliothque';
COMMENT ON    COLUMN    TCONTACT.ID IS 'Identifiant du contact';
COMMENT ON    COLUMN    TCONTACT.TOWNER_ID IS 'Code propritaire associ';
COMMENT ON    COLUMN    TCONTACT.NAME IS 'Nom (Personne physique ou morale)';
COMMENT ON    COLUMN    TCONTACT."FIRSTNAME" IS 'Prnom';
COMMENT ON    COLUMN    TCONTACT.PREFIX IS 'Titre de courtoisie';
COMMENT ON    COLUMN    TCONTACT.EMAIL IS 'Adresse de messagerie du contact';
COMMENT ON    COLUMN    TCONTACT.TEL IS 'N de tlphone du contact';
COMMENT ON    COLUMN    TCONTACT.ADDRESS IS 'Adresse du contact';
COMMENT ON    COLUMN    TCONTACT.POSTCODE IS 'Code postal  du contact';
COMMENT ON    COLUMN    TCONTACT.REGION IS 'Rgion du contact';
COMMENT ON    COLUMN    TCONTACT.CITY IS 'Ville du contact';
COMMENT ON    COLUMN    TCONTACT.COUNTRY IS 'Pays du contact';
COMMENT ON    COLUMN    TCONTACT.STATE IS 'STATE du contact (cf. doc STATE)';
COMMENT ON    COLUMN    TCONTACT.CELLTEL IS 'N de tlphone mobile (ou assimil) du contact';
COMMENT ON    COLUMN    TCONTACT.IDENTIFIER IS 'Indentifiant interne  l''organisation du contact (N salari, N SS, N Client interne, etc...)';
COMMENT ON    COLUMN    TCONTACT.SERVICE IS 'Service interne dans l''organisation du contact';
COMMENT ON    COLUMN    TCONTACT.ORGANIZATION IS 'Organisation (Raison sociale, Entreprise, Socit, Association, etc.) du contact';
COMMENT ON    COLUMN    TCONTACT.CREATE_DATE IS 'Date de cration du contact';
COMMENT ON    COLUMN    TCONTACT.MODIF_DATE IS 'Date de dernire modification du contact';
COMMENT ON TABLE        TCONTLIB IS 'Association des contacts (personnes physiques/morales) avec les bibliothques';
COMMENT ON    COLUMN    TCONTLIB.TLIBRARY_ID IS 'Code bibliothque associe';
COMMENT ON    COLUMN    TCONTLIB.TCONTACT_ID IS 'Code contact associe';
COMMENT ON    COLUMN    TCONTLIB.TCONTTYPE_ID IS 'Type de contact (qualification, par exemple "juridique"/"technique"/"administratif")';
COMMENT ON    COLUMN    TCONTLIB.SYNC_SENDMAIL IS 'Envoi d''un email  l''issue d''une synchronisation (0 => jamais, 1 => sur erreur, 2 => toujours)';
COMMENT ON TABLE        TCONTOWNER IS 'Association des types de contacts (personnes physiques/morales) avec les contacts';
COMMENT ON    COLUMN    TCONTOWNER.TCONTACT_ID IS 'Code contact associe';
COMMENT ON    COLUMN    TCONTOWNER.TCONTTYPE_ID IS 'Type de contact (qualification, par exemple "juridique"/"technique"/"administratif")';
COMMENT ON TABLE        TCONTTYPE IS 'Type de contact';
COMMENT ON    COLUMN    TCONTTYPE.ID IS 'Code interne de type de contact';
COMMENT ON    COLUMN    TCONTTYPE.NAME IS 'Nom de type de contact';
COMMENT ON TABLE        TDOMPARAM IS 'Table des paramtes Domaine (globaux pour l''ensemble du domaine)';
COMMENT ON    COLUMN    TDOMPARAM.NAME IS 'Nom du paramtre Domaine';
COMMENT ON    COLUMN    TDOMPARAM.TYPE IS 'Type de donnes associe au Paramtre Domaine (Informatif)';
COMMENT ON    COLUMN    TDOMPARAM."VALUE" IS 'Valeur du paramtre Domaine (toujours retourne sous le type char, Cast ncessaire  l''aide du type de donnes';
COMMENT ON    COLUMN    TDOMPARAM.VALUEBLB IS 'Valeur BLOB (si applicable) du Paramtre domaine';
COMMENT ON    COLUMN    TDOMPARAM.COMMENT IS 'Commentaires (explications) sur le paramtre Domaine';
COMMENT ON    COLUMN    TDOMPARAM.PROTECTION IS 'Paramtre Domaine protg (0), valeurs modifiables (1) ou cr par l''administrateur local (2)';
COMMENT ON TABLE        TFBSERVER IS 'Table des serveurs Firebird';
COMMENT ON    COLUMN    TFBSERVER.ID IS 'Identifiant Serveur Firebird';
COMMENT ON    COLUMN    TFBSERVER.NAME IS 'Nom courant du Serveur Firebird';
COMMENT ON    COLUMN    TFBSERVER.TCPPORT IS 'Port  l''coute du Serveur Firebird';
COMMENT ON    COLUMN    TFBSERVER.HOST IS 'IP ou Nom FQDN du serveur Firebird';
COMMENT ON    COLUMN    TFBSERVER.TUNNELPORT IS 'Port  utiliser sur le serveur de tunnel (ou accs client lourd)';
COMMENT ON    COLUMN    TFBSERVER.TUNNELHOST IS 'IP ou Nom FQDN de l''hte serveur de tunnel (ou accs client lourd)';
COMMENT ON    COLUMN    TFBSERVER.LIBROOTPATH IS 'Chemin d''accs des librairies situes sur ce serveur (initialisation des librairies)';
COMMENT ON    COLUMN    TFBSERVER.FBADMLOGIN IS 'Utilisateur *ADMINISTRATEUR* du serveur Firebird';
COMMENT ON    COLUMN    TFBSERVER.FBADMPASSWD IS 'Passord (cryptage Novaxel) de *ADMINISTRATEUR* du serveur Firebird';
COMMENT ON    COLUMN    TFBSERVER.STATE IS 'Serveur Firebird Actif/Inactif';
COMMENT ON    COLUMN    TFBSERVER.SIZE_MB IS 'Taille cumule de toutes les bibliothques sur disque (en Mo) pour ce serveur';
COMMENT ON TABLE        TGEDGROUP IS 'Table des Groupes d''utilisateurs GED';
COMMENT ON    COLUMN    TGEDGROUP.ID IS 'Code identifiant du Groupe d''utilisateur GED';
COMMENT ON    COLUMN    TGEDGROUP.TOWNER_ID IS 'Code identifiant du Propritaire';
COMMENT ON    COLUMN    TGEDGROUP.NAME IS 'Nom du Groupe d''utilisateur GED (unique pour chaque Propritaire';
COMMENT ON    COLUMN    TGEDGROUP.TYPE IS 'Type de groupe (1 = groupe primaire)';
COMMENT ON    COLUMN    TGEDGROUP.COMMENT IS 'Commentaire';
COMMENT ON    COLUMN    TGEDGROUP.CREATE_DATE IS 'Date de cration du groupe';
COMMENT ON    COLUMN    TGEDGROUP.MODIF_DATE IS 'Date de modification (dernire MAJ) du groupe';
COMMENT ON    COLUMN    TGEDGROUP.TPROFILE_ID IS 'Profil  appliquer au groupe d''utilisateur';
COMMENT ON TABLE        TGEDGROUPLIB IS 'Table association des groupes d''utilisateur GED et Bibliothque';
COMMENT ON    COLUMN    TGEDGROUPLIB.TGEDGROUP_ID IS 'Code identifiant du groupe';
COMMENT ON    COLUMN    TGEDGROUPLIB.TLIBRARY_ID IS 'Code identifiant de la Bibliothque';
COMMENT ON    COLUMN    TGEDGROUPLIB.TPROFILE_ID IS 'Code identifiant du Profil  appliquer pour ce groupe d''utilisateur GED et cette Bibliothque';
COMMENT ON TABLE        TGEDGROUPUSER IS 'Association des Groupes et des utilisateurs GED';
COMMENT ON    COLUMN    TGEDGROUPUSER.TGEDGROUP_ID IS 'Code identifiant du Groupe d''utilisateur GED';
COMMENT ON    COLUMN    TGEDGROUPUSER.TGEDUSER_ID IS 'Code identifiant de l''utilisateur GED';
COMMENT ON TABLE        TGEDPARAM IS 'Table de rfrence des paramtres GED (utilisables dans les Profils)';
COMMENT ON    COLUMN    TGEDPARAM.ID IS 'Identifiant du Paramtre';
COMMENT ON    COLUMN    TGEDPARAM.SECTION IS 'Section (classement) du Paramtre GED';
COMMENT ON    COLUMN    TGEDPARAM.NAME IS 'Nom du Paramtre GED (unique dans une Section)';
COMMENT ON    COLUMN    TGEDPARAM.TYPE IS 'Type de donnes associe au Paramtre GED (Informatif)';
COMMENT ON    COLUMN    TGEDPARAM.CLASS IS 'Classe (utilisation[s] possible[s]) de paramtre';
COMMENT ON    COLUMN    TGEDPARAM.DEFAULTVALUE IS 'Valeur par dfaut pouvant tre applique lors de l''utilisation de ce paramtre';
COMMENT ON    COLUMN    TGEDPARAM.DEFAULTVALUEBLB IS 'Valeur BLOB par dfaut pouvant tre applique lors de l''utilisation de ce paramtre';
COMMENT ON    COLUMN    TGEDPARAM.COMMENT IS 'Commentaires (explications) sur le Paramtre GED';
COMMENT ON    COLUMN    TGEDPARAM.PROTECTION IS 'Paramtre GED protg (0), valeurs modifiables (1) ou cr par l''administrateur local (2)';
COMMENT ON    COLUMN    TGEDPARAM.MODIF_DATE IS 'Date (automatique) de dernire mise  jour d''un Paramtre';
COMMENT ON    COLUMN    TGEDPARAM.TOWNER_ID IS 'Code identifiant du Propitaire (si saisi, ce paramtre ne pourra pas tre visualis par un autre propritaire)';
COMMENT ON    COLUMN    TGEDPARAM.TLIBRARY_ID IS 'Code identifiant de la Bibliothque (si saisi, ce paramtre ne pourra pas tre visualis par un autre propritaire ou une autre Bibliothque';
COMMENT ON TABLE        TGEDPARAMOWNER IS 'Table des paramtres  GED associs  chaque Profil (VALUE *OU* VALUEBLB doivent tre NOT NULL)';
COMMENT ON    COLUMN    TGEDPARAMOWNER.TGEDPARAM_ID IS 'Code identifiant Paramtre GED';
COMMENT ON    COLUMN    TGEDPARAMOWNER.TOWNER_ID IS 'Code identifiant du Propritaire';
COMMENT ON    COLUMN    TGEDPARAMOWNER."VALUE" IS 'Valeur (si applicable) du Paramtre GED dans le Profil';
COMMENT ON    COLUMN    TGEDPARAMOWNER.VALUEBLB IS 'Valeur BLOB (si applicable) du Paramtre GED dans le Profile';
COMMENT ON    COLUMN    TGEDPARAMOWNER.MODIF_DATE IS 'Date (automatique) de dernire mise  jour d''un Paramtre Profil';
COMMENT ON TABLE        TGEDPARAMPROF IS 'Table des paramtres  GED associs  chaque Profil (VALUE *OU* VALUEBLB doivent tre NOT NULL)';
COMMENT ON    COLUMN    TGEDPARAMPROF.TGEDPARAM_ID IS 'Code identifiant Paramtre GED';
COMMENT ON    COLUMN    TGEDPARAMPROF.TPROFILE_ID IS 'Code identifiant du Profil';
COMMENT ON    COLUMN    TGEDPARAMPROF."VALUE" IS 'Valeur (si applicable) du Paramtre GED dans le Profil';
COMMENT ON    COLUMN    TGEDPARAMPROF.VALUEBLB IS 'Valeur BLOB (si applicable) du Paramtre GED dans le Profile';
COMMENT ON    COLUMN    TGEDPARAMPROF.MODIF_DATE IS 'Date (automatique) de dernire mise  jour d''un Paramtre Profil';
COMMENT ON TABLE        TGEDPARAMUSER IS 'Table des paramtres GED hors profils, donc directement associs  un Utilisateur GED (VALUE *OU* VALUEBLB doivent tre NOT NULL)';
COMMENT ON    COLUMN    TGEDPARAMUSER.TGEDPARAM_ID IS 'Code identifiant Paramtre GED';
COMMENT ON    COLUMN    TGEDPARAMUSER.TGEDUSER_ID IS 'Code identifiant de l''Utilisateur GED';
COMMENT ON    COLUMN    TGEDPARAMUSER.TLIBRARY_ID IS 'Code identifiant de la Bibliothque';
COMMENT ON    COLUMN    TGEDPARAMUSER."VALUE" IS 'Valeur (si applicable) du Paramtre GED dans le Profil';
COMMENT ON    COLUMN    TGEDPARAMUSER.VALUEBLB IS 'Valeur BLOB (si applicable) du Paramtre GED dans le Profile';
COMMENT ON    COLUMN    TGEDPARAMUSER.MODIF_DATE IS 'Date (automatique) de dernire mise  jour d''un Paramtre Utilisateur';
COMMENT ON TABLE        TGEDUSER IS 'Table des utilisateurs GED';
COMMENT ON    COLUMN    TGEDUSER.ID IS 'Code identifiant de l''utilisateur GED';
COMMENT ON    COLUMN    TGEDUSER.TOWNER_ID IS 'Code identifiant du Propritaire';
COMMENT ON    COLUMN    TGEDUSER.LOGIN IS 'Login technique de l''utilisateur GED (restriction des cars. autoriss)';
COMMENT ON    COLUMN    TGEDUSER.PASSWD IS 'Mot de passe (sha256sum) de l''utilisateur GED (restriction des cars. autoriss)';
COMMENT ON    COLUMN    TGEDUSER.STATE IS 'STATE de l''utilisateur GED (cf. doc STATE)';
COMMENT ON    COLUMN    TGEDUSER.CREATE_DATE IS 'Date de cration de l''utilisateur GED';
COMMENT ON    COLUMN    TGEDUSER.MODIF_DATE IS 'Date de dernire modification de l''utilisateur GED';
COMMENT ON    COLUMN    TGEDUSER.SUBSCRIBE_START IS 'Date de dbut d''abonnement';
COMMENT ON    COLUMN    TGEDUSER.SUBSCRIBE_END IS 'Date de fin d''abonnement';
COMMENT ON    COLUMN    TGEDUSER.COMMENT IS 'Commentaires sur l''utilisateur GED';
COMMENT ON    COLUMN    TGEDUSER.CHARGEABLE IS 'Gestion d''abonnement utilisateur GED';
COMMENT ON    COLUMN    TGEDUSER.TPROFILE_ID IS 'Profil par dfaut  appliquer  l''utilisateur GED';
COMMENT ON    COLUMN    TGEDUSER.TCONTACT_ID IS 'Contact associ  l''utilisateur GED';
COMMENT ON    COLUMN    TGEDUSER.TGEDGROUP_ID IS 'Groupe de rfrence (primaire) de l''utilisateur';
COMMENT ON TABLE        TGEDUSERLIB IS 'Table association des utilisateurs GED et Bibliothque';
COMMENT ON    COLUMN    TGEDUSERLIB.TGEDUSER_ID IS 'Code identifiant de l''utilisateur GED';
COMMENT ON    COLUMN    TGEDUSERLIB.TLIBRARY_ID IS 'Code identifiant de la Bibliothque';
COMMENT ON    COLUMN    TGEDUSERLIB.TPROFILE_ID IS 'Code identifiant du Profil  appliquer pour cet utilisateur GED et cette Bibliothque';
COMMENT ON TABLE        TLIBRARY IS 'Table des bibliothques Novaxel hberges sur le domaine';
COMMENT ON    COLUMN    TLIBRARY.ID IS 'Identifiant de la Bibliothque';
COMMENT ON    COLUMN    TLIBRARY.TOWNER_ID IS 'Code Propritaire associ';
COMMENT ON    COLUMN    TLIBRARY.TFBSERVER_ID IS 'Serveur Firebird supportant la Bibliothque';
COMMENT ON    COLUMN    TLIBRARY.COMMENT IS 'Nom Bibliothque interne au domaine (pas forcment le titre)';
COMMENT ON    COLUMN    TLIBRARY.TITLE IS 'Titre de la bibliothque Novaxel (cf. NOVAXEL.FDB.TCONFIG.CLEE=''TITLE''';
COMMENT ON    COLUMN    TLIBRARY.GUID IS 'GUID de la bibliothque Novaxel (cf. NOVAXEL.FDB.TCONFIG.CLEE=''GUID''';
COMMENT ON    COLUMN    TLIBRARY.VERSION IS 'Version Novaxel de la bibliothque';
COMMENT ON    COLUMN    TLIBRARY.DBPATH IS 'Chemin d''accs  la Bibliothque';
COMMENT ON    COLUMN    TLIBRARY.STATE IS 'Bibliothque active/inactive';
COMMENT ON    COLUMN    TLIBRARY.CREATE_DATE IS 'Date/heure de cration de la Bibliothque ';
COMMENT ON    COLUMN    TLIBRARY.MODIF_DATE IS 'Date/heure de la dernire modification apporte  cette bibliothque';
COMMENT ON    COLUMN    TLIBRARY.SUBSCRIBE_START IS 'Date de dbut de souscription d''abonnement';
COMMENT ON    COLUMN    TLIBRARY.SUBSCRIBE_END IS 'Date de fin de souscription d''abonnement';
COMMENT ON    COLUMN    TLIBRARY.ACCESS_MODE IS 'Mode d''accs de la bibliothque : Si 0 (read only, valeur par dfaut) : aucune MAJ directe possible en item (document par panire possible, si autorise) - Si 1 (maj par panires) : MAJ possible en arborescence (complte) et document (par panire) - Si 2 (full Cloud) : Tout ajout/MAJ possible directement';
COMMENT ON    COLUMN    TLIBRARY.ACCESS_TYPE IS 'Type d''accs sur cette bibliothque (Client Lourd/WEB OU Synchro)';
COMMENT ON    COLUMN    TLIBRARY.SIZE_MB IS 'Taille de la bibliothque sur le disque (en Mo) - Si 0 (par dfaut) voir en fonction de LAST_SIZE_CHECK (si NULL = taille  0 mais jamais valu, sinon taille effective  0)';
COMMENT ON    COLUMN    TLIBRARY.LAST_SIZE_CHECK IS 'Date/heure de la dernire vrification de taille (procdure automatise)';
COMMENT ON    COLUMN    TLIBRARY.SIZE_MB_ORG IS 'Taille de la bibliothque sur le poste client de synchro (facturation)';
COMMENT ON    COLUMN    TLIBRARY.CHARGEABLE IS 'Bibliothque facturable';
COMMENT ON    COLUMN    TLIBRARY.TPROFILE_ID IS 'Profil par dfaut  appliquer  la Bibliothque';
COMMENT ON    COLUMN    TLIBRARY.TLOGSYNC_ID IS 'Identifiant de la dernire synchro pour cette bibliothque';
COMMENT ON    COLUMN    TLIBRARY.LISTORDER IS 'Poids pour ordre de tri de la liste des bibliothques en GUI';
COMMENT ON TABLE        TLOGSYNC IS 'Table de journalisation des synchronisations';
COMMENT ON    COLUMN    TLOGSYNC.TLIBRARY_ID IS 'Identifiant de la bilbiothque synchronise';
COMMENT ON    COLUMN    TLOGSYNC.TOWNER_ID IS 'Propritaire de la bilbiothque synchronise';
COMMENT ON    COLUMN    TLOGSYNC.TIME_START IS 'Dbut de synchronisation';
COMMENT ON    COLUMN    TLOGSYNC.TIME_END IS 'Fin de synchronisation';
COMMENT ON    COLUMN    TLOGSYNC.DURATION IS 'Dure de la synchronisaiton en secondes';
COMMENT ON    COLUMN    TLOGSYNC.SIZE_BEFORE IS 'Espace occup avant la synchronisation';
COMMENT ON    COLUMN    TLOGSYNC.SIZE_AFTER IS 'Espace occup aprs la synchronisation';
COMMENT ON    COLUMN    TLOGSYNC.STATE IS 'Etat de la synchro (0 => Ok ; 1 => problme)';
COMMENT ON    COLUMN    TLOGSYNC.ERR_COMMENT IS 'Message d''erreur de synchronisation';
COMMENT ON TABLE        TOWNER IS 'Table des profils d''accs au domaine';
COMMENT ON    COLUMN    TOWNER.ID IS 'Identifiant Compte';
COMMENT ON    COLUMN    TOWNER.NAME IS 'Nom courant du compte';
COMMENT ON    COLUMN    TOWNER.SUBDOMAIN IS 'Nom (unique) de sous-domaine affect  un propritaire pour les accs GED';
COMMENT ON    COLUMN    TOWNER.LOGIN IS 'Nom technique du compte (accs administration espace perso sur le domaine)';
COMMENT ON    COLUMN    TOWNER.PASSWD IS 'Mot de passe du compte (sha256sum)';
COMMENT ON    COLUMN    TOWNER.STATE IS 'Compte Actif/Inactif';
COMMENT ON    COLUMN    TOWNER.SIZE_MB IS 'Taille cumule des bibliothques actives sur disque (en Mo) pour ce propritaire';
COMMENT ON    COLUMN    TOWNER.SIZE_MB_CHARGEABLE IS 'Taille cumule des bibliothques facturables sur disque (en Mo) pour ce propritaire';
COMMENT ON    COLUMN    TOWNER.CREATE_DATE IS 'Date de cration du compte';
COMMENT ON    COLUMN    TOWNER.MODIF_DATE IS 'Date de dernire modification';
COMMENT ON    COLUMN    TOWNER.SUBSCRIBE_START IS 'Date de dbut d''abonnement';
COMMENT ON    COLUMN    TOWNER.SUBSCRIBE_END IS 'Date de fin d''abonnement';
COMMENT ON    COLUMN    TOWNER.EXTERNAL_ID IS 'Code client externe (Genesys par exemple)';
COMMENT ON    COLUMN    TOWNER.COMMENT IS 'Commentaire sur le propritaire';
COMMENT ON    COLUMN    TOWNER.TPROFILE_ID IS 'Profil par dfaut  appliquer au Propritaire';
COMMENT ON    COLUMN    TOWNER.TCONTACT_ID IS 'Contact principal associ au Propritaire';
COMMENT ON TABLE        TPROFILE IS 'Table des Profils (ensemble de paramtres)  appliquer lors de la connexion d''un utilisateur GED';
COMMENT ON    COLUMN    TPROFILE.ID IS 'Identifiant du Profil';
COMMENT ON    COLUMN    TPROFILE.TOWNER_ID IS 'Identifiant du Propritaire du Profil';
COMMENT ON    COLUMN    TPROFILE.NAME IS 'Nom du Profil';
COMMENT ON    COLUMN    TPROFILE.CREATE_DATE IS 'Date de cration du Profil';
COMMENT ON    COLUMN    TPROFILE.MODIF_DATE IS 'Date de dernire modification du Profil';
COMMENT ON    COLUMN    TPROFILE.COMMENT IS 'Commentaire sur le Profil';
COMMENT ON    COLUMN    TPROFILE.TLIBRARY_ID IS 'Identifiant de bibliothque : si le Profil est associ  une bibliothque particulire (notion de PROFILE LIBRARY) - Si NULL, le Profil est considr comme tant utilisable  tous les niveaux (notion de PROFILE GLOBAL)';
COMMENT ON    COLUMN    TPROFILE.TGEDUSER_ID IS 'Identifiant d''utilisateur GED : si le Profil est associ  un utiilsateur GED particulier (notion de PROFILE GEDUSER) - Si NULL, le Profil est considr comme tant utilisable  tous les niveaux (notion de PROFILE GLOBAL)';
COMMENT ON TABLE        TSTORAGE IS 'Table de paramtres "libres" utilisables par les clients sans contrle du serveur d''application';
COMMENT ON    COLUMN    TSTORAGE.TOWNER_ID IS 'Code identifiant du propritaire';
COMMENT ON    COLUMN    TSTORAGE.SECTION IS 'Section (classement) du Paramtre';
COMMENT ON    COLUMN    TSTORAGE.NAME IS 'Nom du Paramtre (unique dans une Section)';
COMMENT ON    COLUMN    TSTORAGE."VALUE" IS 'Valeur du Paramtre';
COMMENT ON    COLUMN    TSTORAGE.TGEDUSER_ID IS 'Code identifiant de la l''utilisateur GED';
COMMENT ON    COLUMN    TSTORAGE.TLIBRARY_ID IS 'Code identifiant de la Bibliothque';
COMMENT ON    COLUMN    TSTORAGE.MODIF_DATE IS 'Date (automatique) de dernire mise  jour du Paramtre';
COMMENT ON PROCEDURE    ADD_CONTACT_TYPE_TO_OWNER IS 'Ajout d''une association Type de contact/Bibliothque dans la table TCONTOWER';
COMMENT ON PROCEDURE    ADD_GEDGROUP_TO_LIBRARY IS 'Ajout d''une association Groupe d''Utilisateur GED/Bibliothqie dans la table TGEDGROUPLIB';
COMMENT ON PROCEDURE    ADD_GEDUSER_TO_GEDGROUP IS 'Ajout d''une association Utilisateur GED/Groupe d''utilisateur GED dans la table TGEDGROUPUSER';
COMMENT ON PROCEDURE    ADD_GEDUSER_TO_LIBRARY IS 'Ajout d''une association Utilisateur GED/Bibliothqie dans la table TGEDUSERLIB';
COMMENT ON PROCEDURE    ADD_LOGSYNC IS 'Ajout d''une ligne en journalisation de synchronisation (table TLOGSYNC)';
COMMENT ON PROCEDURE    DEL_CONTACT IS 'Suppression *logique* d''un Contact dans TCONTACT';
COMMENT ON PROCEDURE    DEL_CONTACT_TYPE_FOR_LIBRARY IS 'Suppression *physique* d''une association Contact + Type de contact/Bibliothque dans la table TCONTLIB';
COMMENT ON PROCEDURE    DEL_CONTACT_TYPE_FOR_OWNER IS 'Suppression *physique* d''une association Type de contact/Bibliothque dans la table TCONTOWER';
COMMENT ON PROCEDURE    DEL_CONTTYPE IS 'Suppression *physique* d''un Type de contact dans la table TCONTTYPE';
COMMENT ON PROCEDURE    DEL_DOMPARAM IS 'Suppression d''un paramtre domaine (table TDOMPARAM)';
COMMENT ON PROCEDURE    DEL_FBSERVER IS 'Suppression *logique* d''un Serveur Firebird dans la table TFBERVER';
COMMENT ON PROCEDURE    DEL_GEDGROUP IS 'Suppression *physique* d''un Groupe d''utilisateur GED dans la table TGEDGROUP';
COMMENT ON PROCEDURE    DEL_GEDGROUP_FOR_LIBRARY IS 'Suppression *physique* d''une association Groupe d''utilisateur GED/Bibliothque dans la table TGEDGROUPLIB';
COMMENT ON PROCEDURE    DEL_GEDPARAM IS 'Suppression (physique) d''un Paramtre GED dans la table TGEDPARAM';
COMMENT ON PROCEDURE    DEL_GEDPARAMOWNER IS 'Suppression d''un Paramtre GED associ  une utilisateur dans la table TGEDPARAMOWNER';
COMMENT ON PROCEDURE    DEL_GEDPARAMPROF IS 'Suppression d''un Paramtre GED pour un Utilisateur GED dans table TGEDPARAMUSER';
COMMENT ON PROCEDURE    DEL_GEDPARAMUSER IS 'Suppression d''un Paramtre GED pour un utilisateur dans la table TGEDPARAMUSER';
COMMENT ON PROCEDURE    DEL_GEDUSER IS 'Suppression *logique* d''un Utilisateur GED dans la table TGEDUSER (STATE + LOGIN)';
COMMENT ON PROCEDURE    DEL_GEDUSER_FOR_GEDGROUP IS 'Suppression *physique* d''une association Utilisateur GED/Groupes d''utilisateur GED dans la table TGEDGROUPUSER';
COMMENT ON PROCEDURE    DEL_GEDUSER_FOR_LIBRARY IS 'Suppression *physique* d''une association Utilisateur GED/Bibliothque dans la table TGEDUSERLIB';
COMMENT ON PROCEDURE    DEL_LIBRARY IS 'Suppression *logique* d''une Bibliothque dans la table TLIBRARY (STATE + TITLE)';
COMMENT ON PROCEDURE    DEL_OWNER IS 'Suppression *logique* d''un Propritaire dans la table TOWNER (STATE + LOGIN)';
COMMENT ON PROCEDURE    DEL_PROFILE IS 'Suppression *physique* d''un Profil dans la table TPROFILE';
COMMENT ON PROCEDURE    DEL_STORAGES IS 'Suppression *physique* de paramtres dans la table TSTORAGE';
COMMENT ON PROCEDURE    GET_ALL_LIBRARIES_FOR_GEDUSER IS 'Liste de TOUTES les bibliothques rattaches  un utilisateur GED, soit directement (base TGEDUSERLIB) soit via son groupe primaire (base TGEDGROUPLIB)';
COMMENT ON PROCEDURE    GET_ALTER_STATE_OK IS 'Technique - Renvoie une chaine de critre (utilisable dans un WHERE) adapte aux STATE de *modification* initialiss par dfaut';
COMMENT ON PROCEDURE    GET_CONTACTS IS 'Liste dtaille de tous les contacts (base TCONTACT)';
COMMENT ON PROCEDURE    GET_CONTACTS_FOR_OWNER IS 'Liste des contacts rattachs  un Propritaire (base TCONTACT)';
COMMENT ON PROCEDURE    GET_CONTACTS_TYPES_FOR_CONTACT IS 'Liste complte des relations d''un contact (utilisation) dans TCONTOWNER et TCONTLIB';
COMMENT ON PROCEDURE    GET_CONTACTS_TYPES_FOR_LIBRARY IS 'Liste des contacts + Types de contact rattachs  une Biliothque (base TCONTLIB)';
COMMENT ON PROCEDURE    GET_CONTACTS_TYPES_FOR_OWNER IS 'Liste des contacts + Types de contact rattachs  un Propritaire (base TCONTOWNER)';
COMMENT ON PROCEDURE    GET_CONTACT_INFOS IS 'Informations dtailles sur un Contact (base TCONTACT)';
COMMENT ON PROCEDURE    GET_CONTACT_TYPE_FOR_LIBRARY IS 'Liste complte des relations d''un contact avec une bibliothque (base TCONTLIB)';
COMMENT ON PROCEDURE    GET_CONTTYPES IS 'Liste des Types de contact possible  (base TCONTTYPE)';
COMMENT ON PROCEDURE    GET_CONTTYPE_INFOS IS 'Informations dtailles sur un Type de contact (base TCONTTYPE)';
COMMENT ON PROCEDURE    GET_CONTTYPE_MDF IS 'Informations dtailles du type de contact pour un contact donn';
COMMENT ON PROCEDURE    GET_DATE_STRING IS 'Technique - Renvoie une chaine formate pour la gestion des date en CHAR (paramtres de procdure)';
COMMENT ON PROCEDURE    GET_DOMPARAM IS 'Renvoie les informations dtailles pour un paramtre de domaine donn (base TDOMPARAM)';
COMMENT ON PROCEDURE    GET_DOMPARAMS IS 'Renvoie la liste complte des paramtres de domaine (base TDOMPARAM)';
COMMENT ON PROCEDURE    GET_DOMPARAM_VALUEBLB IS 'Contenu d''une colonne BLOB pour un paramtre domaine';
COMMENT ON PROCEDURE    GET_DOM_ACCESS IS 'Renvoie l''accs au domaine pour un type particulier (accs global, WEB, Mobile, etc.)';
COMMENT ON PROCEDURE    GET_FBSERVERS IS 'Liste des Serveurs Firebird disponibles (base TFBSERVER)';
COMMENT ON PROCEDURE    GET_FBSERVER_INFOS IS 'Informations dtailles sur un Serveur Firebird (base TFBSERVER)';
COMMENT ON PROCEDURE    GET_GEDGROUPS_FOR_GEDUSER IS 'Liste des Groupes d''utilisateurs GED rattachs  un Utilisateur GED (base TGEDGROUPUSER)';
COMMENT ON PROCEDURE    GET_GEDGROUPS_FOR_LIBRARY IS 'Liste des Groupes d''utilisateur GED associs  une Bibliothque';
COMMENT ON PROCEDURE    GET_GEDGROUPS_FOR_OWNER IS 'Liste des Groupes d'' Utilisateur GED associs  un Propritaire (base TGEDGROUP)';
COMMENT ON PROCEDURE    GET_GEDGROUP_INFOS IS 'Informations dtailles sur Groupe d''Utilisateur GED (base TGEDGROUP)';
COMMENT ON PROCEDURE    GET_GEDPARAM IS 'Renvoie les informations dtailles pour un paramtre de GED donn (base TGEDPARAM)';
COMMENT ON PROCEDURE    GET_GEDPARAMOWNER IS 'Dtail d''un Paramtre GED donn pour un Propritaire donn (base TGEDPARAMOWNER)';
COMMENT ON PROCEDURE    GET_GEDPARAMOWNERS_FOR_OWNER IS 'Liste des Paramtre GED pour un Propritaire donn (base TGEDPARAMOWNER)';
COMMENT ON PROCEDURE    GET_GEDPARAMOWNER_MDF IS 'Informations dtailles des paramtres d''un Propritaire (base TGEDPARAMOWNER)';
COMMENT ON PROCEDURE    GET_GEDPARAMOWNER_VALUEBLB IS 'Contenu d''une colonne BLOB pour un paramtre GED d''un propritaire';
COMMENT ON PROCEDURE    GET_GEDPARAMPROF IS 'Dtail d''un Paramtre GED donn pour un Profil donn (base TGEDPARAMPROF)';
COMMENT ON PROCEDURE    GET_GEDPARAMPROFS_FOR_PROFILE IS 'Liste des Paramtre GED pour un Profil donn (base TGEDPARAMPROF)';
COMMENT ON PROCEDURE    GET_GEDPARAMPROF_VALUEBLB IS 'Contenu d''une colonne BLOB pour un paramtre GED d''un profil';
COMMENT ON PROCEDURE    GET_GEDPARAMS IS 'Renvoie la liste dtaille des paramtres GED globaux OU pour un Propritaire OU pour une Bibliothque (base TGEDPARAM)';
COMMENT ON PROCEDURE    GET_GEDPARAMUSER IS 'Dtail d''un Paramtre GED donn pour un Utilisateur GED donn (base TGEDPARAMUSER)';
COMMENT ON PROCEDURE    GET_GEDPARAMUSERS_FOR_USER IS 'Liste des Paramtre GED pour un Utilisateur GED donn et, ventuellement, une Bibliothque et une sectioin donne (base TGEDPARAMUSER)';
COMMENT ON PROCEDURE    GET_GEDPARAMUSER_VALUEBLB IS 'Contenu d''une colonne BLOB pour un paramtre GED d''un utilisateur';
COMMENT ON PROCEDURE    GET_GEDPARAM_DEFAULTVALUEBLB IS 'Contenu d''une colonne BLOB pour un paramtre GED';
COMMENT ON PROCEDURE    GET_GEDPARAM_FOR_NAME IS 'Renvoie les informations dtailles pour un paramtre de GED donn par son Nom ET sa section (base TGEDPARAM)';
COMMENT ON PROCEDURE    GET_GEDUSERS_FOR_LIBRARY IS 'Liste des Utilisateurs GED rattachs  une Bibliothque (base TGEDUSERLIB)';
COMMENT ON PROCEDURE    GET_GEDUSERS_FOR_OWNER IS 'Liste des Utilisateurs GED rattachs  un Propritaire (base TGEDUSER) ou  un Groupe d''utilisateurs (base TGEDGROUPUSER)';
COMMENT ON PROCEDURE    GET_GEDUSER_ID IS 'Renvoie le code et le STATE d''un Utilisateur GED par rapport  un couple d''authentification LOGIN/PASSWORD (base TGEDUSER)';
COMMENT ON PROCEDURE    GET_GEDUSER_INFOS IS 'Informations dtailles sur Utilisateur GED (base TGEDUSER)';
COMMENT ON PROCEDURE    GET_LASTSYNC_MDF IS 'Informations dtailles concernant la dernire synchronisation d''une librairie donne';
COMMENT ON PROCEDURE    GET_LIBRARIES IS 'Liste des bibliothques du domaine (base TLIBRARY)';
COMMENT ON PROCEDURE    GET_LIBRARIES_FOR_FBSERVER IS 'Liste des bibliothques rattaches  un serveur Firebird (base TLIBRARY)';
COMMENT ON PROCEDURE    GET_LIBRARIES_FOR_GEDGROUP IS 'Liste des Bibliothques associes  un Groupe d''utilisateur GED';
COMMENT ON PROCEDURE    GET_LIBRARIES_FOR_GEDUSER IS 'Liste des bibliothques rattaches  un utilisateur GED (base TGEDUSERLIB)';
COMMENT ON PROCEDURE    GET_LIBRARIES_FOR_OWNER IS 'Liste des bibliothques rattaches  un propritaire (base TLIBRARY)';
COMMENT ON PROCEDURE    GET_LIBRARY_CONNECT IS 'Renvoie une chaine de connexion technique Firebird (utilisable par un client Firebird) pour un Bibliothque donne (base TLIBRARY)';
COMMENT ON PROCEDURE    GET_LIBRARY_INFOS IS 'Informations dtailles sur une bibliothque (base TLIBRARY)';
COMMENT ON PROCEDURE    GET_LOGSYNCS IS 'Renvoie les dtails de synchronisation pour une Bibliothque ou un Propritaire donn (table TLOGSYNC)';
COMMENT ON PROCEDURE    GET_LOGSYNCSTATS IS 'Renvoie les dtails de synchronisation pour une Bibliothque ou une Propritaire donn (table TLOGSYNC)';
COMMENT ON PROCEDURE    GET_LOGSYNC_MDF IS 'Informations dtailles concernant les synchronisations d'' propritaire (attention, trs long), d''une librairie (attention, trs long) ou d''une synchronisation donne';
COMMENT ON PROCEDURE    GET_OWNERS IS 'Liste des Propritaires du domaine (base TOWNER)';
COMMENT ON PROCEDURE    GET_OWNER_ID IS 'Renvoie le code et le STATE d''un Propritaire par rapport  un couple d''authentification LOGIN/PASSWORD (base TOWNER)';
COMMENT ON PROCEDURE    GET_OWNER_INFOS IS 'Informations dtailles sur un Propritaire (base TOWNER)';
COMMENT ON PROCEDURE    GET_OWNER_IS_ADMIN IS 'Renvoie 0/1 en fonction de l''tat "Administrateur du Domaine" pour un Propritaire donn (base TOWNER)';
COMMENT ON PROCEDURE    GET_PROFILES_FOR_OWNER IS 'Liste des Profils associs  un Propritaire';
COMMENT ON PROCEDURE    GET_PROFILE_FOR_GEDGROUPLIB IS 'Renvoie LE profil associ  la Bibliothque et au groupe d''utilisateur donn dans la table TGEDGROUPLIB';
COMMENT ON PROCEDURE    GET_PROFILE_FOR_GEDUSERLIB IS 'Renvoie LE profil associ  la Bibliothque et l''utilisateur donn dans la table TGEDUSERLIB';
COMMENT ON PROCEDURE    GET_PROFILE_INFOS IS 'Informations dtailles sur un Profil';
COMMENT ON PROCEDURE    GET_STATES IS 'Technique - Renvoie une liste des tats (colonne STATE) pour une table et des critres donnes (base gnrique)';
COMMENT ON PROCEDURE    GET_STATE_CRITERIA IS 'Construction d''critre  appliquer sur un STATE d''une table donne en fonction d''un paramtre STATE pass en entre de Procdure stockes (utilisable dans un WHERE)';
COMMENT ON PROCEDURE    GET_STORAGES IS 'Liste des paramtres en STORAGE disponibles filtrs en fonction des paramtres (base TSTORAGE)';
COMMENT ON PROCEDURE    GET_SUBDOMAIN_EXISTS IS 'Renvoie le code Propritaire d''un sous-domaine (unique) donn (base TOWNER)';
COMMENT ON PROCEDURE    GET_VISIBILITY_STATE_OK IS 'Technique - Renvoie une chaine de critre (utilisable dans un WHERE) adapte aux STATE de *visualisation* initialiss par dfaut';
COMMENT ON PROCEDURE    SET_CONTACT_INFOS IS 'Cration (ID = 0) ou MAJ d''un Contact dans la table TCONTACT';
COMMENT ON PROCEDURE    SET_CONTACT_TYPE_TO_LIBRARY IS 'Association d''un contact avec une bibliobthque (base TCONTLIB)';
COMMENT ON PROCEDURE    SET_CONTTYPE_INFOS IS 'Cration (ID = 0) ou MAJ d''un Type de Contact dans la table TCONTTYPE';
COMMENT ON PROCEDURE    SET_DOMPARAM IS 'Cration (NAME inexistant) ou MAJ d''un Paramtre dans la table TDOMPARAM';
COMMENT ON PROCEDURE    SET_DOMPARAM_VALUEBLB IS 'Mise  jour de la valeur BLOB d''un Paramtre dj prsent dans la table TDOMPARAM';
COMMENT ON PROCEDURE    SET_FBSERVER_INFOS IS 'Cration (ID = 0) ou MAJ d''un Serveur Firebird dans la table TFBSERVER';
COMMENT ON PROCEDURE    SET_GEDGROUP_INFOS IS 'Cration (ID=0) ou MAJ d''un Groupe d''Utilisateur GED dans la table TGEDGROUP';
COMMENT ON PROCEDURE    SET_GEDPARAM IS 'Cration (ID inexistant) ou MAJ d''un Paramtre GED dans la table TGEDPARAM';
COMMENT ON PROCEDURE    SET_GEDPARAMOWNER IS 'Ajout ou mise  jour d''un Paramtre GED pour un Propritaire donn, dans la table TGEDPARAMOWNER';
COMMENT ON PROCEDURE    SET_GEDPARAMOWNER_VALUEBLB IS 'Mise  jour de la valeur BLOB d''un Paramtre Propritaire dj prsent dans la table TGEDPARAMOWNER';
COMMENT ON PROCEDURE    SET_GEDPARAMPROF IS 'Ajout ou mise  jour d''un Paramtre GED pour un Profil donn dans la table TGEDPARAMPROF';
COMMENT ON PROCEDURE    SET_GEDPARAMPROF_VALUEBLB IS 'Mise  jour de la valeur BLOB d''un Paramtre Profil dj prsent dans la table TGEDPARAMPROF';
COMMENT ON PROCEDURE    SET_GEDPARAMUSER IS 'Ajout ou mise  jour d''un Paramtre GED  un utilisateur donn dans la table TGEDPARAMUSER';
COMMENT ON PROCEDURE    SET_GEDPARAMUSER_VALUEBLB IS 'Mise  jour de la valeur BLOB d''un Paramtre Utilisateur dj prsent dans la table TGEDPARAMUSER';
COMMENT ON PROCEDURE    SET_GEDPARAM_DEFAULTVALUEBLB IS 'Mise $ jour d''une colonne BLOB pour un paramtre GED';
COMMENT ON PROCEDURE    SET_GEDUSER_INFOS IS 'Cration (ID=0) ou MAJ d''un Utilisateur GED dans la table TGEDUSER';
COMMENT ON PROCEDURE    SET_GEDUSER_PASSWD IS 'MAJ du mot de passe d''un Utilisateur GED dans la table TGEDUSER';
COMMENT ON PROCEDURE    SET_LIBRARY_INFOS IS 'Cration (ID = 0) ou MAJ d''une Bibliothque dans la table TLIBRARY';
COMMENT ON PROCEDURE    SET_OWNER_INFOS IS 'Cration (ID = 0) ou MAJ d''un Propritaire (sauf mot de passe, voir PS "SET_OWNER_DOM_PASSWD") dans la table TOWNER';
COMMENT ON PROCEDURE    SET_OWNER_PASSWD IS 'MAJ du mot de passe d''un Propritaire dans la table TOWNER';
COMMENT ON PROCEDURE    SET_PROFILE_INFOS IS 'Cration (ID = 0) ou MAJ d'' un Profil dans la table TPROFILE';
COMMENT ON PROCEDURE    SET_STATE IS 'Technique - MAJ d''une colonne STATE dans une table donne(base gnrique)';
COMMENT ON PROCEDURE    SET_STORAGE IS 'Cration d''un Paramtre STORAGE dans la table TSTORAGE';
COMMENT ON PROCEDURE    SET_STRING_DATE IS 'Technique - Initialise une chaine formate pour la gestion des date en CHAR (paramtres de procdure)';
COMMENT ON PROCEDURE    UNDEL_CONTACT IS 'Annulation de la suppression *logique* d''un Contact dans TCONTACT';
COMMENT ON PROCEDURE    UNDEL_FBSERVER IS 'Annulation de la suppression *logique* d''un Serveur Firebird dans la table TFBERVER';
COMMENT ON PROCEDURE    UNDEL_GEDUSER IS '''un Utilisateur GED dans la table TGEDUSER (STATE)';
COMMENT ON PROCEDURE    UNDEL_LIBRARY IS 'Annulation de la suppression *logique* d''une Bibliothque dans la table TLIBRARY (STATE + TITLE)';
COMMENT ON PROCEDURE    UNDEL_OWNER IS 'Annulation de la suppression *logique* d''un Propritaire dans la table TOWNER (STATE + LOGIN)';
COMMENT ON TRIGGER      AINC_TCONTACT IS 'MAJ ID SEQ_CONTACT/CREATE_DATE en insertion';
COMMENT ON TRIGGER      AINC_TCONTTYPE IS 'MAJ ID SEQ_CONTTYPE en insertion';
COMMENT ON TRIGGER      AINC_TFBSERVER IS 'MAJ ID SEQ_LOG_SYNC en insertion';
COMMENT ON TRIGGER      AINC_TGEDGROUP IS 'MAJ ID SEQ_GEDGROUP/CREATE_DATE en insertion';
COMMENT ON TRIGGER      AINC_TGEDPARAM IS 'MAJ ID SEQ_GEDPARAM';
COMMENT ON TRIGGER      AINC_TGEDUSER IS 'MAJ ID SEQ_GEDUSER/CREATE_DATE en insertion';
COMMENT ON TRIGGER      AINC_TLIBRARY IS 'MAJ ID SEQ_OWNER/CREATE_DATE en insertion';
COMMENT ON TRIGGER      AINC_TPROFILE IS 'MAJ ID SEQ_PROFILE/CREATE_DATE en insertion';
COMMENT ON TRIGGER      TGEDPARAMOWNER_STAMP IS 'Mise  jour de la date de modification du paramtre Profil';
COMMENT ON TRIGGER      TGEDPARAMPROF_STAMP IS 'Mise  jour de la date de modification du paramtre Profil';
COMMENT ON TRIGGER      TGEDPARAMUSER_STAMP IS 'Mise  jour de la date de modification du paramtre Utilisateur';
COMMENT ON TRIGGER      UPDSIZE_TLIBRARY IS 'Mise  jour des cumuls de taille de LIB pour TOWNER et TFBSERVER';
COMMENT ON EXCEPTION    EX_ALPHAONLY_DOM_LOGIN IS 'Violation des rgles de contraintes de TOWNER.DOM_LOGIN (non vide, alphanum + "_" + "." seulement)';
COMMENT ON EXCEPTION    EX_ALPHAONLY_SUBDOMAIN IS 'Violation des rgles de contraintes de TOWNER.SUBDOMAIN (non vide, alphanum + "_" + "." seulement)';
COMMENT ON EXCEPTION    EX_BADACCESSMODE IS 'Mode d''accs TLIBRARY.ACCESS_MODE non rfrenc (check)';
COMMENT ON EXCEPTION    EX_BADOWNER IS 'Propritaire incohrent pour les paramtres GED';
COMMENT ON EXCEPTION    EX_BAD_DOM_LOGIN IS 'Login Propritaire inexistant OU ou non visible/modifiable par rapport au TOWNER.STATE';
COMMENT ON EXCEPTION    EX_BAD_DOM_PASSWD IS 'Mot de passe incorrect par rapport au login fourni';
COMMENT ON EXCEPTION    EX_BAD_GED_LOGIN IS 'Login inexistant ou Utilisateur GED non visible (lui-mme ou son Propitaire';
COMMENT ON EXCEPTION    EX_BAD_HOSTNAME IS 'Violation des rgles de contraintes de TFBSERVER.HOST (respect RFC 873/1123) - Attention les contraintes sur les IP sont peu fiables (>255 possible)';
COMMENT ON EXCEPTION    EX_BAD_PARAM IS 'Paramtre pass  une procdure incorrect (traitement du paramtre en erreur)';
COMMENT ON EXCEPTION    EX_CONTLIB_EXISTS IS 'Association Contact/Bibliothque dj existante dans la table TCONTLIB (doublon PK)';
COMMENT ON EXCEPTION    EX_CONTOWN_EXISTS IS 'Association Type de contact/Propritaire dj existante dans la table TCONTOWER (doublon PK)';
COMMENT ON EXCEPTION    EX_CONTTYPE_INUSE IS 'Type de contact utilis (violation FK Cascade';
COMMENT ON EXCEPTION    EX_DELCOLOVERFLOW IS 'Dpassement de capacit de colonne suite aux ajouts de marque de suppression (PS DEL_*)';
COMMENT ON EXCEPTION    EX_DOMPARAMSYSTEM IS 'Paramtre TDOMPARAM avec FLAG SYSTEM non modifiable/supprimable';
COMMENT ON EXCEPTION    EX_DOM_LOGIN_EXISTS IS 'Login dj existant dans la table TOWNER (doublon UNIQUE)';
COMMENT ON EXCEPTION    EX_GEDGROUPLIB_EXISTS IS 'Association Groupe d''utilisateur GED/Bibliothque dj existante dans la table TGEDGROUPLIB';
COMMENT ON EXCEPTION    EX_GEDGROUPUSER_EXISTS IS 'Association Groupe/Utilisateur GED dj existante dans la table TGEDGROUPUSER';
COMMENT ON EXCEPTION    EX_GEDGROUP_EXISTS IS 'Groupe d''Utilisateur GED dj existant pour ce Propitaire dans la table TGEDGROUP';
COMMENT ON EXCEPTION    EX_GEDGROUP_INUSE IS 'Groupe utilis, donc ne peut pas tre modifi (violation FK Cascade)';
COMMENT ON EXCEPTION    EX_GEDPARAMPROF_EXISTS IS 'Association Paramtre GED/Profil dj existante dans la table TGEDPARAMPROF';
COMMENT ON EXCEPTION    EX_GEDPARAMUSER_EXISTS IS 'Association Paramtre GED/Profil dj existante dans la table TGEDPARAMUSER';
COMMENT ON EXCEPTION    EX_GEDPARAM_EXISTS IS 'Le paramtre GED spcifi existe dj pour la mme section et le mme propritaire dans la table TGEDPARAM';
COMMENT ON EXCEPTION    EX_GEDPARAM_INUSE IS 'Paramtre GED utilis par un Profil (violation FK)';
COMMENT ON EXCEPTION    EX_GEDPARAM_SECTION_KO IS 'La cration d''un GEDPARAM ncessite l''utilisation d''une section spcifique (TDOMPARAM:DOMAIN/GEDPARAM_SECTION_OWNER ou TDOMPARAM:DOMAIN/GEDPARAM_SECTION_LIB  ou tre autorise par TDOMPARAM:DOMAIN/GEDPARAM_SECTIONS_OWNER_CREATE';
COMMENT ON EXCEPTION    EX_GEDUSERLIB_EXISTS IS 'Association Utilisateur GED/Bibliothque dj existante dans la table TGEDUSERLIB';
COMMENT ON EXCEPTION    EX_GED_LOGIN_EXISTS IS 'Login dj existant dans la table TGEDUSER pour le mme Propitaire (doublon UNIQUE)';
COMMENT ON EXCEPTION    EX_LIBTITLE_EXISTS IS 'Titre de bibliothque dj existant dans la table TLIBRARY pour le mme propritaire (doublon UNIQUE)';
COMMENT ON EXCEPTION    EX_NOCONTACT IS 'Contact non prsent physiquement dans la table TCONTACT ou non visible/modifiable par rapport au STATE';
COMMENT ON EXCEPTION    EX_NOCONTLIB IS 'Association Contact/Bibliothque inexistante dans la table TCONTLIB';
COMMENT ON EXCEPTION    EX_NOCONTOWN IS 'Association Type de contact/Propritaire inexistante dans la table TCONTOWER';
COMMENT ON EXCEPTION    EX_NOCONTTYPE IS 'Type de contact non prsent physiquement dans la table TCONTTYPE';
COMMENT ON EXCEPTION    EX_NODOMPARAM IS 'Paramtre TDOMPARAM inexistant';
COMMENT ON EXCEPTION    EX_NOFBSER IS 'Serveur non prsent physiquement dans la table TFBSERVER ou non visible/modifiable par rapport au STATE';
COMMENT ON EXCEPTION    EX_NOGEDGROUP IS 'Groupe d''Utilisateur GED non prsent physiquement dans la table GEDGROUP ou non visible/modifiable par rapport au STATE du Propritaire';
COMMENT ON EXCEPTION    EX_NOGEDGROUPLIB IS 'Association Groupe d''utilisateur GED/Bibliothque inexistante';
COMMENT ON EXCEPTION    EX_NOGEDGROUPUSER IS 'Association Groupe/Utilisateur GED inexistante dans la table TGEDGROUPUSER';
COMMENT ON EXCEPTION    EX_NOGEDPARAM IS 'Le paramtre GED spcifi n''existe pas dans la table TGEDPARAM';
COMMENT ON EXCEPTION    EX_NOGEDPARAMPROF IS 'Association Paramtre GED/Profil inexistante dans la table TGEDPARAMPROF';
COMMENT ON EXCEPTION    EX_NOGEDPARAMUSER IS 'Association Paramtre GED/Utilisateur inexistante dans la table TGEDPARAMUSER';
COMMENT ON EXCEPTION    EX_NOGEDUSER IS 'Utilisateur GED non prsent physiquement dans la table TGEDUSER ou non visible/modifiable par rapport au STATE';
COMMENT ON EXCEPTION    EX_NOGEDUSERLIB IS 'Association Utilisateur GED/Bibliothque inexistante dans la table TGEDUSERLIB';
COMMENT ON EXCEPTION    EX_NOLIB IS 'Bibliothque non prsente physiquement dans la table TLIBRARY ou non visible/modifiable par rapport au STATE';
COMMENT ON EXCEPTION    EX_NOMODIF IS 'Enregistrement non modifiable par rapport  la colonne STATE';
COMMENT ON EXCEPTION    EX_NONULL IS 'Un paramtre obligatoire n''a pas t soumis  une procdure (la procdure doit ajouter le nom du paramtre au message)';
COMMENT ON EXCEPTION    EX_NOOWNER IS 'Propritaire non prsent physiquement dans la table TOWNER ou non visible/modifiable par rapport au STATE';
COMMENT ON EXCEPTION    EX_NOPARAM IS 'Paramtre non prsent physiquement dans la table TPARAMETERS';
COMMENT ON EXCEPTION    EX_NOPROFILE IS 'Profil non prsent physiquement dans la table TPROFILE ou non visible/modifiable par rapport au STATE';
COMMENT ON EXCEPTION    EX_NOSTORAGE IS 'Le paramtre STORAGE spcifi n''existe pas dans la table TSTORAGE';
COMMENT ON EXCEPTION    EX_NOTABLEORCOL IS 'Table et/ou colonne inexistante (PS techniques  usage interne seulement)';
COMMENT ON EXCEPTION    EX_OWNER_INFOS_DUPLICATE IS 'Code externe ou sous-domaine dj existant dans la table TOWNER (doublon UNIQUE)';
COMMENT ON EXCEPTION    EX_PROFILE_EXISTS IS 'Nom de Profil dj existant pour le mme propitaire (doublon UNIQUE)';
COMMENT ON EXCEPTION    EX_PROFILE_INUSE IS 'Profil utilis, donc ne peut pas tre modifi (violation FK Cascade)';
COMMENT ON EXCEPTION    EX_STORAGE_EXISTS IS 'Le paramtre STORAGE spcifi existe dj pour la mme section et le mme propritaire dans la table TSTORAGE (violation de la rgle d''unicit de la table)';
COMMENT ON GENERATOR    SEQ_CONTACT IS 'Gnrateur ID Contact';
COMMENT ON GENERATOR    SEQ_CONTTYPE IS 'Gnrateur ID Type de contact';
COMMENT ON GENERATOR    SEQ_FBSERVER IS 'Gnrateur ID Serveur Firebird';
COMMENT ON GENERATOR    SEQ_GEDGROUP IS 'Gnrateur ID Groupe d''utlisateur GED';
COMMENT ON GENERATOR    SEQ_GEDPARAM IS 'Gnrateur ID Paramtre GED';
COMMENT ON GENERATOR    SEQ_GEDUSER IS 'Gnrateur ID Utilisateur GED';
COMMENT ON GENERATOR    SEQ_LIBRARY IS 'Gnrateur ID Bibliothque';
COMMENT ON GENERATOR    SEQ_LOGSYNC IS 'Gnrateur ID Journalisation synchronisation';
COMMENT ON GENERATOR    SEQ_OWNER IS 'Gnrateur ID Propritaire';
COMMENT ON GENERATOR    SEQ_PROFILE IS 'Gnrateur ID Profil';
/* version 40 */
COMMIT WORK;
